<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>我的技术与生活——Kubernetes组件学习 | Mr.Long</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="shortcut icon" href="/imgs/shortcut-icon.ico" type="image/x-icon">
  <link rel="stylesheet" href="/css/public.css" />
  <link rel="stylesheet" href="/css/layout.css" />
  <link rel="stylesheet" href="/css/iconfont.css" />
  <link rel="stylesheet" href="/css/APlayer.min.css" />
  <script src="/js/APlayer.min.js"></script>
  <script src="/js/jquery.min.js"></script>
  <script src="/js/jquery.pjax.min.js"></script>

  <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
  <script>
    document.title = `我的技术与生活——Kubernetes组件学习`
  </script>
<meta name="generator" content="Hexo 7.3.0"></head>

<style>
  .load {
    width: 100%;
    height: 100vh;
    background-color: rgb(37, 35, 40);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    position: relative;
    z-index: 9999;
  }
  .load-circle {
    width: 80px;
    height: 80px;
    border: 8px solid orange;
    border-bottom-color: transparent;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    animation: rotate 1s linear infinite;
    filter: drop-shadow(0 0 3px orange);
  }
  .load-circle-inner {
    width: 40px;
    height: 40px;
    border: 8px solid orange;
    border-top-color: transparent;
    border-radius: 50%;
    animation: rotate-reverse .5s linear infinite;
  }
  .load-text {
    margin-top: 20px;
    font-size: 24px;
    color: orange;
    display: flex;
  }
  .load-text span {
    margin: 0 5px;
    text-shadow: 5px 5px 5px orange;
    animation: move 1s linear infinite;
  }
  .load-text span:nth-child(1) {
    animation-delay: -0.6s;
  }
  .load-text span:nth-child(2) {
    animation-delay: -0.5s;
  }
  .load-text span:nth-child(3) {
    animation-delay: -0.4s;
  }
  .load-text span:nth-child(4) {
    animation-delay: -0.3s;
  }
  .load-text span:nth-child(5) {
    animation-delay: -0.2s;
  }
  .load-text span:nth-child(6) {
    animation-delay: -0.1s;
  }
  @keyframes rotate {
    0% { transform: rotate(0); }
    100% { transform: rotate(360deg); }
  }
  @keyframes rotate-reverse {
    0% { transform: rotate(0); }
    100% { transform: rotate(-360deg); }
  }
  @keyframes move {
    0% { transform: translateY(0%) rotate(0) scale(1); }
    20% { transform: translateY(20%) rotate(10deg) scale(1.2); }
    80% { transform: translateY(-10%) rotate(-20deg) scale(.8);}
    100% { transform: translateY(0) rotate(0) scale(1); }
  }

  .progress {
    position: fixed;
    left: 0; top: 0;
    width: 0;
    height: 3px;
    background-color: green;
    transition: all cubic-bezier(0.215, 0.610, 0.355, 1) .1s;
    z-index: 9999;
  }

  .to-up {
    animation: toUp .5s 1;
  }
  .gray {
    position: fixed;
    left: 0;
    top: 0;
    width: 100%;
    height: 100vh;
    z-index: 9999;
    display: none;
    pointer-events: none;
    background-color: #000;
    mix-blend-mode: color;
  }
  @keyframes toUp {
    from { transform: translateY(15px); opacity: 0; }
    to { transform: translateY(0) ; opacity: 1; }
  }
</style>
<body>
  <div id="load" class="load">
    <div class="load-circle">
      <div class="load-circle-inner"></div>
    </div>
    <p class="load-text">
      <span>L</span>
      <span>O</span>
      <span>A</span>
      <span>D</span>
      <span>I</span>
      <span>N</span>
      <span>G</span>
    </p>
  </div>
  <div id="container" class="container w-100 vh-100" style="display: none;">
    <header class="header">
  <div class="header-wrapper">
    <div class="header-left">
      <div class="header-search">
        <input id="search-input" type="text" class="header-search--input" placeholder="请输入要检索的文章标题" />
        <span id="search-btn" class="header-search--icon"><i class="iconfont icon-sousuo"></i></span>
      </div>
      <div id="search-layer" class="header-search--layer hidden">
        <p class="title">
          <span>以下是搜索内容：</span>
          <span id="close-layer-btn">关闭</span>
        </p>
        <ul>
        </ul>
      </div>
    </div>
    <div class="header-right">
      <ul class="header-menu">
        <li>
          <a href="http://example.com/">
            <i class="header-menu--icon iconfont icon-shouye"></i>
            <span class="header-menu--span">首页</span>
          </a>
        </li>
        <li>
          <a href="http://example.com/log">
            <i class="header-menu--icon iconfont icon-rizhi"></i>
            <span class="header-menu--span">日志</span>
          </a>
        </li>
        <li>
          <a href="http://example.com/link">
            <i class="header-menu--icon iconfont icon-youqinglianjie"></i>
            <span class="header-menu--span">友情链接</span>
          </a>
        </li>
        <li>
          <a href="http://example.com/about">
            <i class="header-menu--icon iconfont icon-guanyuwomen"></i>
            <span class="header-menu--span">关于我</span>
          </a>
        </li>
      </ul>
    </div>
  </div>
</header>

<script>
  const ipt = document.querySelector('#search-input')
  const btn = document.querySelector('#search-btn')
  const layer = document.querySelector('#search-layer')
  const posts = JSON.parse(`[{"title":"docker命令","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/71e27d1e01da8c13f3f165a1c3bcc8b571e27d1e01da8c13f3f165a1c3bcc8b5","path":"2024/03/21/Docker命令大全/"},{"title":"Kubernetes扩展","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/2e0af7de62ed4210b634c867367c10ae2e0af7de62ed4210b634c867367c10ae","path":"2024/06/01/Kubernetes容器编排技术[扩展]/"},{"title":"LVM逻辑卷管理","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/d733537fd3e06784932826b5e82a855d","path":"2023/06/28/LVM逻辑卷管理/"},{"title":"LV移除、缩容","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/d733537fd3e06784932826b5e82a855d","path":"2023/06/14/LV逻辑卷扩展/"},{"title":"PXE+Kickstart无人值守安装操作系统","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/82cb48f718f8acc8cb2568140eeaaec382cb48f718f8acc8cb2568140eeaaec3","path":"2023/06/26/PXE+Kickstart无人值守安装操作系统/"},{"title":"python一","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/15096963228077376","path":"2024/02/20/Python1/"},{"title":"python三","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/15096963228077376","path":"2024/02/25/Python3/"},{"title":"PQL","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/240007b00ab1bcd1e3af7bb55f18a966","path":"2024/06/30/PromQL 讲解/"},{"title":"python二","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/15096963228077376","path":"2024/02/21/Python2/"},{"title":"TCP协议","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/15047394039467328","path":"2023/06/23/TCP协议/"},{"title":"python四","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/15096963228077376","path":"2024/03/01/Python4/"},{"title":"Kubernetes组件学习","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/2e0af7de62ed4210b634c867367c10ae2e0af7de62ed4210b634c867367c10ae","path":"2024/06/02/Kubernetes组件/"},{"title":"docker容器","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/71e27d1e01da8c13f3f165a1c3bcc8b571e27d1e01da8c13f3f165a1c3bcc8b5","path":"2024/03/11/docker容器/"},{"title":"FTP文件服务器","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/a9045286aa9b50dcc09302eff83b328a","path":"2023/06/23/ftp/"},{"title":"Galera集群","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/3719037aa1a43c4806d84ac9bd3dbc34","path":"2024/07/26/galera/"},{"title":"redis操作","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/a13d778b5db38e4b127b71bdf122f695","path":"2023/09/26/Redis操作/"},{"title":"ansible模块","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/1e624a7ba7e09f195b3f2f384b2b9bb1","path":"2023/08/17/ansible 模块扩展/"},{"title":"Kubernetes数据库","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/2e0af7de62ed4210b634c867367c10ae2e0af7de62ed4210b634c867367c10ae","path":"2024/06/14/k8s集群数据库/"},{"title":"nginx2","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/8c29198625ff99eee0073bbbb137bbc78c29198625ff99eee0073bbbb137bbc7","path":"2023/12/19/nginx2/"},{"title":"nginx3","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/8c29198625ff99eee0073bbbb137bbc78c29198625ff99eee0073bbbb137bbc7","path":"2023/12/22/nginx3/"},{"title":"nginx1","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/8c29198625ff99eee0073bbbb137bbc78c29198625ff99eee0073bbbb137bbc7","path":"2023/12/17/nginx1/"},{"title":"nginx5","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/8c29198625ff99eee0073bbbb137bbc78c29198625ff99eee0073bbbb137bbc7","path":"2023/12/31/nnginx5/"},{"title":"nginx4","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/8c29198625ff99eee0073bbbb137bbc78c29198625ff99eee0073bbbb137bbc7","path":"2023/12/30/nginx4/"},{"title":"redis集群安装","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/a13d778b5db38e4b127b71bdf122f695","path":"2023/09/21/redis集群/"},{"title":"shell脚本","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/9217d5c6d87ce0e8ec7422ca7469db95","path":"2024/08/10/shell脚本/"},{"title":"prometheus","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/240007b00ab1bcd1e3af7bb55f18a966","path":"2024/06/16/prometheus 监控/"},{"title":"shell编程","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/9217d5c6d87ce0e8ec7422ca7469db95","path":"2023/07/21/shell_newrain/"},{"title":"prometheus-exporter","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/240007b00ab1bcd1e3af7bb55f18a966","path":"2024/06/16/node_exporter/"},{"title":"docker镜像容器","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/71e27d1e01da8c13f3f165a1c3bcc8b571e27d1e01da8c13f3f165a1c3bcc8b5","path":"2024/03/14/容器技术-docker2/"},{"title":"Kubernetes集群部署","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/2e0af7de62ed4210b634c867367c10ae2e0af7de62ed4210b634c867367c10ae","path":"2024/06/10/二进制方式部署k8s集群/"},{"title":"docker-Compose","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/71e27d1e01da8c13f3f165a1c3bcc8b571e27d1e01da8c13f3f165a1c3bcc8b5","path":"2024/03/21/容器技术-docker5/"},{"title":"docker资源限制","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/71e27d1e01da8c13f3f165a1c3bcc8b571e27d1e01da8c13f3f165a1c3bcc8b5","path":"2024/03/15/容器技术docker4/"},{"title":"docker安装","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/71e27d1e01da8c13f3f165a1c3bcc8b571e27d1e01da8c13f3f165a1c3bcc8b5","path":"2024/03/06/容器技术-Docker1/"},{"title":"docker容器","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/71e27d1e01da8c13f3f165a1c3bcc8b571e27d1e01da8c13f3f165a1c3bcc8b5","path":"2024/03/13/容器技术-docker3/"},{"title":"linux文件管理","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/de0f7b079a80d192f90989d9c2c9622d","path":"2023/06/21/文件管理/"},{"title":"用户文件权限","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/3719037aa1a43c4806d84ac9bd3dbc34","path":"2023/06/01/文件权限/"},{"title":"单用户模式破解密码","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/3f6ae566e1f093d2d9dbcc3df361fc4b3f6ae566e1f093d2d9dbcc3df361fc4b","path":"2023/07/01/破解密码/"},{"title":"微服务项目","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/3719037aa1a43c4806d84ac9bd3dbc34","path":"2024/07/26/微服务项目-mall-swarm/"},{"title":"存储管理--1","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/d733537fd3e06784932826b5e82a855d","path":"2023/06/25/磁盘存储管理1/"},{"title":"磁盘阵列","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/69d9906ff9bf88dbc02184ecb8504fc5","path":"2023/07/09/磁盘阵列RAID/"},{"title":"prometheus自定义监控","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/240007b00ab1bcd1e3af7bb55f18a966","path":"2024/06/26/自定义监控/"},{"title":"微服务","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/3719037aa1a43c4806d84ac9bd3dbc34","path":"2024/07/26/微服务概念/"},{"title":"Linux网卡","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/346f59e468f2155074d1fb3164594702","path":"2023/06/11/网络管理基础/"},{"title":"自建YUM源","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/56260873f5720f373c20f43587eab0b8","path":"2023/06/21/自建yum源笔记/"},{"title":"Kubernetes蓝鲸智云平台部署","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/2e0af7de62ed4210b634c867367c10ae2e0af7de62ed4210b634c867367c10ae","path":"2024/09/01/蓝鲸智云平台部署/"},{"title":"走进网络世界","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/583716b0cb306203c308cc0def55dd9e583716b0cb306203c308cc0def55dd9e","path":"2023/06/16/走进网络世界/"}]`)
  ipt.addEventListener('keyup', e => {
    if (e.key === 'Enter') {
      handleSearch()
    }
  })
  btn.addEventListener('click', () => {
    handleSearch()
  })

  document.querySelector('#close-layer-btn').addEventListener('click', () => {
    layer.classList.toggle('hidden')
  })

  function handleSearch() {
    if (ipt.value.trim() === '') {
      return
    }
    let html = ''
    const targetPosts = posts.filter(post => post.title.includes(ipt.value))
    targetPosts.forEach(post => {
      html += `
        <li>
          <div>
            <a href="/${post.path}">${post.title.replace(new RegExp(ipt.value), `<span>${ipt.value}</span>`)}</a>
          </div>
          <img src="${post.cover || '/imgs/default-cover.webp' }" />
        </li>
      `
    })
    if (html.trim () === '') {
      html += '<p class="empty">没有搜索到内容</p>'
    }
    layer.querySelector('ul').innerHTML = html
    layer.classList.remove('hidden')
  }
</script> 
    <section id="main" class="main">
      <div class="main-left-wrapper">
<div class="main-left">
  <div class="main-left--block">
    <div class="main-left--info">
      <img src="/imgs/avatar.jpg"" class="main-left--avatar" />
      <div class="main-left--intro">
        <p class="main-left--name">Mr.Long</p>
        <div class="main-left--tags">
          <span class="main-left--tag">唱跳rap篮球</span>
          <span class="main-left--tag">宅但不肥</span>
        </div>
      </div>
    </div>
  
    <div>
      <div class="main-left--motto">
        <p>“花有重开日，人无再少年”</p>
        <p>“一个简单普通的男孩”</p>
      </div>
      <div class="main-left--github">
        <span class="line"></span>
        <a target="_blank" rel="noopener" href="https://github.com/MyRong99/MyRong99.github.io"><i class="logo iconfont icon-github-fill"></i></a>
        <span class="line"></span>
      </div>
      <div class="main-left--statics">
        <a href="/categories">
          <div>
            <span>0</span>
            <span>分类</span>
          </div>
        </a>
        <a href="/tags">
          <div>
            <span>8</span>
            <span>标签</span>
          </div>
        </a>
        <a href="/archives">
          <div>
            <span>11 </span>
            <span>归档</span>
          </div>
        </a>
      </div>
    </div>
  </div>

  <div class="main-left--block">
    <ul class="main-left--menu">
      
        <li>
          <a href="/">
            <span class="header-menu--span">小站首页</span>
            <i class="header-menu--icon iconfont icon-shouye"></i>
          </a>
        </li>
      
        <li>
          <a href="/log">
            <span class="header-menu--span">个人日志</span>
            <i class="header-menu--icon iconfont icon-rizhi"></i>
          </a>
        </li>
      
        <li>
          <a href="/link">
            <span class="header-menu--span">友情链接</span>
            <i class="header-menu--icon iconfont icon-youqinglianjie"></i>
          </a>
        </li>
      
        <li>
          <a href="/about">
            <span class="header-menu--span">关于自己</span>
            <i class="header-menu--icon iconfont icon-guanyuwomen"></i>
          </a>
        </li>
      
        <li>
          <a href="/tools">
            <span class="header-menu--span">我的工具</span>
            <i class="header-menu--icon iconfont icon-gongju"></i>
          </a>
        </li>
      
    </ul>
  </div>

  <div class="main-left--block">
    <div class="main-left--site">
      <h5 class="main-left--title">
        <span>站点信息</span>
        <i class="iconfont icon-zhandian"></i>
      </h5>
      <p class="main-left--subtitle">
        <span>文章数目：</span>
        <span>46 篇</span>
      </p>
      <p class="main-left--subtitle">
        <span>最近动态：</span>
        <span>今天</span>
      </p>
      <p class="main-left--subtitle">
        <span>上线时间：</span>
        <span>439天</span>
      </p>
      <p class="main-left--subtitle">
        <span>当前版本：</span>
        <span>v1.0.2</span>
      </p>
    </div>
  </div>
</div></div>
      <div id="main-container" class="main-container">


  <link rel="stylesheet" href="/css/partial/article.css" />

<div class="article-container">
  <div class="article">
    <h1 class="article-title">Kubernetes组件学习</h1>
    <div class="article-info">
      <div class="article-info--item">
        <div class="article-info--info">
          
          <div class="article-info--categories">
            <span>分类：</span>
            
          </div>
          
          
          <div class="article-info--tags">
            <span>标签：</span>
            <a class="tag-link" href="/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/" rel="tag">-云原生</a>
          </div>
          
          <p class="article-info--date">日期：2024-06-02 12:08:26</p>
        </div>
        <img src="https://haowallpaper.com/link/common/file/getCroppingImg/2e0af7de62ed4210b634c867367c10ae2e0af7de62ed4210b634c867367c10ae" alt="" class="article-cover">
      </div>
    </div>
    <article class="article-content markdown-body">
      <p><img src="https://img.beyourself.org.cn/logo.jpg?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_25,text_6KW_5a6J5Y2D6ZSL5LqR6K6h566X,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10#id=yvLnZ&originHeight=500&originWidth=889&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<h1 id="Kubernetes-容器编排"><a href="#Kubernetes-容器编排" class="headerlink" title="Kubernetes 容器编排"></a>Kubernetes 容器编排</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><h3 id="知识扩展"><a href="#知识扩展" class="headerlink" title="知识扩展"></a>知识扩展</h3><p>早在 2015 年 5 月，Kubernetes 在 Google 上的搜索热度就已经超过了 Mesos 和 Docker Swarm，从那儿之后更是一路飙升，将对手甩开了十几条街,容器编排引擎领域的三足鼎立时代结束。</p>
<p><img src="https://img.beyourself.org.cn/abc/1584845556532.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_22,text_6KW_5a6J5Y2D6ZSL5LqR6K6h566X,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10#id=HExkv&originHeight=210&originWidth=760&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">目前，AWS、Azure、Google、阿里云、腾讯云等主流公有云提供的是基于  Kubernetes  的容器服务；Rancher、CoreOS、IBM、Mirantis、Oracle、Red Hat、VMWare 等无数厂商也在大力研发和推广基于  Kubernetes 的容器 CaaS 或 PaaS 产品。可以说，Kubernetes 是当前容器行业最炙手可热的明星。</span><br><span class="line"></span><br><span class="line">Google 的数据中心里运行着超过 20 亿个容器，而且 Google 十年前就开始使用容器技术。最初，Google 开发了一个叫 Borg 的系统（现在命名为 Omega）来调度如此庞大数量的容器和工作负载。在积累了这么多年的经验后，Google 决定重写这个容器管理系统，并将其贡献到开源社区，让全世界都能受益。这个项目就是 Kubernetes。简单的讲，Kubernetes 是 Google Omega 的开源版本。跟很多基础设施领域先有工程实践、后有方法论的发展路线不同，Kubernetes 项目的理论基础则要比工程实践走得靠前得多，这当然要归功于 Google 公司在 2015 年 4 月发布的 Borg 论文了。Borg 系统，一直以来都被誉为 Google 公司内部最强大的&quot;秘密武器&quot;。虽然略显夸张，但这个说法倒不算是吹牛。因为，相比于 Spanner、BigTable 等相对上层的项目，Borg 要承担的责任，是承载 Google 公司整个基础设施的核心依赖。在 Google 公司已经公开发表的基础设施体系论文中，Borg 项目当仁不让地位居整个基础设施技术栈的最底层。</span><br><span class="line"></span><br><span class="line">由于这样的定位，Borg 可以说是 Google 最不可能开源的一个项目。而幸运地是，得益于 Docker 项目和容器技术的风靡，它却终于得以以另一种方式与开源社区见面，这个方式就是 Kubernetes 项目。</span><br><span class="line"></span><br><span class="line">所以，相比于&quot;小打小闹&quot;的 Docker 公司、&quot;旧瓶装新酒&quot;的 Mesos 社区，Kubernetes 项目从一开始就比较幸运地站上了一个他人难以企及的高度：在它的成长阶段，这个项目每一个核心特性的提出，几乎都脱胎于 Borg/Omega 系统的设计与经验。更重要的是，这些特性在开源社区落地的过程中，又在整个社区的合力之下得到了极大的改进，修复了很多当年遗留在 Borg 体系中的缺陷和问题。</span><br><span class="line"></span><br><span class="line">所以，尽管在发布之初被批评是&quot;曲高和寡&quot;，但是在逐渐觉察到 Docker 技术栈的&quot;稚嫩&quot;和 Mesos 社区的&quot;老迈&quot;之后，这个社区很快就明白了：k8s 项目在 Borg 体系的指导下，体现出了一种独有的&quot;先进性&quot;与&quot;完备性&quot;，而这些特质才是一个基础设施领域开源项目赖以生存的核心价值。</span><br></pre></td></tr></table></figure>

<h3 id="什么是编排"><a href="#什么是编排" class="headerlink" title="什么是编排"></a>什么是编排</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">一个正在运行的 Linux 容器，可以分成两部分看待：</span><br><span class="line"></span><br><span class="line">1. 容器的静态视图</span><br><span class="line">一组联合挂载在 /var/lib/docker/aufs/mnt 上的 rootfs，这一部分称为&quot;容器镜像&quot;（Container Image）</span><br><span class="line"></span><br><span class="line">2. 容器的动态视图</span><br><span class="line">一个由 Namespace+Cgroups 构成的隔离环境，这一部分称为&quot;容器运行时&quot;（Container Runtime）</span><br><span class="line"></span><br><span class="line"> 作为一名开发者，其实并不关心容器运行时的差异。在整个&quot;开发 - 测试 - 发布&quot;的流程中，真正承载着容器信息进行传递的，是容器镜像，而不是容器运行时。这正是容器技术圈在 Docker 项目成功后不久，就迅速走向了&quot;容器编排&quot;这个&quot;上层建筑&quot;的主要原因：作为一家云服务商或者基础设施提供商，我只要能够将用户提交的 Docker 镜像以容器的方式运行起来，就能成为这个非常热闹的容器生态图上的一个承载点，从而将整个容器技术栈上的价值，沉淀在我的这个节点上。</span><br><span class="line"></span><br><span class="line"> 更重要的是，只要从这个承载点向 Docker 镜像制作者和使用者方向回溯，整条路径上的各个服务节点，比如 CI/CD、监控、安全、网络、存储等等，都有可以发挥和盈利的余地。这个逻辑，正是所有云计算提供商如此热衷于容器技术的重要原因：通过容器镜像，它们可以和潜在用户（即，开发者）直接关联起来。</span><br><span class="line"></span><br><span class="line"> 从一个开发者和单一的容器镜像，到无数开发者和庞大的容器集群，容器技术实现了从&quot;容器&quot;到&quot;容器云&quot;的飞跃，标志着它真正得到了市场和生态的认可。这样，容器就从一个开发者手里的小工具，一跃成为了云计算领域的绝对主角；而能够定义容器组织和管理规范的&quot;容器编排&quot;技术，则当仁不让地坐上了容器技术领域的&quot;头把交椅&quot;。</span><br><span class="line"></span><br><span class="line">最具代表性的容器编排工具：	</span><br><span class="line">1. Docker 公司的 Compose+Swarm 组合</span><br><span class="line">2. Google 与 RedHat 公司共同主导的 Kubernetes 项目</span><br></pre></td></tr></table></figure>

<h2 id="容器编排之战"><a href="#容器编排之战" class="headerlink" title="容器编排之战"></a>容器编排之战</h2><h3 id="一-kubernetes简要概述"><a href="#一-kubernetes简要概述" class="headerlink" title="一. kubernetes简要概述"></a>一. kubernetes简要概述</h3><p>  Kubernetes 是用于自动部署, 扩展和管理容器化应用程序的开源系统. 它将组成应用程序的容器组合成逻辑单元, 以便于管理和服务发现. Kubernetes 源自<a target="_blank" rel="noopener" href="http://queue.acm.org/detail.cfm?id=2898444">Google 15 年生产环境的运维经验</a>, 同时凝聚了社区的最佳创意和实践</p>
<p>  在容器化应用的大趋势下, 越来越多的单体应用被划分成了无数个微小的服务, 从之前的裸机部署单体服务到现今使用容器承载服务运行; 容器越来越贴近研发、运维、测试等IT职能部门, 越来越多的人也渐渐转向了云进行开发, 而不再单独强调单体一致性问题; 这一切的功臣就是 — 容器;</p>
<p>  其实容器这个产物, 早在Linux内核诞生后就已经有了它, 那时候程序员创建一个容器需要编写代码, 调用Linux内核中的Cgroup 和 NameSpace用作资源限制, 而创建出来的容器所观看到的底层文件系统却是和宿主机是同一套文件系统, 导致在容器中操作文件就相当于更改了宿主机的文件系统, 这就大大暴露了容器的应用性差的特性; 后来横空出世的docker解决了这个问题, docker创造了一个叫做镜像的东西, 并将其进行分层, 使得用户在启动容器的时候将镜像拷贝一份读写层挂载到容器中, 让容器看到的底层文件系统只是镜像中的内容从而避免了上述的问题, 镜像带来的好处远不止这一个, 比如在生产、测试、研发三个环境中总是因为环境不统一造成上线后的应用很快崩溃的局面, 而有了镜像就不需要考虑环境的问题, 因为所有的服务运行在容器中, 而提供给容器运行的底层文件系统是镜像, 只要使用的是同一个镜像那么不管在什么环境中, 都是一样的效果, 这对于运维、测试、研发三类人而言就能彻底的和应用运行环境要考虑的事情甩手拜拜了; 而docker这个引擎又提供了很多易于使用的控制容器的指令, 大大降低了程序员操作的难度, 又提供相应的镜像和存储镜像的公共仓库, 使得容器技术飞速发展起来;</p>
<p>  就在容器飞速发展的第五年里, Google发布了容器编排系统 kubernetes, 它解决了容器在多个宿主机间调度的问题, 同时提供可靠的API接口来控制容器的运行, 并时刻保持容器启动的状态, 融合了故障自愈、服务发现等新功能; 从而占领了容器市场的高地; 从此容器圈内又向容器编排发起了猛烈的攻势;</p>
<h4 id="1-1-kubernetes-功能简介"><a href="#1-1-kubernetes-功能简介" class="headerlink" title="1.1 kubernetes 功能简介"></a>1.1 kubernetes 功能简介</h4><ul>
<li><strong>服务发现和负载均衡</strong><br>  Kubernetes 可以使用 DNS 名称或自己的 IP 地址公开容器, 如果进入容器的流量很大,  Kubernetes 可以负载均衡并分配网络流量, 从而使部署稳定. 常用的DNS插件为coreDNS, 用作服务发现和集群中容器通讯; 负载均衡器常使用集群内的service资源进行对外暴露服务, 同时也提供ingress插件接口对外暴露服务 </li>
<li><strong>存储编排</strong><br>  Kubernetes 允许你自动挂载你选择的存储系统, 例如本地存储、公共云提供商等. 对于集群内部的应用有时会需要持久化数据, 这时容器如果被删除数据也会随之消失, 所以一个稳定的外部存储集群就显得很重要了; 常见的对k8s提供存储能力的集群有: heketi + gluesterfs 、Rook + Ceph、阿里云OSS等, 配合集群内的storageclass可直接向存储集群申请存储空间 </li>
<li><strong>自动部署和回滚</strong><br>  你可以使用 Kubernetes 描述已部署容器的所需状态, 它可以以受控的速率将实际状态 更改为期望状态. 例如, 你可以自动化 Kubernetes 来为你的部署创建新容器,  删除现有容器并将它们的所有资源用于新容器. 控制k8s集群中容器的状态大多数时候都会采用 yaml 资源配置清单的形式, 方便记忆也易于识别 </li>
<li><strong>自动完成装箱计算</strong><br>  Kubernetes 允许你指定每个容器所需 CPU 和内存（RAM）.  当容器指定了资源请求时, Kubernetes 可以做出更好的决策来管理容器的资源. 这就与Linux操作系统中的资源限额有关系了, 有些容器在接收高并发访问的时候, 往往会无限制的占用宿主机资源, 从而导致其他服务容器争抢不到应有的资源进行运行和服务, 从而导致大面积瘫痪 </li>
<li><strong>自我修复</strong><br>  Kubernetes 重新启动失败的容器、替换容器、杀死不响应用户定义的 运行状况检查的容器, 并且在准备好服务之前不将其通告给客户端. 在创建pod的时候, 只有当设置在pod中的探针全部探测正常后才会将pod连接到集群内网络中对外进行服务, 否则将通过监控告警给运维人员; 同样的对于k8s中的容器会受到kubelet和kube-apiserver的双重管理, kubelet上报容器运行状态, api-server向etcd中请求期望状态, 比较后让其达到期望的状态, 从而保证其功能&#x2F;服务容器永久保持在线 </li>
<li><strong>密钥与配置管理</strong><br>  Kubernetes 允许你存储和管理敏感信息, 例如密码、OAuth 令牌和 ssh 密钥.  你可以在不重建容器镜像的情况下部署和更新密钥和应用程序配置, 也无需在堆栈配置中暴露密钥. 对于无状态应用(exam: nginx)的配置文件, 可以使用k8s中的configmap资源进行存储, 但对于密码和某些私密信息而言就可以使用secret资源进行存储, 从而避免频繁更改和私密信息泄漏的风险</li>
</ul>
<h4 id="1-2-Kubernetes架构及组件"><a href="#1-2-Kubernetes架构及组件" class="headerlink" title="1.2 Kubernetes架构及组件"></a>1.2 Kubernetes架构及组件</h4><p><img src="https://img.beyourself.org.cn/abc/60a04343d0ae4a2594c69fa5022bd7b21a5465c5.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_22,text_6KW_5a6J5Y2D6ZSL5LqR6K6h566X,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10#id=izYwG&originHeight=350&originWidth=759&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p>  一个 Kubernetes 集群由一组被称作节点的机器组成。这些节点上运行 Kubernetes 所管理的容器化应用。集群具有至少一个工作节点。工作节点托管作为应用负载的组件的 Pod 。控制平面管理集群中的工作节点和 Pod 。 为集群提供故障转移和高可用性，这些控制平面一般跨多主机运行，集群跨多个节点运行。</p>
<ul>
<li><p><strong>kube-apiserver</strong><br>API 服务器是 Kubernetes <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/glossary/?all=true#term-control-plane">控制面</a>的组件， 该组件公开了 Kubernetes API。 API 服务器是 Kubernetes 控制面的前端。Kubernetes API 服务器的主要实现是 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/command-line-tools-reference/kube-apiserver/">kube-apiserver</a>。 kube-apiserver 设计上考虑了水平伸缩，也就是说，它可通过部署多个实例进行伸缩。 你可以运行 kube-apiserver 的多个实例，并在这些实例之间平衡流量。 </p>
</li>
<li><p><strong>etcd</strong><br>etcd 是兼具一致性和高可用性的键值数据库，可以作为保存 Kubernetes 所有集群数据的后台数据库。你的 Kubernetes 集群的 etcd 数据库通常需要有个备份计划。要了解 etcd 更深层次的信息，请参考 <a target="_blank" rel="noopener" href="https://etcd.io/docs/">etcd 文档</a>。 </p>
</li>
<li><p><strong>kube-scheduler</strong><br>控制平面组件，负责监视新创建的、未指定运行<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/architecture/nodes/">节点（node）</a>的 <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/">Pods</a>，选择节点让 Pod 在上面运行。调度决策考虑的因素包括单个 Pod 和 Pod 集合的资源需求、硬件&#x2F;软件&#x2F;策略约束、亲和性和反亲和性规范、数据位置、工作负载间的干扰和最后时限。 </p>
<blockquote>
<p>&#x2F;etc&#x2F;kubernetes&#x2F;manifests&#x2F;kube-scheduler.yaml 中添加参数</p>
<ul>
<li>–node-monitor-grace-period&#x3D;10s：该参数指定了 Node 节点的监控宽限期（Grace Period），即在节点变为不可用之前的时间间隔。在这段时间内，调度器不会将 Pod 从该节点上驱逐，以便给应用程序一些时间来完成正在进行的任务并正常关闭。在这个例子中，宽限期为 10 秒。</li>
<li>–node-monitor-period&#x3D;3s：该参数指定了 Node 节点的监控周期，即调度器检查节点状态的时间间隔。在这个例子中，监控周期为 3 秒。</li>
<li>–node-startup-grace-period&#x3D;20s：该参数指定了新节点加入集群后的启动宽限期（Grace Period），即在节点完全准备好之前的时间间隔。在这段时间内，调度器不会将 Pod 调度到该节点上，以便给节点一些时间来初始化和准备运行 Pod。在这个例子中，启动宽限期为 20 秒。</li>
<li>–pod-eviction-timeout&#x3D;10s：该参数指定了 Pod 的驱逐超时时间，即在调度器决定驱逐一个 Pod 之后，等待该 Pod 关闭的时间间隔。如果 Pod 在这段时间内没有正常关闭，调度器将强制终止该 Pod。在这个例子中，驱逐超时时间为 10 秒。</li>
</ul>
</blockquote>
</li>
<li><p><strong>kube-controller-manager</strong><br>运行<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/architecture/controller/">控制器</a>进程的控制平面组件。从逻辑上讲，每个<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/architecture/controller/">控制器</a>都是一个单独的进程， 但是为了降低复杂性，它们都被编译到同一个可执行文件，并在一个进程中运行。这些控制器包括： </p>
<ul>
<li>节点控制器（Node Controller）：负责在节点出现故障时进行通知和响应 </li>
<li>任务控制器（Job controller）：监测代表一次性任务的 Job 对象，然后创建 Pods 来运行这些任务直至完成 </li>
<li>端点控制器（Endpoints Controller）：填充端点（Endpoints）对象（即加入 Service 与 Pod） </li>
<li>服务帐户和令牌控制器（Service Account &amp; Token Controllers）：为新的命名空间创建默认帐户和 API 访问令牌</li>
</ul>
</li>
<li><p><strong>cloud-controller-manager</strong><br>云控制器管理器是指嵌入特定云的控制逻辑的 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/glossary/?all=true#term-control-plane">控制平面</a>组件。 云控制器管理器使得你可以将你的集群连接到云提供商的 API 之上， 并将与该云平台交互的组件同与你的集群交互的组件分离开来。<code>cloud-controller-manager</code> 仅运行特定于云平台的控制回路。 如果你在自己的环境中运行 Kubernetes，或者在本地计算机中运行学习环境， 所部署的环境中不需要云控制器管理器。与 <code>kube-controller-manager</code> 类似，<code>cloud-controller-manager</code> 将若干逻辑上独立的 控制回路组合到同一个可执行文件中，供你以同一进程的方式运行。 你可以对其执行水平扩容（运行不止一个副本）以提升性能或者增强容错能力。下面的控制器都包含对云平台驱动的依赖： </p>
<ul>
<li>节点控制器（Node Controller）：用于在节点终止响应后检查云提供商以确定节点是否已被删除 </li>
<li>路由控制器（Route Controller）：用于在底层云基础架构中设置路由 </li>
<li>服务控制器（Service Controller）：用于创建、更新和删除云提供商负载均衡器</li>
</ul>
</li>
<li><p><strong>Node 组件</strong>: 节点组件在每个节点上运行，维护运行的 Pod 并提供 Kubernetes 运行环境。 </p>
</li>
<li><p><strong>kubelet</strong><br>一个在集群中每个<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/architecture/nodes/">节点（node）</a>上运行的代理。 它保证<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/overview/what-is-kubernetes/#why-containers">容器（containers）</a>都 运行在 <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/">Pod</a> 中。kubelet 接收一组通过各类机制提供给它的 PodSpecs，确保这些 PodSpecs 中描述的容器处于运行状态且健康。 kubelet 不会管理不是由 Kubernetes 创建的容器。 </p>
</li>
<li><p><strong>kube-proxy</strong><br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/command-line-tools-reference/kube-proxy/">kube-proxy</a> 是集群中每个节点上运行的网络代理， 实现 Kubernetes <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/services-networking/service/">服务（Service）</a> 概念的一部分。kube-proxy 维护节点上的网络规则。这些网络规则允许从集群内部或外部的网络会话与 Pod 进行网络通信。如果操作系统提供了数据包过滤层并可用的话，kube-proxy 会通过它来实现网络规则。否则， kube-proxy 仅转发流量本身。 </p>
</li>
<li><p><strong>容器运行时（Container Runtime）</strong><br>容器运行环境是负责运行容器的软件。Kubernetes 支持容器运行时，例如 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/kubectl/docker-cli-to-kubectl/">Docker</a>、 <a target="_blank" rel="noopener" href="https://containerd.io/docs/">containerd</a>、<a target="_blank" rel="noopener" href="https://cri-o.io/#what-is-cri-o">CRI-O</a> 以及 <a href="be1bd03ebab19a7d55df83d8e90bedda">Kubernetes CRI (容器运行环境接口)</a> 的其他任何实现。 </p>
</li>
<li><p><strong>插件（Addons）</strong><br>插件使用 Kubernetes 资源实现集群功能。 因为这些插件提供集群级别的功能，插件中命名空间域的资源属于 <code>kube-system</code> 命名空间。下面描述众多插件中的几种。有关可用插件的完整列表，请参见 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/cluster-administration/addons/">插件（Addons）</a>。 </p>
<ul>
<li><strong>DNS</strong><br>尽管其他插件都并非严格意义上的必需组件，但几乎所有 Kubernetes 集群都应该 有<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/services-networking/dns-pod-service/">集群 DNS</a>， 因为很多示例都需要 DNS 服务。集群 DNS 是一个 DNS 服务器，和环境中的其他 DNS 服务器一起工作，它为 Kubernetes 服务提供 DNS 记录。Kubernetes 启动的容器自动将此 DNS 服务器包含在其 DNS 搜索列表中。 </li>
<li><strong>Web 界面（仪表盘）</strong><br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/access-application-cluster/web-ui-dashboard/">Dashboard</a> 是 Kubernetes 集群的通用的、基于 Web 的用户界面。 它使用户可以管理集群中运行的应用程序以及集群本身并进行故障排除。 </li>
<li><strong>容器资源监控</strong><br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/debug/debug-cluster/resource-usage-monitoring/">容器资源监控</a> 将关于容器的一些常见的时间序列度量值保存到一个集中的数据库中，并提供用于浏览这些数据的界面。 </li>
<li><strong>集群层面日志</strong><br><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/cluster-administration/logging/">集群层面日志</a> 机制负责将容器的日志数据 保存到一个集中的日志存储中，该存储能够提供搜索和浏览接口 ELK&#x2F;Loki+grafana</li>
</ul>
</li>
</ul>
<h4 id="1-3-Kubernetes核心概念"><a href="#1-3-Kubernetes核心概念" class="headerlink" title="1.3 Kubernetes核心概念"></a>1.3 Kubernetes核心概念</h4><p>Master</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Master节点主要负责资源调度(Scheduler)，控制副本(Replication Controller)，和提供统一访问集群的入口(API Server)。---核心节点也是管理节点</span><br></pre></td></tr></table></figure>

<p>Node</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Node是Kubernetes集群架构中运行Pod的服务节点（亦叫agent或minion）。Node是Kubernetes集群操作的单元，用来承载被分配Pod的运行，是Pod运行的宿主机，由Master管理，并汇报容器状态给Master，当Node节点宕机（NotReady状态）时，该节点上运行的Pod会被自动地转移到其他节点上。</span><br><span class="line"></span><br><span class="line">Kubelet组件---Kubelet会从API Server接收Pod的创建请求，启动和停止容器，监控容器运行状态并汇报给Kubernetes API Server。</span><br><span class="line"></span><br><span class="line">KuberProxy组件--实现将客户端请求流量转发到内部的pod资源。</span><br><span class="line"></span><br><span class="line">Docker Engine（docker）组件，Docker引擎，负责本机的容器创建和管理工作；</span><br></pre></td></tr></table></figure>

<p>Node IP</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Node节点的IP地址，是Kubernetes集群中每个节点的物理网卡的IP地址，是真是存在的物理网络，所有属于这个网络的服务器之间都能通过这个网络直接通信；</span><br></pre></td></tr></table></figure>

<p>Pod</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Pod直译是豆荚，可以把容器想像成豆荚里的豆子，把一个或多个关系紧密的豆子包在一起就是豆荚（一个Pod）。处于同一个Pod中的容器共享同样的存储空间（Volume，卷或存储卷）、网络命名空间IP地址和Port端口。在k8s中我们不会直接操作容器，而是把容器包装成Pod再进行管理</span><br><span class="line"></span><br><span class="line">运行于Node节点上，Pod是k8s进行创建、调度和管理的最小单位.一个Pod可以包含一个容器或者多个相关容器。</span><br><span class="line">　</span><br><span class="line">Pod 就是 k8s 世界里的&quot;应用&quot;；而一个应用，可以由多个容器组成。</span><br></pre></td></tr></table></figure>

<p><img src="https://img.beyourself.org.cn/abc/1584847102040.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_22,text_6KW_5a6J5Y2D6ZSL5LqR6K6h566X,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10#id=YCq2O&originHeight=649&originWidth=757&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p>pause容器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">每个Pod中都有一个pause容器，pause容器做为Pod的网络接入点，Pod中其他的容器会使用容器映射模式启动并接入到这个pause容器。</span><br></pre></td></tr></table></figure>

<p>Pod IP</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Pod的IP地址，是Docker Engine根据docker0网桥的IP地址段进行分配的，通常是一个虚拟的二层网络，位于不同Node上的Pod能够彼此通信，需要通过Pod IP所在的虚拟二层网络进行通信，而真实的TCP流量则是通过Node IP所在的物理网卡流出的</span><br></pre></td></tr></table></figure>

<p><img src="https://img.beyourself.org.cn/abc/1584847199864.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_21,text_6KW_5a6J5Y2D6ZSL5LqR6K6h566X,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10#id=z3o1l&originHeight=522&originWidth=740&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p>资源限制：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">每个Pod可以设置限额的计算机资源有CPU和Memory；</span><br></pre></td></tr></table></figure>

<p><img src="https://img.beyourself.org.cn/abc/1584847373945.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_22,text_6KW_5a6J5Y2D6ZSL5LqR6K6h566X,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10#id=JSIr3&originHeight=541&originWidth=759&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p>Pod Volume:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Docker Volume对应Kubernetes中的Pod Volume；数间共享数据。</span><br></pre></td></tr></table></figure>

<p>Event</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">是一个事件记录，记录了事件最早产生的时间、最后重复时间、重复次数、发起者、类型，以及导致此事件的原因等信息。Event通常关联到具体资源对象上，是排查故障的重要参考信息</span><br></pre></td></tr></table></figure>

<p>Endpoint（pod IP+容器Port）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">标识服务进程的访问点；</span><br></pre></td></tr></table></figure>

<p>ReplicaSet</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">确保任何指定的Pod副本数量，并提供声明式更新等功能。</span><br></pre></td></tr></table></figure>

<p>Deployment</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Deployment是一个更高层次的API对象，它管理ReplicaSets和Pod，并提供声明式更新等功能。</span><br><span class="line"></span><br><span class="line">官方建议使用Deployment管理ReplicaSets，而不是直接使用ReplicaSets，这就意味着可能永远不需要直接操作ReplicaSet对象，因此Deployment将会是使用最频繁的资源对象。</span><br></pre></td></tr></table></figure>

<p>RC-Replication Controller</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Replication  Controller用来管理Pod的副本，保证集群中存在指定数量的Pod副本。集群中副本的数量大于指定数量，则会停止指定数量之外的多余pod数量，反之，则会启动少于指定数量个数的容器，保证数量不变。Replication  Controller是实现弹性伸缩、动态扩容和滚动升级的核心。</span><br></pre></td></tr></table></figure>

<p>Service</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Service定义了Pod的逻辑集合和访问该集合的策略，是真实服务的抽象。它有暴露内部服务的端口到外网的能力。Service提供了一个统一的服务访问入口以及服务代理和发现机制，用户不需要了解后台Pod是如何运行。</span><br><span class="line"></span><br><span class="line">一个service定义了访问pod的方式，就像单个固定的IP地址和与其相对应的DNS名之间的关系。</span><br><span class="line">service分为两种ip地址:</span><br><span class="line">一种是对内的叫Cluster IP ，一种是对外的叫external ip：</span><br><span class="line">实现对外ip方式分为：</span><br><span class="line">1.NodePort：通过每个 Node 上的 IP 和内部服务暴露出来的静态端口实现暴露服务。</span><br><span class="line">2.LoadBalancer：使用云提供商的负载均衡器.</span><br><span class="line">3.ingress:使用负载均衡软件实现负载均衡，向外部暴露服务。</span><br></pre></td></tr></table></figure>

<p><img src="https://img.beyourself.org.cn/abc/1584847713520.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_22,text_6KW_5a6J5Y2D6ZSL5LqR6K6h566X,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10#id=VPjaJ&originHeight=443&originWidth=760&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p>Cluster IP</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Service的IP地址,特性：</span><br><span class="line">专门给集群内部资源访问的。在k8s集群里面部署的容器，用内部的容器可以访问这个ip地址。但是集群外面的机器不能访问。</span><br><span class="line"></span><br><span class="line">1.无法被Ping通；</span><br><span class="line">2.Node IP、Pod IP、Cluster IP之间的通信，采用的是Kubernetes自己设计的一种编程方式的特殊的路由规则，与IP路由有很大的不同</span><br></pre></td></tr></table></figure>

<p>Label—标签与Selectors—选择器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">　Kubernetes中的任意API对象都是通过Label进行标识，Label的实质是一系列的K/V键值对。Label是Replication Controller和Service运行的基础，二者通过Label来进行关联Node上运行的Pod。</span><br><span class="line">　比如，你可能创建了一个&quot;tier&quot;和“app”标签，通过Label（tier=frontend, app=myapp）来标记前端Pod容器，使用 Label（tier=backend, app=myapp）标记后台Pod。然后可以使用 Selectors 选择带有特定Label的Pod，并且将 Service 或者 Replication Controller 应用到上面。</span><br><span class="line"></span><br><span class="line">一个label是一个被附加到资源上的键/值对，譬如附加到一个Pod上，为它传递一个用户自定的并且可识别的属性。</span><br></pre></td></tr></table></figure>

<p>注：Node、Pod、Replication Controller和Service等都可以看作是一种”资源对象”，几乎所有的资源对象都可以通过Kubernetes提供的kubectl工具执行增、删、改、查等操作并将其保存在etcd中持久化存储。</p>
<h3 id="二-常用镜像库"><a href="#二-常用镜像库" class="headerlink" title="二. 常用镜像库"></a>二. 常用镜像库</h3><ol>
<li><strong>官方 Docker Hub 仓库</strong>:<ul>
<li>官方 Kubernetes 镜像通常存放在 Docker Hub 上。地址通常是 **k8s.gcr.io&#x2F;&lt;镜像名&gt;:&lt;标签&gt;**，但实际上你需要通过 Docker Hub 访问这些镜像，例如 **docker pull k8s.gcr.io&#x2F;&lt;镜像名&gt;:&lt;标签&gt;**。</li>
</ul>
</li>
<li><strong>阿里云容器镜像服务</strong>（Aliyun Docker Registry）:<ul>
<li>阿里云的 Kubernetes 镜像仓库地址格式一般为 **registry.cn-hangzhou.aliyuncs.com&#x2F;google_containers&#x2F;&lt;镜像名&gt;:&lt;标签&gt;**。</li>
<li>例如，对于 kube-apiserver 镜像，地址可能是 **registry.cn-hangzhou.aliyuncs.com&#x2F;google_containers&#x2F;kube-apiserver:&lt;标签&gt;**。</li>
</ul>
</li>
<li><strong>腾讯云容器镜像服务</strong>（Tencent Cloud Container Registry）:<ul>
<li>腾讯云的 Kubernetes 镜像仓库地址格式可能类似于 **ccr.ccs.tencentyun.com&#x2F;tke-market&#x2F;&lt;镜像名&gt;:&lt;标签&gt;**。</li>
</ul>
</li>
<li><strong>华为云容器镜像服务</strong>（Huawei Cloud Container Registry）:<ul>
<li>华为云的 Kubernetes 镜像仓库地址格式可能类似于 **swr.cn-north-4.myhuaweicloud.com&#x2F;&lt;镜像名&gt;:&lt;标签&gt;**。</li>
</ul>
</li>
</ol>
<h3 id="三-集群部署方式"><a href="#三-集群部署方式" class="headerlink" title="三.集群部署方式"></a>三.集群部署方式</h3><ul>
<li>方式1. minikube</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Minikube是一个工具，可以在本地快速运行一个单点的Kubernetes，尝试Kubernetes或日常开发的用户使用。不能用于生产环境。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">官方地址：https</span>:<span class="string">//kubernetes.io/docs/setup/minikube/</span></span><br></pre></td></tr></table></figure>

<ul>
<li>方式2. kubeadm</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Kubeadm也是一个工具，提供kubeadm</span> <span class="string">init和kubeadm join，用于快速部署Kubernetes集群。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">官方地址：https</span>:<span class="string">//kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm/</span></span><br></pre></td></tr></table></figure>

<ul>
<li>方式3. 直接使用epel-release yum源，缺点就是版本较低 1.5 </li>
<li>方式4. 二进制包</li>
</ul>
<h3 id="四-Kubeadm-方式部署集群"><a href="#四-Kubeadm-方式部署集群" class="headerlink" title="四.Kubeadm 方式部署集群"></a>四.Kubeadm 方式部署集群</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">kubeadm部署官方文档</a><br><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/">kubeadm部署k8s高可用集群的官方文档</a><br>主节点CPU核数必须是 ≥2核且内存要求必须≥2G，否则k8s无法启动</p>
</blockquote>
<table>
<thead>
<tr>
<th>主机名</th>
<th>地址</th>
<th>角色</th>
<th>配置</th>
</tr>
</thead>
<tbody><tr>
<td>kub-k8s-master1</td>
<td>192.168.75.100</td>
<td>主节点</td>
<td>2核2G 50G</td>
</tr>
<tr>
<td>kub-k8s-master2</td>
<td>192.168.75.101</td>
<td>主节点</td>
<td>2核2G 50G</td>
</tr>
<tr>
<td>kub-k8s-master3</td>
<td>192.168.75.102</td>
<td>主节点</td>
<td>2核2G 50G</td>
</tr>
<tr>
<td>kub-k8s-node1</td>
<td>192.168.75.103</td>
<td>工作节点</td>
<td>1核2G 50G</td>
</tr>
<tr>
<td>kub-k8s-node2</td>
<td>192.168.75.104</td>
<td>工作节点&#x2F;haproxy</td>
<td>1核2G 50G</td>
</tr>
</tbody></table>
<h4 id="4-1-安装docker-集群"><a href="#4-1-安装docker-集群" class="headerlink" title="4.1 安装docker[集群]"></a>4.1 安装docker[集群]</h4><blockquote>
<p>过程请查看docker安装部分</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 一键安装docker脚本</span></span><br><span class="line">curl -L https://gitea.beyourself.org.cn/newrain001/shell-project/raw/branch/master/os/get-docker-latest.sh | sh</span><br></pre></td></tr></table></figure>
<h4 id="4-2-获取镜像-集群"><a href="#4-2-获取镜像-集群" class="headerlink" title="4.2 获取镜像[集群]"></a>4.2 获取镜像[集群]</h4><blockquote>
<p>获取镜像版本方法</p>
</blockquote>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kubeadm</span> <span class="string">config images list --kubernetes-version=&lt;版本号&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>谷歌镜像[由于国内网络原因，无法下载，后续将采用阿里云镜像代替]</p>
</blockquote>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 官方，不采用</span></span><br><span class="line"><span class="attr">docker</span> <span class="string">pull k8s.gcr.io/kube-apiserver:v1.22.0</span></span><br><span class="line"><span class="attr">docker</span> <span class="string">pull k8s.gcr.io/kube-proxy:v1.22.0</span></span><br><span class="line"><span class="attr">docker</span> <span class="string">pull k8s.gcr.io/kube-controller-manager:v1.22.0</span></span><br><span class="line"><span class="attr">docker</span> <span class="string">pull k8s.gcr.io/kube-scheduler:v1.22.0</span></span><br><span class="line"><span class="attr">docker</span> <span class="string">pull k8s.gcr.io/etcd:3.5.0-0</span></span><br><span class="line"><span class="attr">docker</span> <span class="string">pull k8s.gcr.io/pause:3.5</span></span><br><span class="line"><span class="attr">docker</span> <span class="string">pull k8s.gcr.io/coredns/coredns:v1.8.4</span></span><br></pre></td></tr></table></figure>

<h4 id="4-3-阿里仓库下载-集群"><a href="#4-3-阿里仓库下载-集群" class="headerlink" title="4.3 阿里仓库下载[集群]"></a>4.3 阿里仓库下载[集群]</h4><blockquote>
<p>在线下载</p>
</blockquote>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">docker</span> <span class="string">pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.22.0</span></span><br><span class="line"><span class="attr">docker</span> <span class="string">pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.22.0</span></span><br><span class="line"><span class="attr">docker</span> <span class="string">pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.22.0</span></span><br><span class="line"><span class="attr">docker</span> <span class="string">pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.22.0</span></span><br><span class="line"><span class="attr">docker</span> <span class="string">pull registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.8.4</span></span><br><span class="line"><span class="attr">docker</span> <span class="string">pull registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.0-0</span></span><br><span class="line"><span class="attr">docker</span> <span class="string">pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.5</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 下载完了之后需要将aliyun下载下来的所有镜像打成k8s.gcr.io/kube-controller-manager:v1.22.0这样的tag</span></span><br><span class="line"><span class="attr">docker</span> <span class="string">tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.22.0 k8s.gcr.io/kube-controller-manager:v1.22.0</span></span><br><span class="line"><span class="attr">docker</span> <span class="string">tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.22.0 k8s.gcr.io/kube-proxy:v1.22.0</span></span><br><span class="line"><span class="attr">docker</span> <span class="string">tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.22.0 k8s.gcr.io/kube-apiserver:v1.22.0</span></span><br><span class="line"><span class="attr">docker</span> <span class="string">tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.22.0 k8s.gcr.io/kube-scheduler:v1.22.0</span></span><br><span class="line"><span class="attr">docker</span> <span class="string">tag registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.8.4 k8s.gcr.io/coredns/coredns:v1.8.4</span></span><br><span class="line"><span class="attr">docker</span> <span class="string">tag registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.0-0 k8s.gcr.io/etcd:3.5.0-0</span></span><br><span class="line"><span class="attr">docker</span> <span class="string">tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.5 k8s.gcr.io/pause:3.5	</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 可以清理掉aliyun的镜像标签</span></span><br><span class="line"><span class="attr">docker</span> <span class="string">rmi -f `docker images --format &#123;&#123;.Repository&#125;&#125;:&#123;&#123;.Tag&#125;&#125; | grep aliyun`</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>离线安装[适用于当前网络环境不佳的情况]</p>
</blockquote>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@localhost</span> <span class="string">~]# ls</span></span><br><span class="line"><span class="attr">anaconda-ks.cfg</span>  <span class="string">application.tar.xz  kube-1.22.0.tar.xz</span></span><br><span class="line"><span class="attr">[root@localhost</span> <span class="string">~]# tar xvf application.tar.xz  </span></span><br><span class="line"><span class="attr">[root@localhost</span> <span class="string">~]# tar xvf kube-1.22.0.tar.xz </span></span><br><span class="line"><span class="attr">[root@localhost</span> <span class="string">~]# cd application/images &amp;&amp; ls *.tar | xargs -i docker load -i &#123;&#125; &amp;&amp; cd ../.. &amp;&amp; cd kube-1.22.0/images &amp;&amp; ls *.tar | xargs -i docker load -i &#123;&#125; &amp;&amp; cd ../.. &amp;&amp; docker images | wc -l</span></span><br></pre></td></tr></table></figure>
<h4 id="4-4-集群部署-集群"><a href="#4-4-集群部署-集群" class="headerlink" title="4.4 集群部署[集群]"></a>4.4 集群部署[集群]</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt;&gt; /etc/hosts &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">192.168.75.100   kub-k8s-master1</span></span><br><span class="line"><span class="string">192.168.75.101   kub-k8s-master2</span></span><br><span class="line"><span class="string">192.168.75.102   kub-k8s-master3</span></span><br><span class="line"><span class="string">192.168.75.103   kub-k8s-node1</span></span><br><span class="line"><span class="string">192.168.75.104   kub-k8s-node2</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">制作本地解析，修改主机名。相互解析</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="4-5-集群环境配置-集群"><a href="#4-5-集群环境配置-集群" class="headerlink" title="4.5 集群环境配置[集群]"></a>4.5 集群环境配置[集群]</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">1.关闭防火墙：</span></span><br><span class="line"><span class="comment"># systemctl disable firewalld --now</span></span><br><span class="line"></span><br><span class="line"><span class="attr">2.禁用SELinux：</span></span><br><span class="line"><span class="comment"># setenforce 0</span></span><br><span class="line"></span><br><span class="line"><span class="attr">3.编辑文件/etc/selinux/config，将SELINUX修改为disabled，如下：</span></span><br><span class="line"><span class="comment"># sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/&#x27; /etc/sysconfig/selinux</span></span><br><span class="line"><span class="attr">SELINUX</span>=<span class="string">disabled</span></span><br><span class="line"></span><br><span class="line"><span class="attr">4.时间同步</span></span><br><span class="line"><span class="attr">vim</span> <span class="string">/etc/chrony.conf</span></span><br><span class="line"><span class="comment"># 注释下面配置</span></span><br><span class="line"><span class="comment">#pool 2.centos.pool.ntp.org iburst</span></span><br><span class="line"><span class="comment"># 新增下面配置</span></span><br><span class="line"><span class="attr">server</span> <span class="string">ntp6.aliyun.com iburst</span></span><br><span class="line"><span class="attr">systemctl</span> <span class="string">restart chronyd </span></span><br><span class="line"><span class="attr">systemctl</span> <span class="string">enable chronyd </span></span><br><span class="line"></span><br><span class="line"><span class="attr">5.配置静态ip</span></span><br><span class="line"><span class="comment"># vim /etc/NetworkManager/system-connections/ens160.nmconnection </span></span><br><span class="line"><span class="attr">[connection]</span></span><br><span class="line"><span class="attr">id</span>=<span class="string">ens160</span></span><br><span class="line"><span class="attr">uuid</span>=<span class="string">986b8e1f-ffad-3908-8d9f-6220da0233b5</span></span><br><span class="line"><span class="attr">type</span>=<span class="string">ethernet</span></span><br><span class="line"><span class="attr">autoconnect-priority</span>=<span class="string">-999</span></span><br><span class="line"><span class="attr">interface-name</span>=<span class="string">ens160</span></span><br><span class="line"><span class="attr">timestamp</span>=<span class="string">1715007304</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[ethernet]</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[ipv4]</span></span><br><span class="line"><span class="attr">method</span>=<span class="string">manual</span></span><br><span class="line"><span class="attr">addresses</span>=<span class="string">10.36.176.184/24;10.36.176.1</span></span><br><span class="line"><span class="attr">dns</span>=<span class="string">223.5.5.5;223.6.6.6</span></span><br><span class="line"><span class="attr">[ipv6]</span></span><br><span class="line"><span class="attr">addr-gen-mode</span>=<span class="string">eui64</span></span><br><span class="line"><span class="attr">method</span>=<span class="string">auto</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[proxy]</span></span><br></pre></td></tr></table></figure>

<h4 id="4-6-关闭系统Swap-集群"><a href="#4-6-关闭系统Swap-集群" class="headerlink" title="4.6 关闭系统Swap[集群]"></a>4.6 关闭系统Swap[集群]</h4><p>Kubernetes 1.8开始要求关闭系统的Swap，如果不关闭，默认配置下kubelet将无法启动。</p>
<ul>
<li>方法一: 通过kubelet的启动参数–fail-swap-on&#x3D;false更改这个限制。</li>
<li>方法二: 关闭系统的Swap。</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">1.关闭swap分区</span></span><br><span class="line"><span class="comment"># swapoff -a</span></span><br><span class="line"><span class="attr">修改/etc/fstab文件，注释掉SWAP的自动挂载，使用free</span> <span class="string">-m确认swap已经关闭。</span></span><br><span class="line"><span class="attr">2.注释掉swap分区：</span></span><br><span class="line"><span class="comment"># sed -i &#x27;s/.*swap.*/#&amp;/&#x27; /etc/fstab</span></span><br><span class="line"><span class="comment"># free -m</span></span><br><span class="line">             <span class="attr">total</span>        <span class="string">used        free      shared  buff/cache   available</span></span><br><span class="line"><span class="attr">Mem</span>:           <span class="string">3935         144        3415           8         375        3518</span></span><br><span class="line"><span class="attr">Swap</span>:             <span class="string">0           0           0</span></span><br></pre></td></tr></table></figure>

<h4 id="4-7-安装Kubeadm包-集群"><a href="#4-7-安装Kubeadm包-集群" class="headerlink" title="4.7 安装Kubeadm包[集群]"></a>4.7 安装Kubeadm包[集群]</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">配置官方源[需翻墙]</span></span><br><span class="line"><span class="comment"># cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span></span><br><span class="line"><span class="attr">[kubernetes]</span></span><br><span class="line"><span class="attr">name</span>=<span class="string">Kubernetes</span></span><br><span class="line"><span class="attr">baseurl</span>=<span class="string">https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64/</span></span><br><span class="line"><span class="attr">enabled</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">gpgcheck</span>=<span class="string">0</span></span><br><span class="line"><span class="attr">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="attr">配置阿里云源</span></span><br><span class="line"><span class="attr">cat</span> <span class="string">&lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span></span><br><span class="line"><span class="attr">[kubernetes]</span></span><br><span class="line"><span class="attr">name</span>=<span class="string">Kubernetes</span></span><br><span class="line"><span class="attr">baseurl</span>=<span class="string">https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span></span><br><span class="line"><span class="attr">enabled</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">gpgcheck</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">repo_gpgcheck</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">gpgkey</span>=<span class="string">https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span></span><br><span class="line"><span class="attr">EOF</span></span><br></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">所有节点：</span></span><br><span class="line"></span><br><span class="line"><span class="attr">1.安装依赖包及常用软件包</span></span><br><span class="line"><span class="comment"># yum install -y conntrack ipvsadm ipset iptables sysstat libseccomp net-tools git iproute bash-completion tree bridge-utils unzip bind-utils gcc</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">2.安装对应版本</span></span><br><span class="line"><span class="comment"># yum install -y kubelet-1.22.0-0.x86_64 kubeadm-1.22.0-0.x86_64 kubectl-1.22.0-0.x86_64</span></span><br><span class="line"></span><br><span class="line"><span class="attr">3.加载ipvs相关内核模块</span></span><br><span class="line"><span class="comment">    # cat &lt;&lt;EOF &gt; /etc/modules-load.d/kubernetes.conf</span></span><br><span class="line">    <span class="attr">ip_vs</span></span><br><span class="line">    <span class="attr">ip_vs_lc</span></span><br><span class="line">    <span class="attr">ip_vs_wlc</span></span><br><span class="line">    <span class="attr">ip_vs_rr</span></span><br><span class="line">    <span class="attr">ip_vs_wrr</span></span><br><span class="line">    <span class="attr">ip_vs_lblc</span></span><br><span class="line">    <span class="attr">ip_vs_lblcr</span></span><br><span class="line">    <span class="attr">ip_vs_dh</span></span><br><span class="line">    <span class="attr">ip_vs_sh</span></span><br><span class="line">    <span class="attr">ip_vs_nq</span></span><br><span class="line">    <span class="attr">ip_vs_sed</span></span><br><span class="line">    <span class="attr">ip_vs_ftp</span></span><br><span class="line">    <span class="attr">ip_vs_sh</span></span><br><span class="line">    <span class="attr">nf_conntrack_ipv4</span></span><br><span class="line">    <span class="attr">ip_tables</span></span><br><span class="line">    <span class="attr">ip_set</span></span><br><span class="line">    <span class="attr">xt_set</span></span><br><span class="line">    <span class="attr">ipt_set</span></span><br><span class="line">    <span class="attr">ipt_rpfilter</span></span><br><span class="line">    <span class="attr">ipt_REJECT</span></span><br><span class="line">    <span class="attr">ipip</span></span><br><span class="line">    <span class="attr">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="attr">4.配置：</span></span><br><span class="line"><span class="attr">配置转发相关参数，否则可能会出错</span></span><br><span class="line"><span class="comment"># cat &lt;&lt;EOF &gt;  /etc/sysctl.d/k8s.conf</span></span><br><span class="line"><span class="attr">net.bridge.bridge-nf-call-iptables</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">net.bridge.bridge-nf-call-ip6tables</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">net.ipv4.ip_forward</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">net.ipv4.tcp_tw_recycle</span>=<span class="string">0</span></span><br><span class="line"><span class="attr">vm.swappiness</span>=<span class="string">0</span></span><br><span class="line"><span class="attr">vm.overcommit_memory</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">vm.panic_on_oom</span>=<span class="string">0</span></span><br><span class="line"><span class="attr">fs.inotify.max_user_instances</span>=<span class="string">8192</span></span><br><span class="line"><span class="attr">fs.inotify.max_user_watches</span>=<span class="string">1048576</span></span><br><span class="line"><span class="attr">fs.file-max</span>=<span class="string">52706963</span></span><br><span class="line"><span class="attr">fs.nr_open</span>=<span class="string">52706963</span></span><br><span class="line"><span class="attr">net.ipv6.conf.all.disable_ipv6</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">net.netfilter.nf_conntrack_max</span>=<span class="string">2310720</span></span><br><span class="line"><span class="attr">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="attr">5.使配置生效（重启最好）</span></span><br><span class="line"><span class="comment"># sysctl --system</span></span><br><span class="line"></span><br><span class="line"><span class="attr">6.如果net.bridge.bridge-nf-call-iptables报错，加载br_netfilter模块</span></span><br><span class="line"><span class="comment"># modprobe br_netfilter</span></span><br><span class="line"><span class="comment"># modprobe ip_conntrack</span></span><br><span class="line"><span class="comment"># sysctl -p /etc/sysctl.d/k8s.conf</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">7.查看是否加载成功</span></span><br><span class="line"><span class="comment"># lsmod | grep ip_vs</span></span><br></pre></td></tr></table></figure>

<h4 id="4-8-配置启动kubelet-集群"><a href="#4-8-配置启动kubelet-集群" class="headerlink" title="4.8 配置启动kubelet[集群]"></a>4.8 配置启动kubelet[集群]</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">1.配置kubelet使用pause镜像</span></span><br><span class="line"><span class="attr">获取docker的cgroups</span></span><br><span class="line"><span class="attr">配置变量：</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">~]# DOCKER_CGROUPS=`docker info |grep &#x27;Cgroup&#x27; | awk &#x27; NR==1 &#123;print $3&#125;&#x27;`</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">~]# echo $DOCKER_CGROUPS</span></span><br><span class="line"><span class="attr">systemd</span></span><br><span class="line"></span><br><span class="line"><span class="attr">2.配置kubelet的cgroups</span></span><br><span class="line"><span class="comment"># cat &gt;/etc/sysconfig/kubelet&lt;&lt;EOF</span></span><br><span class="line"><span class="attr">KUBELET_EXTRA_ARGS</span>=<span class="string">&quot;--cgroup-driver=$DOCKER_CGROUPS --pod-infra-container-image=k8s.gcr.io/pause:3.5&quot;</span></span><br><span class="line"><span class="attr">EOF</span></span><br></pre></td></tr></table></figure>

<img src="https://guangxipengyuyan.oss-cn-guangzhou.aliyuncs.com/image-20240813000632943.png" alt="image-20240813000632943" style="zoom:50%;" />

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">启动</span></span><br><span class="line"><span class="comment"># systemctl daemon-reload</span></span><br><span class="line"><span class="comment"># systemctl enable kubelet &amp;&amp; systemctl restart kubelet</span></span><br><span class="line"><span class="attr">在这里使用</span> <span class="string"># systemctl status kubelet，你会发现报错误信息；</span></span><br><span class="line"></span><br><span class="line"><span class="attr">10月</span> <span class="string">11 00:26:43 node1 systemd[1]: kubelet.service: main process exited, code=exited, status=255/n/a</span></span><br><span class="line"><span class="attr">10月</span> <span class="string">11 00:26:43 node1 systemd[1]: Unit kubelet.service entered failed state.</span></span><br><span class="line"><span class="attr">10月</span> <span class="string">11 00:26:43 node1 systemd[1]: kubelet.service failed.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">运行</span> <span class="string"># journalctl -xefu kubelet 命令查看systemd日志才发现，真正的错误是：</span></span><br><span class="line">    <span class="attr">unable</span> <span class="string">to load client CA file /etc/kubernetes/pki/ca.crt: open /etc/kubernetes/pki/ca.crt: no such file or directory</span></span><br><span class="line"><span class="comment">#这个错误在运行kubeadm init 生成CA证书后会被自动解决，此处可先忽略。</span></span><br><span class="line"><span class="comment">#简单地说就是在kubeadm init 之前kubelet会不断重启。</span></span><br></pre></td></tr></table></figure>

<h4 id="4-9-配置master节点-master"><a href="#4-9-配置master节点-master" class="headerlink" title="4.9 配置master节点[master]"></a>4.9 配置master节点[master]</h4><h5 id="4-9-1-安装haproxy"><a href="#4-9-1-安装haproxy" class="headerlink" title="4.9.1 安装haproxy"></a>4.9.1 安装haproxy</h5><blockquote>
<p>也可以选择lvs、nginx等</p>
</blockquote>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@localhost</span> <span class="string">~]# yum install -y haproxy</span></span><br><span class="line"><span class="attr">[root@localhost</span> <span class="string">~]# vim /etc/haproxy/haproxy.cfg </span></span><br><span class="line"><span class="comment"># Global settings section</span></span><br><span class="line"><span class="attr">global</span></span><br><span class="line">    <span class="attr">log</span>         <span class="string">127.0.0.1 local2     # 设置日志记录，使用本地系统日志服务</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">chroot</span>      <span class="string">/var/lib/haproxy     # 设置 HAProxy 的运行环境为隔离模式</span></span><br><span class="line">    <span class="attr">pidfile</span>     <span class="string">/var/run/haproxy.pid # 指定 HAProxy 进程的 PID 文件位置</span></span><br><span class="line">    <span class="attr">maxconn</span>     <span class="string">4000                 # 设置最大并发连接数</span></span><br><span class="line">    <span class="attr">user</span>        <span class="string">haproxy              # 指定 HAProxy 运行的用户</span></span><br><span class="line">    <span class="attr">group</span>       <span class="string">haproxy              # 指定 HAProxy 运行的用户组</span></span><br><span class="line">    <span class="attr">daemon</span>                           <span class="string"># 以守护进程模式运行</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    # 开启状态统计的 UNIX 套接字</span></span><br><span class="line">    <span class="attr">stats</span> <span class="string">socket /var/lib/haproxy/stats</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># Default settings section</span></span><br><span class="line"><span class="attr">defaults</span></span><br><span class="line">    <span class="attr">mode</span>                    <span class="string">tcp      # 默认使用 TCP 模式，适用于非 HTTP 流量</span></span><br><span class="line">    <span class="attr">log</span>                     <span class="string">global   # 使用全局日志设置</span></span><br><span class="line">    <span class="attr">option</span>                  <span class="string">tcplog   # 开启 TCP 日志记录</span></span><br><span class="line">    <span class="attr">timeout</span> <span class="string">connect         10s      # 连接超时设置</span></span><br><span class="line">    <span class="attr">timeout</span> <span class="string">client          1m       # 客户端超时</span></span><br><span class="line">    <span class="attr">timeout</span> <span class="string">server          1m       # 服务器超时</span></span><br><span class="line">    <span class="attr">retries</span>                 <span class="string">3        # 连接重试次数</span></span><br><span class="line"></span><br><span class="line"><span class="attr">frontend</span> <span class="string">stats</span></span><br><span class="line">    <span class="attr">mode</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">bind</span> <span class="string">*:9000                # 监听 9000 端口，用于访问统计页面</span></span><br><span class="line">    <span class="attr">stats</span> <span class="string">enable               # 启用统计报告</span></span><br><span class="line">    <span class="attr">stats</span> <span class="string">uri /haproxy_stats   # 设置统计报告的 URI，可以通过 http://&lt;your-ip&gt;:9000/haproxy_stats 访问</span></span><br><span class="line">    <span class="attr">stats</span> <span class="string">realm HAProxy\ Statistics  # 设置认证弹窗的标题</span></span><br><span class="line">    <span class="attr">stats</span> <span class="string">auth admin:password  # 设置访问统计页面的用户名和密码，这里为 admin 和 password，您应该设置一个更安全的密码</span></span><br><span class="line">    <span class="attr">stats</span> <span class="string">admin if TRUE        # 如果设置为 TRUE，允许在页面上进行管理操作</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># Kubernetes Master 节点的前端配置</span></span><br><span class="line"><span class="attr">frontend</span> <span class="string">kubernetes-frontend</span></span><br><span class="line">    <span class="attr">bind</span> <span class="string">*:6443                        # 监听 8443 端口，用于 Kubernetes API</span></span><br><span class="line">    <span class="attr">default_backend</span> <span class="string">kubernetes-backend # 默认后端设置为 kubernetes-backend</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># Kubernetes Master 节点的后端配置</span></span><br><span class="line"><span class="attr">backend</span> <span class="string">kubernetes-backend</span></span><br><span class="line">    <span class="attr">balance</span> <span class="string">roundrobin                 # 使用轮询算法进行负载均衡</span></span><br><span class="line">    <span class="attr">option</span> <span class="string">tcp-check                   # 开启 TCP 检查以检测服务器健康状态</span></span><br><span class="line">    <span class="attr">server</span> <span class="string">master1 kub-k8s-master1:6443 check # Kubernetes Master 节点1</span></span><br><span class="line">    <span class="attr">server</span> <span class="string">master2 kub-k8s-master2:6443 check # Kubernetes Master 节点2（第一次要把这个注释）</span></span><br><span class="line">    <span class="attr">server</span> <span class="string">master3 kub-k8s-master3:6443 check # Kubernetes Master 节点3（第一次要把这个注释）</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[root@localhost</span> <span class="string">~]# systemctl start haproxy</span></span><br></pre></td></tr></table></figure>
<p><img src="https://guangxipengyuyan.oss-cn-guangzhou.aliyuncs.com/image-20240813084638528.png" alt="image-20240813084638528"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/29063483/1705910315391-d3050f02-40c9-4401-aef7-29e8257fcf9d.png#averageHue=%23f7edea&clientId=ub5dfea4b-421e-4&from=paste&height=859&id=u8f8e05c9&originHeight=1471&originWidth=2560&originalType=binary&ratio=1.712499976158142&rotation=0&showTitle=false&size=208734&status=done&style=none&taskId=uff110167-5ca3-4c00-9e42-7c03a72bd61&title=&width=1494.890531761149" alt="image.png"></p>
<h5 id="4-9-2-初始化集群"><a href="#4-9-2-初始化集群" class="headerlink" title="4.9.2 初始化集群"></a>4.9.2 初始化集群</h5><ul>
<li>注意： 如果只有一个master节点，以下参数可以不加<ul>
<li>–control-plane-endpoint  </li>
<li>–apiserver-cert-extra-sans  </li>
<li>–upload-certs</li>
</ul>
</li>
<li>添加  –image-repository&#x3D;registry.aliyuncs.com&#x2F;google_containers  可以拉取阿里云的镜像</li>
<li>如果初始化语句执行错误，可以使用kubeadm reset –force 重置后再次执行</li>
<li><img src="https://guangxipengyuyan.oss-cn-guangzhou.aliyuncs.com/image-20240813003449583.png" alt="image-20240813003449583"><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">运行初始化过程如下：</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master1</span> <span class="string">~]# kubeadm init --kubernetes-version=v1.22.0 --control-plane-endpoint &quot;192.168.75.104:8443&quot; --pod-network-cidr=10.244.0.0/16 --apiserver-advertise-address=192.168.75.100 --apiserver-cert-extra-sans=192.168.75.104,192.168.75.100,192.168.75.101,192.168.75.102 --upload-certs</span></span><br><span class="line"><span class="attr">[init]</span> <span class="string">Using Kubernetes version: v1.22.0</span></span><br><span class="line"><span class="attr">[preflight]</span> <span class="string">Running pre-flight checks</span></span><br><span class="line">        <span class="attr">[WARNING</span> <span class="string">SystemVerification]: this Docker version is not on the list of validated versions: 25.0.0. Latest validated version: 20.10</span></span><br><span class="line"><span class="attr">[preflight]</span> <span class="string">Pulling images required for setting up a Kubernetes cluster</span></span><br><span class="line"><span class="attr">[preflight]</span> <span class="string">This might take a minute or two, depending on the speed of your internet connection</span></span><br><span class="line"><span class="attr">[preflight]</span> <span class="string">You can also perform this action in beforehand using &#x27;kubeadm config images pull&#x27;</span></span><br><span class="line"><span class="attr">[certs]</span> <span class="string">Using certificateDir folder &quot;/etc/kubernetes/pki&quot;</span></span><br><span class="line"><span class="attr">[certs]</span> <span class="string">Generating &quot;ca&quot; certificate and key</span></span><br><span class="line"><span class="attr">[certs]</span> <span class="string">Generating &quot;apiserver&quot; certificate and key</span></span><br><span class="line"><span class="attr">[certs]</span> <span class="string">apiserver serving cert is signed for DNS names [kub-k8s-master1 kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [10.96.0.1 192.168.75.100 192.168.75.104 192.168.75.101 192.168.75.102]</span></span><br><span class="line"><span class="attr">[certs]</span> <span class="string">Generating &quot;apiserver-kubelet-client&quot; certificate and key</span></span><br><span class="line"><span class="attr">[certs]</span> <span class="string">Generating &quot;front-proxy-ca&quot; certificate and key</span></span><br><span class="line"><span class="attr">[certs]</span> <span class="string">Generating &quot;front-proxy-client&quot; certificate and key</span></span><br><span class="line"><span class="attr">[certs]</span> <span class="string">Generating &quot;etcd/ca&quot; certificate and key</span></span><br><span class="line"><span class="attr">[certs]</span> <span class="string">Generating &quot;etcd/server&quot; certificate and key</span></span><br><span class="line"><span class="attr">[certs]</span> <span class="string">etcd/server serving cert is signed for DNS names [kub-k8s-master1 localhost] and IPs [192.168.75.100 127.0.0.1 ::1]</span></span><br><span class="line"><span class="attr">[certs]</span> <span class="string">Generating &quot;etcd/peer&quot; certificate and key</span></span><br><span class="line"><span class="attr">[certs]</span> <span class="string">etcd/peer serving cert is signed for DNS names [kub-k8s-master1 localhost] and IPs [192.168.75.100 127.0.0.1 ::1]</span></span><br><span class="line"><span class="attr">[certs]</span> <span class="string">Generating &quot;etcd/healthcheck-client&quot; certificate and key</span></span><br><span class="line"><span class="attr">[certs]</span> <span class="string">Generating &quot;apiserver-etcd-client&quot; certificate and key</span></span><br><span class="line"><span class="attr">[certs]</span> <span class="string">Generating &quot;sa&quot; key and public key</span></span><br><span class="line"><span class="attr">[kubeconfig]</span> <span class="string">Using kubeconfig folder &quot;/etc/kubernetes&quot;</span></span><br><span class="line"><span class="attr">[endpoint]</span> <span class="string">WARNING: port specified in controlPlaneEndpoint overrides bindPort in the controlplane address</span></span><br><span class="line"><span class="attr">[kubeconfig]</span> <span class="string">Writing &quot;admin.conf&quot; kubeconfig file</span></span><br><span class="line"><span class="attr">[endpoint]</span> <span class="string">WARNING: port specified in controlPlaneEndpoint overrides bindPort in the controlplane address</span></span><br><span class="line"><span class="attr">[kubeconfig]</span> <span class="string">Writing &quot;kubelet.conf&quot; kubeconfig file</span></span><br><span class="line"><span class="attr">[endpoint]</span> <span class="string">WARNING: port specified in controlPlaneEndpoint overrides bindPort in the controlplane address</span></span><br><span class="line"><span class="attr">[kubeconfig]</span> <span class="string">Writing &quot;controller-manager.conf&quot; kubeconfig file</span></span><br><span class="line"><span class="attr">[endpoint]</span> <span class="string">WARNING: port specified in controlPlaneEndpoint overrides bindPort in the controlplane address</span></span><br><span class="line"><span class="attr">[kubeconfig]</span> <span class="string">Writing &quot;scheduler.conf&quot; kubeconfig file</span></span><br><span class="line"><span class="attr">[kubelet-start]</span> <span class="string">Writing kubelet environment file with flags to file &quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span></span><br><span class="line"><span class="attr">[kubelet-start]</span> <span class="string">Writing kubelet configuration to file &quot;/var/lib/kubelet/config.yaml&quot;</span></span><br><span class="line"><span class="attr">[kubelet-start]</span> <span class="string">Starting the kubelet</span></span><br><span class="line"><span class="attr">[control-plane]</span> <span class="string">Using manifest folder &quot;/etc/kubernetes/manifests&quot;</span></span><br><span class="line"><span class="attr">[control-plane]</span> <span class="string">Creating static Pod manifest for &quot;kube-apiserver&quot;</span></span><br><span class="line"><span class="attr">[control-plane]</span> <span class="string">Creating static Pod manifest for &quot;kube-controller-manager&quot;</span></span><br><span class="line"><span class="attr">[control-plane]</span> <span class="string">Creating static Pod manifest for &quot;kube-scheduler&quot;</span></span><br><span class="line"><span class="attr">[etcd]</span> <span class="string">Creating static Pod manifest for local etcd in &quot;/etc/kubernetes/manifests&quot;</span></span><br><span class="line"><span class="attr">[wait-control-plane]</span> <span class="string">Waiting for the kubelet to boot up the control plane as static Pods from directory &quot;/etc/kubernetes/manifests&quot;. This can take up to 4m0s</span></span><br><span class="line"><span class="attr">[apiclient]</span> <span class="string">All control plane components are healthy after 5.013483 seconds</span></span><br><span class="line"><span class="attr">[upload-config]</span> <span class="string">Storing the configuration used in ConfigMap &quot;kubeadm-config&quot; in the &quot;kube-system&quot; Namespace</span></span><br><span class="line"><span class="attr">[kubelet]</span> <span class="string">Creating a ConfigMap &quot;kubelet-config-1.22&quot; in namespace kube-system with the configuration for the kubelets in the cluster</span></span><br><span class="line"><span class="attr">[upload-certs]</span> <span class="string">Storing the certificates in Secret &quot;kubeadm-certs&quot; in the &quot;kube-system&quot; Namespace</span></span><br><span class="line"><span class="attr">[upload-certs]</span> <span class="string">Using certificate key:</span></span><br><span class="line"><span class="attr">1d241f4bdfbfb37444221397b0e3522c8096f54d4b301cc49b69ddc735bee9c1</span></span><br><span class="line"><span class="attr">[mark-control-plane]</span> <span class="string">Marking the node kub-k8s-master1 as control-plane by adding the labels: [node-role.kubernetes.io/master(deprecated) node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers]</span></span><br><span class="line"><span class="attr">[mark-control-plane]</span> <span class="string">Marking the node kub-k8s-master1 as control-plane by adding the taints [node-role.kubernetes.io/master:NoSchedule]</span></span><br><span class="line"><span class="attr">[bootstrap-token]</span> <span class="string">Using token: hxyvvg.bzvpv2h1ag28g79m</span></span><br><span class="line"><span class="attr">[bootstrap-token]</span> <span class="string">Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles</span></span><br><span class="line"><span class="attr">[bootstrap-token]</span> <span class="string">configured RBAC rules to allow Node Bootstrap tokens to get nodes</span></span><br><span class="line"><span class="attr">[bootstrap-token]</span> <span class="string">configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials</span></span><br><span class="line"><span class="attr">[bootstrap-token]</span> <span class="string">configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token</span></span><br><span class="line"><span class="attr">[bootstrap-token]</span> <span class="string">configured RBAC rules to allow certificate rotation for all node client certificates in the cluster</span></span><br><span class="line"><span class="attr">[bootstrap-token]</span> <span class="string">Creating the &quot;cluster-info&quot; ConfigMap in the &quot;kube-public&quot; namespace</span></span><br><span class="line"><span class="attr">[kubelet-finalize]</span> <span class="string">Updating &quot;/etc/kubernetes/kubelet.conf&quot; to point to a rotatable kubelet client certificate and key</span></span><br><span class="line"><span class="attr">[addons]</span> <span class="string">Applied essential addon: CoreDNS</span></span><br><span class="line"><span class="attr">[endpoint]</span> <span class="string">WARNING: port specified in controlPlaneEndpoint overrides bindPort in the controlplane address</span></span><br><span class="line"><span class="attr">[addons]</span> <span class="string">Applied essential addon: kube-proxy</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Your</span> <span class="string">Kubernetes control-plane has initialized successfully!</span></span><br><span class="line"></span><br><span class="line"><span class="attr">To</span> <span class="string">start using your cluster, you need to run the following as a regular user:</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">mkdir</span> <span class="string">-p $HOME/.kube</span></span><br><span class="line">  <span class="attr">sudo</span> <span class="string">cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span></span><br><span class="line">  <span class="attr">sudo</span> <span class="string">chown $(id -u):$(id -g) $HOME/.kube/config</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Alternatively,</span> <span class="string">if you are the root user, you can run:</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">export</span> <span class="string">KUBECONFIG=/etc/kubernetes/admin.conf</span></span><br><span class="line"></span><br><span class="line"><span class="attr">You</span> <span class="string">should now deploy a pod network to the cluster.</span></span><br><span class="line"><span class="attr">Run</span> <span class="string">&quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:</span></span><br><span class="line">  <span class="attr">https</span>:<span class="string">//kubernetes.io/docs/concepts/cluster-administration/addons/</span></span><br><span class="line"></span><br><span class="line"><span class="attr">You</span> <span class="string">can now join any number of the control-plane node running the following command on each as root:</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">kubeadm</span> <span class="string">join 192.168.75.104:8443 --token hxyvvg.bzvpv2h1ag28g79m \</span></span><br><span class="line"><span class="string">        --discovery-token-ca-cert-hash sha256:19a140207276157f923d7f962b5a51e93006f282180b439ad5c1390acaea722c \</span></span><br><span class="line"><span class="string">        --control-plane --certificate-key 1d241f4bdfbfb37444221397b0e3522c8096f54d4b301cc49b69ddc735bee9c1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Please</span> <span class="string">note that the certificate-key gives access to cluster sensitive data, keep it secret!</span></span><br><span class="line"><span class="attr">As</span> <span class="string">a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use</span></span><br><span class="line"><span class="attr">&quot;kubeadm</span> <span class="string">init phase upload-certs --upload-certs&quot; to reload certs afterward.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Then</span> <span class="string">you can join any number of worker nodes by running the following on each as root:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">kubeadm</span> <span class="string">join 192.168.75.104:8443 --token hxyvvg.bzvpv2h1ag28g79m \</span></span><br><span class="line"><span class="string">        --discovery-token-ca-cert-hash sha256:19a140207276157f923d7f962b5a51e93006f282180b439ad5c1390acaea722c </span></span><br></pre></td></tr></table></figure>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">参数解析：</span></span><br><span class="line"><span class="attr">1.</span> <span class="string">--kubernetes-version=v1.22.0</span></span><br><span class="line"><span class="attr">指定了</span> <span class="string">Kubernetes 的版本号</span></span><br><span class="line"></span><br><span class="line"><span class="attr">2.</span> <span class="string">--control-plane-endpoint &quot;192.168.75.104:8443&quot;</span></span><br><span class="line"><span class="attr">这指定了控制平面的访问端点。在多主节点（多控制平面）的集群中，它通常是一个负载均衡器的地址。在这个例子中，端点是</span> <span class="string">192.168.75.104，使用的端口是 8443。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">3.</span> <span class="string">--pod-network-cidr=10.244.0.0/16</span></span><br><span class="line"><span class="attr">定义了</span> <span class="string">Pod 网络的 CIDR（Classless Inter-Domain Routing）范围。在这里，Pod 网络的地址空间是 10.244.0.0/16。这个参数通常需要与所选择的 CNI（容器网络接口）插件相匹配，比如 Flannel 通常会使用这个 CIDR。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">4.</span> <span class="string">--apiserver-advertise-address=192.168.75.100</span></span><br><span class="line"><span class="attr">指定了</span> <span class="string">kube-apiserver 广播的 IP 地址。在这个例子中，API 服务器将通过 192.168.75.100 这个 IP 地址进行广播。通常这个地址是该节点的 IP 地址。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">5.</span> <span class="string">--apiserver-cert-extra-sans=192.168.75.104,192.168.75.100,192.168.75.101,192.168.75.102</span></span><br><span class="line"><span class="attr">这个参数指定了</span> <span class="string">API 服务器证书中的额外的 SAN（Subject Alternative Names）。SAN 是证书中的一个字段，允许证书绑定多个域名或 IP 地址。在这里，你指定了多个 IP 地址（192.168.75.104、192.168.75.100、192.168.75.101、192.168.75.102），确保这些 IP 都可以使用该证书进行访问。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">6.</span> <span class="string">--upload-certs</span></span><br><span class="line"><span class="attr">这个参数表示在初始化时上传控制平面的证书，以便后续的其他控制平面节点可以共享这些证书。这个对于多主节点的集群来说非常重要，因为每个控制平面节点都需要访问相同的证书。</span></span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">上面记录了完成的初始化输出的内容，根据输出的内容基本上可以看出手动初始化安装一个Kubernetes集群所需要的关键步骤。</span></span><br><span class="line"><span class="attr">其中有以下关键内容：</span></span><br><span class="line">    <span class="attr">[kubelet]</span> <span class="string">生成kubelet的配置文件”/var/lib/kubelet/config.yaml”</span></span><br><span class="line">    <span class="attr">[certificates]生成相关的各种证书</span></span><br><span class="line">    <span class="attr">[kubeconfig]生成相关的kubeconfig文件</span></span><br><span class="line">    <span class="attr">[bootstraptoken]生成token记录下来，后边使用kubeadm</span> <span class="string">join往集群中添加节点时会用到</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">配置使用kubectl</span></span><br><span class="line"><span class="attr">如下操作在master节点操作</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master1</span> <span class="string">~]# rm -rf $HOME/.kube</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master1</span> <span class="string">~]# mkdir -p $HOME/.kube</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master1</span> <span class="string">~]# cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master1</span> <span class="string">~]# chown $(id -u):$(id -g) $HOME/.kube/config</span></span><br><span class="line"></span><br><span class="line"><span class="attr">查看node节点</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">~]# kubectl get nodes</span></span><br><span class="line"><span class="attr">NAME</span>         <span class="string">STATUS     ROLES    AGE     VERSION</span></span><br><span class="line"><span class="attr">k8s-master</span>   <span class="string">NotReady   master   2m41s   v1.22.0</span></span><br></pre></td></tr></table></figure>

<h4 id="4-10-配置使用网络插件-master"><a href="#4-10-配置使用网络插件-master" class="headerlink" title="4.10 配置使用网络插件[master]"></a>4.10 配置使用网络插件[master]</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 版本差异 https://projectcalico.docs.tigera.io/archive/v3.22/getting-started/kubernetes/requirements</span></span><br><span class="line"><span class="comment">#&gt; 部署calico网络插件</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master1</span> <span class="string">~]# curl -L https://docs.projectcalico.org/v3.22/manifests/calico.yaml -O</span></span><br><span class="line"><span class="comment"># 修改 文件</span></span><br><span class="line"><span class="attr">4205</span>             <span class="string">- name: IP_AUTODETECTION_METHOD</span></span><br><span class="line"><span class="attr">4206</span>               <span class="string">value: &quot;interface=ens33&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[root@kub-k8s-master1</span> <span class="string">~]# kubectl apply -f  calico.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[root@kub-k8s-master1</span> <span class="string">~]# kubectl get pod -A -w</span></span><br><span class="line"><span class="attr">NAMESPACE</span>     <span class="string">NAME                                       READY   STATUS    RESTARTS       AGE</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">calico-kube-controllers-7c87c5f9b8-q2vth   1/1     Running   0              36s</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">calico-node-5th7f                          1/1     Running   0              36s</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">calico-node-g996t                          1/1     Running   0              36s</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">calico-node-n94v5                          1/1     Running   0              36s</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">calico-node-qjmth                          1/1     Running   0              36s</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">calico-node-rfzf7                          1/1     Running   0              36s</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">coredns-78fcd69978-5sg7p                   1/1     Running   0              11m</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">coredns-78fcd69978-btws4                   1/1     Running   0              11m</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">etcd-kub-k8s-master1                       1/1     Running   6              11m</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">etcd-kub-k8s-master2                       1/1     Running   0              10m</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">etcd-kub-k8s-master3                       1/1     Running   0              10m</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">kube-apiserver-kub-k8s-master1             1/1     Running   6              11m</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">kube-apiserver-kub-k8s-master2             1/1     Running   2 (10m ago)    11m</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">kube-apiserver-kub-k8s-master3             1/1     Running   0              10m</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">kube-controller-manager-kub-k8s-master1    1/1     Running   10 (10m ago)   11m</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">kube-controller-manager-kub-k8s-master2    1/1     Running   0              11m</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">kube-controller-manager-kub-k8s-master3    1/1     Running   0              10m</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">kube-proxy-4bsm2                           1/1     Running   0              8m2s</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">kube-proxy-bb5rd                           1/1     Running   0              10m</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">kube-proxy-bnxj5                           1/1     Running   0              8m4s</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">kube-proxy-cfm5m                           1/1     Running   0              11m</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">kube-proxy-smhd6                           1/1     Running   0              11m</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">kube-scheduler-kub-k8s-master1             1/1     Running   10 (10m ago)   11m</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">kube-scheduler-kub-k8s-master2             1/1     Running   0              11m</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">kube-scheduler-kub-k8s-master3             1/1     Running   0              10m</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>calico 原理</p>
</blockquote>
<blockquote>
<ul>
<li>基于 BGP 的网络连接：Calico 使用 BGP 协议在 Kubernetes 集群中的节点之间建立网络连接。每个节点运行一个 Calico 代理【daemonset】，该代理负责与其他节点建立 BGP 连接，并将容器的网络流量路由到正确的目的地。</li>
<li>网络策略：Calico 提供了一种灵活的网络策略模型，允许定义容器之间的访问规则。可以使用标签来标识容器，并使用网络策略来控制容器之间的流量。</li>
<li>IP 地址管理：Calico 自动管理 Kubernetes 集群中的 IP 地址分配。它使用 IPIP 隧道技术将容器的 IP 地址映射到节点的 IP 地址，以确保容器之间的通信。</li>
<li>网络隔离：Calico 提供了网络隔离功能，允许将不同的容器和应用程序隔离到不同的网络中。</li>
</ul>
</blockquote>
<blockquote>
<p>flannel 原理</p>
</blockquote>
<blockquote>
<ul>
<li>网络覆盖：Flannel 在 Kubernetes 集群中的每个节点上运行一个守护进程，该守护进程使用 VXLAN。</li>
<li>网络配置：Flannel 守护进程负责配置虚拟网络，并将容器的网络流量路由到正确的目的地。</li>
<li>IP 地址分配：Flannel 自动管理 Kubernetes 集群中的 IP 地址分配。它使用 IPAM（IP Address Management）模块来分配 IP 地址，并将它们分配给容器。</li>
<li>网络策略：Flannel 支持网络策略，允许定义容器之间的访问规则。可以使用网络策略来控制容器之间的流量，以确保应用程序的安全性。</li>
</ul>
</blockquote>
<h4 id="4-11-加入集群-node"><a href="#4-11-加入集群-node" class="headerlink" title="4.11 加入集群[node]"></a>4.11 加入集群[node]</h4><blockquote>
<p> 注意，如果丢失了初始化命令，可以通过一下命令重新生成</p>
</blockquote>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kubeadm</span> <span class="string">token create --print-join-command</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>master 节点[master2、master3]</p>
</blockquote>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@kub-k8s-master1</span> <span class="string">~]# kubeadm join 192.168.75.104:8443 --token hxyvvg.bzvpv2h1ag28g79m         --discovery-token-ca-cert-hash sha256:19a140207276157f923d7f962b5a51e93006f282180b439ad5c1390acaea722c         --control-plane --certificate-key 1d241f4bdfbfb37444221397b0e3522c8096f54d4b301cc49b69ddc735bee9c1</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>node 节点</p>
</blockquote>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">配置node节点加入集群：</span></span><br><span class="line"><span class="attr">如果报错开启ip转发：</span></span><br><span class="line"><span class="comment"># sysctl -w net.ipv4.ip_forward=1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">在所有node节点操作，此命令为初始化master成功后返回的结果</span></span><br><span class="line"><span class="comment"># kubeadm join 192.168.75.104:8443 --token hxyvvg.bzvpv2h1ag28g79m \</span></span><br><span class="line">        <span class="attr">--discovery-token-ca-cert-hash</span> <span class="string">sha256:19a140207276157f923d7f962b5a51e93006f282180b439ad5c1390acaea722c</span></span><br></pre></td></tr></table></figure>

<h4 id="4-12-后续检查-master"><a href="#4-12-后续检查-master" class="headerlink" title="4.12 后续检查[master]"></a>4.12 后续检查[master]</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">各种检测：</span></span><br><span class="line"><span class="attr">1.查看pods</span>:<span class="string"></span></span><br><span class="line"><span class="attr">[root@kub-k8s-master1</span> <span class="string">~]# kubectl get pod -A -w</span></span><br><span class="line"><span class="attr">NAMESPACE</span>     <span class="string">NAME                                       READY   STATUS    RESTARTS       AGE</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">calico-kube-controllers-7c87c5f9b8-q2vth   1/1     Running   0              36s</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">calico-node-5th7f                          1/1     Running   0              36s</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">calico-node-g996t                          1/1     Running   0              36s</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">calico-node-n94v5                          1/1     Running   0              36s</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">calico-node-qjmth                          1/1     Running   0              36s</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">calico-node-rfzf7                          1/1     Running   0              36s</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">coredns-78fcd69978-5sg7p                   1/1     Running   0              11m</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">coredns-78fcd69978-btws4                   1/1     Running   0              11m</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">etcd-kub-k8s-master1                       1/1     Running   6              11m</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">etcd-kub-k8s-master2                       1/1     Running   0              10m</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">etcd-kub-k8s-master3                       1/1     Running   0              10m</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">kube-apiserver-kub-k8s-master1             1/1     Running   6              11m</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">kube-apiserver-kub-k8s-master2             1/1     Running   2 (10m ago)    11m</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">kube-apiserver-kub-k8s-master3             1/1     Running   0              10m</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">kube-controller-manager-kub-k8s-master1    1/1     Running   10 (10m ago)   11m</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">kube-controller-manager-kub-k8s-master2    1/1     Running   0              11m</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">kube-controller-manager-kub-k8s-master3    1/1     Running   0              10m</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">kube-proxy-4bsm2                           1/1     Running   0              8m2s</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">kube-proxy-bb5rd                           1/1     Running   0              10m</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">kube-proxy-bnxj5                           1/1     Running   0              8m4s</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">kube-proxy-cfm5m                           1/1     Running   0              11m</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">kube-proxy-smhd6                           1/1     Running   0              11m</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">kube-scheduler-kub-k8s-master1             1/1     Running   10 (10m ago)   11m</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">kube-scheduler-kub-k8s-master2             1/1     Running   0              11m</span></span><br><span class="line"><span class="attr">kube-system</span>   <span class="string">kube-scheduler-kub-k8s-master3             1/1     Running   0              10m</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">2.查看节点：</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master1</span> <span class="string">~]# kubectl get nodes</span></span><br><span class="line"><span class="attr">NAME</span>             <span class="string">STATUS   ROLES    AGE     VERSION</span></span><br><span class="line"><span class="attr">kub-k8s-master</span>   <span class="string">Ready    master   43m     v1.22.0</span></span><br><span class="line"><span class="attr">kub-k8s-node1</span>    <span class="string">Ready    &lt;none&gt;   6m46s   v1.22.0</span></span><br><span class="line"><span class="attr">kub-k8s-node2</span>    <span class="string">Ready    &lt;none&gt;   6m37s   v1.22.0</span></span><br><span class="line"></span><br><span class="line"><span class="attr">到此集群配置完成</span></span><br></pre></td></tr></table></figure>

<h4 id="4-13-集群数据库相关操作"><a href="#4-13-集群数据库相关操作" class="headerlink" title="4.13 集群数据库相关操作"></a>4.13 集群数据库相关操作</h4><blockquote>
<p>由k8s集群数据库文档单独记录</p>
</blockquote>
<p><strong>kubernetes命令自动补全</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@kub-k8s-master1 ~]# yum install -y epel-release bash-completion</span><br><span class="line">[root@kub-k8s-master1 ~]# <span class="built_in">source</span> /usr/share/bash-completion/bash_completion</span><br><span class="line">[root@kub-k8s-master1 ~]# <span class="built_in">source</span> &lt;(kubectl completion bash)</span><br><span class="line">[root@kub-k8s-master1 ~]# <span class="built_in">echo</span> <span class="string">&quot;source &lt;(kubectl completion bash)&quot;</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="comment"># 输入kubectl, 双击Tab</span></span><br><span class="line">[root@kub-k8s-master1 ~]# kubectl</span><br><span class="line">alpha       apply       certificate    convert      delete       edit        get       options      proxy        scale          uncordon</span><br><span class="line">annotate    attach      cluster-info   cordon       describe     <span class="built_in">exec</span>        kustomize patch        replace      <span class="built_in">set</span>            version</span><br><span class="line">api-resources  auth     completion     <span class="built_in">cp</span>           diff         explain     label     plugin       rollout      taint          <span class="built_in">wait</span></span><br><span class="line">api-versions   autoscale config        create       drain        expose      logs      port-forward   run        top</span><br><span class="line">[root@kub-k8s-master1 ~]# kubectl</span><br></pre></td></tr></table></figure>
<p>错误整理</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&gt; 如果集群初始化失败：(每个节点都要执行)</span></span><br><span class="line"><span class="attr">$</span> <span class="string">kubeadm reset -f; ipvsadm --clear; rm -rf ~/.kube</span></span><br><span class="line"><span class="attr">$</span> <span class="string">systemctl restart kubelet</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#&gt; 如果忘记token值</span></span><br><span class="line"><span class="attr">$</span> <span class="string">kubeadm token create --print-join-command</span></span><br><span class="line"><span class="attr">$</span> <span class="string">kubeadm init phase upload-certs --upload-certs</span></span><br></pre></td></tr></table></figure>

<h3 id="五-可视化部署"><a href="#五-可视化部署" class="headerlink" title="五.可视化部署"></a>五.可视化部署</h3><h4 id="5-1-官方Dashboard"><a href="#5-1-官方Dashboard" class="headerlink" title="5.1 官方Dashboard"></a>5.1 官方Dashboard</h4><h5 id="5-1-1-部署Dashboard"><a href="#5-1-1-部署Dashboard" class="headerlink" title="5.1.1 部署Dashboard"></a>5.1.1 部署Dashboard</h5><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.4.0/aio/deploy/recommended.yaml</span></span><br><span class="line"><span class="comment"># kubectl edit svc kubernetes-dashboard -n kubernetes-dashboard</span></span><br><span class="line"><span class="comment"># 注意将 type: ClusterIP 改为 type: NodePort</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># kubectl get svc -A |grep kubernetes-dashboard</span></span><br><span class="line"><span class="attr">kubernetes-dashboard</span>   <span class="string">dashboard-metrics-scraper   ClusterIP   10.107.179.10   &lt;none&gt;        8000/TCP                 38s</span></span><br><span class="line"><span class="attr">kubernetes-dashboard</span>   <span class="string">kubernetes-dashboard        NodePort    10.110.18.72    &lt;none&gt;        443:32231/TCP            38s</span></span><br></pre></td></tr></table></figure>

<h5 id="5-1-2-创建访问账号"><a href="#5-1-2-创建访问账号" class="headerlink" title="5.1.2 创建访问账号"></a>5.1.2 创建访问账号</h5><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建访问账号，准备一个yaml文件； vi dash.yaml</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">v1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">admin-user</span></span><br><span class="line">  <span class="attr">namespace</span>: <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">---</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">admin-user</span></span><br><span class="line"><span class="attr">roleRef</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">apiGroup</span>: <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind</span>: <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">cluster-admin</span></span><br><span class="line"><span class="attr">subjects</span>:<span class="string"></span></span><br><span class="line"><span class="attr">-</span> <span class="string">kind: ServiceAccount</span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">admin-user</span></span><br><span class="line">  <span class="attr">namespace</span>: <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="comment">  </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># kubectl apply -f dash.yaml</span></span><br></pre></td></tr></table></figure>

<h5 id="5-1-3-获取访问令牌"><a href="#5-1-3-获取访问令牌" class="headerlink" title="5.1.3 获取访问令牌"></a>5.1.3 获取访问令牌</h5><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#获取访问令牌</span></span><br><span class="line"><span class="comment"># kubectl -n kubernetes-dashboard get secret $(kubectl -n kubernetes-dashboard get sa/admin-user -o jsonpath=&quot;&#123;.secrets[0].name&#125;&quot;) -o go-template=&quot;&#123;&#123;.data.token | base64decode&#125;&#125;&quot;</span></span><br><span class="line"><span class="attr">eyJhbGciOiJSUzI1NiIsImtpZCI6ImhRa2Q3UDFGempzb3VneVdUS0R0dk50SHlwUHExc0tuT21SOTdWQkczaG8ifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLXBmbGxyIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJlNDk0MTFhYS0zOTVhLTRkYzUtYmZmYS04MDZiODE3M2VmZWEiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZXJuZXRlcy1kYXNoYm9hcmQ6YWRtaW4tdXNlciJ9.k3Gd9vRF6gP3Zxy89x14y4I2RCGn232bGLo9A5iEmeMl6BRPdJXZPbwy9fm3OT6ZjVc7LHiRgArczjZuCU3Sis4tIA_24A55h74WQE_JTeiZ5XnSGRknYQRHFSqyBrTaTxgDJb-O-DHol8GQLQjr6gIPzppHc-RhWhUFFNnPVP1nr2MLFBkvIT_qAcbHP6McFf2N6IsYwVFuvyIO77qWcmyFlgSr8a3A0INEJYB2bFPRL82rNc41c0TsUwOguQbJYrDA9lBqVpSff_7Uk_-7ycabZclbZX1HPz2-F59LQW7NWQy7biZw5b25AZaXAG3kL3SDuRRBoMNS92MmDFsVyA</span></span><br></pre></td></tr></table></figure>

<h5 id="5-1-4-浏览器访问"><a href="#5-1-4-浏览器访问" class="headerlink" title="5.1.4 浏览器访问"></a>5.1.4 浏览器访问</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">任意节点ip+端口[上面查看到为32231]</span><br><span class="line">url https://192.168.246.216:32231/</span><br><span class="line">使用token登录</span><br></pre></td></tr></table></figure>

<p><img src="https://img.beyourself.org.cn/abc/2a0b256519aa814aa9b8c89531c333289d761688.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_54,text_6KW_5a6J5Y2D6ZSL5LqR6K6h566X,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10#id=PboYj&originHeight=944&originWidth=1906&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<h4 id="5-2-kuboard-部署"><a href="#5-2-kuboard-部署" class="headerlink" title="5.2 kuboard 部署"></a>5.2 kuboard 部署</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@kube-master ~]# kubectl apply -f https://addons.kuboard.cn/kuboard/kuboard-v3.yaml</span><br><span class="line"></span><br><span class="line">[root@kube-master ~]# kubectl get pod -n kuboard</span><br><span class="line">NAME                               READY   STATUS    RESTARTS         AGE</span><br><span class="line">kuboard-agent-2-5c54dcb98f-4vqvc   1/1     Running   24 (7m50s ago)   16d</span><br><span class="line">kuboard-agent-747b97fdb7-j42wr     1/1     Running   24 (7m34s ago)   16d</span><br><span class="line">kuboard-etcd-ccdxk                 1/1     Running   16 (8m58s ago)   16d</span><br><span class="line">kuboard-etcd-k586q                 1/1     Running   16 (8m53s ago)   16d</span><br><span class="line">kuboard-questdb-bd65d6b96-rgx4x    1/1     Running   10 (8m53s ago)   16d</span><br><span class="line">kuboard-v3-5fc46b5557-zwnsf        1/1     Running   12 (8m53s ago)   16d</span><br><span class="line"></span><br><span class="line">[root@kube-master ~]# kubectl get svc -n kuboard</span><br><span class="line">NAME         TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)                                        AGE</span><br><span class="line">kuboard-v3   NodePort   10.96.25.125   &lt;none&gt;        80:30080/TCP,10081:30081/TCP,10081:30081/UDP   16d</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/29063483/1700289148095-bd10eec9-ffc1-40fa-97b4-fc920f224187.png#averageHue=%234eeda0&clientId=u9b1bfd5d-73a8-4&from=paste&height=741&id=uf8836e5a&originHeight=1390&originWidth=2472&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=469731&status=done&style=none&taskId=ud8be58f8-9e20-475a-a824-7a5936b2b69&title=&width=1318.4" alt="image.png"></p>
<h4 id="5-3-kubesphere-部署"><a href="#5-3-kubesphere-部署" class="headerlink" title="5.3 kubesphere 部署"></a>5.3 kubesphere 部署</h4><blockquote>
<p>官方文档: </p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://kubesphere.io/zh/docs/v3.4/quick-start/minimal-kubesphere-on-k8s/">在 Kubernetes 上最小化安装 KubeSphere</a><br><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/29063483/1700790070270-60a68093-4998-405d-a706-dca17ec002bc.jpeg#averageHue=%23ebf4ef&clientId=uca2eb34c-dbcb-4&from=paste&id=u5c5a5b70&originHeight=1800&originWidth=2880&originalType=url&ratio=1.5625&rotation=0&showTitle=false&status=done&style=none&taskId=ua376e8e0-4dac-4cd8-ac59-cece564c7a0&title="></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 运行安装</span></span><br><span class="line">[root@kube-master ~]# kubectl apply -f https://github.com/kubesphere/ks-installer/releases/download/v3.4.0/kubesphere-installer.yaml</span><br><span class="line">[root@kube-master ~]# kubectl apply -f https://github.com/kubesphere/ks-installer/releases/download/v3.4.0/cluster-configuration.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看日志</span></span><br><span class="line">[root@kube-master ~]# kubectl logs -n kubesphere-system $(kubectl get pod -n kubesphere-system -l <span class="string">&#x27;app in (ks-install, ks-installer)&#x27;</span> -o jsonpath=<span class="string">&#x27;&#123;.items[0].metadata.name&#125;&#x27;</span>) -f</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>卸载kubesphere</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@kube-master ~]# curl https://raw.githubusercontent.com/kubesphere/ks-installer/release-3.4/scripts/kubesphere-delete.sh | sh</span><br></pre></td></tr></table></figure>
<h4 id="5-4-rainbond-部署"><a href="#5-4-rainbond-部署" class="headerlink" title="5.4  rainbond 部署"></a>5.4  rainbond 部署</h4><p><a target="_blank" rel="noopener" href="https://www.rainbond.com/">Rainbond</a><br><img src="https://cdn.nlark.com/yuque/0/2023/png/29063483/1700790121544-5acd0c0a-08f4-417d-81f5-cdb9c1ada16a.png#averageHue=%238ed159&clientId=uca2eb34c-dbcb-4&from=paste&height=602&id=ZVqHN&originHeight=941&originWidth=1860&originalType=binary&ratio=1.5625&rotation=0&showTitle=false&size=73828&status=done&style=none&taskId=ub2c8afe3-442a-46d6-a7b2-a2940fa5ac0&title=&width=1190.4" alt="image.png"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@kube-master ~]# curl -o install.sh https://get.rainbond.com &amp;&amp; bash ./install.sh</span><br><span class="line">RO</span><br><span class="line">[root@kube-master ~]# helm repo add rainbond https://openchart.goodrain.com/goodrain/rainbond</span><br><span class="line">[root@kube-master ~]# helm repo update</span><br><span class="line">[root@kube-master ~]# kubectl create namespace rbd-system</span><br></pre></td></tr></table></figure>
<blockquote>
<p>卸载</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">如果是基于helm创建的rainbond</span><br><span class="line">[root@kube-master ~]# helm uninstall rainbond -n rbd-system</span><br><span class="line"></span><br><span class="line">如果是基于官方脚本创建的rainbond</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Delete PVC</span></span><br><span class="line">[root@kube-master ~]# kubectl get pvc -n rbd-system | grep -v NAME | awk &#x27;&#123;print $1&#125;&#x27; | xargs kubectl delete pvc -n rbd-system</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Delete PV</span></span><br><span class="line">[root@kube-master ~]# kubectl get pv | grep rbd-system | grep -v NAME | awk &#x27;&#123;print $1&#125;&#x27; | xargs kubectl delete pv</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Delete CRD</span></span><br><span class="line">[root@kube-master ~]# kubectl delete crd componentdefinitions.rainbond.io \</span><br><span class="line">helmapps.rainbond.io \</span><br><span class="line">rainbondclusters.rainbond.io \</span><br><span class="line">rainbondpackages.rainbond.io \</span><br><span class="line">rainbondvolumes.rainbond.io \</span><br><span class="line">rbdcomponents.rainbond.io \</span><br><span class="line">servicemonitors.monitoring.coreos.com \</span><br><span class="line">thirdcomponents.rainbond.io \</span><br><span class="line">rbdabilities.rainbond.io \</span><br><span class="line">rbdplugins.rainbond.io \</span><br><span class="line">servicemeshclasses.rainbond.io \</span><br><span class="line">servicemeshes.rainbond.io \</span><br><span class="line">-n rbd-system</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Delete NAMESPACE</span></span><br><span class="line">[root@kube-master ~]# kubectl delete ns rbd-system</span><br></pre></td></tr></table></figure>

<h3 id="六-集群常用指令"><a href="#六-集群常用指令" class="headerlink" title="六.集群常用指令"></a>六.集群常用指令</h3><h4 id="6-1-基础控制指令"><a href="#6-1-基础控制指令" class="headerlink" title="6.1 基础控制指令"></a>6.1 基础控制指令</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看对应资源: 状态</span></span><br><span class="line"><span class="attr">$</span> <span class="string">kubectl get &lt;SOURCE_NAME&gt; -n &lt;NAMESPACE&gt; -o wide</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 查看对应资源: 事件信息</span></span><br><span class="line"><span class="attr">$</span> <span class="string">kubectl describe &lt;SOURCE_NAME&gt; &lt;SOURCE_NAME_RANDOM_ID&gt; -n &lt;NAMESPACE&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 查看pod资源: 日志</span></span><br><span class="line"><span class="attr">$</span> <span class="string">kubectl logs -f &lt;SOURCE_NAME_RANDOM_ID&gt; [CONTINER_NAME] -n &lt;NAMESPACE&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 创建资源: 根据资源清单</span></span><br><span class="line"><span class="attr">$</span> <span class="string">kubectl apply[or create] -f &lt;SOURCE_FILENAME&gt;.yaml</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 删除资源: 根据资源清单</span></span><br><span class="line"><span class="attr">$</span> <span class="string">kubectl delete -f &lt;SOURCE_FILENAME&gt;.yaml</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 修改资源: 根据反射出的etcd中的配置内容, 生产中不允许该项操作, 且命令禁止</span></span><br><span class="line"><span class="attr">$</span> <span class="string">kubectl edit &lt;SOURCE_NAME&gt; &lt;SOURCE_NAME_RANDOM_ID&gt; -n &lt;NAMESPACE&gt;</span></span><br></pre></td></tr></table></figure>



<h4 id="6-2-命令实践"><a href="#6-2-命令实践" class="headerlink" title="6.2 命令实践"></a><img src="https://guangxipengyuyan.oss-cn-guangzhou.aliyuncs.com/image-20240813201537883.png" alt="image-20240813201537883" style="zoom:80%;" />6.2 命令实践</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看node状态</span></span><br><span class="line"><span class="attr">$</span> <span class="string">kubectl get node # -o wide 显示更加详细的信息</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 查看service对象</span></span><br><span class="line"><span class="attr">$</span> <span class="string">kubectl get svc</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 查看kube-system名称空间内的Pod</span></span><br><span class="line"><span class="attr">$</span> <span class="string">kubectl get pod -n kube-system</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 查看所有名称空间内的pod</span></span><br><span class="line"><span class="attr">$</span> <span class="string">kubectl get pod -A</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 查看集群信息</span></span><br><span class="line"><span class="attr">$</span> <span class="string">kubectl cluster-info</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 查看各组件信息</span></span><br><span class="line"><span class="attr">$</span> <span class="string">kubectl -s https://api-server:6443 get componentstatuses</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 查看各资源对象对应的api版本</span></span><br><span class="line"><span class="attr">$</span> <span class="string">kubectl explain pod</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 查看帮助信息</span></span><br><span class="line"><span class="attr">$</span> <span class="string">kubectl explain deployment</span></span><br><span class="line"><span class="attr">$</span> <span class="string">kubectl explain deployment.spec</span></span><br><span class="line"><span class="attr">$</span> <span class="string">kubectl explain deployment.spec.replicas</span></span><br></pre></td></tr></table></figure>

<h4 id="6-3-备注"><a href="#6-3-备注" class="headerlink" title="6.3 备注"></a>6.3 备注</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">问题一</span> <span class="string">查看各组件信息，可能会发现错误</span></span><br><span class="line"><span class="attr">$</span> <span class="string">kubectl -s https://192.168.96.143:6443 get componentstatuses</span></span><br><span class="line"><span class="attr">Warning</span>: <span class="string">v1 ComponentStatus is deprecated in v1.19+</span></span><br><span class="line"><span class="attr">NAME</span>                 <span class="string">STATUS      MESSAGE                                                                                       ERROR</span></span><br><span class="line"><span class="attr">scheduler</span>            <span class="string">Unhealthy   Get &quot;http://127.0.0.1:10251/healthz&quot;: dial tcp 127.0.0.1:10251: connect: connection refused   </span></span><br><span class="line"><span class="attr">controller-manager</span>   <span class="string">Unhealthy   Get &quot;http://127.0.0.1:10252/healthz&quot;: dial tcp 127.0.0.1:10252: connect: connection refused   </span></span><br><span class="line"><span class="attr">etcd-0</span>               <span class="string">Healthy     &#123;&quot;health&quot;:&quot;true&quot;&#125;                                                           </span></span><br><span class="line"></span><br><span class="line"><span class="attr">问题一解决</span></span><br><span class="line"><span class="attr">$</span> <span class="string">vim /etc/kubernetes/manifests/kube-scheduler.yaml</span></span><br><span class="line"> <span class="attr">10</span> <span class="string">spec:</span></span><br><span class="line"> <span class="attr">11</span>   <span class="string">containers:</span></span><br><span class="line"> <span class="attr">12</span>   <span class="string">- command:</span></span><br><span class="line"> <span class="attr">13</span>     <span class="string">- kube-scheduler</span></span><br><span class="line"> <span class="attr">14</span>     <span class="string">- --authentication-kubeconfig=/etc/kubernetes/scheduler.conf</span></span><br><span class="line"> <span class="attr">15</span>     <span class="string">- --authorization-kubeconfig=/etc/kubernetes/scheduler.conf</span></span><br><span class="line"> <span class="attr">16</span>     <span class="string">- --bind-address=127.0.0.1</span></span><br><span class="line"> <span class="attr">17</span>     <span class="string">- --kubeconfig=/etc/kubernetes/scheduler.conf</span></span><br><span class="line"> <span class="attr">18</span>     <span class="string">- --leader-elect=true</span></span><br><span class="line"> <span class="attr">19</span>     <span class="string">- --port=0   # 将此行注释或删除</span></span><br><span class="line"> </span><br><span class="line"> <span class="attr">$</span> <span class="string">vim /etc/kubernetes/manifests/kube-controller-manager.yaml</span></span><br><span class="line">  <span class="attr">10</span> <span class="string">spec:</span></span><br><span class="line"> <span class="attr">11</span>   <span class="string">containers:</span></span><br><span class="line"> <span class="attr">12</span>   <span class="string">- command:</span></span><br><span class="line"> <span class="attr">13</span>     <span class="string">- kube-controller-manager</span></span><br><span class="line"> <span class="attr">14</span>     <span class="string">- --allocate-node-cidrs=true</span></span><br><span class="line"> <span class="attr">15</span>     <span class="string">- --authentication-kubeconfig=/etc/kubernetes/controller-manager.conf</span></span><br><span class="line"> <span class="attr">16</span>     <span class="string">- --authorization-kubeconfig=/etc/kubernetes/controller-manager.conf</span></span><br><span class="line"> <span class="attr">17</span>     <span class="string">- --bind-address=127.0.0.1</span></span><br><span class="line"> <span class="attr">18</span>     <span class="string">- --client-ca-file=/etc/kubernetes/pki/ca.crt</span></span><br><span class="line"> <span class="attr">19</span>     <span class="string">- --cluster-cidr=10.244.0.0/16</span></span><br><span class="line"> <span class="attr">20</span>     <span class="string">- --cluster-name=kubernetes</span></span><br><span class="line"> <span class="attr">21</span>     <span class="string">- --cluster-signing-cert-file=/etc/kubernetes/pki/ca.crt</span></span><br><span class="line"> <span class="attr">22</span>     <span class="string">- --cluster-signing-key-file=/etc/kubernetes/pki/ca.key</span></span><br><span class="line"> <span class="attr">23</span>     <span class="string">- --controllers=*,bootstrapsigner,tokencleaner</span></span><br><span class="line"> <span class="attr">24</span>     <span class="string">- --kubeconfig=/etc/kubernetes/controller-manager.conf</span></span><br><span class="line"> <span class="attr">25</span>     <span class="string">- --port=0 # 将此行注释或删除</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">$</span> <span class="string">systemctl restart kubelet</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">$</span> <span class="string">kubectl -s https://192.168.96.143:6443 get componentstatuses</span></span><br><span class="line"><span class="attr">Warning</span>: <span class="string">v1 ComponentStatus is deprecated in v1.19+</span></span><br><span class="line"><span class="attr">NAME</span>                 <span class="string">STATUS    MESSAGE             ERROR</span></span><br><span class="line"><span class="attr">scheduler</span>            <span class="string">Healthy   ok                  </span></span><br><span class="line"><span class="attr">controller-manager</span>   <span class="string">Healthy   ok                  </span></span><br><span class="line"><span class="attr">etcd-0</span>               <span class="string">Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="七-Yaml语法解析"><a href="#七-Yaml语法解析" class="headerlink" title="七.Yaml语法解析"></a>七.Yaml语法解析</h3><blockquote>
<p>YAML是一个类似 XML、JSON 的标记性语言。它强调以数据为中心，并不是以标识语言为重点。因而YAML本身的定义比较简单，号称”一种人性化的数据格式语言”。</p>
</blockquote>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">YAML的语法比较简单，主要有下面几个：</span></span><br><span class="line"><span class="attr">1、大小写敏感</span></span><br><span class="line"><span class="attr">2、使用缩进表示层级关系</span></span><br><span class="line"><span class="attr">3、缩进不允许使用tab，只允许空格(</span> <span class="string">低版本限制 )</span></span><br><span class="line"><span class="attr">4、缩进的空格数不重要，只要相同层级的元素左对齐即可</span></span><br><span class="line"><span class="attr">5、&#x27;#&#x27;表示注释</span></span><br><span class="line"></span><br><span class="line"><span class="attr">YAML支持以下几种数据类型：</span></span><br><span class="line"><span class="attr">1、纯量：单个的、不可再分的值</span></span><br><span class="line"><span class="attr">2、对象：键值对的集合，又称为映射（mapping）/</span> <span class="string">哈希（hash） / 字典（dictionary）</span></span><br><span class="line"><span class="attr">3、数组：一组按次序排列的值，又称为序列（sequence）</span> <span class="string">/ 列表（list）</span></span><br><span class="line"></span><br><span class="line"><span class="attr">补充说明：</span></span><br><span class="line"><span class="attr">1、书写yaml切记</span>: <span class="string">后面要加一个空格</span></span><br><span class="line"><span class="attr">2、如果需要将多段yaml配置放在一个文件中，中间要使用---分隔</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>举个例子，通过声明式配置yaml 创建名称空间</p>
</blockquote>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">$</span> <span class="string">vim namespace.yaml</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">v1</span></span><br><span class="line">	<span class="attr">kind</span>: <span class="string">Namespace</span></span><br><span class="line">	<span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">  		<span class="attr">name</span>: <span class="string">webserver</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">$</span> <span class="string">kubectl apply -f namespace.yaml</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 如果通过命令行创建</span></span><br><span class="line"><span class="attr">$</span> <span class="string">kubectl create namespace webserver</span></span><br><span class="line"><span class="comment"># 删除名称空间[注意，这将删除名称空间下的所有资源]</span></span><br><span class="line"><span class="attr">$</span> <span class="string">kubectl delete namespace webserver</span></span><br></pre></td></tr></table></figure>

<h3 id="八-k8s中的Pod"><a href="#八-k8s中的Pod" class="headerlink" title="八.k8s中的Pod"></a>八.k8s中的Pod</h3><blockquote>
<p>  <em>Pod</em> 是可以在 <em>Kubernetes</em> 中创建和管理的、最小的可部署的计算单元; <em>Pod</em> 中会启动一个或一组紧密相关的业务容器, 各个业务容器相当于_Pod_ 中的各个进程, 此时就可以将_Pod_ 作为虚拟机看待; 在创建 <em>Pod</em> 时会启动一个init容器, 用来初始化存储和网络, 其余的业务容器都将在init容器启动后启动, 业务容器共享init容器的存储和网络; <em>Pod</em> 只是一个逻辑单元, 并不是真实存在的“主机”, 这种类比主机的概念可以更好的符合现有互联网中几乎所有的虚拟化设计; 像之前运行在虚拟机中的 nginx、mysql、php均可以使用对应的镜像运行出对应的容器在Pod中, 来类比虚拟机中运行这三者;</p>
</blockquote>
<blockquote>
<p>  对于 <em>Pod</em> 而言, 在运行的过程中, k8s为了控制其生命周期的状态, 增加了_容器探测指针_、<em>资源限额_、_期望状态保持_、_多容器结合_、_安全策略设定_、_控制器受管_、_故障处理策略</em> 等; Pod在平时是不能够被单独创建的, 而是需要使用控制器对其创建, 这样可以时刻保持Pod的期望状态;</p>
</blockquote>
<blockquote>
<p>  在Kubernetes中所有的资源均可通过命令行参数或者资源清单[yaml&#x2F;json]的方式进行创建和修改, 但由于Kubernetes属于声明式资源控制集群, 故大多管理Kubernetes集群的方式采用资源配置清单; 资源配置清单可以很好的追溯资源的原型和详细的配置, 且配合版本控制能够完成更好的溯源、回滚、发布等操作; 所以课程中所有的资源创建和修改都会采用资源配置清单的方式, 除部分命令行操作以外;</p>
</blockquote>
<blockquote>
<h3 id="Pod-API-对象"><a href="#Pod-API-对象" class="headerlink" title="Pod API 对象"></a>Pod API 对象</h3><p>问题：</p>
<p>    通过yaml文件创建pod的时候里面有容器，这个文件里面到底哪些属性属于 Pod 对象，哪些属性属于 Container？</p>
<p>解决：</p>
<p>    共同特征是，它们描述的是”机器”这个整体，而不是里面运行的”程序”。</p>
<h4 id="容器可选的设置属性包括："><a href="#容器可选的设置属性包括：" class="headerlink" title="容器可选的设置属性包括："></a>容器可选的设置属性包括：</h4></blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Pod是 k8s 项目中的最小编排单位。将这个设计落实到 API 对象上，容器（Container）就成了 Pod 属性里一个普通的字段。</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">把 Pod 看成传统环境里的&quot;虚拟机机器&quot;、把容器看作是运行在这个&quot;机器&quot;里的&quot;用户程序&quot;，那么很多关于 Pod 对象的设计就非常容易理解了。</span><br><span class="line">凡是调度、网络、存储，以及安全相关的属性，基本上是 Pod 级别的</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">比如：</span><br><span class="line"></span><br><span class="line">配置这个&quot;机器&quot;的网卡（即：Pod 的网络定义）</span><br><span class="line"></span><br><span class="line">配置这个&quot;机器&quot;的磁盘（即：Pod 的存储定义）</span><br><span class="line"></span><br><span class="line">配置这个&quot;机器&quot;的防火墙（即：Pod 的安全定义）</span><br><span class="line"></span><br><span class="line">这台&quot;机器&quot;运行在哪个服务器之上（即：Pod 的调度）</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kind：指定了这个 API 对象的类型（Type），是一个 Pod，根据实际情况，此处资源类型可以是Deployment、Job、Ingress、Service等。</span><br><span class="line"></span><br><span class="line">metadata：包含Pod的一些meta信息，比如名称、namespace、标签等信息.</span><br><span class="line"></span><br><span class="line">spec：specification of the resource content 指定该资源的内容,包括一些container，storage，volume以及其他Kubernetes需要的参数，以及诸如是否在容器失败时重新启动容器的属性。可在特定Kubernetes API找到完整的Kubernetes Pod的属性。</span><br><span class="line">ˌ</span><br><span class="line"><span class="meta prompt_">specification-----&gt;</span><span class="language-bash">[spesɪfɪˈkeɪʃn]</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&quot;name&quot;: 容器名称</span><br><span class="line">&quot;image&quot;: 容器镜像</span><br><span class="line">&quot;command&quot;: 容器启动指令</span><br><span class="line">&quot;args&quot;: 指令参数</span><br><span class="line">&quot;workingDir&quot;: 工作目录</span><br><span class="line">&quot;ports&quot;: 容器端口</span><br><span class="line">&quot;env&quot;: 环境变量</span><br><span class="line">&quot;resource&quot;: 资源限制</span><br><span class="line">&quot;volumeMounts&quot;: 卷挂载</span><br><span class="line">&quot;livenessProbe&quot;: 存活探针</span><br><span class="line">&quot;readinessProbe&quot;: 就绪探针</span><br><span class="line">&quot;startupProbe&quot;: 启动探针</span><br><span class="line">&quot;livecycle&quot;: 钩子函数</span><br><span class="line">&quot;terminationMessagePath&quot;: 容器的异常终止消息的路径，默认在 /dev/termination-log</span><br><span class="line">&quot;imagePullPolicy&quot;: 镜像拉去策略</span><br><span class="line">&quot;securityContext&quot;: 安全上下文</span><br><span class="line">&quot;stdin&quot;: 给容器分配标准输入，类似docker run -i</span><br><span class="line">&quot;tty&quot;: 分配终端</span><br></pre></td></tr></table></figure>

<h4 id="8-1-创建一个pod"><a href="#8-1-创建一个pod" class="headerlink" title="8.1 创建一个pod"></a>8.1 创建一个pod</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">vim</span> <span class="string">nginx.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx:1.16.1</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        </span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">nginx.yaml</span></span><br></pre></td></tr></table></figure>

<h4 id="8-2-pod是如何被创建的"><a href="#8-2-pod是如何被创建的" class="headerlink" title="8.2 pod是如何被创建的"></a>8.2 pod是如何被创建的</h4><blockquote>
<ul>
<li>step1: kubectl 向 k8s api server 发起一个create pod 请求</li>
<li>step2: k8s api server接收到pod创建请求后，不会去直接创建pod；而是生成一个包含创建信息的yaml。</li>
<li>step3: apiserver 将刚才的yaml信息写入etcd数据库。</li>
<li>step4: scheduler 查看 k8s api,判断：pod.spec.Node &#x3D;&#x3D; null,若为null，表示这个Pod请求是新来的，需要创建；因此先进行调度计算，找到最适合的node。并更新数据库</li>
<li>step5: node节点上的Kubelet通过监听数据库更新，发现有新的任务与自己的node编号匹配，则进行任务创建</li>
</ul>
</blockquote>
<h4 id="8-3-创建一个单容器pod"><a href="#8-3-创建一个单容器pod" class="headerlink" title="8.3 创建一个单容器pod"></a>8.3 创建一个单容器pod</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">vim</span> <span class="string">mysql.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">OnFailure</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:5.7</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">&quot;123456&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;1024Mi&quot;</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;1000m&quot;</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3306</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">kubernetes.io/hostname:</span> <span class="string">kub-k8s-node2</span></span><br><span class="line">  <span class="comment"># nodeName: kub-k8s-node2</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">mysql.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 字段解析</span></span><br><span class="line"><span class="string">restartPolicy：</span></span><br><span class="line"><span class="string">pod</span> <span class="string">重启策略，可选参数有：</span></span><br><span class="line"><span class="number">1</span><span class="string">、Always：Pod中的容器无论如何停止都会自动重启</span></span><br><span class="line"><span class="number">2</span><span class="string">、OnFailure:</span> <span class="string">Pod中的容器非正常停止会自动重启</span></span><br><span class="line"><span class="number">3</span><span class="string">、Never:</span> <span class="string">Pod中的容器无论怎样都不会自动重启</span></span><br><span class="line"></span><br><span class="line"><span class="attr">imagePullPolicy:</span></span><br><span class="line"><span class="string">镜像拉取策略，可选参数有：</span></span><br><span class="line"><span class="number">1</span><span class="string">、Always：总是重新拉取</span></span><br><span class="line"><span class="number">2</span><span class="string">、IfNotPresent：默认，如果本地有，则不拉取</span></span><br><span class="line"><span class="number">3</span><span class="string">、Never：只是用本地镜像，从不拉取</span></span><br><span class="line"></span><br><span class="line"><span class="string">nodeSelector：</span></span><br><span class="line"><span class="string">节点选择器：可以指定node的标签，查看标签指令：</span></span><br><span class="line"><span class="attr">nodeName:</span></span><br><span class="line"><span class="string">节点名称:</span> <span class="string">可以指定node的名称进行调度</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">node</span> <span class="string">--show-labels</span></span><br></pre></td></tr></table></figure>

<h4 id="8-4-创建一个多容器pod"><a href="#8-4-创建一个多容器pod" class="headerlink" title="8.4 创建一个多容器pod"></a>8.4 创建一个多容器pod</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#vim lnmp.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-many</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">  	<span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">OnFailure</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.16.1</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">php-fpm</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">php:8.0-fpm-alpine</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9000</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">lnmp.yaml</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 字段解析</span></span><br><span class="line"><span class="string">nodeSelector：</span></span><br><span class="line"><span class="string">节点选择器：可以指定node的标签，查看标签指令：</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">node</span> <span class="string">--show-labels</span></span><br></pre></td></tr></table></figure>

<h5 id="8-4-1-配置节点标签"><a href="#8-4-1-配置节点标签" class="headerlink" title="8.4.1 配置节点标签"></a>8.4.1 配置节点标签</h5><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">添加标签</span></span><br><span class="line"><span class="attr">kubectl</span> <span class="string">label nodes node3 name=value</span></span><br><span class="line"><span class="attr">删除标签</span></span><br><span class="line"><span class="attr">kubectl</span> <span class="string">label nodes node3 name-</span></span><br></pre></td></tr></table></figure>

<h4 id="8-5-Pod容器的交互"><a href="#8-5-Pod容器的交互" class="headerlink" title="8.5 Pod容器的交互"></a>8.5 Pod容器的交互</h4><h5 id="8-5-1-创建pod，并做本地解析"><a href="#8-5-1-创建pod，并做本地解析" class="headerlink" title="8.5.1 创建pod，并做本地解析"></a>8.5.1 创建pod，并做本地解析</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">host-alias.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">centos</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">centos</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">centos</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">centos:7</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;tail&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;-f&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;/dev/null&quot;</span></span><br><span class="line">  <span class="attr">hostAliases:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ip:</span> <span class="string">&quot;192.168.100.128&quot;</span></span><br><span class="line">      <span class="attr">hostnames:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;master&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;k8s-master&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;apiserver&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 字段解析</span></span><br><span class="line"><span class="attr">command:</span></span><br><span class="line"><span class="string">启动容器时执行的指令，类似于docker</span> <span class="string">run</span> <span class="string">-it</span> <span class="string">镜像</span> <span class="string">tail</span> <span class="string">-f</span> <span class="string">/dev/null</span></span><br><span class="line"></span><br><span class="line"><span class="attr">hostAliases:</span></span><br><span class="line"><span class="string">在容器中的/etc/hosts文件中配置本地解析</span></span><br></pre></td></tr></table></figure>

<h5 id="8-5-2-pod共享进程"><a href="#8-5-2-pod共享进程" class="headerlink" title="8.5.2 pod共享进程"></a>8.5.2 pod共享进程</h5><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl delete -f pod.yml</span></span><br><span class="line"><span class="attr">pod</span> <span class="string">&quot;website&quot; deleted</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# vim pod.yml   #修改如下。最好是提前将镜像pull下来。</span></span><br><span class="line"><span class="attr">---</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">v1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">website</span></span><br><span class="line">  <span class="attr">labels</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">app</span>: <span class="string">website</span></span><br><span class="line"><span class="attr">spec</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">shareProcessNamespace</span>: <span class="string">true  #共享进程名称空间</span></span><br><span class="line">  <span class="attr">containers</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">-</span> <span class="string">name: test-web</span></span><br><span class="line">      <span class="attr">image</span>: <span class="string">daocloud.io/library/nginx</span></span><br><span class="line">      <span class="attr">ports</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">-</span> <span class="string">containerPort: 80</span></span><br><span class="line">    <span class="attr">-</span> <span class="string">name: busybox</span></span><br><span class="line">      <span class="attr">image</span>: <span class="string">daocloud.io/library/busybox</span></span><br><span class="line">      <span class="attr">stdin</span>: <span class="string">true</span></span><br><span class="line">      <span class="attr">tty</span>: <span class="string">true</span></span><br><span class="line">      </span><br><span class="line"><span class="attr">2.创建</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl apply -f pod.yml </span></span><br><span class="line"><span class="attr">pod/website</span> <span class="string">created</span></span><br></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">1.</span> <span class="string">定义了 shareProcessNamespace=true</span></span><br><span class="line"><span class="attr">表示这个</span> <span class="string">Pod 里的容器要共享进程(PID Namespace)如果是false则为不共享。</span></span><br><span class="line"><span class="attr">2.</span> <span class="string">定义了两个容器：</span></span><br><span class="line"><span class="attr">一个</span> <span class="string">nginx 容器</span></span><br><span class="line"><span class="attr">一个开启了</span> <span class="string">tty 和 stdin 的 busybos 容器</span></span><br><span class="line"></span><br><span class="line"><span class="attr">在</span> <span class="string">Pod 的 YAML 文件里声明开启它们俩，等同于设置了 docker run 里的 -it（-i 即 stdin，-t 即 tty）参数。此 Pod 被创建后，就可以使用 shell 容器的 tty 跟这个容器进行交互了。</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">我们通过kubectl可以查看到</span><br><span class="line"># kubectl exec -it website -c busybox -- ps aux</span><br><span class="line">PID   USER     TIME  COMMAND</span><br><span class="line">    1 root      0:00 /pause</span><br><span class="line">    7 root      0:00 nginx: master process nginx -g daemon off;</span><br><span class="line">   35 101       0:00 nginx: worker process</span><br><span class="line">   36 root      0:00 sh</span><br><span class="line">   66 root      0:00 ps aux</span><br><span class="line">   </span><br><span class="line">在busybox中可以查看到nginx的进程</span><br></pre></td></tr></table></figure>

<h5 id="8-5-2-pod共用宿主机namespace"><a href="#8-5-2-pod共用宿主机namespace" class="headerlink" title="8.5.2 pod共用宿主机namespace"></a>8.5.2 pod共用宿主机namespace</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">刚才的都是pod里面容器的Namespace，并没有和本机的Namespace做共享，接下来我们可以做与本机的Namespace共享，可以在容器里面看到本机的进程。</span><br><span class="line"></span><br><span class="line">[root@kub-k8s-master prome]# kubectl delete -f pod.yml </span><br><span class="line">pod &quot;website&quot; deleted</span><br><span class="line">[root@kub-k8s-master prome]# vim pod.yml #修改如下</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: website</span><br><span class="line">  labels:</span><br><span class="line">    app: website</span><br><span class="line">spec:</span><br><span class="line">  hostNetwork: true  #共享宿主机网络</span><br><span class="line">  hostIPC: true  #共享ipc通信</span><br><span class="line">  hostPID: true  #共享宿主机的pid</span><br><span class="line">  containers:</span><br><span class="line">    - name: test-web</span><br><span class="line">      image: daocloud.io/library/nginx</span><br><span class="line">      ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">    - name: busybos</span><br><span class="line">      image: daocloud.io/library/busybox</span><br><span class="line">      stdin: true</span><br><span class="line">      tty: true</span><br><span class="line">创建pod</span><br><span class="line">[root@kub-k8s-master prome]# kubectl apply -f pod.yml </span><br><span class="line">pod/website created</span><br></pre></td></tr></table></figure>

<p><img src="https://img.beyourself.org.cn/abc/1571586498134.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_35,text_6KW_5a6J5Y2D6ZSL5LqR6K6h566X,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10#id=OgWl6&originHeight=95&originWidth=1243&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p><img src="https://img.beyourself.org.cn/abc/1571586551112.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_25,text_6KW_5a6J5Y2D6ZSL5LqR6K6h566X,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10#id=KiU47&originHeight=355&originWidth=887&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p>定义了共享宿主机的 Network、IPC 和 PID Namespace。这样，此 Pod 里的所有容器，会直接使用宿主机的网络、直接与宿主机进行 IPC 通信、看到宿主机里正在运行的所有进程。</p>
<h4 id="8-6-钩子函数lifecycle"><a href="#8-6-钩子函数lifecycle" class="headerlink" title="8.6 钩子函数lifecycle"></a>8.6 钩子函数lifecycle</h4><blockquote>
<h2 id="kubernetes-在主容器启动之后和删除之前提供了两个钩子函数：-post-start：容器创建之后执行，如果失败会重启容器-pre-stop：容器删除之前执行，执行完成之后容器将成功删除，在其完成之前会阻塞删除容器的操作-钩子函数有三种定义方式-第一种-exec-执行指令"><a href="#kubernetes-在主容器启动之后和删除之前提供了两个钩子函数：-post-start：容器创建之后执行，如果失败会重启容器-pre-stop：容器删除之前执行，执行完成之后容器将成功删除，在其完成之前会阻塞删除容器的操作-钩子函数有三种定义方式-第一种-exec-执行指令" class="headerlink" title="kubernetes 在主容器启动之后和删除之前提供了两个钩子函数：-  post start：容器创建之后执行，如果失败会重启容器-  pre stop：容器删除之前执行，执行完成之后容器将成功删除，在其完成之前会阻塞删除容器的操作-  钩子函数有三种定义方式-  第一种 exec 执行指令 "></a>kubernetes 在主容器启动之后和删除之前提供了两个钩子函数：<br><br>-  post start：容器创建之后执行，如果失败会重启容器<br>-  pre stop：容器删除之前执行，执行完成之后容器将成功删除，在其完成之前会阻塞删除容器的操作<br>-  钩子函数有三种定义方式<br>-  第一种 exec 执行指令 </h2><ul>
<li>第二种 在容器中请求端口 </li>
<li></li>
<li>第三种 向容器发起http请求 </li>
<li></li>
</ul>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">lifecycle:</span></span><br><span class="line">  <span class="attr">postStart:</span> </span><br><span class="line">    <span class="attr">exec:</span></span><br><span class="line">      <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">cat</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/etc/hosts</span></span><br></pre></td></tr></table></figure>
<blockquote>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">lifecycle:</span></span><br><span class="line">  <span class="attr">postStart:</span></span><br><span class="line">    <span class="attr">tcpSocket:</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>
<blockquote>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">lifecycle:</span></span><br><span class="line">  <span class="attr">postStart:</span></span><br><span class="line">    <span class="attr">httpGet:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/</span>                  <span class="comment"># URI地址</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span>                 <span class="comment"># 端口号</span></span><br><span class="line">      <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.75</span><span class="number">.100</span>     <span class="comment"># 主机地址  </span></span><br><span class="line">      <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br></pre></td></tr></table></figure>
<blockquote>
</blockquote>
<h5 id="一个钩子函数的示例"><a href="#一个钩子函数的示例" class="headerlink" title="一个钩子函数的示例"></a>一个钩子函数的示例</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">nginx-lifecycle.yaml</span> </span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-lifecycle</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-lifecycle</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx:1.16.1</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">lifecycle:</span></span><br><span class="line">        <span class="attr">postStart:</span></span><br><span class="line">          <span class="attr">exec:</span></span><br><span class="line">            <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;echo &#x27;&lt;h1&gt;this is a nginx-lifecycle test page&lt;/h1&gt;&#x27; &gt; /usr/share/nginx/html/index.html&quot;</span>]</span><br><span class="line">        <span class="attr">preStop:</span></span><br><span class="line">          <span class="attr">exec:</span></span><br><span class="line">            <span class="attr">command:</span> [<span class="string">&quot;/usr/sbin/nginx&quot;</span>, <span class="string">&quot;-s&quot;</span>, <span class="string">&quot;quit&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">nginx-lifecycle.yaml</span> </span><br><span class="line"><span class="string">pod/pod-lifecycle</span> <span class="string">created</span></span><br></pre></td></tr></table></figure>

<h3 id="九-容器监控检查及恢复机制"><a href="#九-容器监控检查及恢复机制" class="headerlink" title="九.容器监控检查及恢复机制"></a>九.容器监控检查及恢复机制</h3><blockquote>
<p>在 k8s 中，可以为 Pod 里的容器定义一个健康检查”探针”（Probe）。kubelet 就会根据这个 Probe 的返回值决定这个容器的状态，而不是直接以容器是否运行（来自 Docker 返回的信息）作为依据。这种机制，是生产环境中保证应用健康存活的重要手段。</p>
</blockquote>
<h4 id="9-1-命令模式探针"><a href="#9-1-命令模式探针" class="headerlink" title="9.1 命令模式探针"></a>9.1 命令模式探针</h4><p>Kubernetes 文档中的例子:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@kub-k8s-master1 ~]# cd prome/</span><br><span class="line">[root@kub-k8s-master prome]# vim test-liveness-exec.yaml</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    test: liveness</span><br><span class="line">  name: test-liveness-exec</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: liveness</span><br><span class="line">    image: daocloud.io/library/nginx</span><br><span class="line">    args:</span><br><span class="line">    - /bin/sh</span><br><span class="line">    - -c  </span><br><span class="line">    - touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 50</span><br><span class="line">    livenessProbe:    #探针，健康检查</span><br><span class="line">      exec:    #类型</span><br><span class="line">        command:  #命令</span><br><span class="line">        - cat </span><br><span class="line">        - /tmp/healthy</span><br><span class="line">      initialDelaySeconds: 5   #健康检查，在容器启动5s后开始执行</span><br><span class="line">      periodSeconds: 5   #每5s执行一次</span><br><span class="line">它在启动之后做的第一件事是在/tmp目录下创建了一个healthy文件，以此作为自己已经正常运行的标志。而30s过后，它会把这个文件删除掉。</span><br><span class="line">与此同时，定义了一个这样的 livenessProbe（健康检查）。它的类型是 exec，它会在容器启动后，在容器里面执行一句我们指定的命令，比如：&quot;cat /tmp/healthy&quot;。这时，如果这个文件存在，这条命令的返回值就是 0，Pod就会认为这个容器不仅已经启动，而且是健康的。这个健康检查，在容器启动5s后开始执行（initialDelaySeconds: 5），每5s执行一次（periodSeconds: 5）。</span><br></pre></td></tr></table></figure>

<p>创建Pod：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@kub-k8s-master prome]# kubectl apply -f test-liveness-exec.yaml </span><br><span class="line">pod/test-liveness-exec created</span><br></pre></td></tr></table></figure>

<p>查看 Pod 的状态：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@kub-k8s-master prome]# kubectl get pod </span><br><span class="line">NAME                    READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-configmap         1/1     Running   0          16h</span><br><span class="line">nginx-pod               1/1     Running   0          12h</span><br><span class="line">test-liveness-exec      1/1     Running   0          75s</span><br></pre></td></tr></table></figure>

<p>由于已经通过了健康检查，这个 Pod 就进入了 Running 状态。</p>
<p>然后30 s 之后，再查看一下 Pod 的 Events：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@kub-k8s-master prome]# kubectl describe pod test-liveness-exec</span><br></pre></td></tr></table></figure>

<p>发现，这个 Pod 在 Events 报告了一个异常：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Events:</span><br><span class="line">  Type     Reason     Age                  From                    Message</span><br><span class="line">  ----     ------     ----                 ----                    -------</span><br><span class="line">Warning  Unhealthy  54s (x9 over 3m34s)  kubelet, kub-k8s-node1  Liveness probe failed: cat: /tmp/healthy: No such file or directory</span><br></pre></td></tr></table></figure>

<p>这个健康检查探查到 &#x2F;tmp&#x2F;healthy 已经不存在了，所以它报告容器是不健康的。那么接下来会发生什么呢？</p>
<p>再次查看一下这个 Pod 的状态：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@kub-k8s-master prome]# kubectl get pod test-liveness-exec</span><br><span class="line">NAME                 READY   STATUS    RESTARTS   AGE</span><br><span class="line">test-liveness-exec   1/1     Running   4          5m19s</span><br></pre></td></tr></table></figure>

<p>这时发现，Pod 并没有进入 Failed 状态，而是保持了 Running 状态。这是为什么呢？</p>
<blockquote>
<p>RESTARTS 字段从 0 到 1 的变化，就明白原因了：这个异常的容器已经被 Kubernetes 重启了。在这个过程中，Pod 保持 Running 状态不变。<br>#注<br>k8s 中并没有 Docker 的 Stop 语义。所以如果容器被探针检测到有问题，查看状态虽然看到的是 Restart，但实际却是重新创建了容器。</p>
<p>这个功能就是 Kubernetes 里的Pod 恢复机制，也叫 restartPolicy。它是 Pod 的 Spec 部分的一个标准字段（pod.spec.restartPolicy），默认值是 Always，即：任何时候这个容器发生了异常，它一定会被重新创建。</p>
</blockquote>
<p>小提示：</p>
<blockquote>
<pre><code>Pod 的恢复过程，永远都是发生在当前节点上，而不会跑到别的节点上去。事实上，一旦一个 Pod 与一个节点（Node）绑定，除非这个绑定发生了变化（pod.spec.node 字段被修改），否则它永远都不会离开这个节点。这也就意味着，如果这个宿主机宕机了，这个 Pod 也不会主动迁移到其他节点上去。
</code></pre>
</blockquote>
<h4 id="9-2-http-get方式探针"><a href="#9-2-http-get方式探针" class="headerlink" title="9.2 http get方式探针"></a>9.2 http get方式探针</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@kub-k8s-master prome]# vim liveness-httpget.yaml</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: liveness-httpget-pod</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">    - name: liveness-exec-container</span><br><span class="line">      image: daocloud.io/library/nginx</span><br><span class="line">      imagePullPolicy: IfNotPresent</span><br><span class="line">      ports:</span><br><span class="line">        - name: http</span><br><span class="line">          containerPort: 80</span><br><span class="line">      livenessProbe:  #探针，健康检查</span><br><span class="line">        httpGet:</span><br><span class="line">          port: http</span><br><span class="line">          path: /index.html</span><br><span class="line">        initialDelaySeconds: 1</span><br><span class="line">        periodSeconds: 3</span><br></pre></td></tr></table></figure>

<p>创建该pod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@kub-k8s-master prome]# kubectl create -f liveness-httpget.yaml </span><br><span class="line">pod/liveness-httpget-pod created</span><br></pre></td></tr></table></figure>

<p>查看当前pod的状态</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@kub-k8s-master prome]# kubectl describe pod liveness-httpget-pod</span><br><span class="line">...</span><br><span class="line">Liveness:       http-get http://:http/index.html delay=1s timeout=1s period=3s #success=1 #failure=3</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>登陆容器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">测试将容器内的index.html删除掉</span><br><span class="line">[root@kub-k8s-master prome]# kubectl exec -it liveness-httpget-pod /bin/bash</span><br><span class="line">root@liveness-httpget-pod:/# mv /usr/share/nginx/html/index.html index.html</span><br><span class="line">root@liveness-httpget-pod:/# command terminated with exit code 137</span><br><span class="line">可以看到，当把index.html移走后，这个容器立马就退出了。</span><br></pre></td></tr></table></figure>

<p>此时，查看pod的信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@kub-k8s-master prome]# kubectl describe pod liveness-httpget-pod</span><br><span class="line">...</span><br><span class="line">Normal   Killing    49s                  kubelet, kub-k8s-node2  Container liveness-exec-container failed liveness probe, will be restarted</span><br><span class="line">  Normal   Pulled     49s                  kubelet, kub-k8s-node2  Container image &quot;daocloud.io/library/nginx&quot; already present on machine</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>看输出，容器由于健康检查未通过，pod会被杀掉，并重新创建</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@kub-k8s-master prome]#  kubectl get pods</span><br><span class="line">NAME                    READY   STATUS             RESTARTS   AGE</span><br><span class="line">lifecycle-demo          1/1     Running            1          34h</span><br><span class="line">liveness-httpget-pod    1/1     Running            1          5m42s</span><br><span class="line"></span><br><span class="line">#restarts 为 1</span><br></pre></td></tr></table></figure>

<p>重新登陆容器，发现index.html又出现了，证明容器是被重拉了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@kub-k8s-master prome]# kubectl exec -it liveness-httpget-pod /bin/bash</span><br><span class="line">root@liveness-httpget-pod:/# cat /usr/share/nginx/html/index.html</span><br></pre></td></tr></table></figure>

<h4 id="9-3-POD-的恢复策略"><a href="#9-3-POD-的恢复策略" class="headerlink" title="9.3 POD 的恢复策略"></a>9.3 POD 的恢复策略</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Pod  恢复策略：</span><br><span class="line">可以通过设置 restartPolicy，改变 Pod 的恢复策略。一共有3种：</span><br><span class="line">    1. Always：      在任何情况下，只要容器不在运行状态，就自动重启容器；</span><br><span class="line">    2. OnFailure:    只在容器 异常时才自动重启容器；</span><br><span class="line">    3. Never:         从来不重启容器。</span><br><span class="line">实际使用时，需要根据应用运行的特性，合理设置这三种恢复策略。</span><br></pre></td></tr></table></figure>

<h3 id="十-投射数据卷-Projected-Volume"><a href="#十-投射数据卷-Projected-Volume" class="headerlink" title="十.投射数据卷 Projected Volume"></a>十.投射数据卷 Projected Volume</h3><blockquote>
<p>注：Projected Volume 是 Kubernetes v1.11 之后的新特性</p>
</blockquote>
<h4 id="10-1-什么是Projected-Volume"><a href="#10-1-什么是Projected-Volume" class="headerlink" title="10.1 什么是Projected Volume"></a>10.1 什么是Projected Volume</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">在</span> <span class="string">k8s 中，有几种特殊的 Volume，它们的意义不是为了存放容器里的数据，&quot;而是为容器提供预先定义好的数据。&quot;</span></span><br><span class="line"><span class="attr">从容器的角度来看，这些</span> <span class="string">Volume 里的信息仿佛是被 k8s &quot;投射&quot;（Project）进入容器当中的。</span></span><br></pre></td></tr></table></figure>

<h4 id="10-2-k8s-支持的-Projected-Volume-方式"><a href="#10-2-k8s-支持的-Projected-Volume-方式" class="headerlink" title="10.2 k8s 支持的 Projected Volume 方式"></a>10.2 k8s 支持的 Projected Volume 方式</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Secret</span></span><br><span class="line"><span class="attr">ConfigMap</span></span><br><span class="line"><span class="attr">Downward</span> <span class="string">API</span></span><br></pre></td></tr></table></figure>

<h3 id="十一-Secret-实现"><a href="#十一-Secret-实现" class="headerlink" title="十一.Secret 实现"></a>十一.Secret 实现</h3><h4 id="11-1-secret-详解"><a href="#11-1-secret-详解" class="headerlink" title="11.1 secret  详解"></a>11.1 secret  详解</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">secret用来保存小片敏感数据的k8s资源，例如密码，token，或者秘钥。这类数据当然也可以存放在Pod或者镜像中，但是放在Secret中是为了更方便的控制如何使用数据，并减少暴露的风险。</span></span><br><span class="line"> </span><br><span class="line"> <span class="attr">用户可以创建自己的secret，系统也会有自己的secret。</span></span><br><span class="line"> <span class="attr">Pod需要先引用才能使用某个secret</span></span><br></pre></td></tr></table></figure>

<p>Pod使用secret方式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">作为volume的一个域被一个或多个容器挂载</span><br></pre></td></tr></table></figure>

<p>內建的Secrets:</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">由ServiceAccount创建的API证书附加的秘钥k8s自动生成的用来访问apiserver的Secret，所有Pod会默认使用这个Secret与apiserver通信</span></span><br></pre></td></tr></table></figure>

<p>创建自己的Secret:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">方式1：使用kubectl create secret命令</span><br><span class="line">方式2：yaml文件创建Secret</span><br></pre></td></tr></table></figure>

<ol>
<li></li>
</ol>
<p><img src="C:\Users\曹俊龙\AppData\Roaming\Typora\typora-user-images\image-20240815102640049.png" alt="image-20240815102640049"></p>
<p><img src="https://guangxipengyuyan.oss-cn-guangzhou.aliyuncs.com/image-20240815102720076.png" alt="image-20240815102720076"></p>
<p>2.yml</p>
<p><img src="https://guangxipengyuyan.oss-cn-guangzhou.aliyuncs.com/image-20240815102905937.png" alt="image-20240815102905937"></p>
<p><img src="https://guangxipengyuyan.oss-cn-guangzhou.aliyuncs.com/image-20240815103136552.png" alt="image-20240815103136552"></p>
<h4 id="11-2-secret-使用"><a href="#11-2-secret-使用" class="headerlink" title="11.2 secret 使用"></a>11.2 secret 使用</h4><p>创建Secret</p>
<p>假如某个Pod要访问数据库，需要用户名密码，现在我们分别设置这个用户名和密码<br>Secret 对象要求这些数据必须是经过 Base64 转码的，以免出现明文密码显示的安全隐患。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">创建一个secret.yaml文件，内容用base64编码</span>:<span class="string">明文显示容易被别人发现，这里先转码。</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master1</span> <span class="string">~]# echo -n &#x27;admin&#x27; | base64  （-n  表示去掉换行符进行加密编码）</span></span><br><span class="line"><span class="attr">YWRtaW4</span>=<span class="string"></span></span><br><span class="line"><span class="attr">[root@kub-k8s-master1</span> <span class="string">~]# echo -n &#x27;1f2d1e2e67df&#x27; | base64</span></span><br><span class="line"><span class="attr">MWYyZDFlMmU2N2Rm</span></span><br></pre></td></tr></table></figure>

<p>创建一个secret.yaml文件，内容用base64编码</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# vim secret.yml</span></span><br><span class="line"><span class="attr">---</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">v1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">mysecret</span></span><br><span class="line"><span class="attr">type</span>: <span class="string">Opaque  #模糊</span></span><br><span class="line"><span class="attr">data</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">username</span>: <span class="string">YWRtaW4=</span></span><br><span class="line">  <span class="attr">password</span>: <span class="string">MWYyZDFlMmU2N2Rm</span></span><br></pre></td></tr></table></figure>

<p>创建：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl apply -f secret.yml </span></span><br><span class="line"><span class="attr">secret/mysecret</span> <span class="string">created</span></span><br></pre></td></tr></table></figure>

<p>解析Secret中内容,还是经过编码的—需要解码</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">查看secret</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master1</span> <span class="string">~]# kubectl get secrets</span></span><br><span class="line"><span class="attr">NAME</span>                  <span class="string">TYPE                                  DATA   AGE</span></span><br><span class="line"><span class="attr">default-token-7vc82</span>   <span class="string">kubernetes.io/service-account-token   3      30h</span></span><br><span class="line"><span class="attr">mysecret</span>              <span class="string">Opaque                                2      6s</span></span><br><span class="line"></span><br><span class="line"><span class="attr">查看secret详细信息</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl get secret mysecret -o yaml</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">v1</span></span><br><span class="line"><span class="attr">data</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">password</span>: <span class="string">MWYyZDFlMmU2N2Rm</span></span><br><span class="line">  <span class="attr">username</span>: <span class="string">YWRtaW4=</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">creationTimestamp</span>: <span class="string">&quot;2019-10-21T03:07:56Z&quot;</span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">mysecret</span></span><br><span class="line">  <span class="attr">namespace</span>: <span class="string">default</span></span><br><span class="line">  <span class="attr">resourceVersion</span>: <span class="string">&quot;162855&quot;</span></span><br><span class="line">  <span class="attr">selfLink</span>: <span class="string">/api/v1/namespaces/default/secrets/mysecret</span></span><br><span class="line">  <span class="attr">uid</span>: <span class="string">36bcd07d-92eb-4755-ac0a-a5843ed986dd</span></span><br><span class="line"><span class="attr">type</span>: <span class="string">Opaque</span></span><br></pre></td></tr></table></figure>

<p>手动base64解码方式:</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@kub-k8s-master1</span> <span class="string">~]# echo &#x27;MWYyZDFlMmU2N2Rm&#x27; | base64 --decode</span></span><br></pre></td></tr></table></figure>

<h4 id="11-3-使用Secret"><a href="#11-3-使用Secret" class="headerlink" title="11.3 使用Secret"></a>11.3 使用Secret</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">secret可以作为数据卷挂载或者作为环境变量暴露给Pod中的容器使用，也可以被系统中的其他资源使用。</span></span><br></pre></td></tr></table></figure>

<p>一个Pod中引用Secret的列子：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">创建一个Secret，多个Pod可以引用同一个Secret</span></span><br><span class="line"></span><br><span class="line"><span class="attr">修改Pod的定义，在spec.volumes[]加一个volume，给这个volume起个名字，spec.volumes[].secret.secretName记录的是要引用的Secret名字</span></span><br></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# vim pod_use_secret.yaml</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">v1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">mypod</span></span><br><span class="line"><span class="attr">spec</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">containers</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">-</span> <span class="string">name: testredis</span></span><br><span class="line">    <span class="attr">image</span>: <span class="string">daocloud.io/library/redis</span></span><br><span class="line">    <span class="attr">volumeMounts</span>:    <span class="string">#挂载一个卷</span></span><br><span class="line">    <span class="attr">-</span> <span class="string">name: foo     #这个名字需要与定义的卷的名字一致</span></span><br><span class="line">      <span class="attr">mountPath</span>: <span class="string">&quot;/etc/foo&quot;  #挂载到容器里哪个目录下，随便写</span></span><br><span class="line">      <span class="attr">readOnly</span>: <span class="string">true</span></span><br><span class="line">  <span class="attr">volumes</span>:     <span class="string">#数据卷的定义</span></span><br><span class="line">  <span class="attr">-</span> <span class="string">name: foo   #卷的名字这个名字自定义</span></span><br><span class="line">    <span class="attr">secret</span>:    <span class="string">#卷是直接使用的secret。</span></span><br><span class="line">      <span class="attr">secretName</span>: <span class="string">mysecret   #调用刚才定义的secret</span></span><br><span class="line">      </span><br><span class="line"><span class="attr">创建：</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl apply -f pod_use_secret.yaml </span></span><br><span class="line"><span class="attr">pod/mypod</span> <span class="string">created</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl exec -it mypod /bin/bash</span></span><br><span class="line"><span class="attr">root@mypod</span>:<span class="string">/data# cd /etc/foo/</span></span><br><span class="line"><span class="attr">root@mypod</span>:<span class="string">/etc/foo# ls</span></span><br><span class="line"><span class="attr">password</span>  <span class="string">username</span></span><br><span class="line"><span class="attr">root@mypod</span>:<span class="string">/etc/foo# cat password </span></span><br><span class="line"><span class="attr">1f2d1e2e67df</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">结果中看到，保存在 Etcd 里的用户名和密码信息，已经以文件的形式出现在了容器的 Volume 目录里。</span><br><span class="line">而这个文件的名字，就是 kubectl create secret 指定的 Key，或者说是 Secret 对象的 data 字段指定的 Key。</span><br></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">每一个被引用的Secret都要在spec.volumes中定义</span></span><br><span class="line"> <span class="attr">如果Pod中的多个容器都要引用这个Secret那么每一个容器定义中都要指定自己的volumeMounts，但是Pod定义中声明一次spec.volumes就好了。</span></span><br></pre></td></tr></table></figure>

<p><strong>映射secret key到指定的路径</strong></p>
<p>可以控制secret key被映射到容器内的路径，利用spec.volumes[].secret.items来修改被映射的具体路径</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl delete -f pod_use_secret.yaml </span></span><br><span class="line"><span class="attr">pod</span> <span class="string">&quot;mypod&quot; deleted</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# vim pod_use_secret.yaml</span></span><br><span class="line"><span class="attr">---</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">v1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line"> <span class="attr">name</span>: <span class="string">mypod</span></span><br><span class="line"><span class="attr">spec</span>:<span class="string"></span></span><br><span class="line"> <span class="attr">containers</span>:<span class="string"></span></span><br><span class="line"> <span class="attr">-</span> <span class="string">name: testredis</span></span><br><span class="line">   <span class="attr">image</span>: <span class="string">daocloud.io/library/redis</span></span><br><span class="line">   <span class="attr">volumeMounts</span>:<span class="string"></span></span><br><span class="line">   <span class="attr">-</span> <span class="string">name: foo</span></span><br><span class="line">     <span class="attr">mountPath</span>: <span class="string">&quot;/etc/foo&quot;</span></span><br><span class="line">     <span class="attr">readOnly</span>: <span class="string">true</span></span><br><span class="line"> <span class="attr">volumes</span>:<span class="string"></span></span><br><span class="line"> <span class="attr">-</span> <span class="string">name: foo</span></span><br><span class="line">   <span class="attr">secret</span>:<span class="string"></span></span><br><span class="line">     <span class="attr">secretName</span>: <span class="string">mysecret</span></span><br><span class="line">     <span class="attr">items</span>:   <span class="string">#定义一个items</span></span><br><span class="line">      <span class="attr">-</span> <span class="string">key: username   #将那个key重新定义到那个目录下</span></span><br><span class="line">        <span class="attr">path</span>: <span class="string">my-group/my-username  #相对路径，相对于/etc/foo的路径</span></span><br><span class="line">       </span><br><span class="line"><span class="attr">2.创建</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl apply -f pod_use_secret.yaml </span></span><br><span class="line"><span class="attr">pod/mypod</span> <span class="string">created</span></span><br><span class="line"><span class="attr">3.从volume中读取secret的值</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl exec -it mypod /bin/bash                         </span></span><br><span class="line"><span class="attr">root@mypod</span>:<span class="string">/data# cd /etc/foo/my-group</span></span><br><span class="line"><span class="attr">root@mypod</span>:<span class="string">/etc/foo/my-group# ls</span></span><br><span class="line"><span class="attr">my-username</span></span><br><span class="line"><span class="attr">root@mypod</span>:<span class="string">/etc/foo/my-group# cat my-username </span></span><br><span class="line"><span class="attr">admin</span></span><br><span class="line"><span class="attr">root@mypod</span>:<span class="string">/etc/foo/my-group#</span></span><br></pre></td></tr></table></figure>

<p>username被映射到了文件&#x2F;etc&#x2F;foo&#x2F;my-group&#x2F;my-username而不是&#x2F;etc&#x2F;foo&#x2F;username,而password没有被使用,这种方式每个key的调用需要单独用key像username一样调用</p>
<p><strong>被挂载的secret内容自动更新</strong></p>
<p>也就是如果修改一个Secret的内容，那么挂载了该Secret的容器中也将会取到更新后的值，但是这个时间间隔是由kubelet的同步时间决定的。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">1.设置base64加密</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# echo qianfeng | base64</span></span><br><span class="line"><span class="attr">cWlhbmZlbmcK</span></span><br><span class="line"><span class="attr">2.将admin替换成qianfeng</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# vim secret.yml</span></span><br><span class="line"><span class="attr">---</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">v1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">mysecret</span></span><br><span class="line"><span class="attr">type</span>: <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">username</span>: <span class="string">cWlhbmZlbmcK   #修改为qianfeng的base64加密后的</span></span><br><span class="line">  <span class="attr">password</span>: <span class="string">MWYyZDFlMmU2N2Rm</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">1.创建</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl apply -f secret.yml </span></span><br><span class="line"><span class="attr">Warning</span>: <span class="string">kubectl apply should be used on resource created by either kubectl create --save-config or kubectl apply</span></span><br><span class="line"><span class="attr">secret/mysecret</span> <span class="string">configured</span></span><br><span class="line"><span class="attr">2.连接pod容器</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl exec -it mypod /bin/bash</span></span><br><span class="line"><span class="attr">root@mypod</span>:<span class="string">/data# cd /etc/foo/my-group</span></span><br><span class="line"><span class="attr">root@mypod</span>:<span class="string">/etc/foo/my-group# ls</span></span><br><span class="line"><span class="attr">my-username</span></span><br><span class="line"><span class="attr">root@mypod</span>:<span class="string">/etc/foo/my-group# cat my-username </span></span><br><span class="line"><span class="attr">qianfeng</span></span><br></pre></td></tr></table></figure>

<p><strong>以环境变量的形式使用Secret</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl delete -f pod_use_secret.yaml </span></span><br><span class="line"><span class="attr">pod</span> <span class="string">&quot;mypod&quot; deleted</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# vim pod_use_secret.yaml</span></span><br><span class="line"><span class="attr">---</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">v1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">mypod</span></span><br><span class="line"><span class="attr">spec</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">containers</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">-</span> <span class="string">name: testredis</span></span><br><span class="line">    <span class="attr">image</span>: <span class="string">daocloud.io/library/redis</span></span><br><span class="line">    <span class="attr">env</span>:  <span class="string">#定义环境变量</span></span><br><span class="line">     <span class="attr">-</span> <span class="string">name: SECRET_USERNAME   #创建新的环境变量名称</span></span><br><span class="line">       <span class="attr">valueFrom</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">secretKeyRef</span>:     <span class="string">#调用的key是什么</span></span><br><span class="line">         <span class="attr">name</span>: <span class="string">mysecret       #变量的值来自于mysecret</span></span><br><span class="line">         <span class="attr">key</span>: <span class="string">username       #username里面的值</span></span><br><span class="line"></span><br><span class="line"><span class="attr">2.创建使用secret的pod容器</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl apply -f pod_use_secret.yaml </span></span><br><span class="line"><span class="attr">pod/mypod</span> <span class="string">created</span></span><br><span class="line"><span class="attr">3.连接</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl exec -it mypod /bin/bash </span></span><br><span class="line"><span class="attr">root@mypod</span>:<span class="string">/data# echo $SECRET_USERNAME   #打印一下定义的变量</span></span><br><span class="line"><span class="attr">qianfeng</span></span><br></pre></td></tr></table></figure>

<h4 id="11-4-实战案例"><a href="#11-4-实战案例" class="headerlink" title="11.4 实战案例"></a>11.4 实战案例</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">1.创建数据库用户的密码secret</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">test]# echo -n &#x27;QianFeng@123!&#x27; | base64</span></span><br><span class="line"><span class="attr">UWlhbkZlbmdAMTIzIQ</span>=<span class="string">=</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">test]# cat secret.yml </span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">v1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line"> <span class="attr">name</span>: <span class="string">mysql-secret</span></span><br><span class="line"><span class="attr">type</span>: <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data</span>:<span class="string"></span></span><br><span class="line"> <span class="attr">password</span>: <span class="string">UWlhbkZlbmdAMTIzIQ==</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">test]# kubectl apply -f secret.yml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">2.创建数据库并使用secret</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">test]# cat mysql.yaml </span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">v1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line"> <span class="attr">name</span>: <span class="string">my-mysql</span></span><br><span class="line"><span class="attr">spec</span>:<span class="string"></span></span><br><span class="line"> <span class="attr">containers</span>:<span class="string"></span></span><br><span class="line"> <span class="attr">-</span> <span class="string">name: mysql</span></span><br><span class="line">   <span class="attr">image</span>: <span class="string">daocloud.io/library/mysql:5.7</span></span><br><span class="line">   <span class="attr">ports</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">-</span> <span class="string">containerPort: 3306</span></span><br><span class="line">   <span class="attr">env</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">-</span> <span class="string">name: MYSQL_ROOT_PASSWORD</span></span><br><span class="line">      <span class="attr">valueFrom</span>:<span class="string"></span></span><br><span class="line">       <span class="attr">secretKeyRef</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">name</span>: <span class="string">mysql-secret</span></span><br><span class="line">        <span class="attr">key</span>: <span class="string">password</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">test]# kubectl apply -f myslq.yaml</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">test]# kubectl get pod -o wide </span></span><br><span class="line"><span class="attr">NAME</span>       <span class="string">READY   STATUS    RESTARTS   AGE     IP            NODE    NOMINATED NODE   READINESS GATES</span></span><br><span class="line"><span class="attr">my-mysql</span>   <span class="string">1/1     Running   0          2m47s   10.244.2.13   node2   &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">测试</span>:<span class="string"></span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">test]# mysql -uroot -p&#x27;QianFeng@123!&#x27; -h 10.244.2.13 -P3306</span></span><br></pre></td></tr></table></figure>

<h3 id="十二-ConfigMap祥解"><a href="#十二-ConfigMap祥解" class="headerlink" title="十二.ConfigMap祥解"></a>十二.ConfigMap祥解</h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ConfigMap与</span> <span class="string">Secret 类似，用来存储配置文件的kubernetes资源对象，所有的配置内容都存储在etcd中。</span></span><br></pre></td></tr></table></figure>

<p>与 Secret 的区别：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ConfigMap</span> <span class="string">保存的是不需要加密的、应用所需的配置信息。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ConfigMap</span> <span class="string">的用法几乎与 Secret 完全相同：可以使用 kubectl create configmap 从文件或者目录创建 ConfigMap，也可以直接编写 ConfigMap 对象的 YAML 文件。</span></span><br></pre></td></tr></table></figure>

<h4 id="12-1-创建ConfigMap的方式"><a href="#12-1-创建ConfigMap的方式" class="headerlink" title="12.1 创建ConfigMap的方式"></a>12.1 创建ConfigMap的方式</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">创建ConfigMap的方式有4种：</span></span><br><span class="line"></span><br><span class="line"><span class="attr">命令行方式</span></span><br><span class="line"><span class="attr">方式1：通过直接在命令行中指定configmap参数创建，即--from-literal</span></span><br><span class="line"><span class="attr">方式2：通过指定文件创建，即将一个配置文件创建为一个ConfigMap，--from-file</span>=<span class="string">&lt;文件&gt;</span></span><br><span class="line"><span class="attr">方式3：通过指定目录创建，即将一个目录下的所有配置文件创建为一个ConfigMap，--from-file</span>=<span class="string">&lt;目录&gt;</span></span><br><span class="line"><span class="attr">配置文件方式</span></span><br><span class="line"><span class="attr">方式4：事先写好标准的configmap的yaml文件，然后kubectl</span> <span class="string">create -f 创建</span></span><br></pre></td></tr></table></figure>

<h4 id="12-2-通过命令行参数创建"><a href="#12-2-通过命令行参数创建" class="headerlink" title="12.2 通过命令行参数创建"></a>12.2 通过命令行参数创建</h4><p>创建命令：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl create configmap test-configmap --from-literal=user=admin --from-literal=pass=1122334</span></span><br><span class="line"><span class="attr">configmap/test-configmap</span> <span class="string">created</span></span><br></pre></td></tr></table></figure>

<p>结果如下面的data内容所示：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl get configmap test-configmap -o yaml</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">v1</span></span><br><span class="line"><span class="attr">data</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">pass</span>: <span class="string">&quot;1122334&quot;</span></span><br><span class="line">  <span class="attr">user</span>: <span class="string">admin</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">creationTimestamp</span>: <span class="string">&quot;2019-10-21T07:48:15Z&quot;</span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">test-configmap</span></span><br><span class="line">  <span class="attr">namespace</span>: <span class="string">default</span></span><br><span class="line">  <span class="attr">resourceVersion</span>: <span class="string">&quot;187590&quot;</span></span><br><span class="line">  <span class="attr">selfLink</span>: <span class="string">/api/v1/namespaces/default/configmaps/test-configmap</span></span><br><span class="line">  <span class="attr">uid</span>: <span class="string">62a8a0d0-fab9-4159-86f4-a06aa213f4b1</span></span><br></pre></td></tr></table></figure>

<h4 id="12-3-通过指定文件创建"><a href="#12-3-通过指定文件创建" class="headerlink" title="12.3 通过指定文件创建"></a>12.3 通过指定文件创建</h4><p>编辑文件server.conf内容如下：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# vim server.conf</span></span><br><span class="line"><span class="attr">server</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">listen</span> <span class="string">80;</span></span><br><span class="line"><span class="attr">server_name</span> <span class="string">localhost;</span></span><br><span class="line"><span class="attr">location</span> <span class="string">/ &#123;</span></span><br><span class="line"><span class="attr">root</span> <span class="string">/var/www/html;</span></span><br><span class="line"><span class="attr">index</span> <span class="string">index.html index.htm;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure>

<p>创建（可以有多个–from-file）：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl create configmap test-config2 --from-file=server.conf</span></span><br><span class="line"><span class="attr">configmap/test-config2</span> <span class="string">created</span></span><br></pre></td></tr></table></figure>

<p>结果如下面data内容所示：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl get configmap test-config2 -o yaml</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">v1</span></span><br><span class="line"><span class="attr">data</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">server.conf</span>: <span class="string">|</span></span><br><span class="line">    <span class="attr">server</span> <span class="string">&#123;</span></span><br><span class="line">    <span class="attr">listen</span> <span class="string">80;</span></span><br><span class="line">    <span class="attr">server_name</span> <span class="string">localhost;</span></span><br><span class="line">    <span class="attr">localtion</span> <span class="string">/ &#123;</span></span><br><span class="line">    <span class="attr">root</span> <span class="string">/var/www/html;</span></span><br><span class="line">    <span class="attr">index</span> <span class="string">index.html index.htm;</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">creationTimestamp</span>: <span class="string">&quot;2019-10-21T08:01:43Z&quot;</span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">test-config2</span></span><br><span class="line">  <span class="attr">namespace</span>: <span class="string">default</span></span><br><span class="line">  <span class="attr">resourceVersion</span>: <span class="string">&quot;188765&quot;</span></span><br><span class="line">  <span class="attr">selfLink</span>: <span class="string">/api/v1/namespaces/default/configmaps/test-config2</span></span><br><span class="line">  <span class="attr">uid</span>: <span class="string">790fca12-3900-4bf3-a017-5af1070792e5</span></span><br></pre></td></tr></table></figure>

<p>通过指定文件创建时，configmap会创建一个key&#x2F;value对，key是文件名，value是文件内容。</p>
<h4 id="12-4-指定目录创建"><a href="#12-4-指定目录创建" class="headerlink" title="12.4 指定目录创建"></a>12.4 指定目录创建</h4><p>configs 目录下的config-1和config-2内容如下所示：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# mkdir config</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# cd config/</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">config]# vim config1</span></span><br><span class="line"><span class="attr">aaa</span></span><br><span class="line"><span class="attr">bbb</span></span><br><span class="line"><span class="attr">c</span>=<span class="string">d</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">config]# vim config2</span></span><br><span class="line"><span class="attr">eee</span></span><br><span class="line"><span class="attr">fff</span></span><br><span class="line"><span class="attr">h</span>=<span class="string">k</span></span><br></pre></td></tr></table></figure>

<p>创建：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">config]# cd ..</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl create configmap test-config3 --from-file=./config</span></span><br><span class="line"><span class="attr">configmap/test-config3</span> <span class="string">created</span></span><br></pre></td></tr></table></figure>

<p>结果下面data内容所示：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl get configmap test-config3 -o yaml</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">v1</span></span><br><span class="line"><span class="attr">data</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">config1</span>: <span class="string">|</span></span><br><span class="line">    <span class="attr">aaa</span></span><br><span class="line">    <span class="attr">bbb</span></span><br><span class="line">    <span class="attr">c</span>=<span class="string">d</span></span><br><span class="line">  <span class="attr">config2</span>: <span class="string">|</span></span><br><span class="line">    <span class="attr">eee</span></span><br><span class="line">    <span class="attr">fff</span></span><br><span class="line">    <span class="attr">h</span>=<span class="string">k</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">creationTimestamp</span>: <span class="string">&quot;2019-10-21T08:20:42Z&quot;</span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">test-config3</span></span><br><span class="line">  <span class="attr">namespace</span>: <span class="string">default</span></span><br><span class="line">  <span class="attr">resourceVersion</span>: <span class="string">&quot;190420&quot;</span></span><br><span class="line">  <span class="attr">selfLink</span>: <span class="string">/api/v1/namespaces/default/configmaps/test-config3</span></span><br><span class="line">  <span class="attr">uid</span>: <span class="string">6e00fded-80a8-4297-aeb3-4c48795e6eb9</span></span><br></pre></td></tr></table></figure>

<p>指定目录创建时，configmap内容中的各个文件会创建一个key&#x2F;value对，<strong>key是文件名，value是文件内容。</strong></p>
<h4 id="12-5-通过yaml文件创建"><a href="#12-5-通过yaml文件创建" class="headerlink" title="12.5 通过yaml文件创建"></a>12.5 通过yaml文件创建</h4><p>yaml文件内容如下： 注意其中一个key的value有多行内容时的写法</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# vim configmap.yaml</span></span><br><span class="line"><span class="attr">---</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">v1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">test-config4</span></span><br><span class="line">  <span class="attr">namespace</span>: <span class="string">default</span></span><br><span class="line"><span class="attr">data</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">cache_host</span>: <span class="string">memcached-gcxt</span></span><br><span class="line">  <span class="attr">cache_port</span>: <span class="string">&quot;11211&quot;</span></span><br><span class="line">  <span class="attr">cache_prefix</span>: <span class="string">gcxt</span></span><br><span class="line">  <span class="attr">my.cnf</span>: <span class="string">|</span></span><br><span class="line">   <span class="attr">[mysqld]</span></span><br><span class="line">   <span class="attr">log-bin</span> = <span class="string">mysql-bin</span></span><br><span class="line">   <span class="attr">haha</span> = <span class="string">hehe</span></span><br></pre></td></tr></table></figure>

<p>创建：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl apply -f configmap.yaml </span></span><br><span class="line"><span class="attr">configmap/test-config4</span> <span class="string">created</span></span><br></pre></td></tr></table></figure>

<p>结果如下面data内容所示：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl get configmap test-config4 -o yaml</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">v1</span></span><br><span class="line"><span class="attr">data</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">cache_host</span>: <span class="string">memcached-gcxt</span></span><br><span class="line">  <span class="attr">cache_port</span>: <span class="string">&quot;11211&quot;</span></span><br><span class="line">  <span class="attr">cache_prefix</span>: <span class="string">gcxt</span></span><br><span class="line">  <span class="attr">my.cnf</span>: <span class="string">|</span></span><br><span class="line">    <span class="attr">[mysqld]</span></span><br><span class="line">    <span class="attr">log-bin</span> = <span class="string">mysql-bin</span></span><br><span class="line">    <span class="attr">haha</span> = <span class="string">hehe</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">annotations</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">kubectl.kubernetes.io/last-applied-configuration</span>: <span class="string">|</span></span><br><span class="line">      <span class="attr">&#123;&quot;apiVersion&quot;</span>:<span class="string">&quot;v1&quot;,&quot;data&quot;:&#123;&quot;cache_host&quot;:&quot;memcached-gcxt&quot;,&quot;cache_port&quot;:&quot;11211&quot;,&quot;cache_prefix&quot;:&quot;gcxt&quot;,&quot;my.cnf&quot;:&quot;[mysqld]\nlog-bin = mysql-bin\nhaha = hehe\n&quot;&#125;,&quot;kind&quot;:&quot;ConfigMap&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;name&quot;:&quot;test-config4&quot;,&quot;namespace&quot;:&quot;default&quot;&#125;&#125;</span></span><br><span class="line">  <span class="attr">creationTimestamp</span>: <span class="string">&quot;2019-10-21T08:30:24Z&quot;</span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">test-config4</span></span><br><span class="line">  <span class="attr">namespace</span>: <span class="string">default</span></span><br><span class="line">  <span class="attr">resourceVersion</span>: <span class="string">&quot;191270&quot;</span></span><br><span class="line">  <span class="attr">selfLink</span>: <span class="string">/api/v1/namespaces/default/configmaps/test-config4</span></span><br><span class="line">  <span class="attr">uid</span>: <span class="string">2a8cd6e7-db2c-4781-b005-e0b76d26394b</span></span><br></pre></td></tr></table></figure>

<p>查看configmap的详细信息：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl describe configmap</span></span><br></pre></td></tr></table></figure>

<h4 id="12-6-使用ConfigMap"><a href="#12-6-使用ConfigMap" class="headerlink" title="12.6 使用ConfigMap"></a>12.6 使用ConfigMap</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">使用ConfigMap的方式，一种是通过环境变量的方式，直接传递pod，另一种是使用volume的方式挂载入到pod内</span></span><br></pre></td></tr></table></figure>

<p>示例ConfigMap文件：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# vim config-map.yml</span></span><br><span class="line"><span class="attr">---</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">v1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">config-map</span></span><br><span class="line">  <span class="attr">namespace</span>: <span class="string">default</span></span><br><span class="line"><span class="attr">data</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">special.how</span>: <span class="string">very</span></span><br><span class="line">  <span class="attr">special.type</span>: <span class="string">charm  </span></span><br><span class="line"></span><br><span class="line"><span class="attr">创建</span>  <span class="string"></span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl apply -f config-map.yml </span></span><br><span class="line"><span class="attr">configmap/config-map</span> <span class="string">created</span></span><br></pre></td></tr></table></figure>

<h5 id="12-6-1-通过变量使用"><a href="#12-6-1-通过变量使用" class="headerlink" title="12.6.1 通过变量使用"></a>12.6.1 通过变量使用</h5><p>(1) 使用valueFrom、configMapKeyRef、name、key指定要用的key:</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">1.设置指定变量的方式</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# vim testpod.yml</span></span><br><span class="line"><span class="attr">---</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">v1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">dapi-test-pod</span></span><br><span class="line"><span class="attr">spec</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">containers</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">-</span> <span class="string">name: test-container</span></span><br><span class="line">      <span class="attr">image</span>: <span class="string">daocloud.io/library/nginx</span></span><br><span class="line">      <span class="attr">env</span>:   <span class="string">#专门在容器里面设置变量的关键字</span></span><br><span class="line">        <span class="attr">-</span> <span class="string">name: SPECIAL_LEVEL_KEY   #这里的-name,是容器里设置的新变量的名字</span></span><br><span class="line">          <span class="attr">valueFrom</span>:<span class="string"></span></span><br><span class="line">            <span class="attr">configMapKeyRef</span>:<span class="string"></span></span><br><span class="line">              <span class="attr">name</span>: <span class="string">config-map   #这里是来源于哪个configMap</span></span><br><span class="line">              <span class="attr">key</span>: <span class="string">special.how      #configMap里的key</span></span><br><span class="line">        <span class="attr">-</span> <span class="string">name: SPECIAL_TYPE_KEY</span></span><br><span class="line">          <span class="attr">valueFrom</span>:<span class="string"></span></span><br><span class="line">            <span class="attr">configMapKeyRef</span>:<span class="string"></span></span><br><span class="line">              <span class="attr">name</span>: <span class="string">config-map</span></span><br><span class="line">              <span class="attr">key</span>: <span class="string">special.type</span></span><br><span class="line">  <span class="attr">restartPolicy</span>: <span class="string">Never</span></span><br><span class="line"></span><br><span class="line"><span class="attr">创建pod</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl apply -f testpod.yml </span></span><br><span class="line"><span class="attr">pod/dapi-test-pod</span> <span class="string">created</span></span><br></pre></td></tr></table></figure>

<p>测试：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl exec -it dapi-test-pod /bin/bash</span></span><br><span class="line"><span class="attr">root@dapi-test-pod</span>:<span class="string">/# echo $SPECIAL_TYPE_KEY</span></span><br><span class="line"><span class="attr">charm</span></span><br></pre></td></tr></table></figure>

<p>(2) 通过envFrom、configMapRef、name使得configmap中的所有key&#x2F;value对儿  都自动变成环境变量：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl delete -f testpod.yml </span></span><br><span class="line"><span class="attr">pod</span> <span class="string">&quot;dapi-test-pod&quot; deleted</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# cp testpod.yml testpod.yml.bak</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# vim testpod.yml</span></span><br><span class="line"><span class="attr">---</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">v1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line"> <span class="attr">name</span>: <span class="string">dapi-test-pod</span></span><br><span class="line"><span class="attr">spec</span>:<span class="string"></span></span><br><span class="line"> <span class="attr">containers</span>:<span class="string"></span></span><br><span class="line">   <span class="attr">-</span> <span class="string">name: test-container</span></span><br><span class="line">     <span class="attr">image</span>: <span class="string">daocloud.io/library/nginx</span></span><br><span class="line">     <span class="attr">envFrom</span>:<span class="string"></span></span><br><span class="line">     <span class="attr">-</span> <span class="string">configMapRef:</span></span><br><span class="line">         <span class="attr">name</span>: <span class="string">config-map</span></span><br><span class="line"> <span class="attr">restartPolicy</span>: <span class="string">Never</span></span><br></pre></td></tr></table></figure>

<p>这样容器里的变量名称直接使用configMap里的key名：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl apply -f testpod.yml</span></span><br><span class="line"><span class="attr">pod/dapi-test-pod</span> <span class="string">created.</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl exec -it dapi-test-pod /bin/bash</span></span><br><span class="line"><span class="attr">root@dapi-test-pod</span>:<span class="string">/# env</span></span><br><span class="line"><span class="attr">HOSTNAME</span>=<span class="string">dapi-test-pod</span></span><br><span class="line"><span class="attr">NJS_VERSION</span>=<span class="string">0.3.3</span></span><br><span class="line"><span class="attr">NGINX_VERSION</span>=<span class="string">1.17.1</span></span><br><span class="line"><span class="attr">KUBERNETES_PORT_443_TCP_PROTO</span>=<span class="string">tcp</span></span><br><span class="line"><span class="attr">KUBERNETES_PORT_443_TCP_ADDR</span>=<span class="string">10.96.0.1</span></span><br><span class="line"><span class="attr">PKG_RELEASE</span>=<span class="string">1~stretch</span></span><br><span class="line"><span class="attr">KUBERNETES_PORT</span>=<span class="string">tcp://10.96.0.1:443</span></span><br><span class="line"><span class="attr">PWD</span>=<span class="string">/</span></span><br><span class="line"><span class="attr">special.how</span>=<span class="string">very</span></span><br><span class="line"><span class="attr">HOME</span>=<span class="string">/root</span></span><br><span class="line"><span class="attr">KUBERNETES_SERVICE_PORT_HTTPS</span>=<span class="string">443</span></span><br><span class="line"><span class="attr">KUBERNETES_PORT_443_TCP_PORT</span>=<span class="string">443</span></span><br><span class="line"><span class="attr">KUBERNETES_PORT_443_TCP</span>=<span class="string">tcp://10.96.0.1:443</span></span><br><span class="line"><span class="attr">TERM</span>=<span class="string">xterm</span></span><br><span class="line"><span class="attr">SHLVL</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">KUBERNETES_SERVICE_PORT</span>=<span class="string">443</span></span><br><span class="line"><span class="attr">PATH</span>=<span class="string">/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span></span><br><span class="line"><span class="attr">special.type</span>=<span class="string">charm</span></span><br><span class="line"><span class="attr">KUBERNETES_SERVICE_HOST</span>=<span class="string">10.96.0.1</span></span><br><span class="line"><span class="attr">_</span>=<span class="string">/usr/bin/env</span></span><br></pre></td></tr></table></figure>

<h5 id="12-6-2-作为volume挂载使用"><a href="#12-6-2-作为volume挂载使用" class="headerlink" title="12.6.2 作为volume挂载使用"></a>12.6.2 作为volume挂载使用</h5><p>(1) 把1.4中test-config4所有key&#x2F;value挂载进来：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl delete -f testpod.yml</span></span><br><span class="line"><span class="attr">pod</span> <span class="string">&quot;dapi-test-pod&quot; deleted</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# vim volupod.yml</span></span><br><span class="line"><span class="attr">---</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">v1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">nginx-configmap</span></span><br><span class="line"><span class="attr">spec</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">containers</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">-</span> <span class="string">name: nginx-configmap</span></span><br><span class="line">    <span class="attr">image</span>: <span class="string">daocloud.io/library/nginx</span></span><br><span class="line">    <span class="attr">volumeMounts</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">-</span> <span class="string">name: config-volume4</span></span><br><span class="line">      <span class="attr">mountPath</span>: <span class="string">&quot;/tmp/config4&quot;</span></span><br><span class="line">  <span class="attr">volumes</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">-</span> <span class="string">name: config-volume4</span></span><br><span class="line">    <span class="attr">configMap</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">name</span>: <span class="string">test-config4</span></span><br><span class="line">          </span><br><span class="line"><span class="attr">创建pod</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl apply -f volupod.yml </span></span><br><span class="line"><span class="attr">pod/nginx-configmap</span> <span class="string">created</span></span><br></pre></td></tr></table></figure>

<p>进入容器中&#x2F;tmp&#x2F;config4查看：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]#  kubectl  exec -it nginx-configmap /bin/bash</span></span><br><span class="line"><span class="attr">root@nginx-configmap</span>:<span class="string">/# ls /tmp/config4/</span></span><br><span class="line"><span class="attr">cache_host</span>  <span class="string">cache_port	cache_prefix  my.cnf</span></span><br><span class="line"><span class="attr">root@nginx-configmap</span>:<span class="string">/# cat /tmp/config4/cache_host </span></span><br><span class="line"><span class="attr">memcached-gcxt</span></span><br><span class="line"><span class="attr">root@nginx-configmap</span>:<span class="string">/#</span></span><br></pre></td></tr></table></figure>

<p>可以看到，在config4文件夹下以每一个key为文件名,value为内容,创建了多个文件。</p>
<h4 id="12-7-实战案例"><a href="#12-7-实战案例" class="headerlink" title="12.7 实战案例"></a>12.7 实战案例</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">创建configmap</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">configmap]# vim configmap.yaml</span></span><br><span class="line"><span class="attr">---</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">v1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line"> <span class="attr">name</span>: <span class="string">nginx-server-conf</span></span><br><span class="line"> <span class="attr">namespace</span>: <span class="string">default</span></span><br><span class="line"><span class="attr">data</span>:<span class="string"></span></span><br><span class="line"> <span class="attr">index.html</span>: <span class="string">|</span></span><br><span class="line">  <span class="attr">Hello,</span> <span class="string">cloud computing</span></span><br><span class="line">  <span class="attr">Hello,</span> <span class="string">Mr. Wang</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">configmap]# kubectl get configmap</span></span><br><span class="line"><span class="attr">NAME</span>                <span class="string">DATA   AGE</span></span><br><span class="line"><span class="attr">nginx-server-conf</span>   <span class="string">2      7s</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">configmap]# kubectl get configmap nginx-server-conf -o yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">使用configmap</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">configmap]# vim pod.yaml</span></span><br><span class="line"><span class="attr">---</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">v1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line"> <span class="attr">name</span>: <span class="string">test-webapp</span></span><br><span class="line"><span class="attr">spec</span>:<span class="string"></span></span><br><span class="line"> <span class="attr">containers</span>:<span class="string"></span></span><br><span class="line"> <span class="attr">-</span> <span class="string">name: nginx-app</span></span><br><span class="line">   <span class="attr">image</span>: <span class="string">daocloud.io/library/nginx</span></span><br><span class="line">   <span class="attr">ports</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">-</span> <span class="string">containerPort: 80</span></span><br><span class="line">   <span class="attr">volumeMounts</span>:<span class="string"></span></span><br><span class="line">   <span class="attr">-</span> <span class="string">name: nginx-volume</span></span><br><span class="line">     <span class="attr">mountPath</span>: <span class="string">&quot;/usr/share/nginx/html&quot;</span></span><br><span class="line"> <span class="attr">volumes</span>:<span class="string"></span></span><br><span class="line"> <span class="attr">-</span> <span class="string">name: nginx-volume</span></span><br><span class="line">   <span class="attr">configMap</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">name</span>: <span class="string">nginx-server-conf</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">configmap]# kubectl apply -f pod.yaml</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">configmap]# kubectl get pod </span></span><br><span class="line"><span class="attr">NAME</span>          <span class="string">READY   STATUS    RESTARTS   AGE</span></span><br><span class="line"><span class="attr">test-webapp</span>   <span class="string">1/1     Running   0          6s</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">configmap]# kubectl exec -it test-webapp /bin/bash</span></span><br><span class="line"><span class="attr">root@test-webapp</span>:<span class="string">/# cd /usr/share/nginx/html/</span></span><br><span class="line"><span class="attr">root@test-webapp</span>:<span class="string">/usr/share/nginx/html# ls</span></span><br><span class="line"><span class="attr">index.html</span></span><br><span class="line"><span class="attr">root@test-webapp</span>:<span class="string">/usr/share/nginx/html# cat index.html </span></span><br><span class="line"><span class="attr">Hello,</span> <span class="string">cloud computing</span></span><br><span class="line"><span class="attr">Hello,</span> <span class="string">Mr. Wang</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">configmap]# curl 10.244.2.25</span></span><br><span class="line"><span class="attr">Hello,</span> <span class="string">cloud computing</span></span><br><span class="line"><span class="attr">Hello,</span> <span class="string">Mr. Wang</span></span><br></pre></td></tr></table></figure>

<h3 id="十三-Downward-API"><a href="#十三-Downward-API" class="headerlink" title="十三.Downward API"></a>十三.Downward API</h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Downward</span> <span class="string">API</span></span><br><span class="line"><span class="attr">用于在容器中获取</span> <span class="string">POD 的基本信息，kubernetes原生支持</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Downward</span> <span class="string">API提供了两种方式用于将 POD 的信息注入到容器内部：</span></span><br><span class="line"><span class="attr">1.环境变量：用于单个变量，可以将</span> <span class="string">POD 信息直接注入容器内部。</span></span><br><span class="line"><span class="attr">2.Volume挂载：将</span> <span class="string">POD 信息生成为文件，直接挂载到容器内部中去。</span></span><br></pre></td></tr></table></figure>

<h4 id="13-1-目前-Downward-API-支持的字段"><a href="#13-1-目前-Downward-API-支持的字段" class="headerlink" title="13.1 目前 Downward API 支持的字段"></a>13.1 目前 Downward API 支持的字段</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">1.</span> <span class="string">使用 fieldRef 可以声明使用:</span></span><br><span class="line"><span class="attr">spec.nodeName</span> <span class="string">- 宿主机名字</span></span><br><span class="line"><span class="attr">status.hostIP</span> <span class="string">- 宿主机 IP</span></span><br><span class="line"><span class="attr">metadata.name</span> <span class="string">- Pod 的名字</span></span><br><span class="line"><span class="attr">metadata.namespace</span> <span class="string">- Pod 的 Namespace</span></span><br><span class="line"><span class="attr">status.podIP</span> <span class="string">- Pod 的 IP</span></span><br><span class="line"><span class="attr">spec.serviceAccountName</span> <span class="string">- Pod 的 Service Account 的名字</span></span><br><span class="line"><span class="attr">metadata.uid</span> <span class="string">- Pod 的 UID</span></span><br><span class="line"><span class="attr">metadata.labels[&#x27;&lt;KEY&gt;&#x27;]</span> <span class="string">- 指定 &lt;KEY&gt; 的 Label 值</span></span><br><span class="line"><span class="attr">metadata.annotations[&#x27;&lt;KEY&gt;&#x27;]</span> <span class="string">- 指定 &lt;KEY&gt; 的 Annotation 值</span></span><br><span class="line"><span class="attr">metadata.labels</span> <span class="string">- Pod 的所有 Label</span></span><br><span class="line"><span class="attr">metadata.annotations</span> <span class="string">- Pod 的所有 Annotation</span></span><br><span class="line"></span><br><span class="line"><span class="attr">上面这个列表的内容，随着</span> <span class="string">Kubernetes 项目的发展肯定还会不断增加。所以这里列出来的信息仅供参考，在使用 Downward API 时，还是要记得去查阅一下官方文档。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">所有基本信息可以使用下面的方式去查看（describe方式看不出来）：</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">configmap]# kubectl  get pod test-webapp -o yaml</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">v1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">annotations</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">kubectl.kubernetes.io/last-applied-configuration</span>: <span class="string">|</span></span><br><span class="line">      <span class="attr">&#123;&quot;apiVersion&quot;</span>:<span class="string">&quot;v1&quot;,&quot;kind&quot;:&quot;Pod&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;name&quot;:&quot;test-webapp&quot;,&quot;namespace&quot;:&quot;default&quot;&#125;,&quot;spec&quot;:&#123;&quot;containers&quot;:[&#123;&quot;image&quot;:&quot;daocloud.io/library/nginx&quot;,&quot;name&quot;:&quot;nginx-app&quot;,&quot;volumeMounts&quot;:[&#123;&quot;mountPath&quot;:&quot;/usr/share/nginx/html&quot;,&quot;name&quot;:&quot;nginx-volume&quot;&#125;]&#125;],&quot;volumes&quot;:[&#123;&quot;configMap&quot;:&#123;&quot;name&quot;:&quot;nginx-server-conf&quot;&#125;,&quot;name&quot;:&quot;nginx-volume&quot;&#125;]&#125;&#125;</span></span><br><span class="line">  <span class="attr">creationTimestamp</span>: <span class="string">&quot;2021-02-21T09:44:51Z&quot;</span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">test-webapp</span></span><br><span class="line">  <span class="attr">namespace</span>: <span class="string">default</span></span><br><span class="line">  <span class="attr">resourceVersion</span>: <span class="string">&quot;270687&quot;</span></span><br><span class="line">  <span class="attr">selfLink</span>: <span class="string">/api/v1/namespaces/default/pods/test-webapp</span></span><br><span class="line">  <span class="attr">uid</span>: <span class="string">ed92d685-f800-464f-95dc-d6aa5f92fc9c</span></span><br><span class="line"><span class="attr">......</span></span><br></pre></td></tr></table></figure>

<h4 id="13-2-实战案例"><a href="#13-2-实战案例" class="headerlink" title="13.2 实战案例"></a>13.2 实战案例</h4><p>使用fieldRef获取 POD 的基本信息，以环境变量的方式实现</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# vim test-env-pod.yml</span></span><br><span class="line"><span class="attr">---</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">v1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">name</span>: <span class="string">test-env-pod</span></span><br><span class="line">    <span class="attr">namespace</span>: <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">containers</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">-</span> <span class="string">name: test-env-pod</span></span><br><span class="line">      <span class="attr">image</span>: <span class="string">daocloud.io/library/nginx</span></span><br><span class="line">      <span class="attr">env</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">-</span> <span class="string">name: POD_NAME   #第一个环境变量的名字</span></span><br><span class="line">        <span class="attr">valueFrom</span>:      <span class="string">#使用valueFrom方式设置</span></span><br><span class="line">          <span class="attr">fieldRef</span>:    <span class="string">#关联一个字段metadata.name</span></span><br><span class="line">            <span class="attr">fieldPath</span>: <span class="string">metadata.name  #这个字段从当前运行的pod详细信息查看</span></span><br><span class="line">      <span class="attr">-</span> <span class="string">name: POD_NAMESPACE</span></span><br><span class="line">        <span class="attr">valueFrom</span>:<span class="string"></span></span><br><span class="line">          <span class="attr">fieldRef</span>:<span class="string"></span></span><br><span class="line">            <span class="attr">fieldPath</span>: <span class="string">metadata.namespace</span></span><br><span class="line">      <span class="attr">-</span> <span class="string">name: POD_IP</span></span><br><span class="line">        <span class="attr">valueFrom</span>:<span class="string"></span></span><br><span class="line">          <span class="attr">fieldRef</span>:<span class="string"></span></span><br><span class="line">            <span class="attr">fieldPath</span>: <span class="string">status.podIP</span></span><br></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">注意：</span> <span class="string">POD 的 name 和 namespace 属于元数据，是在 POD 创建之前就已经定下来了的，所以使用 metadata 获取就可以了，但是对于 POD 的 IP 则不一样，因为POD IP 是不固定的，POD 重建了就变了，它属于状态数据，所以使用 status 去获取。</span></span><br></pre></td></tr></table></figure>

<p>创建上面的 POD：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]#  kubectl apply -f test-env-pod.yml</span></span><br><span class="line"><span class="attr">pod/test-env-pod</span> <span class="string">created</span></span><br></pre></td></tr></table></figure>

<p>POD 创建成功后，查看：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl exec -it test-env-pod /bin/bash -n kube-system</span></span><br><span class="line"><span class="attr">root@test-env-pod</span>:<span class="string">/# env | grep POD</span></span><br><span class="line"><span class="attr">POD_NAME</span>=<span class="string">test-env-pod</span></span><br><span class="line"><span class="attr">POD_NAMESPACE</span>=<span class="string">kube-system</span></span><br><span class="line"><span class="attr">POD_IP</span>=<span class="string">10.244.1.35</span></span><br><span class="line"><span class="attr">root@test-env-pod</span>:<span class="string">/#</span></span><br></pre></td></tr></table></figure>

<p><strong>Volume挂载</strong></p>
<p>通过Downward API将 POD 的 Label、等信息通过 Volume 以文件的形式挂载到容器的某个文件中去，然后在容器中打印出该文件的值来验证。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# vim test-volume-pod.yaml</span></span><br><span class="line"><span class="attr">---</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">v1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">   <span class="attr">name</span>: <span class="string">test-volume-pod</span></span><br><span class="line">   <span class="attr">namespace</span>: <span class="string">kube-system</span></span><br><span class="line">   <span class="attr">labels</span>:<span class="string"></span></span><br><span class="line">       <span class="attr">k8s-app</span>: <span class="string">test-volume</span></span><br><span class="line">       <span class="attr">node-env</span>: <span class="string">test</span></span><br><span class="line"><span class="attr">spec</span>:<span class="string"></span></span><br><span class="line">   <span class="attr">containers</span>:<span class="string"></span></span><br><span class="line">   <span class="attr">-</span> <span class="string">name: test-volume-pod-container</span></span><br><span class="line">     <span class="attr">image</span>: <span class="string">daocloud.io/library/nginx</span></span><br><span class="line">     <span class="attr">volumeMounts</span>:<span class="string"></span></span><br><span class="line">     <span class="attr">-</span> <span class="string">name: podinfo</span></span><br><span class="line">       <span class="attr">mountPath</span>: <span class="string">/etc/podinfo</span></span><br><span class="line">   <span class="attr">volumes</span>:<span class="string"></span></span><br><span class="line">   <span class="attr">-</span> <span class="string">name: podinfo</span></span><br><span class="line">     <span class="attr">downwardAPI</span>:<span class="string"></span></span><br><span class="line">       <span class="attr">items</span>:<span class="string"></span></span><br><span class="line">       <span class="attr">-</span> <span class="string">path: &quot;labels&quot;</span></span><br><span class="line">         <span class="attr">fieldRef</span>:<span class="string"></span></span><br><span class="line">           <span class="attr">fieldPath</span>: <span class="string">metadata.labels</span></span><br></pre></td></tr></table></figure>

<p>创建上面的 POD ：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl apply -f test-volume-pod.yaml pod/test-volume-pod created</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl get pod -n kube-system</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">prome]# kubectl exec -it test-volume-pod /bin/bash -n kube-system</span></span><br></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Secret、ConfigMap，以及</span> <span class="string">Downward API 这三种 Projected Volume 定义的信息，大多还可以通过环境变量的方式出现在容器里。但是，通过环境变量获取这些信息的方式，不具备自动更新的能力。一般情况下，建议使用 Volume 文件的方式获取这些信息。</span></span><br></pre></td></tr></table></figure>

<h3 id="十四-ServiceAccount详解"><a href="#十四-ServiceAccount详解" class="headerlink" title="十四.ServiceAccount详解"></a>十四.ServiceAccount详解</h3><p>官方文档地址：<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/">https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">k8s中提供了良好的多租户认证管理机制，如RBAC、ServiceAccount还有各种Policy等。</span><br></pre></td></tr></table></figure>

<p>什么是 Service Account ？</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Pod里的进程也可以与 apiserver 联系。 当它们在联系 apiserver 的时候，它们就会被认证为一个特定的 Service Account。</span><br></pre></td></tr></table></figure>

<p>使用场景：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Service Account它并不是给kubernetes集群的用户使用的，而是给pod里面的进程使用的，它为pod提供必要的身份认证。----专门为pod里面的进程和apiserver通信提供认证的。</span><br></pre></td></tr></table></figure>

<p>Service account与User account区别:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1. User account是为人设计的，而service account则是为Pod中的进程调用Kubernetes API或其他外部服务而设计的</span><br><span class="line"></span><br><span class="line">2. User account是跨namespace的，而service account则是仅局限它所在的namespace；</span><br><span class="line"></span><br><span class="line">3. 每个namespace都会自动创建一个default service account    </span><br><span class="line"></span><br><span class="line">4. Token controller检测service account的创建，并为它们创建secret</span><br></pre></td></tr></table></figure>

<h4 id="14-1-Service-Account应用示例"><a href="#14-1-Service-Account应用示例" class="headerlink" title="14.1 Service Account应用示例"></a>14.1 Service Account应用示例</h4><p>Service Account（服务账号）示例</p>
<p>因为平时系统会使用默认service account，我们不需要自己创建，感觉不到service account的存在，本实验是使用自己手动创建的service account</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">定义 Service Account</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: test-sa  # Service Account 的名称</span><br><span class="line">---</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">定义 Role，授予读取 Pods 的权限</span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  name: read-only-role  # 角色的名称</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [&quot;&quot;]  # 指定 API 组，空字符串表示 core API 组</span><br><span class="line">  resources: [&quot;pods&quot;]  # 指定资源类型，这里是 pods</span><br><span class="line">  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]  # 指定允许的操作，这里是读取和监听</span><br><span class="line">---</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">定义 RoleBinding，将前面创建的 Role 绑定到 Service Account</span></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: read-only-binding  # RoleBinding 的名称</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount  # 指定绑定的对象类型，这里是 Service Account</span><br><span class="line">  name: test-sa  # 指定绑定的 Service Account 的名称</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">默认命名空间是与 RoleBinding 相同的命名空间，如果有特定的命名空间，需要在此指定</span></span><br><span class="line">roleRef:</span><br><span class="line">  kind: Role  # 角色类型，这里是 Role</span><br><span class="line">  name: read-only-role  # 绑定的角色名称</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io  # 角色所属的 API 组</span><br><span class="line">---</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">定义 Pod，并指定使用前面创建的 Service Account</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: test-pod  # Pod 的名称</span><br><span class="line">spec:</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">serviceAccountName: test-sa  <span class="comment"># 指定使用的 Service Account</span></span></span><br><span class="line">  containers:</span><br><span class="line">  - name: test-container  # 容器的名称</span><br><span class="line">    image: busybox  # 使用的镜像</span><br><span class="line">    command: [&quot;sleep&quot;, &quot;3600&quot;]  # 容器启动时执行的命令，这里是睡眠 3600 秒</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: kubectl  # 卷的名称</span><br><span class="line">      mountPath: /usr/bin/kubectl  # 挂载路径</span><br><span class="line">  volumes:</span><br><span class="line">    - name: kubectl  # 卷的名称</span><br><span class="line">      hostPath: </span><br><span class="line">        path: /usr/bin/kubectl  # 指定主机上的路径，挂载到容器中</span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在关闭了serviceAccountName 的情况下，可以看到</span></span><br><span class="line">[root@kube-master1 ~]# kubectl <span class="built_in">exec</span> -it test-pod -- /bin/sh</span><br><span class="line">/ <span class="comment"># kubectl get pod</span></span><br><span class="line">Error from server (Forbidden): pods is forbidden: User <span class="string">&quot;system:serviceaccount:default:default&quot;</span> cannot list resource <span class="string">&quot;pods&quot;</span> <span class="keyword">in</span> API group <span class="string">&quot;&quot;</span> <span class="keyword">in</span> the namespace <span class="string">&quot;default&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果开启上面yaml中的serviceAccountName，那么将会拥有对应权限</span></span><br><span class="line">[root@kube-master1 ~]# kubectl <span class="built_in">exec</span> -it test-pod -- /bin/sh</span><br><span class="line">/ <span class="comment"># kubectl get pod </span></span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE</span><br><span class="line">test-pod   1/1     Running   0          34s</span><br></pre></td></tr></table></figure>
<h3 id="十五-RBAC-详解-基于角色的访问控制"><a href="#十五-RBAC-详解-基于角色的访问控制" class="headerlink" title="十五.RBAC 详解(基于角色的访问控制)"></a>十五.RBAC 详解(基于角色的访问控制)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">在Kubernetes中，授权有ABAC（基于属性的访问控制）、RBAC（基于角色的访问控制）、Webhook、Node、AlwaysDeny（一直拒绝）和AlwaysAllow（一直允许）这6种模式。</span><br><span class="line"></span><br><span class="line">RBAC基于角色的访问控制--全拼Role-Based Access Control----做权限控制的，顾名思义就是通过给角色赋予相应的权限，从而使得该角色具有访问相关资源的权限。</span><br><span class="line"></span><br><span class="line">k8s里面有两种用户,一种是User,一种就是service account(服务使用的账号)。</span><br><span class="line">User account是为人设计的属于用户账户（个人使用的账号），此外User Account是跨Namespace的，而ServiceAccount则是仅局限它所在的Namespace。</span><br><span class="line"></span><br><span class="line">在RABC API中，通过如下的步骤进行授权：</span><br><span class="line">1）定义角色：在定义角色时会指定此角色对于资源的访问控制的规则；</span><br><span class="line">2）绑定角色：将主体与角色进行绑定，对用户进行访问授权。</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">在K8s中这些资源分属于两个级别，名称空间（role/rolebinding）和集群级别（clusterrole/clusterrolebinding）这两个都是标准的K8s资源，可以直接定义。</span><br><span class="line"></span><br><span class="line">Role与ClusterRole</span><br><span class="line"> Role普通角色:一个Role对象只能用于授予对某一单一命名空间中资源的访问权限，普通角色只是在当前的名称空间生效。</span><br><span class="line"> ClusterRole集群角色:整个Kubernetes集群范围内有效的角色则通过ClusterRole对象实现，可以访问整个集群资源。</span><br><span class="line"> 简介</span><br><span class="line">role/ClusterRole:</span><br><span class="line">    1、允许的操作，如get,list,update,create,delete等权限</span><br><span class="line">    2、允许操作的对象，如pod,svc等资源</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rolebinding:将哪个用户绑定到哪个role上</span><br><span class="line">clusterrolebinding:绑定到集群角色上</span><br><span class="line">   如果使用clusterrolebinding绑定到clusterrole上，表示绑定的用户拥有所有namespace的权限</span><br><span class="line">   </span><br><span class="line"><span class="meta prompt_"> #</span><span class="language-bash">这里面有哪些重要的东西：role，clusterrole，binding，账号。</span></span><br></pre></td></tr></table></figure>

<h4 id="15-1-创建k8s账号与RBAC授权使用"><a href="#15-1-创建k8s账号与RBAC授权使用" class="headerlink" title="15.1 创建k8s账号与RBAC授权使用"></a>15.1 创建k8s账号与RBAC授权使用</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">创建账号</span><br><span class="line">1、创建私钥</span><br><span class="line">[root@kub-k8s-master1 ~]# (umask 077; openssl genrsa -out soso.key 2048)</span><br><span class="line">Generating RSA private key, 2048 bit long modulus</span><br><span class="line">...............................+++</span><br><span class="line">..........................+++</span><br><span class="line">e is 65537 (0x10001)</span><br><span class="line"></span><br><span class="line">用此私钥创建一个csr(证书签名请求)文件</span><br><span class="line">[root@kub-k8s-master1 ~]# openssl  req -new -key soso.key -out soso.csr -subj  &quot;/CN=soso&quot; # 这个地方是用户名</span><br><span class="line"></span><br><span class="line">拿着私钥和请求文件生成证书</span><br><span class="line">[root@kub-k8s-master1 ~]# openssl x509 -req -in soso.csr -CA  /etc/kubernetes/pki/ca.crt  -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -out soso.crt -days 365</span><br><span class="line">Signature ok</span><br><span class="line">subject=/CN=soso</span><br><span class="line">Getting CA Private Key</span><br><span class="line"></span><br><span class="line">生成账号</span><br><span class="line">[root@kub-k8s-master1 ~]# kubectl config set-credentials soso --client-certificate=soso.crt --client-key=soso.key --embed-certs=true</span><br><span class="line">User &quot;soso&quot; set.</span><br><span class="line"></span><br><span class="line">3、设置上下文环境--指的是创建这个账号的环境在当前名称空间中</span><br><span class="line">[root@kub-k8s-master1 ~]# kubectl config set-context soso@kubernetes --cluster=kubernetes --user=soso</span><br><span class="line">Context &quot;soso@kubernetes&quot; created.</span><br><span class="line">查看当前的工作上下文</span><br><span class="line">[root@kub-k8s-master1 ~]# kubectl config view</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: DATA+OMITTED</span><br><span class="line">    server: https://192.168.75.100:6443</span><br><span class="line">....</span><br><span class="line">4、切换用户（切换上下文）</span><br><span class="line">[root@kub-k8s-master1 ~]# kubectl  config use-context soso@kubernetes</span><br><span class="line">Switched to context &quot;soso@kubernetes&quot;.</span><br><span class="line">验证是否已经切换到了新的上下文</span><br><span class="line">[root@kub-k8s-master1 ~]# kubectl config current-context</span><br><span class="line">soso@kubernetes</span><br><span class="line">5.测试（还未赋予权限）</span><br><span class="line">[root@kub-k8s-master1 ~]# kubectl  get pod</span><br><span class="line">Error from server (Forbidden): pods is forbidden: User &quot;soso&quot; cannot list resource &quot;pods&quot; in API group &quot;&quot; in the namespace &quot;default&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line">创建一个角色（role）---设置权限</span><br><span class="line">1.切回管理帐号先</span><br><span class="line">[root@kub-k8s-master1 ~]# kubectl  config use-context kubernetes-admin@kubernetes</span><br><span class="line">Switched to context &quot;kubernetes-admin@kubernetes&quot;.</span><br><span class="line"></span><br><span class="line">创建角色（命令）：</span><br><span class="line">[root@kub-k8s-master1 ~]# kubectl  create role  role-reader  --verb=get,list,watch --resource=pod,svc</span><br><span class="line">role.rbac.authorization.k8s.io/role-reader created</span><br><span class="line">--verb： 相当于是权限</span><br><span class="line">--resource：给什么资源使用</span><br><span class="line"></span><br><span class="line">yaml文件方式:</span><br><span class="line">[root@kub-k8s-master1 ~]# vim role.yaml</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line"> name: role-reader</span><br><span class="line">rules: #定义规则</span><br><span class="line"> - apiGroups: [&quot;&quot;]  #表示当前pod使用核心的APIserver组，默认用&quot;&quot;表示就可以</span><br><span class="line">   resources: [&quot;pods&quot;,&quot;svc&quot;]</span><br><span class="line">   verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;update&quot;, &quot;delete&quot;] #[&quot;*&quot;]表示所有权限</span><br><span class="line"></span><br><span class="line">[root@kub-k8s-master1 ~]# kubectl apply -f role.yaml </span><br><span class="line">role.rbac.authorization.k8s.io/role-reader created</span><br><span class="line"></span><br><span class="line">[root@kub-k8s-master1 ~]# kubectl get roles</span><br><span class="line">NAME          AGE</span><br><span class="line">role-reader   30s</span><br><span class="line"></span><br><span class="line">[root@kub-k8s-master1 ~]# kubectl describe role role-reader</span><br><span class="line">Name:         role-reader</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  kubectl.kubernetes.io/last-applied-configuration:</span><br><span class="line">                &#123;&quot;apiVersion&quot;:&quot;rbac.authorization.k8s.io/v1beta1&quot;,&quot;kind&quot;:&quot;Role&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;name&quot;:&quot;role-reader&quot;,&quot;namespace&quot;:&quot;default&quot;&#125;,&quot;...</span><br><span class="line">PolicyRule:</span><br><span class="line">  Resources  Non-Resource URLs  Resource Names  Verbs</span><br><span class="line">  ---------  -----------------  --------------  -----</span><br><span class="line">  pods       []                 []              [get list watch create update delete]</span><br><span class="line">  svc        []                 []              [get list watch create update delete]</span><br><span class="line"></span><br><span class="line">2.绑定用户soso（上面创建的用户），绑定用户到role-reader</span><br><span class="line">[root@kub-k8s-master1 ~]# kubectl  create  rolebinding myrole-binding  --role=role-reader  --user=soso</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/myrole-binding created</span><br><span class="line"></span><br><span class="line">yaml文件方式：</span><br><span class="line">[root@k8s-master ~]# vim role-binding.yaml</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line"> name: myrolebind</span><br><span class="line">subjects:  #定义对那个主体进行操作，有三种Subjects:Service Account、User Account、Groups</span><br><span class="line">- kind: User</span><br><span class="line">  name: soso</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">roleRef:  #定义使用哪个角色</span><br><span class="line">  kind: Role</span><br><span class="line">  name: role-reader</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]# kubectl apply -f role-binding.yaml </span><br><span class="line">rolebinding.rbac.authorization.k8s.io/myrolebind created</span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]# kubectl get rolebinding </span><br><span class="line">NAME         AGE</span><br><span class="line">myrolebind   25s</span><br><span class="line"></span><br><span class="line">3.切换用户</span><br><span class="line">[root@kub-k8s-master1 ~]# kubectl  config use-context soso@kubernetes</span><br><span class="line">Switched to context &quot;soso@kubernetes&quot;.</span><br><span class="line"></span><br><span class="line">4.查看权限（只授权了default名称空间pod和svc的get，list，watch权限）</span><br><span class="line">[root@kub-k8s-master1 ~]# kubectl  get pod</span><br><span class="line">NAME                    READY   STATUS    RESTARTS   AGE</span><br><span class="line">lifecycle-demo          1/1     Running   1          22h</span><br><span class="line">mypod                   1/1     Running   0          8h</span><br><span class="line">nginx-configmap         1/1     Running   0          4h29m</span><br><span class="line">nginx-pod               1/1     Running   0          39m</span><br><span class="line">[root@kub-k8s-master1 ~]#  kubectl  get pod -n kube-system  #无权访问kube-system</span><br><span class="line">Error from server (Forbidden): pods is forbidden: User &quot;soso&quot; cannot list resource &quot;pods&quot; in API group &quot;&quot; in the namespace &quot;kube-system&quot;</span><br><span class="line"></span><br><span class="line">[root@kub-k8s-master1 ~]# kubectl  delete pod nginx-pod   #无权限删除</span><br><span class="line">Error from server (Forbidden): pods &quot;nginx-pod&quot; is forbidden: User &quot;soso&quot; cannot delete resource &quot;pods&quot; in API group &quot;&quot; in the namespace &quot;default&quot;</span><br><span class="line"></span><br><span class="line">5.切换用户</span><br><span class="line">[root@kub-k8s-master1 ~]# kubectl  config use-context kubernetes-admin@kubernetes</span><br><span class="line">Switched to context &quot;kubernetes-admin@kubernetes&quot;.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">实验二，绑定用户到集群角色</span><br><span class="line"></span><br><span class="line">6.删除soso账号之前绑定的rolebinding</span><br><span class="line">[root@kub-k8s-master1 ~]# kubectl  delete rolebinding myrolebind</span><br><span class="line">rolebinding.rbac.authorization.k8s.io &quot;myrolebind&quot; deleted</span><br><span class="line"></span><br><span class="line">7.创建clusterrole #可以访问全部的namespace</span><br><span class="line">[root@kub-k8s-master1 ~]# kubectl create clusterrole myclusterrole --verb=get,list,watch --resource=pod,svc</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/myclusterrole created</span><br><span class="line"></span><br><span class="line">yaml文件方式：</span><br><span class="line">[root@kub-k8s-master1 ~]# vim clusterrole.yaml</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: myclusterrole</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - pods</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">[root@kub-k8s-master1 ~]# kubectl apply -f clusterrole.yaml</span><br><span class="line">[root@kub-k8s-master1 ~]# kubectl get clusterrole</span><br><span class="line"></span><br><span class="line">8.绑定集群角色到用户soso</span><br><span class="line">[root@kub-k8s-master1 ~]# kubectl  create clusterrolebinding my-cluster-rolebinding   --clusterrole=myclusterrole --user=soso</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/my-cluster-rolebinding created</span><br><span class="line"></span><br><span class="line">yaml文件方式：</span><br><span class="line">[root@kub-k8s-master1 ~]# vim clusterrolebinding.yaml</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: my-cluster-rolebinding</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: myclusterrole</span><br><span class="line">subjects:</span><br><span class="line">- apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: User</span><br><span class="line">  name: soso</span><br><span class="line">[root@kub-k8s-master1 ~]# kubectl apply -f clusterrolebinding.yaml</span><br><span class="line">[root@kub-k8s-master1 ~]# kubectl get clusterrolebinding</span><br><span class="line"></span><br><span class="line">9.切换账号</span><br><span class="line">[root@kub-k8s-master1 ~]# kubectl  config use-context soso@kubernetes</span><br><span class="line">Switched to context &quot;soso@kubernetes&quot;.</span><br><span class="line"></span><br><span class="line">10.查看权限 查看kube-system空间的pod</span><br><span class="line">[root@kub-k8s-master1 ~]# kubectl  get pod -n kube-system</span><br><span class="line">NAME                                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-5644d7b6d9-sm8hs                 1/1     Running   0          5d</span><br><span class="line">coredns-5644d7b6d9-vddll                 1/1     Running   0          5d</span><br><span class="line">etcd-kub-k8s-master                      1/1     Running   0          5d</span><br><span class="line">... </span><br><span class="line"></span><br><span class="line">注意：11.切换为管理员用户</span><br><span class="line">[root@kub-k8s-master1 ~]# kubectl  config use-context kubernetes-admin@kubernetes</span><br></pre></td></tr></table></figure>

<h4 id="15-2-设置上下文和账户切换"><a href="#15-2-设置上下文和账户切换" class="headerlink" title="15.2 设置上下文和账户切换"></a>15.2 设置上下文和账户切换</h4><p>设置工作上下文（前提得有用户）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@kub-k8s-master1 ~]# kubectl  config   set-context  soso@kubernetes --cluster=kubernetes --user=soso</span><br><span class="line">Context &quot;soso@kubernetes&quot; created.</span><br></pre></td></tr></table></figure>

<p>查看当前的工作上下文</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@kub-k8s-master1 ~]# kubectl config view</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">....</span><br></pre></td></tr></table></figure>

<p>切换上下文（切换用户）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@kub-k8s-master1 ~]# kubectl config use-context soso@kubernetes</span><br><span class="line">Switched to context &quot;soso@kubernetes&quot;.</span><br></pre></td></tr></table></figure>

<p>切换为管理员用户</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@kub-k8s-master prome]# kubectl  config use-context kubernetes-admin@kubernetes</span><br><span class="line">Switched to context &quot;kubernetes-admin@kubernetes&quot;.</span><br></pre></td></tr></table></figure>

<p>查看某个资源类型是由哪个apiserver版本提供</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@kub-k8s-master1 ~]# kubectl explain ClusterRole</span><br></pre></td></tr></table></figure>

<h3 id="十六-Deployment-资源详解"><a href="#十六-Deployment-资源详解" class="headerlink" title="十六.Deployment 资源详解"></a>十六.Deployment 资源详解</h3><blockquote>
<p>如果Pod出现故障，对应的服务也会挂掉，所以Kubernetes提供了一个Deployment的概念 ，目的是让Kubernetes去管理一组Pod的副本，也就是副本集 ，这样就能够保证一定数量的副本一直可用，不会因为某一个Pod挂掉导致整个服务挂掉。</p>
<p>Deployment 还负责在 Pod 定义发生变化时，对每个副本进行滚动更新（Rolling Update）。</p>
</blockquote>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">使用yaml创建Deployment</span></span><br><span class="line"><span class="attr">k8s</span> <span class="string">deployment资源创建流程：</span></span><br><span class="line"><span class="attr">1.</span> <span class="string">用户通过 kubectl 创建 Deployment。</span></span><br><span class="line"><span class="attr">2.</span> <span class="string">Deployment 创建 ReplicaSet。</span></span><br><span class="line"><span class="attr">3.</span> <span class="string">ReplicaSet 创建 Pod。</span></span><br></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">对象的命名方式是：子对象的名字</span> = <span class="string">父对象名字 + 随机字符串或数字</span></span><br></pre></td></tr></table></figure>

<p><img src="https://img.beyourself.org.cn/abc/1571716412223.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_24,text_6KW_5a6J5Y2D6ZSL5LqR6K6h566X,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10#id=jgFBs&originHeight=650&originWidth=834&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p>Deployment是一个定义及管理多副本应用（即多个副本 Pod）的新一代对象，与Replication Controller相比，它提供了更加完善的功能，使用起来更加简单方便。</p>
<h4 id="16-1-deployment-实例"><a href="#16-1-deployment-实例" class="headerlink" title="16.1 deployment 实例"></a>16.1 deployment 实例</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">例1：</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"> <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"> <span class="attr">selector:</span></span><br><span class="line">   <span class="attr">matchLabels:</span></span><br><span class="line">     <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"> <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line"> <span class="attr">template:</span></span><br><span class="line">   <span class="attr">metadata:</span></span><br><span class="line">     <span class="attr">labels:</span></span><br><span class="line">       <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">   <span class="attr">spec:</span></span><br><span class="line">     <span class="attr">containers:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">       <span class="attr">image:</span> <span class="string">nginx:1.7.9</span></span><br><span class="line">       <span class="attr">ports:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">例2：在上面yaml的基础上添加了volume</span></span><br><span class="line">[<span class="string">root@kub-k8s-master</span> <span class="string">prome</span>]<span class="comment"># vim deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span>  <span class="comment">#注意版本号</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">selector:</span>  <span class="comment">#属性，选择器</span></span><br><span class="line">  <span class="attr">matchLabels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">replicas:</span> <span class="number">2</span>  <span class="comment">#管理的副本个数</span></span><br><span class="line"><span class="attr">template:</span>  <span class="comment">#模板属性</span></span><br><span class="line">  <span class="attr">metadata:</span> <span class="comment">#对pod的描述</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">spec:</span></span><br><span class="line">    <span class="attr">volumes:</span>   <span class="comment">#定义共享卷</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-vol</span></span><br><span class="line">      <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">daocloud.io/library/nginx</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">volumeMounts:</span>  <span class="comment">#定义挂载卷</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">&quot;/usr/share/nginx/html&quot;</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx-vol</span></span><br></pre></td></tr></table></figure>

<h4 id="16-2-文件说明"><a href="#16-2-文件说明" class="headerlink" title="16.2 文件说明"></a>16.2 文件说明</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">创建Deployment：</span></span><br><span class="line"><span class="attr">将上述的YAML文件保存为deployment.yaml，然后创建Deployment：</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl apply -f deployment.yaml</span></span><br><span class="line"><span class="attr">deployment.apps/nginx-deployment</span> <span class="string">created</span></span><br><span class="line"></span><br><span class="line"><span class="attr">检查Deployment的列表：启动之后需要创建时间比较长</span></span><br><span class="line"><span class="attr">通过</span> <span class="string">kubectl get 命令检查这个 YAML 运行起来的状态：</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl get deployments</span></span><br><span class="line"><span class="attr">NAME</span>               <span class="string">READY   UP-TO-DATE   AVAILABLE   AGE</span></span><br><span class="line"><span class="attr">nginx-deployment</span>   <span class="string">2/2     2            2           2m22s</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl get pods -l app=nginx</span></span><br><span class="line"><span class="attr">NAME</span>                                <span class="string">READY   STATUS    RESTARTS   AGE</span></span><br><span class="line"><span class="attr">nginx-deployment-59c4b86474-2llrt</span>   <span class="string">1/1     Running   0          2m51s</span></span><br><span class="line"><span class="attr">nginx-deployment-59c4b86474-n2r2m</span>   <span class="string">1/1     Running   0          2m51s</span></span><br><span class="line"></span><br><span class="line"><span class="attr">在这里加上了一个</span> <span class="string">-l 参数，即获取所有匹配 app: nginx 标签的 Pod。需要注意的是，在命令行中，所有 key-value 格式的参数，都使用&quot;=&quot;而非&quot;:&quot;表示。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">删除Deployment</span>:<span class="string"></span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">~]# kubectl delete deployments nginx-deployment</span></span><br><span class="line"><span class="attr">deployment</span> <span class="string">&quot;nginx-deployment&quot; deleted</span></span><br><span class="line"><span class="attr">或者</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">~]# kubectl delete -f deployment.yaml</span></span><br></pre></td></tr></table></figure>

<h4 id="16-3-deployment可用字段"><a href="#16-3-deployment可用字段" class="headerlink" title="16.3 deployment可用字段"></a>16.3 deployment可用字段</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">replicas</span>: <span class="string">1 # 声明副本数目</span></span><br><span class="line"><span class="attr">revisionHistoryLimit</span>: <span class="string">3 # 保留历史版本</span></span><br><span class="line"><span class="attr">selector</span>: <span class="string"># 选择器</span></span><br></pre></td></tr></table></figure>

<h3 id="十七-Service-服务"><a href="#十七-Service-服务" class="headerlink" title="十七.Service 服务"></a>十七.Service 服务</h3><blockquote>
<p>k8s 内部域名访问方式<br>..svc.cluster.local</p>
</blockquote>
<h4 id="17-1-创建service"><a href="#17-1-创建service" class="headerlink" title="17.1 创建service"></a>17.1 创建service</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">1.创建一个depl</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# vim nginx-depl.yml</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">dep01</span></span><br><span class="line"><span class="attr">spec</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">selector</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">matchLabels</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">app</span>: <span class="string">web</span></span><br><span class="line">  <span class="attr">replicas</span>: <span class="string">2</span></span><br><span class="line">  <span class="attr">template</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">labels</span>:<span class="string"></span></span><br><span class="line">          <span class="attr">app</span>: <span class="string">web</span></span><br><span class="line">      <span class="attr">spec</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">containers</span>:<span class="string"></span></span><br><span class="line">          <span class="attr">-</span> <span class="string">name: testnginx9</span></span><br><span class="line">            <span class="attr">image</span>: <span class="string">daocloud.io/library/nginx</span></span><br><span class="line">            <span class="attr">ports</span>:<span class="string"></span></span><br><span class="line">              <span class="attr">-</span> <span class="string">containerPort: 80</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl apply -f nginx-depl.yml </span></span><br><span class="line"><span class="attr">deployment.apps/nginx-deployment</span> <span class="string">created</span></span><br><span class="line"><span class="attr">2.</span> <span class="string">创建service并且以nodePort的方式暴露端口给外网：</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# vim nginx_svc.yaml</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">v1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">mysvc</span></span><br><span class="line"><span class="attr">spec</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">type</span>: <span class="string">NodePort  #类型</span></span><br><span class="line">  <span class="attr">ports</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">-</span> <span class="string">port: 8080</span></span><br><span class="line">      <span class="attr">nodePort</span>: <span class="string">30001</span></span><br><span class="line">      <span class="attr">targetPort</span>: <span class="string">80</span></span><br><span class="line">  <span class="attr">selector</span>:   <span class="string">#选择器</span></span><br><span class="line">    <span class="attr">app</span>: <span class="string">web</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl apply -f nginx_svc.yaml </span></span><br><span class="line"><span class="attr">service/mysvc</span> <span class="string">created</span></span><br><span class="line"></span><br><span class="line"><span class="attr">3.测试</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl get svc</span></span><br><span class="line"><span class="attr">NAME</span>         <span class="string">TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE</span></span><br><span class="line"><span class="attr">kubernetes</span>   <span class="string">ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP          5d18h</span></span><br><span class="line"><span class="attr">mysvc</span>        <span class="string">NodePort    10.100.166.208   &lt;none&gt;        8080:30001/TCP   21s</span></span><br></pre></td></tr></table></figure>

<h4 id="17-2-页面请求测试"><a href="#17-2-页面请求测试" class="headerlink" title="17.2 页面请求测试"></a>17.2 页面请求测试</h4><p><img src="https://img.beyourself.org.cn/abc/image-20220919215740981.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_54,text_6KW_5a6J5Y2D6ZSL5LqR6K6h566X,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10#id=ledaF&originHeight=1028&originWidth=1912&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<h4 id="17-3-pod内部请求测试"><a href="#17-3-pod内部请求测试" class="headerlink" title="17.3 pod内部请求测试"></a>17.3 pod内部请求测试</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入docker容器</span></span><br><span class="line"><span class="attr">[root@kube-node1</span> <span class="string">~]# docker exec -it b4 /bin/bash</span></span><br><span class="line"><span class="comment"># 请求</span></span><br><span class="line"><span class="attr">root@dep01-694c5dbcd-ccdsv</span>:<span class="string">/# curl mysvc.default.svc.cluster.local:8080</span></span><br><span class="line"><span class="attr">&lt;!DOCTYPE</span> <span class="string">html&gt;</span></span><br><span class="line"><span class="attr">&lt;html&gt;</span></span><br><span class="line"><span class="attr">&lt;head&gt;</span></span><br><span class="line"><span class="attr">&lt;title&gt;Welcome</span> <span class="string">to nginx!&lt;/title&gt;</span></span><br><span class="line"><span class="attr">&lt;style&gt;</span></span><br><span class="line">    <span class="attr">body</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="attr">width</span>: <span class="string">35em;</span></span><br><span class="line">        <span class="attr">margin</span>: <span class="string">0 auto;</span></span><br><span class="line">        <span class="attr">font-family</span>: <span class="string">Tahoma, Verdana, Arial, sans-serif;</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line"><span class="attr">&lt;/style&gt;</span></span><br><span class="line"><span class="attr">&lt;/head&gt;</span></span><br><span class="line"><span class="attr">&lt;body&gt;</span></span><br><span class="line"><span class="attr">&lt;h1&gt;Welcome</span> <span class="string">to nginx!&lt;/h1&gt;</span></span><br><span class="line"><span class="attr">&lt;p&gt;If</span> <span class="string">you see this page, the nginx web server is successfully installed and</span></span><br><span class="line"><span class="attr">working.</span> <span class="string">Further configuration is required.&lt;/p&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">&lt;p&gt;For</span> <span class="string">online documentation and support please refer to</span></span><br><span class="line"><span class="attr">&lt;a</span> <span class="string">href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span></span><br><span class="line"><span class="attr">Commercial</span> <span class="string">support is available at</span></span><br><span class="line"><span class="attr">&lt;a</span> <span class="string">href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">&lt;p&gt;&lt;em&gt;Thank</span> <span class="string">you for using nginx.&lt;/em&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="attr">&lt;/body&gt;</span></span><br><span class="line"><span class="attr">&lt;/html&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="17-4-端口解析"><a href="#17-4-端口解析" class="headerlink" title="17.4 端口解析"></a>17.4 端口解析</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 解析</span></span><br><span class="line"><span class="attr">port</span></span><br><span class="line"><span class="attr">port是暴露在cluster</span> <span class="string">ip上的端口，port提供了集群内部客户端访问service的入口，即clusterIP:port。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">nodeport</span></span><br><span class="line"><span class="attr">nodePort</span> <span class="string">提供了集群外部客户端访问 Service 的一种方式，nodePort 提供了集群外部客户端访问 Service 的端口，通过 nodeIP:nodePort 提供了外部流量访问k8s集群中service的入口。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">targetPort</span></span><br><span class="line"><span class="attr">targetPort是pod的端口，从port和nodePort来的流量经过kube-proxy流入到后端pod的targetPort上，最后进入容器。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">containerPort</span></span><br><span class="line"><span class="attr">containerPort是pod内部容器的端口，targetPort映射到containerPort。</span></span><br></pre></td></tr></table></figure>

<h4 id="17-5-kube-proxy-使用ipvs"><a href="#17-5-kube-proxy-使用ipvs" class="headerlink" title="17.5 kube-proxy 使用ipvs"></a>17.5 kube-proxy 使用ipvs</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@master</span> <span class="string">~]# kubectl get configmap kube-proxy -n kube-system -o yaml &gt; kube-proxy-configmap.yaml</span></span><br><span class="line"><span class="attr">[root@master</span> <span class="string">~]# sed -i &#x27;s/mode: &quot;&quot;/mode: &quot;ipvs&quot;/&#x27; kube-proxy-configmap.yaml</span></span><br><span class="line"><span class="attr">[root@master</span> <span class="string">~]# kubectl apply -f kube-proxy-configmap.yaml</span></span><br><span class="line"><span class="attr">[root@master</span> <span class="string">~]# rm -f kube-proxy-configmap.yaml</span></span><br><span class="line"><span class="attr">[root@master</span> <span class="string">~]# kubectl get pod -n kube-system | grep kube-proxy | awk &#x27;&#123;system(&quot;kubectl delete pod &quot;$1&quot; -n kube-system&quot;)&#125;&#x27; </span></span><br><span class="line"></span><br><span class="line"><span class="attr">后续请求时，可以发现已经通过了算法进行调度</span></span><br><span class="line"><span class="attr">[root@kube-master</span> <span class="string">~]# ipvsadm -L -n</span></span><br><span class="line"><span class="attr">IP</span> <span class="string">Virtual Server version 1.2.1 (size=4096)</span></span><br><span class="line"><span class="attr">Prot</span> <span class="string">LocalAddress:Port Scheduler Flags</span></span><br><span class="line">  <span class="attr">-&gt;</span> <span class="string">RemoteAddress:Port           Forward Weight ActiveConn InActConn</span></span><br><span class="line"><span class="attr">TCP</span>  <span class="string">172.17.0.1:30001 rr</span></span><br><span class="line">  <span class="attr">-&gt;</span> <span class="string">10.244.1.34:80               Masq    1      0          0         </span></span><br><span class="line">  <span class="attr">-&gt;</span> <span class="string">10.244.2.31:80               Masq    1      0          0         </span></span><br><span class="line"><span class="attr">TCP</span>  <span class="string">192.168.96.143:30001 rr</span></span><br><span class="line">  <span class="attr">-&gt;</span> <span class="string">10.244.1.34:80               Masq    1      0          12        </span></span><br><span class="line">  <span class="attr">-&gt;</span> <span class="string">10.244.2.31:80               Masq    1      0          12</span></span><br></pre></td></tr></table></figure>

<h3 id="十八-k8s服务暴露"><a href="#十八-k8s服务暴露" class="headerlink" title="十八.k8s服务暴露"></a>十八.k8s服务暴露</h3><h4 id="18-1-ClusterIP"><a href="#18-1-ClusterIP" class="headerlink" title="18.1 ClusterIP"></a>18.1 ClusterIP</h4><blockquote>
<p>此类型会提供一个集群内部的虚拟IP（与Pod不在同一网段)，以供集群内部的pod之间通信使用。ClusterIP也是Kubernetes service的默认类型。</p>
</blockquote>
<h4 id="18-2-NodePort"><a href="#18-2-NodePort" class="headerlink" title="18.2 NodePort"></a>18.2 NodePort</h4><blockquote>
<p>外网client—&gt;nodeIP+nodePort—&gt;podIP+PodPort</p>
<p>为每个节点暴露一个端口，通过nodeip + nodeport可以访问这个服务，同时服务依然会有cluster类型的ip+port。内部通过clusterip方式访问，外部通过nodeport方式访问。</p>
</blockquote>
<h4 id="18-3-loadbalance"><a href="#18-3-loadbalance" class="headerlink" title="18.3 loadbalance"></a>18.3 loadbalance</h4><blockquote>
<p>LoadBalancer在NodePort基础上，K8S可以请求底层云平台创建一个负载均衡器，将每个Node作为后端，进行服务分发。</p>
</blockquote>
<h4 id="18-4-Ingress"><a href="#18-4-Ingress" class="headerlink" title="18.4 Ingress"></a>18.4 Ingress</h4><blockquote>
<p>Ingress是一种HTTP方式的路由转发机制，为K8S服务配置HTTP负载均衡器，通常会将服务暴露给K8S群集外的客户端。</p>
</blockquote>
<h3 id="十九-Ingress-暴露服务"><a href="#十九-Ingress-暴露服务" class="headerlink" title="十九.Ingress 暴露服务"></a>十九.Ingress 暴露服务</h3><blockquote>
<p>要理解ingress，需要区分两个概念，ingress和ingress-controller：</p>
<p>ingress对象：<br>指的是k8s中的一个api对象，一般用yaml配置。作用是定义请求如何转发到service的规则，可以理解为配置模板。</p>
<p>ingress-controller：<br>具体实现反向代理及负载均衡的程序，对ingress定义的规则进行解析，根据配置的规则来实现请求转发。</p>
<p>简单来说，ingress-controller才是负责具体转发的组件，通过各种方式将它暴露在集群入口，外部对集群的请求流量会先到ingress-controller，而ingress对象是用来告诉ingress-controller该如何转发请求，比如哪些域名哪些path要转发到哪些服务等等。</p>
</blockquote>
<blockquote>
<p>service 的表现形式为IP:PORT，即工作在第四层传输层（TCP&#x2F;IP层），对于不同的URL地址经常对应用不同的后端服务或者虚拟服务器，这些应用层的转发机制仅通过kubernetes的service机制是无法实现的，这种情况我么可以使用ingress策略定义和一个具体的ingress Controller.</p>
<p>Ingress提供七层负载均衡能力，可以通过 Ingress 配置提供外部可访问的 URL、负载均衡、SSL、基于名称的虚拟主机等。作为集群流量接入层，Ingress 的高可靠性显得尤为重要。</p>
</blockquote>
<h4 id="19-1-ingress详解"><a href="#19-1-ingress详解" class="headerlink" title="19.1 ingress详解"></a>19.1 ingress详解</h4><ul>
<li>这个负载均衡是基于nginx七层反向代理来实现的，ingress工作原理如下图：<br><img src="https://img.beyourself.org.cn/abc/image-20210602215339600.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_27,text_6KW_5a6J5Y2D6ZSL5LqR6K6h566X,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10#id=oTSXr&originHeight=731&originWidth=958&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="> </li>
<li>外部客户端通过访问负载均衡器，然后调度到service上，然后在调度到IngressController，IngressController通过Ingress规则（域名或虚拟主机）访问到后端pod，而在Ingress规则当中对应的主机是由service分组来设定的，可以看到，这幅图有2种service，最上面的service是用来对外提供服务的，而下面2个service仅仅是用来分pod组的</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Kubernetes</span> <span class="string">并没有自带 Ingress Controller，实际上ingress-controller只是一个统称，具体实现有多种，需要自己单独安装，目前，由k8s维护的ingress-controller只有google云的GCE与ingress-nginx两个，常用的是 Ingress-nginx Controller.</span></span><br></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Ingress</span> <span class="string">一般由三个组件组成：</span></span><br><span class="line"></span><br><span class="line"><span class="attr">1.</span> <span class="string">Nginx 反向代理负载均衡器</span></span><br><span class="line"><span class="attr">2.</span> <span class="string">Ingress Controller 可以理解为控制器，它通过不断的跟 Kubernetes API 交互，实时获取后端 Service、Pod 等的变化，比如新增、删除等，然后结合 Ingress 定义的规则生成配置，然后动态更新上边的 Nginx 负载均衡器，并刷新使配置生效，来达到服务自动发现的作用。</span></span><br><span class="line"><span class="attr">3.</span> <span class="string">Ingress 则是定义规则，通过它定义某个域名的请求过来之后转发到集群中指定的 Service。它可以通过 Yaml 文件定义，可以给一个或多个 Service 定义一个或多个 Ingress 规则。</span></span><br></pre></td></tr></table></figure>

<h4 id="19-2-如何创建-Ingress-资源"><a href="#19-2-如何创建-Ingress-资源" class="headerlink" title="19.2 如何创建 Ingress 资源"></a>19.2 如何创建 Ingress 资源</h4><ul>
<li>Ingress 中的spec字段是Ingress资源的核心组成部分，主要包含以下3个字段： <ul>
<li>rules：用于定义当前Ingress资源的转发规则列表；由rules定义规则，或没有匹配到规则时，所有的流量会转发到由backend定义的默认后端。</li>
<li>backend：默认的后端，用于服务那些没有匹配到任何规则的请求；定义Ingress资源时，必须要定义backend或rules两者之一，该字段用于让负载均衡器指定一个全局默认的后端。</li>
<li>tls：TLS配置，目前仅支持通过默认端口443提供服务，如果要配置指定的列表成员指向不同的主机，则需要通过SNI TLS扩展机制来支持该功能。</li>
</ul>
</li>
</ul>
<h4 id="19-3-部署-Ingress-控制器（Nginx）"><a href="#19-3-部署-Ingress-控制器（Nginx）" class="headerlink" title="19.3 部署 Ingress 控制器（Nginx）"></a>19.3 部署 Ingress 控制器（Nginx）</h4><h5 id="19-3-1-下载ingress-controller"><a href="#19-3-1-下载ingress-controller" class="headerlink" title="19.3.1 下载ingress controller"></a>19.3.1 下载ingress controller</h5><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">~]# cd /mnt/</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">mnt]# wget https://codeload.github.com/kubernetes/ingress-nginx/tar.gz/refs/tags/controller-v1.3.1</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">mnt]# tar xf ingress-nginx-controller-v1.3.1.tar.gz</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">mnt]# cd ingress-nginx-controller-v1.3.1/deploy/static/provider/cloud</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">cloud]# ls</span></span><br><span class="line"><span class="attr">deploy.yaml</span>  <span class="string">kustomization.yaml</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">cloud]# cd</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">~]# vim deploy.yaml #修改配置文件</span></span><br><span class="line"><span class="attr">找到已下apiserver的版本：</span></span><br><span class="line"><span class="comment"># 390行修改</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">DaemonSet  #将原来的Deployment修改为DaemonSet</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 415行下边添加</span></span><br><span class="line"><span class="attr">hostNetwork</span>: <span class="string">true  #添加此配置</span></span><br></pre></td></tr></table></figure>

<p><strong>需要修改的地方：</strong></p>
<p>kind: DaemonSet：</p>
<blockquote>
<p>官方原始文件使用的是deployment，replicate 为 1，这样将会在某一台节点上启动对应的nginx-ingress-controller pod。外部流量访问至该节点，由该节点负载分担至内部的service。测试环境考虑防止单点故障，改为DaemonSet然后删掉replicate ，配合亲和性部署在制定节点上启动nginx-ingress-controller pod，确保有多个节点启动nginx-ingress-controller pod，后续将这些节点加入到外部硬件负载均衡组实现高可用性。</p>
</blockquote>
<p>hostNetwork: true：</p>
<blockquote>
<p>添加该字段，暴露nginx-ingress-controller pod的服务端口（80）</p>
</blockquote>
<h5 id="19-3-2-创建ingress-controller"><a href="#19-3-2-创建ingress-controller" class="headerlink" title="19.3.2 创建ingress-controller"></a>19.3.2 创建ingress-controller</h5><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">~]# kubectl apply -f deploy.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">查看ingress-controller资源</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">~]# kubectl get pods -n ingress-nginx</span></span><br><span class="line"><span class="attr">NAME</span>                             <span class="string">READY   STATUS    RESTARTS   AGE</span></span><br><span class="line"><span class="attr">nginx-ingress-controller-s8vnl</span>   <span class="string">1/1     Running   0          98m</span></span><br><span class="line"><span class="attr">nginx-ingress-controller-ztxz4</span>   <span class="string">1/1     Running   0          97m</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">cloud]# kubectl get ingressclass</span></span><br><span class="line"><span class="attr">NAME</span>    <span class="string">CONTROLLER             PARAMETERS   AGE</span></span><br><span class="line"><span class="attr">nginx</span>   <span class="string">k8s.io/ingress-nginx   &lt;none&gt;       38m</span></span><br></pre></td></tr></table></figure>

<p>测试ingress</p>
<p>创建两个应用和service</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">~]# vim my-apache.yaml</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line"> <span class="attr">name</span>: <span class="string">my-apache</span></span><br><span class="line"><span class="attr">spec</span>:<span class="string"></span></span><br><span class="line"> <span class="attr">selector</span>:<span class="string"></span></span><br><span class="line">   <span class="attr">matchLabels</span>:<span class="string"></span></span><br><span class="line">     <span class="attr">run</span>: <span class="string">my-apache</span></span><br><span class="line"> <span class="attr">replicas</span>: <span class="string">2</span></span><br><span class="line"> <span class="attr">template</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">   <span class="attr">labels</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">run</span>: <span class="string">my-apache</span></span><br><span class="line">  <span class="attr">spec</span>:<span class="string"></span></span><br><span class="line">   <span class="attr">containers</span>:<span class="string"></span></span><br><span class="line">   <span class="attr">-</span> <span class="string">name: my-apache</span></span><br><span class="line">     <span class="attr">image</span>: <span class="string">daocloud.io/library/httpd:2.4</span></span><br><span class="line">     <span class="attr">ports</span>:<span class="string"></span></span><br><span class="line">     <span class="attr">-</span> <span class="string">containerPort: 80</span></span><br><span class="line"><span class="attr">---</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">v1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line"> <span class="attr">name</span>: <span class="string">my-apache</span></span><br><span class="line"> <span class="attr">labels</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">run</span>: <span class="string">my-apache</span></span><br><span class="line"><span class="attr">spec</span>:<span class="string"></span></span><br><span class="line"><span class="comment"> #type: NodePort</span></span><br><span class="line"> <span class="attr">ports</span>:<span class="string"></span></span><br><span class="line"> <span class="attr">-</span> <span class="string">port: 80</span></span><br><span class="line">   <span class="attr">targetPort</span>: <span class="string">80</span></span><br><span class="line"><span class="comment">   #nodePort: 30002</span></span><br><span class="line"> <span class="attr">selector</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">run</span>: <span class="string">my-apache</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">~]# cat my-nginx.yaml </span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line"> <span class="attr">name</span>: <span class="string">my-nginx</span></span><br><span class="line"><span class="attr">spec</span>:<span class="string"></span></span><br><span class="line"> <span class="attr">selector</span>:<span class="string"></span></span><br><span class="line">   <span class="attr">matchLabels</span>:<span class="string"></span></span><br><span class="line">     <span class="attr">run</span>: <span class="string">my-nginx</span></span><br><span class="line"> <span class="attr">replicas</span>: <span class="string">2</span></span><br><span class="line"> <span class="attr">template</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">   <span class="attr">labels</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">run</span>: <span class="string">my-nginx</span></span><br><span class="line">  <span class="attr">spec</span>:<span class="string"></span></span><br><span class="line">   <span class="attr">containers</span>:<span class="string"></span></span><br><span class="line">   <span class="attr">-</span> <span class="string">name: my-nginx</span></span><br><span class="line">     <span class="attr">image</span>: <span class="string">daocloud.io/library/nginx:1.7.9</span></span><br><span class="line">     <span class="attr">ports</span>:<span class="string"></span></span><br><span class="line">     <span class="attr">-</span> <span class="string">containerPort: 80</span></span><br><span class="line"><span class="attr">---</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">v1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line"> <span class="attr">name</span>: <span class="string">my-nginx</span></span><br><span class="line"> <span class="attr">labels</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">run</span>: <span class="string">my-nginx</span></span><br><span class="line"><span class="attr">spec</span>:<span class="string"></span></span><br><span class="line"><span class="comment"> #type: NodePort</span></span><br><span class="line"> <span class="attr">ports</span>:<span class="string"></span></span><br><span class="line"> <span class="attr">-</span> <span class="string">port: 80</span></span><br><span class="line">   <span class="attr">targetPort</span>: <span class="string">80</span></span><br><span class="line"><span class="comment">   #nodePort: 30001</span></span><br><span class="line"> <span class="attr">selector</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">run</span>: <span class="string">my-nginx</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="attr">创建pod和service</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">~]# kubectl apply -f my-apache.yaml</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">~]# kubectl apply -f my-nginx.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">查看资源</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">~]# kubectl get pods</span></span><br><span class="line"><span class="attr">NAME</span>                        <span class="string">READY   STATUS    RESTARTS   AGE</span></span><br><span class="line"><span class="attr">my-apache-d49c8b95c-8z8l9</span>   <span class="string">1/1     Running   0          125m</span></span><br><span class="line"><span class="attr">my-apache-d49c8b95c-d9q5s</span>   <span class="string">1/1     Running   0          125m</span></span><br><span class="line"><span class="attr">my-nginx-5fdc96f9b4-bmf6s</span>   <span class="string">1/1     Running   0          124m</span></span><br><span class="line"><span class="attr">my-nginx-5fdc96f9b4-qfw8c</span>   <span class="string">1/1     Running   0          124m</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">~]# kubectl get svc</span></span><br><span class="line"><span class="attr">NAME</span>         <span class="string">TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE</span></span><br><span class="line"><span class="attr">kubernetes</span>   <span class="string">ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP        20d</span></span><br><span class="line"><span class="attr">my-apache</span>    <span class="string">NodePort    10.99.178.186   &lt;none&gt;        80/TCP   125m</span></span><br><span class="line"><span class="attr">my-nginx</span>     <span class="string">NodePort    10.97.171.188   &lt;none&gt;        80/TCP   124m</span></span><br></pre></td></tr></table></figure>

<p>配置ingress转发文件</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">~]# cat ingress-test.yaml </span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line"> <span class="attr">name</span>: <span class="string">test-ingress</span></span><br><span class="line"> <span class="attr">namespace</span>: <span class="string">default</span></span><br><span class="line"> <span class="attr">annotations</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/rewrite-target</span>: <span class="string">/</span></span><br><span class="line"><span class="attr">spec</span>:<span class="string"></span></span><br><span class="line"> <span class="attr">ingressClassName</span>: <span class="string">nginx</span></span><br><span class="line"> <span class="attr">rules</span>:  <span class="string">#定义转发规则</span></span><br><span class="line"> <span class="attr">-</span> <span class="string">host: test.apache.ingress  #指定域名方式</span></span><br><span class="line">   <span class="attr">http</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">paths</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">-</span> <span class="string">path: /  #指定访问的路径</span></span><br><span class="line">      <span class="attr">pathType</span>: <span class="string">Prefix  #定义路径的类型</span></span><br><span class="line">      <span class="attr">backend</span>:   <span class="string">#定义转发后端的服务</span></span><br><span class="line">       <span class="attr">service</span>:  <span class="string">#定义转发的service</span></span><br><span class="line">         <span class="attr">name</span>: <span class="string">my-apache</span></span><br><span class="line">         <span class="attr">port</span>:<span class="string"></span></span><br><span class="line">          <span class="attr">number</span>: <span class="string">80</span></span><br><span class="line"> <span class="attr">-</span> <span class="string">host: test.nginx.ingress</span></span><br><span class="line">   <span class="attr">http</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">paths</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">-</span> <span class="string">path: /</span></span><br><span class="line">      <span class="attr">pathType</span>: <span class="string">Prefix</span></span><br><span class="line">      <span class="attr">backend</span>:<span class="string"></span></span><br><span class="line">       <span class="attr">service</span>:<span class="string"></span></span><br><span class="line">         <span class="attr">name</span>: <span class="string">my-nginx</span></span><br><span class="line">         <span class="attr">port</span>:<span class="string"></span></span><br><span class="line">          <span class="attr">number</span>: <span class="string">80</span></span><br><span class="line">          </span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">~]# kubectl apply -f ingress-test.yaml</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">~]# kubectl get ingress</span></span><br><span class="line"><span class="attr">NAME</span>           <span class="string">CLASS    HOSTS                                    ADDRESS   PORTS   AGE</span></span><br><span class="line"><span class="attr">test-ingress</span>   <span class="string">&lt;none&gt;   test.apache.ingress,test.nginx.ingress             80      119m</span></span><br></pre></td></tr></table></figure>

<h5 id="19-3-3-修改ingress转发类型"><a href="#19-3-3-修改ingress转发类型" class="headerlink" title="19.3.3 修改ingress转发类型"></a>19.3.3 修改ingress转发类型</h5><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">~]# kubectl edit svc ingress-nginx-controller -n ingress-nginx</span></span><br><span class="line"><span class="comment"># 将type修改为NodePort</span></span><br></pre></td></tr></table></figure>

<p>nginx-ingress-controller运行在node1,node2两个节点上。</p>
<p>如果网络中有dns服务器，在dns中把这两个域名映射到nginx-ingress-controller运行的任意一个节点上，如果没有dns服务器只能修改host文件了。</p>
<p>任意一个节点上操作：(客户端解析)</p>
<p>我这里有两个节点部署了控制器，ip分别为172.16.229.5，172.16.229.6 ，如果有多个，可以随便选。</p>
<p>在wind电脑设置本地解析</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">172.16.229.5</span> <span class="string">test.nginx.ingress</span></span><br><span class="line"><span class="attr">172.16.229.6</span> <span class="string">test.apache.ingress</span></span><br></pre></td></tr></table></figure>

<h3 id="二十-企业级镜像仓库Harbor"><a href="#二十-企业级镜像仓库Harbor" class="headerlink" title="二十.企业级镜像仓库Harbor"></a>二十.企业级镜像仓库Harbor</h3><blockquote>
<p>如果资源不足可以在3个节点中的任意节点部署，也可以在单独的一台中部署。</p>
</blockquote>
<h4 id="20-1-上传harbor安装包并安装"><a href="#20-1-上传harbor安装包并安装" class="headerlink" title="20.1 上传harbor安装包并安装"></a>20.1 上传harbor安装包并安装</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">$</span> <span class="string">tar xf harbor-offline-installer-v2.5.3.tgz</span></span><br><span class="line"><span class="attr">$</span> <span class="string">cp harbor.yml.tmpl harbor.yml</span></span><br><span class="line"><span class="attr">$</span> <span class="string">vim harbor.yml</span></span><br><span class="line"><span class="attr">hostname</span>: <span class="string">192.168.246.217</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># http related config</span></span><br><span class="line"><span class="attr">http</span>:<span class="string"></span></span><br><span class="line"><span class="comment">  # port for http, default is 80. If https enabled, this port will redirect to https port</span></span><br><span class="line">  <span class="attr">port</span>: <span class="string">80</span></span><br><span class="line"><span class="comment"># 注释所有https的内容</span></span><br><span class="line"></span><br><span class="line"><span class="attr">$</span> <span class="string">./install.sh</span></span><br></pre></td></tr></table></figure>

<h4 id="20-2-浏览器访问"><a href="#20-2-浏览器访问" class="headerlink" title="20.2 浏览器访问"></a>20.2 浏览器访问</h4><blockquote>
<p>默认账号：admin 默认密码：Harbor12345</p>
</blockquote>
<p><img src="https://img.beyourself.org.cn/abc/ea6ae6811b140a358cc9e891954a8dd.jpg?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_55,text_6KW_5a6J5Y2D6ZSL5LqR6K6h566X,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10#id=g2JPM&originHeight=945&originWidth=1920&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<h4 id="20-3-k8s使用harbor仓库"><a href="#20-3-k8s使用harbor仓库" class="headerlink" title="20.3 k8s使用harbor仓库"></a>20.3 k8s使用harbor仓库</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 两台node节点执行</span></span><br><span class="line"><span class="attr">[root@kub-k8s-node1</span> <span class="string">~]# vim /etc/docker/daemon.json    #不存在则创建</span></span><br><span class="line"><span class="attr">&#123;</span> <span class="string">&quot;insecure-registries&quot;:[&quot;192.168.246.168&quot;] &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">重启docker：</span></span><br><span class="line"><span class="attr">[root@kub-k8s-node1</span> <span class="string">~]# systemctl restart docker</span></span><br></pre></td></tr></table></figure>

<h4 id="20-4-上传镜像到仓库"><a href="#20-4-上传镜像到仓库" class="headerlink" title="20.4 上传镜像到仓库"></a>20.4 上传镜像到仓库</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ docker login http://192.168.246.168</span><br><span class="line">页面中创建用户及仓库</span><br><span class="line">$ docker pull newrain857/show</span><br><span class="line">$ docker tag newrain857/show 192.168.246.168/os-image/show:latest</span><br></pre></td></tr></table></figure>

<h4 id="20-5-创建secret-yaml文件"><a href="#20-5-创建secret-yaml文件" class="headerlink" title="20.5 创建secret.yaml文件"></a>20.5 创建secret.yaml文件</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">$</span> <span class="string">cat ~/.docker/config.json |base64 -w 0</span></span><br><span class="line"><span class="attr">ewoJImF1dGhzIjogewoJCSIxOTIuMTY4Ljk2LjIxNyI6IHsKCQkJImF1dGgiOiAiZUdsaGIyMXBibWM2VVhFeE1URXhNVEU9IgoJCX0KCX0KfQ</span>=<span class="string">=</span></span><br><span class="line"></span><br><span class="line"><span class="attr">创建</span> <span class="string">secret.yaml 文件</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">v1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">login</span></span><br><span class="line"><span class="attr">type</span>: <span class="string">kubernetes.io/dockerconfigjson</span></span><br><span class="line"><span class="attr">data</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">.dockerconfigjson</span>: <span class="string">ewoJImF1dGhzIjogewoJCSIxOTIuMTY4Ljk2LjIxNyI6IHsKCQkJImF1dGgiOiAiZUdsaGIyMXBibWM2VVhFeE1URXhNVEU9IgoJCX0KCX0KfQ==</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">$</span> <span class="string">kubectl apply -f secret.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">或者</span> <span class="string"></span></span><br><span class="line"><span class="attr">kubectl</span> <span class="string">create secret docker-registry  --docker-server=192.168.246.168 --docker-username=admin --docker-password=Harbor12345 --docker-email=admin@newrain.com</span></span><br></pre></td></tr></table></figure>

<h4 id="20-6-k8s-pod-使用镜像"><a href="#20-6-k8s-pod-使用镜像" class="headerlink" title="20.6 k8s-pod 使用镜像"></a>20.6 k8s-pod 使用镜像</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">vim</span> <span class="string">harbor-pod.yml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">---</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">show</span></span><br><span class="line"><span class="attr">spec</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">replicas</span>: <span class="string">2</span></span><br><span class="line">  <span class="attr">selector</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">matchLabels</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">app</span>: <span class="string">show</span></span><br><span class="line">  <span class="attr">template</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">labels</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">app</span>: <span class="string">show</span></span><br><span class="line">    <span class="attr">spec</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">containers</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">-</span> <span class="string">name: show</span></span><br><span class="line">        <span class="attr">image</span>: <span class="string">192.168.246.168/os-image/show:latest</span></span><br><span class="line">        <span class="attr">ports</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">-</span> <span class="string">containerPort: 80</span></span><br><span class="line">      <span class="attr">imagePullSecrets</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">-</span> <span class="string">name: login</span></span><br><span class="line"></span><br><span class="line"><span class="attr">---</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">v1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">show-service</span></span><br><span class="line"><span class="attr">spec</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">type</span>: <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">selector</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">app</span>: <span class="string">show</span></span><br><span class="line">  <span class="attr">ports</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">-</span> <span class="string">port: 80</span></span><br><span class="line">    <span class="attr">targetPort</span>: <span class="string">80</span></span><br><span class="line">    <span class="attr">nodePort</span>: <span class="string">32000</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 浏览器访问最终的结果</span></span><br></pre></td></tr></table></figure>

<h3 id="二十一-水平扩展-收缩与滚动更新"><a href="#二十一-水平扩展-收缩与滚动更新" class="headerlink" title="二十一.水平扩展&#x2F;收缩与滚动更新"></a>二十一.水平扩展&#x2F;收缩与滚动更新</h3><h4 id="21-1-水平扩展-收缩"><a href="#21-1-水平扩展-收缩" class="headerlink" title="21.1 水平扩展&#x2F;收缩"></a>21.1 水平扩展&#x2F;收缩</h4><h5 id="21-1-1-创建一个deployment"><a href="#21-1-1-创建一个deployment" class="headerlink" title="21.1.1 创建一个deployment"></a>21.1.1 创建一个deployment</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dep01</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">dep01</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">nginx-dep</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.16.1</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<h5 id="21-1-2-通过声明方式扩展"><a href="#21-1-2-通过声明方式扩展" class="headerlink" title="21.1.2 通过声明方式扩展"></a>21.1.2 通过声明方式扩展</h5><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl get deploy</span></span><br><span class="line"><span class="attr">NAME</span>               <span class="string">READY   UP-TO-DATE   AVAILABLE   AGE</span></span><br><span class="line"><span class="attr">dep01</span>              <span class="string">2/2     2            2           4h41m</span></span><br><span class="line"></span><br><span class="line"><span class="attr">我们将dep01的副本数量变成4个，现在2个</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# vim deployment.yaml  #修改如下内容</span></span><br><span class="line"><span class="attr">将replicas</span>: <span class="string">2</span></span><br><span class="line"><span class="attr">修改为：</span></span><br><span class="line"><span class="attr">replicas</span>: <span class="string">4</span></span><br></pre></td></tr></table></figure>

<p><img src="https://img.beyourself.org.cn/abc/1571754655365.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_13,text_6KW_5a6J5Y2D6ZSL5LqR6K6h566X,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10#id=xFb9F&originHeight=202&originWidth=294&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p>创建上节儿的：dep01</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl apply -f deployment.yaml --record</span></span><br><span class="line"><span class="attr">deployment.apps/dep01</span> <span class="string">configured</span></span><br><span class="line"></span><br><span class="line"><span class="attr">--record</span>  <span class="string">kubectl apply 每次更新应用时 Kubernetes 都会记录下当前的配置，保存为一个 revision（版次），这样就可以回滚到某个特定 revision。</span></span><br></pre></td></tr></table></figure>

<p>检查nginx-deployment 创建后的状态信息：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl get deploy</span></span><br><span class="line"><span class="attr">NAME</span>               <span class="string">READY   UP-TO-DATE   AVAILABLE   AGE</span></span><br><span class="line"><span class="attr">dep01</span>              <span class="string">4/4     4            4           4h53m</span></span><br></pre></td></tr></table></figure>

<p>返回结果中四个状态字段含义：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">DESIRED：</span> <span class="string"></span></span><br><span class="line"><span class="attr">如果有就表示用户期望的</span> <span class="string">Pod 副本个数（spec.replicas 的值）；</span></span><br><span class="line"></span><br><span class="line"><span class="attr">CURRENT：</span></span><br><span class="line"><span class="attr">当前处于</span> <span class="string">Running 状态的 Pod 的个数；</span></span><br><span class="line"></span><br><span class="line"><span class="attr">UP-TO-DATE：</span></span><br><span class="line"><span class="attr">当前处于最新版本的</span> <span class="string">Pod 的个数，所谓最新版本指的是 Pod 的 Spec 部分与 Deployment 里 Pod 模板里定义的完全一致；</span></span><br><span class="line"></span><br><span class="line"><span class="attr">AVAILABLE：</span></span><br><span class="line"><span class="attr">当前已经可用的</span> <span class="string">Pod 的个数，即：既是 Running 状态，又是最新版本，并且已经处于 Ready（健康检查正确）状态的 Pod 的个数。只有这个字段，描述的才是用户所期望的最终状态。</span></span><br></pre></td></tr></table></figure>

<h5 id="21-1-3-通过edit方式收缩"><a href="#21-1-3-通过edit方式收缩" class="headerlink" title="21.1.3 通过edit方式收缩"></a>21.1.3 通过edit方式收缩</h5><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl get deploy</span></span><br><span class="line"><span class="attr">NAME</span>               <span class="string">READY   UP-TO-DATE   AVAILABLE   AGE</span></span><br><span class="line"><span class="attr">dep01</span>              <span class="string">4/4     4            4           4h59m</span></span><br><span class="line"></span><br><span class="line"><span class="attr">将dep01的副本将4变为3个</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl edit deployment/dep01</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># reopened with the relevant failures.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">...</span></span><br><span class="line"><span class="attr">spec</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">progressDeadlineSeconds</span>: <span class="string">600</span></span><br><span class="line">  <span class="attr">replicas</span>: <span class="string">3   #将这里原来的4改为3</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit</span>: <span class="string">10</span></span><br><span class="line">  <span class="attr">selector</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">matchLabels</span>:<span class="string"></span></span><br><span class="line"><span class="attr">...</span></span><br><span class="line"><span class="attr">保存退出，vim的方式</span></span><br><span class="line"><span class="attr">[root@kub-k8s-master</span> <span class="string">prome]# kubectl edit deployment/dep01</span></span><br><span class="line"><span class="attr">deployment.apps/dep01</span> <span class="string">edited</span></span><br></pre></td></tr></table></figure>

<h4 id="21-2-滚动更新"><a href="#21-2-滚动更新" class="headerlink" title="21.2 滚动更新"></a>21.2 滚动更新</h4><p>概念：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">将一个集群中正在运行的多个 Pod 版本，交替地逐一升级的过程，就是&quot;滚动更新&quot;。</span><br></pre></td></tr></table></figure>

<h5 id="21-2-1-进行版本的升级"><a href="#21-2-1-进行版本的升级" class="headerlink" title="21.2.1 进行版本的升级"></a>21.2.1 进行版本的升级</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">创建一个新的deploy</span><br><span class="line">[root@kub-k8s-master prome]# cp nginx-depl.yml nginx-depl02.yml</span><br><span class="line">[root@kub-k8s-master prome]# vim nginx-depl02.yml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: dep02 #注意修改</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: web1</span><br><span class="line">  replicas: 2</span><br><span class="line">  template:</span><br><span class="line">      metadata:</span><br><span class="line">        name: testnginx9</span><br><span class="line">        labels:</span><br><span class="line">          app: web1</span><br><span class="line">      spec:</span><br><span class="line">        containers:</span><br><span class="line">          - name: testnginx9</span><br><span class="line">            image: daocloud.io/library/nginx:1.14 #注意修改</span><br><span class="line">            ports:</span><br><span class="line">              - containerPort: 80</span><br><span class="line">[root@kub-k8s-master prome]# kubectl apply -f nginx-depl02.yml </span><br><span class="line">deployment.apps/dep02 created</span><br><span class="line">[root@kub-k8s-master prome]# kubectl get pods</span><br><span class="line">NAME                                READY   STATUS    RESTARTS   AGE</span><br><span class="line">dep01-58f6d4d4cb-997jw              1/1     Running   0          16m</span><br><span class="line">dep01-58f6d4d4cb-g6vtg              1/1     Running   0          5h32m</span><br><span class="line">dep01-58f6d4d4cb-k6z47              1/1     Running   0          5h32m</span><br><span class="line">dep02-78dbd944fc-47czr              1/1     Running   0          44s</span><br><span class="line">dep02-78dbd944fc-4snsj              1/1     Running   0          25s</span><br><span class="line"></span><br><span class="line">将nginx的版本从1.14升级到1.16</span><br><span class="line">[root@kub-k8s-master prome]# kubectl edit deployment/dep02</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Please edit the object below. Lines beginning with a <span class="string">&#x27;#&#x27;</span> will be ignored,</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">and an empty file will abort the edit. If an error occurs <span class="keyword">while</span> saving this file will be</span></span><br><span class="line">...</span><br><span class="line">spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: daocloud.io/library/nginx:1.16  #将这里原来的nginx:1.14修改为nginx:1.16</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        name: testnginx9</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">...</span><br><span class="line">保存退出，vim的方式</span><br><span class="line">[root@kub-k8s-master prome]# kubectl edit deployment/dep02</span><br><span class="line">deployment.apps/dep01 edited</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这时可以通过查看 Deployment 的 Events，看到这个”滚动更新”的流程</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@kub-k8s-master prome]# kubectl describe deployment dep02</span><br><span class="line">...</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason             Age   From                   Message</span><br><span class="line">  ----    ------             ----  ----                   -------</span><br><span class="line">  Normal  ScalingReplicaSet  50s   deployment-controller  Scaled up replica set dep02-846bf8775b to 2</span><br><span class="line">  Normal  ScalingReplicaSet  9s    deployment-controller  Scaled up replica set dep02-58f8d5678 to 1</span><br><span class="line">  Normal  ScalingReplicaSet  8s    deployment-controller  Scaled down replica set dep02-846bf8775b to 1</span><br><span class="line">  Normal  ScalingReplicaSet  8s    deployment-controller  Scaled up replica set dep02-58f8d5678 to 2</span><br><span class="line">  Normal  ScalingReplicaSet  5s    deployment-controller  Scaled down replica set dep02-846bf8775b to 0</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">如此交替进行，新 ReplicaSet 管理的 Pod 副本数，从 0 个变成 1 个，再变成 2 个，最后变成 3 个。而旧的 ReplicaSet 管理的 Pod 副本数则从 3 个变成 2 个，再变成 1 个，最后变成 0 个。这样，就完成了这一组 Pod 的版本升级过程。</span><br></pre></td></tr></table></figure>

<h5 id="21-2-2-验证"><a href="#21-2-2-验证" class="headerlink" title="21.2.2 验证"></a>21.2.2 验证</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@kub-k8s-master prome]# kubectl get pods</span><br><span class="line">NAME                                READY   STATUS    RESTARTS   AGE</span><br><span class="line">dep02-78dbd944fc-69t8x              1/1     Running   0          11h</span><br><span class="line">dep02-78dbd944fc-7cn86              1/1     Running   0          11h</span><br><span class="line">[root@kub-k8s-master prome]# kubectl exec -it dep02-78dbd944fc-69t8x /bin/bash </span><br><span class="line">root@dep02-78dbd944fc-69t8x:/# nginx -v </span><br><span class="line">nginx version: nginx/1.16.1</span><br><span class="line">root@dep02-78dbd944fc-69t8x:/# exit</span><br></pre></td></tr></table></figure>

<h5 id="21-2-3-滚动更新的好处"><a href="#21-2-3-滚动更新的好处" class="headerlink" title="21.2.3 滚动更新的好处"></a>21.2.3 滚动更新的好处</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在升级刚开始的时候，集群里只有 1 个新版本的 Pod。如果这时，新版本 Pod 有问题启动不起来，那么&quot;滚动更新&quot;就会停止，从而允许开发和运维人员介入。而在这个过程中，由于应用本身还有两个旧版本的 Pod 在线，所以服务并不会受到太大的影响。</span><br></pre></td></tr></table></figure>

<h4 id="21-3-版本回滚"><a href="#21-3-版本回滚" class="headerlink" title="21.3 版本回滚"></a>21.3 版本回滚</h4><h5 id="21-3-1-查看版本历史"><a href="#21-3-1-查看版本历史" class="headerlink" title="21.3.1 查看版本历史"></a>21.3.1 查看版本历史</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@kub-k8s-master prome]# kubectl rollout history deployment/dep02</span><br><span class="line">deployment.apps/dep02 </span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line">1         &lt;none&gt;</span><br><span class="line">2         &lt;none&gt;</span><br></pre></td></tr></table></figure>

<h5 id="21-3-2-回滚到以前的旧版本："><a href="#21-3-2-回滚到以前的旧版本：" class="headerlink" title="21.3.2 回滚到以前的旧版本："></a>21.3.2 回滚到以前的旧版本：</h5><p>    把整个 Deployment 回滚到上一个版本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@kub-k8s-master prome]# kubectl rollout undo deployment/dep02</span><br><span class="line">deployment.apps/dep02 rolled back</span><br></pre></td></tr></table></figure>

<p>查看回滚状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@kub-k8s-master prome]# kubectl rollout status deployment/dep02</span><br><span class="line">deployment &quot;dep02&quot; successfully rolled out</span><br></pre></td></tr></table></figure>

<p>验证：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@kub-k8s-master prome]# kubectl get pods</span><br><span class="line">NAME                                READY   STATUS             RESTARTS   AGE</span><br><span class="line">dep02-8594cd6447-pqtxk              1/1     Running            0          55s</span><br><span class="line">dep02-8594cd6447-tt4h4              1/1     Running            0          51s</span><br><span class="line">[root@kub-k8s-master prome]# kubectl exec -it dep02-8594cd6447-tt4h4 /bin/bash </span><br><span class="line">root@dep02-8594cd6447-tt4h4:/# nginx -v </span><br><span class="line">nginx version: nginx/1.14.2</span><br></pre></td></tr></table></figure>

<h5 id="21-3-3-回滚到更早之前的版本"><a href="#21-3-3-回滚到更早之前的版本" class="headerlink" title="21.3.3 回滚到更早之前的版本"></a>21.3.3 回滚到更早之前的版本</h5><ol>
<li>使用 kubectl rollout history 命令查看每次 Deployment 变更对应的版本。</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@kub-k8s-master prome]# kubectl rollout history deployment/dep02</span><br><span class="line">deployment.apps/dep02 </span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line">2         &lt;none&gt;</span><br><span class="line">3         &lt;none&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">默认配置下，Kubernetes 只会保留最近的几个 revision，可以在 Deployment 配置文件中通过 revisionHistoryLimit: 属性增加 revision 数量。</span></span><br></pre></td></tr></table></figure>

<p><strong>由于在创建这个 Deployment 的时候，指定了–record 参数，会将创建这些版本时执行的 kubectl 时文件中的配置，都会记录下来。</strong></p>
<p>    查看每个版本对应的 Deployment 的 API 对象的细节：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@kub-k8s-master prome]# kubectl rollout history deployment/dep02 --revision=3</span><br><span class="line">deployment.apps/dep02 with revision #3</span><br><span class="line">Pod Template:</span><br><span class="line">  Labels:	app=web1</span><br><span class="line">	pod-template-hash=8594cd6447</span><br><span class="line">  Containers:</span><br><span class="line">   testnginx9:</span><br><span class="line">    Image:	daocloud.io/library/nginx:1.14</span><br><span class="line">    Port:	80/TCP</span><br><span class="line">    Host Port:	0/TCP</span><br><span class="line">    Environment:	&lt;none&gt;</span><br><span class="line">    Mounts:	&lt;none&gt;</span><br><span class="line">  Volumes:	&lt;none&gt;</span><br></pre></td></tr></table></figure>

<p><strong>2.在 kubectl rollout undo 命令行最后，加上要回滚到的指定版本的版本号，就可以回滚到指定版本了。</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@kub-k8s-master prome]# kubectl rollout undo deployment/dep02 --to-revision=2</span><br><span class="line">deployment.apps/dep02 rolled back</span><br></pre></td></tr></table></figure>

<p>验证：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@kub-k8s-master prome]# kubectl get pods</span><br><span class="line">NAME                                READY   STATUS             RESTARTS   AGE</span><br><span class="line">dep02-78dbd944fc-8nvxl              1/1     Running            0          86s</span><br><span class="line">dep02-78dbd944fc-sb9sj              1/1     Running            0          88s</span><br><span class="line">[root@kub-k8s-master prome]# kubectl exec -it dep02-78dbd944fc-8nvxl /bin/bash </span><br><span class="line">root@dep02-78dbd944fc-8nvxl:/# nginx -v</span><br><span class="line">nginx version: nginx/1.16.1</span><br></pre></td></tr></table></figure>

<p>课后了解</p>
<p>你听说过金丝雀发布（Canary Deployment）和蓝绿发布（Blue-Green Deployment）吗？你能说出它们是什么意思吗？</p>
<h3 id="二十二-DeamonSet详解"><a href="#二十二-DeamonSet详解" class="headerlink" title="二十二.DeamonSet详解"></a>二十二.DeamonSet详解</h3><h4 id="22-1-何为DaemonSet"><a href="#22-1-何为DaemonSet" class="headerlink" title="22.1 何为DaemonSet"></a>22.1 何为DaemonSet</h4><p>介绍DaemonSet我们先来思考一个问题：相信大家都接触过监控系统比如zabbix，监控系统需要在被监控机安装一个agent，安装agent通常会涉及到以下几个场景：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">-</span> <span class="string">所有节点都必须安装agent以便采集监控数据</span></span><br><span class="line"><span class="attr">-</span> <span class="string">新加入的节点需要配置agent，手动或者运行脚本</span></span><br></pre></td></tr></table></figure>

<p>k8s中经常涉及到在node上安装部署应用，它是如何解决上述的问题的呢？答案是DaemonSet。DaemonSet守护进程简称DS，适用于在所有节点或部分节点运行一个daemon守护进程。</p>
<p>DaemonSet 的主要作用，是让你在 k8s 集群里，运行一个 Daemon Pod。</p>
<p>这个 Pod 有如下三个特征：</p>
<blockquote>
<ol>
<li>这个 Pod 运行在 k8s 集群里的每一个节点（Node）上；</li>
<li>每个节点上只有一个这样的 Pod 实例；</li>
<li>当有新的节点加入 Kubernetes 集群后，该 Pod 会自动地在新节点上被创建出来；而当旧节点被删除后，它上面的 Pod 也相应地会被回收掉。</li>
</ol>
</blockquote>
<p>举例：</p>
<blockquote>
<p>各种网络插件的 Agent 组件，都必须运行在每一个节点上，用来处理这个节点上的容器网络；</p>
<p>各种存储插件的 Agent 组件，也必须运行在每一个节点上，用来在这个节点上挂载远程存储目录，操作容器的 Volume 目录；</p>
<p>各种监控组件和日志组件，也必须运行在每一个节点上，负责这个节点上的监控信息和日志搜集。</p>
</blockquote>
<h4 id="22-2-DaemonSet-的-API-对象的定义"><a href="#22-2-DaemonSet-的-API-对象的定义" class="headerlink" title="22.2 DaemonSet 的 API 对象的定义"></a>22.2 DaemonSet 的 API 对象的定义</h4><p>所有node节点分别下载镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">docker pull daocloud.io/daocloud/fluentd-elasticsearch:1.20</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">docker pull daocloud.io/daocloud/fluentd-elasticsearch:v2.2.0</span></span><br></pre></td></tr></table></figure>

<p><strong>fluentd-elasticsearch 镜像功能：</strong></p>
<p>通过 fluentd 将每个node节点上面的Docker 容器里的日志转发到 ElasticSearch 中。</p>
<p>编写daemonset配置文件</p>
<p>Yaml文件内容如下</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">~]# mkdir set</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">~]# cd set/</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">set]# vim fluentd-elasticsearch.yaml # DaemonSet 没有 replicas 字段</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">DaemonSet  #创建资源的类型</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line"> <span class="attr">name</span>: <span class="string">fluentd-elasticsearch</span></span><br><span class="line"> <span class="attr">namespace</span>: <span class="string">kube-system</span></span><br><span class="line"> <span class="attr">labels</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">k8s-app</span>: <span class="string">fluentd-logging</span></span><br><span class="line"><span class="attr">spec</span>:<span class="string"></span></span><br><span class="line"> <span class="attr">selector</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">matchLabels</span>:<span class="string"></span></span><br><span class="line">   <span class="attr">name</span>: <span class="string">fluentd-elasticsearch</span></span><br><span class="line"> <span class="attr">template</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">   <span class="attr">labels</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">name</span>: <span class="string">fluentd-elasticsearch</span></span><br><span class="line">  <span class="attr">spec</span>:<span class="string"></span></span><br><span class="line">   <span class="attr">tolerations</span>:  <span class="string">#容忍污点</span></span><br><span class="line">   <span class="attr">-</span> <span class="string">key: node-role.kubernetes.io/master #污点</span></span><br><span class="line">     <span class="attr">effect</span>: <span class="string">NoSchedule  #描述污点的效应</span></span><br><span class="line">   <span class="attr">containers</span>:<span class="string"></span></span><br><span class="line">   <span class="attr">-</span> <span class="string">name: fluentd-elasticsearch</span></span><br><span class="line">     <span class="attr">image</span>: <span class="string">daocloud.io/daocloud/fluentd-elasticsearch:1.20</span></span><br><span class="line">     <span class="attr">resources</span>:  <span class="string">#限制使用资源</span></span><br><span class="line">      <span class="attr">limits</span>:  <span class="string">#定义使用内存的资源上限</span></span><br><span class="line">       <span class="attr">memory</span>: <span class="string">200Mi</span></span><br><span class="line">      <span class="attr">requests</span>: <span class="string">#实际使用</span></span><br><span class="line">       <span class="attr">cpu</span>: <span class="string">100m</span></span><br><span class="line">       <span class="attr">memory</span>: <span class="string">200Mi</span></span><br><span class="line">     <span class="attr">volumeMounts</span>:<span class="string"></span></span><br><span class="line">     <span class="attr">-</span> <span class="string">name: varlog</span></span><br><span class="line">       <span class="attr">mountPath</span>: <span class="string">/var/log</span></span><br><span class="line">     <span class="attr">-</span> <span class="string">name: varlibdockercontainers</span></span><br><span class="line">       <span class="attr">mountPath</span>: <span class="string">/var/lib/docker/containers</span></span><br><span class="line">       <span class="attr">readOnly</span>: <span class="string">true</span></span><br><span class="line">   <span class="attr">volumes</span>:<span class="string"></span></span><br><span class="line">   <span class="attr">-</span> <span class="string">name: varlog</span></span><br><span class="line">     <span class="attr">hostPath</span>:  <span class="string">#定义卷使用宿主机目录</span></span><br><span class="line">      <span class="attr">path</span>: <span class="string">/var/log</span></span><br><span class="line">   <span class="attr">-</span> <span class="string">name: varlibdockercontainers</span></span><br><span class="line">     <span class="attr">hostPath</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">path</span>: <span class="string">/var/lib/docker/containers</span></span><br></pre></td></tr></table></figure>

<p><strong>DaemonSet 没有 replicas 字段</strong></p>
<p><strong>selector :</strong></p>
<p>选择管理所有携带了 name&#x3D;fluentd-elasticsearch 标签的 Pod。</p>
<p><strong>Pod 的模板用 template 字段定义:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#定义了一个使用 fluentd-elasticsearch:1.20 镜像的容器，而且这个容器挂载了两个 hostPath 类型的 Volume，分别对应宿主机的 /var/log 目录和 /var/lib/docker/containers 目录。</span><br><span class="line"></span><br><span class="line">#fluentd 启动之后，它会从这两个目录里搜集日志信息，并转发给 ElasticSearch 保存。这样，通过 ElasticSearch 就可以很方便地检索这些日志了。Docker 容器里应用的日志，默认会保存在宿主机的 /var/lib/docker/containers/&#123;&#123;. 容器 ID&#125;&#125;/&#123;&#123;. 容器 ID&#125;&#125;-json.log 文件里，这个目录正是 fluentd 的搜集目标。</span><br></pre></td></tr></table></figure>

<p><strong>DaemonSet 如何保证每个 Node 上有且只有一个被管理的 Pod ？</strong></p>
<p>#DaemonSet Controller，首先从 Etcd 里获取所有的 Node 列表，然后遍历所有的 Node。这时，它就可以很容易地去检查，当前这个 Node 上是不是有一个携带了 name&#x3D;fluentd-elasticsearch 标签的 Pod 在运行。</p>
<p><strong>检查结果有三种情况：</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">1.</span> <span class="string">没有这种 Pod，那么就意味着要在这个 Node 上创建这样一个 Pod；指定的 Node 上创建新 Pod 用 nodeSelector，选择 Node 的名字即可。</span></span><br><span class="line"><span class="attr">2.</span> <span class="string">有这种 Pod，但是数量大于 1，那就说明要把多余的 Pod 从这个 Node 上删除掉；删除节点（Node）上多余的 Pod 非常简单，直接调用 Kubernetes API 就可以了。</span></span><br><span class="line"><span class="attr">3.</span> <span class="string">正好只有一个这种 Pod，那说明这个节点是正常的。</span></span><br></pre></td></tr></table></figure>

<p><strong>tolerations:</strong></p>
<p>DaemonSet 还会给这个 Pod 自动加上另外一个与调度相关的字段，叫作 tolerations。这个字段意思是这个 Pod，会”容忍”（Toleration）某些 Node 的”污点”（Taint）。</p>
<p>tolerations 字段，格式如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"> <span class="attr">name:</span> <span class="string">with-toleration</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"> <span class="attr">tolerations:</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node.kubernetes.io/unschedulable</span>  <span class="comment">#污点的key</span></span><br><span class="line">   <span class="attr">operator:</span> <span class="string">Exists</span> <span class="comment">#将会忽略value；只要有key和effect就行</span></span><br><span class="line">   <span class="attr">effect:</span> <span class="string">NoSchedule</span>  <span class="comment">#污点的作用</span></span><br></pre></td></tr></table></figure>

<p>含义是：”容忍”所有被标记为 unschedulable”污点”的 Node；”容忍”的效果是允许调度。可以简单地把”污点”理解为一种特殊的 Label。</p>
<p>正常情况下，被标记了 unschedulable”污点”的 Node，是不会有任何 Pod 被调度上去的（effect: NoSchedule）。可是，DaemonSet 自动地给被管理的 Pod 加上了这个特殊的 Toleration，就使得这些 Pod 可以忽略这个限制，保证每个节点上都会被调度一个 Pod。如果这个节点有故障的话，这个 Pod 可能会启动失败，DaemonSet 会始终尝试下去，直到 Pod 启动成功。</p>
<p><strong>DaemonSet 的”过人之处”，其实就是依靠 Toleration 实现的</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">DaemonSet</span> <span class="string">是一个控制器。在它的控制循环中，只需要遍历所有节点，然后根据节点上是否有被管理 Pod 的情况，来决定是否要创建或者删除一个 Pod。</span></span><br></pre></td></tr></table></figure>

<p><strong>更多种类的Toleration</strong></p>
<p>可以在 Pod 模板里加上更多种类的 Toleration，从而利用 DaemonSet 实现自己的目的。</p>
<p>比如，在这个 fluentd-elasticsearch DaemonSet 里，给它加上了这样的 Toleration：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tolerations:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line">  <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br></pre></td></tr></table></figure>

<p>这是因为在默认情况下，Kubernetes 集群不允许用户在 Master 节点部署 Pod。因为，Master 节点默认携带了一个叫作node-role.kubernetes.io&#x2F;master的”污点”。所以，为了能在 Master 节点上部署 DaemonSet 的 Pod，就必须让这个 Pod”容忍”这个”污点”。</p>
<h4 id="22-3-DaemonSet实践"><a href="#22-3-DaemonSet实践" class="headerlink" title="22.3 DaemonSet实践"></a>22.3 DaemonSet实践</h4><h5 id="22-3-1-创建-DaemonSet-对象"><a href="#22-3-1-创建-DaemonSet-对象" class="headerlink" title="22.3.1 创建 DaemonSet 对象"></a>22.3.1 创建 DaemonSet 对象</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master set] # kubectl create -f fluentd-elasticsearch.yaml</span><br></pre></td></tr></table></figure>

<p>DaemonSet 上一般都加上 resources 字段，来限制它的 CPU 和内存使用，防止它占用过多的宿主机资源。</p>
<p>创建成功后，如果有 3 个节点，就会有 3 个 fluentd-elasticsearch Pod 在运行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master set]# kubectl get pod -n kube-system -l name=fluentd-elasticsearch</span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE</span><br><span class="line">fluentd-elasticsearch-6lmnb   1/1     Running   0          21m</span><br><span class="line">fluentd-elasticsearch-9fd7k   1/1     Running   0          21m</span><br><span class="line">fluentd-elasticsearch-vz4n4   1/1     Running   0          21m</span><br></pre></td></tr></table></figure>

<h5 id="22-3-2-查看-DaemonSet-对象"><a href="#22-3-2-查看-DaemonSet-对象" class="headerlink" title="22.3.2 查看 DaemonSet 对象"></a>22.3.2 查看 DaemonSet 对象</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master set]# kubectl get ds -n kube-system fluentd-elasticsearch</span><br><span class="line">NAME                    DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE</span><br><span class="line">fluentd-elasticsearch   3         3         3       3            3           &lt;none&gt;          22m</span><br></pre></td></tr></table></figure>

<p>注：k8s 里比较长的 API 对象都有短名字，比如 DaemonSet 对应的是 ds，Deployment 对应的是 deploy。</p>
<h5 id="22-3-3-DaemonSet-版本管理"><a href="#22-3-3-DaemonSet-版本管理" class="headerlink" title="22.3.3 DaemonSet 版本管理"></a>22.3.3 DaemonSet 版本管理</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master set]# kubectl rollout history daemonset fluentd-elasticsearch -n kube-system</span><br><span class="line">daemonset.apps/fluentd-elasticsearch </span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line">1         &lt;none&gt;</span><br></pre></td></tr></table></figure>

<h5 id="22-3-4-DaemonSet-的容器镜像版本到-v2-2-0"><a href="#22-3-4-DaemonSet-的容器镜像版本到-v2-2-0" class="headerlink" title="22.3.4 DaemonSet 的容器镜像版本到 v2.2.0"></a>22.3.4 DaemonSet 的容器镜像版本到 v2.2.0</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master set]# kubectl set image ds/fluentd-elasticsearch fluentd-elasticsearch=daocloud.io/daocloud/fluentd-elasticsearch:v2.2.0 --record -n=kube-system</span><br><span class="line">daemonset.apps/fluentd-elasticsearch image updated</span><br></pre></td></tr></table></figure>

<p>这个 kubectl set image 命令里，第一个 fluentd-elasticsearch 是 DaemonSet 的名字，第二个 fluentd-elasticsearch 是容器的名字。</p>
<p><strong>–record 参数:</strong></p>
<p>升级使用到的指令会自动出现在 DaemonSet 的 rollout history 里面，如下所示：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master set]# kubectl rollout history daemonset fluentd-elasticsearch -n kube-system</span><br><span class="line">daemonset.apps/fluentd-elasticsearch </span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line">1         &lt;none&gt;</span><br><span class="line">2         kubectl set image ds/fluentd-elasticsearch fluentd-elasticsearch=daocloud.io/daocloud/fluentd-elasticsearch:v2.2.0 --record=true --namespace=kube-system</span><br></pre></td></tr></table></figure>

<p>有了版本号，也就可以像 Deployment 一样，将 DaemonSet 回滚到某个指定的历史版本了。</p>
<h3 id="二十三-离线业务编排详解"><a href="#二十三-离线业务编排详解" class="headerlink" title="二十三.离线业务编排详解"></a>二十三.离线业务编排详解</h3><h4 id="23-1-在线业务和离线业务"><a href="#23-1-在线业务和离线业务" class="headerlink" title="23.1 在线业务和离线业务"></a>23.1 在线业务和离线业务</h4><p><strong>在线业务</strong></p>
<blockquote>
<p>Deployment、StatefulSet以及 DaemonSet 这三个编排概念的共同之处是：它们主要编排的对象，都是”在线业务”，即：Long Running Task（长作业）。比如常用的 Nginx、Tomcat，以及 MySQL 等等。这些应用一旦运行起来，除非出错或者停止，它的容器进程会一直保持在 Running 状态。</p>
</blockquote>
<p><strong>离线业务</strong></p>
<blockquote>
<p>也可以叫做Batch Job（计算业务）。这种业务在计算完成后就直接退出了，如果用 Deployment 来管理这种业务，会发现 Pod 会在计算结束后退出，然后被 Deployment Controller 不断地重启</p>
</blockquote>
<h4 id="23-2-Job解析"><a href="#23-2-Job解析" class="headerlink" title="23.2 Job解析"></a>23.2 Job解析</h4><p><strong>什么是Job？</strong></p>
<blockquote>
<p>一个用来描述离线业务的 API 对象</p>
</blockquote>
<p><strong>Job API 对象的定义</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim job.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pi</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">     <span class="attr">containers:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pi</span></span><br><span class="line">       <span class="attr">image:</span> <span class="string">resouer/ubuntu-bc</span></span><br><span class="line">       <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;echo &#x27;scale=10000; 4*a(1)&#x27; | bc -l &quot;</span>]</span><br><span class="line">     <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br><span class="line">  <span class="attr">backoffLimit:</span> <span class="number">4</span></span><br></pre></td></tr></table></figure>

<p><strong>Job 对象不要求定义一个 spec.selector 来描述要控制哪些 Pod</strong></p>
<p><strong>spec.template 字段为Pod 模板</strong></p>
<h4 id="23-3-运行程序"><a href="#23-3-运行程序" class="headerlink" title="23.3 运行程序"></a>23.3 运行程序</h4><blockquote>
<p>echo “scale&#x3D;10000; 4*a(1)” | bc -l</p>
<p>bc 命令：</p>
<p>    是 Linux 里的”计算器”</p>
<p>     -l 表示：是要使用标准数学库</p>
<p>     a(1)：  是调用数学库中的 arctangent 函数，计算 atan(1)。这是什么意思呢？</p>
<p>数学知识回顾：</p>
<pre><code>        tan(π/4) = 1。所以，4*atan(1)正好就是π，也就是 3.1415926…。
                             
 		这是一个计算π值的容器。通过 scale=10000，指定了输出的小数点后的位数是 10000。在我的计算机上，这个计算大概用时 1 分 54 秒。
</code></pre>
</blockquote>
<h4 id="23-4-创建Job"><a href="#23-4-创建Job" class="headerlink" title="23.4 创建Job"></a>23.4 创建Job</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl create -f job.yaml</span></span><br></pre></td></tr></table></figure>

<p><strong>查看 Job 对象</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl describe jobs/pi</span></span><br><span class="line"><span class="attr">Name:</span>       <span class="string">pi</span></span><br><span class="line"><span class="attr">Namespace:</span>  <span class="string">default</span></span><br><span class="line"><span class="attr">Selector:</span>     <span class="string">controller-uid=c2db599a-2c9d-11e6-b324-0209dc45a495</span></span><br><span class="line"><span class="attr">Labels:</span>      <span class="string">controller-uid=c2db599a-2c9d-11e6-b324-0209dc45a495</span></span><br><span class="line">         <span class="string">job-name=pi</span></span><br><span class="line"><span class="attr">Annotations:</span>    <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="attr">Parallelism:</span>    <span class="number">1</span></span><br><span class="line"><span class="attr">Completions:</span>    <span class="number">1</span></span><br><span class="line"><span class="string">..</span></span><br><span class="line"><span class="attr">Pods Statuses:</span>   <span class="number">0</span> <span class="string">Running</span> <span class="string">/</span> <span class="number">1</span> <span class="string">Succeeded</span> <span class="string">/</span> <span class="number">0</span> <span class="string">Failed</span></span><br><span class="line"><span class="attr">Pod Template:</span></span><br><span class="line"> <span class="attr">Labels:</span>    <span class="string">controller-uid=c2db599a-2c9d-11e6-b324-0209dc45a495</span></span><br><span class="line">        <span class="string">job-name=pi</span></span><br><span class="line"> <span class="attr">Containers:</span></span><br><span class="line">  <span class="string">...</span></span><br><span class="line"> <span class="attr">Volumes:</span>        <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="attr">Events:</span></span><br><span class="line"> <span class="string">FirstSeen</span>   <span class="string">LastSeen</span>   <span class="string">Count</span>   <span class="string">From</span>       <span class="string">SubobjectPath</span>   <span class="string">Type</span>     <span class="string">Reason</span>       <span class="string">Message</span></span><br><span class="line"><span class="string">---------</span>   <span class="string">--------</span>   <span class="string">-----</span>   <span class="string">----</span>       <span class="string">-------------</span>   <span class="string">--------</span>   <span class="string">------</span>       <span class="string">-------</span></span><br><span class="line"> <span class="string">1m</span>      <span class="string">1m</span>      <span class="number">1</span>     &#123;<span class="string">job-controller</span> &#125;         <span class="attr">Normal    SuccessfulCreate  Created pod:</span> <span class="string">pi-rq5rl</span></span><br></pre></td></tr></table></figure>

<p>为了避免不同 Job 对象所管理的 Pod 发生重合,Job 对象在创建后，它的 Pod 模板，被自动加上了一个 controller-uid&#x3D;&lt; 一个随机字符串 &gt; 这样的 Label。而这个 Job 对象本身，则被自动加上了这个 Label 对应的 Selector，保证了 Job 与它所管理的 Pod 之间的匹配关系。</p>
<p>这种自动生成的 Label 对用户并不友好，不太适合推广到 Deployment 等长作业编排对象上。</p>
<p><strong>Pod 进入了 Running 状态说明它正在计算 Pi 的值</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get pods</span></span><br><span class="line">NAME                 READY   STATUS   RESTARTS  AGE</span><br><span class="line">pi-rq5rl               1/1    Running  0      10s</span><br></pre></td></tr></table></figure>

<p><strong>几分钟后计算结束，这个 Pod 就会进入 Completed 状态</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get pods</span></span><br><span class="line">NAME                  READY    STATUS    RESTARTS  AGE</span><br><span class="line">pi-rq5rl               0/1     Completed  0      4m</span><br></pre></td></tr></table></figure>

<p><strong>离线计算的 Pod 永远都不应该被重启</strong></p>
<blockquote>
<p>实现方式是在 Pod 模板中定义 restartPolicy&#x3D;Never</p>
<p>事实上restartPolicy 在 Job 对象里只允许被设置为 Never 和 OnFailure；而在 Deployment 对象里，restartPolicy 则只允许被设置为 Always。</p>
</blockquote>
<p><strong>查看 Pod 日志</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl logs pi-rq5rl  //可以看到计算得到的 Pi 值已经被打印了出来</span></span><br><span class="line">3.141592653589793238462643383279...</span><br></pre></td></tr></table></figure>

<p><strong>离线作业失败处理方式</strong></p>
<p>离线作业失败后 Job Controller 就会不断地尝试创建一个新 Pod，这个尝试肯定不能无限进行下去。所以，在 Job 对象的 spec.backoffLimit 字段里定义了重试次数为 4（即，backoffLimit&#x3D;4，默认值是 6）</p>
<p>Job Controller 重新创建 Pod 的间隔是呈指数增加的，即下一次重新创建 Pod 的动作会分别发生在 10 s、20 s、40 s …后。</p>
<p>如果restartPolicy&#x3D;OnFailure，离线作业失败后，Job Controller 就不会去尝试创建新的 Pod。但是，它会不断地尝试重启 Pod 里的容器。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get pods</span></span><br><span class="line">NAME                 READY   STATUS        RESTARTS  AGE</span><br><span class="line">pi-55h89               0/1    ContainerCreating  0      2s</span><br><span class="line">pi-tqbcz               0/1    Error        0      5s</span><br></pre></td></tr></table></figure>

<p>可以看到，这时候会不断地有新 Pod 被创建出来。</p>
<p><strong>spec.activeDeadlineSeconds 字段：</strong></p>
<p>当一个 Job 的 Pod 运行结束后，它会进入 Completed 状态。但是，如果这个 Pod 因为某种原因一直不肯结束呢？</p>
<p>在 Job 的 API 对象里，有一个 spec.activeDeadlineSeconds 字段可以设置最长运行时间，比如：</p>
<p><strong>spec:</strong></p>
<p><strong>backoffLimit: 5</strong></p>
<p><strong>activeDeadlineSeconds: 100</strong></p>
<p>一旦运行超过了 100 s，这个 Job 的所有 Pod 都会被终止。并且，你可以在 Pod 的状态里看到终止的原因是 reason: DeadlineExceeded。</p>
<p>以上，就是一个 Job API 对象最主要的概念和用法</p>
<h4 id="23-5-并行作业"><a href="#23-5-并行作业" class="headerlink" title="23.5 并行作业"></a>23.5 并行作业</h4><p>离线业务之所以被称为 Batch Job，是因为它们可以以”Batch”，也就是并行的方式去运行。</p>
<p>负责并行控制的参数有两个：</p>
<blockquote>
<p>spec.parallelism:</p>
<p>    定义一个 Job 在任意时间最多可以启动多少个 Pod 同时运行；</p>
<p>spec.completions:</p>
<p>    定义 Job 至少要完成的 Pod 数目，即 Job 的最小完成数。</p>
</blockquote>
<p>在之前计算 Pi 值的 Job 里，添加这两个参数：</p>
<p>注意：本例只是为了演示 Job 的并行特性，实际用途不大。不过现实中确实存在很多需要并行处理的场景。比如批处理程序，每个副本（Pod）都会从任务池中读取任务并执行，副本越多，执行时间就越短，效率就越高。这种类似的场景都可以用 Job 来实现。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"> <span class="attr">name:</span> <span class="string">pi</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"> <span class="attr">parallelism:</span> <span class="number">2</span></span><br><span class="line"> <span class="attr">completions:</span> <span class="number">4</span></span><br><span class="line"> <span class="attr">template:</span></span><br><span class="line">  <span class="attr">spec:</span></span><br><span class="line">   <span class="attr">containers:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pi</span></span><br><span class="line">     <span class="attr">image:</span> <span class="string">resouer/ubuntu-bc</span></span><br><span class="line">     <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;echo &#x27;scale=5000; 4*a(1)&#x27; | bc -l &quot;</span>]</span><br><span class="line">   <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br><span class="line"> <span class="attr">backoffLimit:</span> <span class="number">4</span></span><br></pre></td></tr></table></figure>

<p>这样，我们就指定了这个 Job 最大的并行数是 2，而最小的完成数是 4。</p>
<p>创建这个 Job 对象：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl create -f job.yaml</span></span><br></pre></td></tr></table></figure>

<p>这个 Job 其实也维护了两个状态字段，即 DESIRED 和 SUCCESSFUL，如下所示：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get job  //注意，最新版本的子段已经不一样了</span></span><br><span class="line">NAME    DESIRED  SUCCESSFUL  AGE</span><br><span class="line">pi        4     0       3s</span><br></pre></td></tr></table></figure>

<p>其中，DESIRED 的值，正是 completions 定义的最小完成数。</p>
<p>这个 Job 首先创建了两个并行运行的 Pod 来计算 Pi：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get pods</span></span><br><span class="line">NAME    READY   STATUS   RESTARTS  AGE</span><br><span class="line">pi-5mt88  1/1    Running  0      6s</span><br><span class="line">pi-gmcq5  1/1    Running  0      6s</span><br></pre></td></tr></table></figure>

<p>而在 40 s 后，这两个 Pod 相继完成计算。</p>
<p>这时可以看到，每当有一个 Pod 完成计算进入 Completed 状态时，就会有一个新的 Pod 被自动创建出来，并且快速地从 Pending 状态进入到 ContainerCreating 状态：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get pods</span></span><br><span class="line">NAME    READY   STATUS   RESTARTS  AGE</span><br><span class="line">pi-gmcq5  0/1    Completed  0     40s</span><br><span class="line">pi-84ww8  0/1    Pending  0     0s</span><br><span class="line">pi-5mt88  0/1    Completed  0     41s</span><br><span class="line">pi-62rbt  0/1    Pending  0     0s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get pods</span></span><br><span class="line">NAME    READY   STATUS   RESTARTS  AGE</span><br><span class="line">pi-gmcq5  0/1    Completed  0     40s</span><br><span class="line">pi-84ww8  0/1    ContainerCreating  0     0s</span><br><span class="line">pi-5mt88  0/1    Completed  0     41s</span><br><span class="line">pi-62rbt  0/1    ContainerCreating  0     0s</span><br></pre></td></tr></table></figure>

<p>紧接着，Job Controller 第二次创建出来的两个并行的 Pod 也进入了 Running 状态：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get pods</span> </span><br><span class="line">NAME    READY    STATUS    RESTARTS  AGE</span><br><span class="line">pi-5mt88  0/1    Completed  0        54s</span><br><span class="line">pi-62rbt  1/1    Running    0        13s</span><br><span class="line">pi-84ww8  1/1    Running    0        14s</span><br><span class="line">pi-gmcq5  0/1    Completed  0        54s</span><br></pre></td></tr></table></figure>

<p>最终，后面创建的这两个 Pod 也完成了计算，进入了 Completed 状态。</p>
<p>这时，由于所有的 Pod 均已经成功退出，这个 Job 也就执行完了，所以你会看到它的 SUCCESSFUL 字段的值变成了 4：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get pods</span> </span><br><span class="line">NAME      READY  STATUS    RESTARTS  	AGE</span><br><span class="line">pi-5mt88  0/1    Completed  0      		5m</span><br><span class="line">pi-62rbt  0/1    Completed  0      		4m</span><br><span class="line">pi-84ww8  0/1    Completed  0      		4m</span><br><span class="line">pi-gmcq5  0/1    Completed  0      		5m</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get job</span></span><br><span class="line">NAME    DESIRED  SUCCESSFUL   AGE</span><br><span class="line">pi         4          4       5m</span><br></pre></td></tr></table></figure>

<p><strong>Job Controller工作原理总结</strong></p>
<blockquote>
<ol>
<li>Job Controller 控制的对象，直接就是 Pod。 </li>
<li>Job Controller 在控制循环中进行的调谐（Reconcile）操作，是根据实际在 Running 状态 Pod 的数目、已经成功退出的 Pod 的数目，以及 parallelism、completions 参数的值共同计算出在这个周期里，应该创建或者删除的 Pod 数目，然后调用 Kubernetes API 来执行这个操作。</li>
</ol>
</blockquote>
<p>在上面计算 Pi 值的这个例子中，当 Job 一开始创建出来时，实际处于 Running 状态的 Pod 数目 &#x3D;0，已经成功退出的 Pod 数目 &#x3D;0，而用户定义的 completions，也就是最终用户需要的 Pod 数目 &#x3D;4。</p>
<p>所以，在这个时刻，需要创建的 Pod 数目 &#x3D; 最终需要的 Pod 数目 - 实际在 Running 状态 Pod 数目 - 已经成功退出的 Pod 数目 &#x3D; 4 - 0 - 0&#x3D; 4。也就是说，Job Controller 需要创建 4 个 Pod 来纠正这个不一致状态。</p>
<p>可是，又定义了这个 Job 的 parallelism&#x3D;2 规定了每次并发创建的 Pod 个数不能超过 2 个。所以，Job Controller 会对前面的计算结果做一个修正，修正后的期望创建的 Pod 数目应该是：2 个。</p>
<p>这时候，Job Controller 就会并发地向 kube-apiserver 发起两个创建 Pod 的请求。</p>
<p>类似地，如果在这次调谐周期里，Job Controller 发现实际在 Running 状态的 Pod 数目，比 parallelism 还大，那么它就会删除一些 Pod，使两者相等。</p>
<p>综上所述，Job Controller 实际上控制了，作业执行的并行度，以及总共需要完成的任务数这两个重要参数。而在实际使用时，你需要根据作业的特性，来决定并行度（parallelism）和任务数（completions）的合理取值。</p>
<h4 id="23-6-Job控制器CronJob"><a href="#23-6-Job控制器CronJob" class="headerlink" title="23.6 Job控制器CronJob"></a>23.6 Job控制器CronJob</h4><p>Job 对象：CronJob</p>
<p>CronJob 描述的是定时任务,CronJob 是一个 Job 对象的控制器（Controller）</p>
<p>CronJob的 API 对象，如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim ./cronjob.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CronJob</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hello</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">schedule:</span> <span class="string">&quot;*/1 * * * *&quot;</span></span><br><span class="line">  <span class="attr">jobTemplate:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="attr">spec:</span></span><br><span class="line">          <span class="attr">containers:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hello</span></span><br><span class="line">              <span class="attr">image:</span> <span class="string">daocloud.io/library/busybox</span></span><br><span class="line">              <span class="attr">args:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">date;</span> <span class="string">echo</span> <span class="string">Hello</span> <span class="string">from</span> <span class="string">the</span> <span class="string">Kubernetes</span> <span class="string">cluster</span></span><br><span class="line">          <span class="attr">restartPolicy:</span> <span class="string">OnFailure</span></span><br></pre></td></tr></table></figure>

<p>CronJob 与 Job 的关系，同 Deployment 与 Pod 的关系一样。</p>
<p>CronJob 是一个专门用来管理 Job 对象的控制器。它创建和删除 Job 的依据，是 schedule 字段定义的、一个标准的Unix Cron格式的表达式。</p>
<p>比如:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*/1 * * * *</span><br><span class="line">分钟、小时、日、月、星期</span><br></pre></td></tr></table></figure>

<p>这个 Cron 表达式里 _&#x2F;1 中的 _ 表示从 0 开始，&#x2F; 表示”每”，1 表示偏移量。所以，它的意思就是：从 0 开始，每 1 个时间单位执行一次。</p>
<p>本例表示从当前开始，每分钟执行一次</p>
<p>这里要执行的内容，就是 jobTemplate 定义的 Job 。</p>
<p>这个 CronJob 对象在创建 1 分钟后，就会有一个 Job 产生了，如下所示：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl create -f ./cronjob.yaml</span></span><br><span class="line">cronjob &quot;hello&quot; created</span><br></pre></td></tr></table></figure>

<p>一分钟后</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get <span class="built_in">jobs</span></span></span><br><span class="line">NAME        DESIRED  SUCCESSFUL  AGE</span><br><span class="line">hello-4111706356  1     1     2s</span><br></pre></td></tr></table></figure>

<p>此时，CronJob 对象会记录下这次 Job 执行的时间：新版本中在describe里显示执行时间</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get cronjob hello</span></span><br><span class="line">NAME    SCHEDULE    SUSPEND  ACTIVE   LAST-SCHEDULE</span><br><span class="line">hello     */1 * * * *     False   0     Thu, 6 Sep 2018 14:34:00 -070</span><br></pre></td></tr></table></figure>

<blockquote>
<p>spec.concurrencyPolicy 字段：</p>
<p>由于定时任务的特殊性，很可能某个 Job 还没有执行完，另外一个新 Job 就产生了。这时候，可以通过 spec.concurrencyPolicy 字段来定义具体的处理策略。</p>
<p>concurrencyPolicy&#x3D;Allow</p>
<p>默认情况，表示这些 Job 可以同时存在；</p>
<p>concurrencyPolicy&#x3D;Forbid</p>
<p>表示不会创建新的 Pod，该创建周期被跳过；</p>
<p>concurrencyPolicy&#x3D;Replace</p>
<p>表示新产生的 Job 会替换旧的、没有执行完的 Job。</p>
<p>spec.startingDeadlineSeconds 字段：</p>
<p>如果某一次 Job 创建失败，这次创建就会被标记为”miss”。当在指定的时间窗口内，miss 的数目达到 100 时，那么 CronJob 会停止再创建这个 Job。</p>
<p>这个时间窗口，可以由 spec.startingDeadlineSeconds 字段指定。比如 startingDeadlineSeconds&#x3D;200，意味着在过去 200 s 里，如果 miss 的数目达到了 100 次，那么这个 Job 就不会被创建执行了。</p>
</blockquote>
<h3 id="二十四-k8s之共享存储pv-pvc"><a href="#二十四-k8s之共享存储pv-pvc" class="headerlink" title="二十四.k8s之共享存储pv&amp;pvc"></a>二十四.k8s之共享存储pv&amp;pvc</h3><h4 id="24-1-存储资源管理"><a href="#24-1-存储资源管理" class="headerlink" title="24.1 存储资源管理"></a>24.1 存储资源管理</h4><p>在基于k8s容器云平台上，对存储资源的使用需求通常包括以下几方面：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">1.应用配置文件、密钥的管理；</span></span><br><span class="line"><span class="attr">2.应用的数据持久化存储；</span></span><br><span class="line"><span class="attr">3.在不同的应用间共享数据存储；</span></span><br></pre></td></tr></table></figure>

<p>k8s的Volume抽象概念就是针对这些问题提供的解决方案，k8s的volume类型非常丰富，从临时目录、宿主机目录、ConfigMap、Secret、共享存储（PV和PVC）。</p>
<p>k8s支持Volume类型包括以下几类：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">1.临时空目录（随着Pod的销毁而销毁）</span></span><br><span class="line"><span class="attr">emptyDir</span>:<span class="string"></span></span><br><span class="line"></span><br><span class="line"><span class="attr">2.配置类（将配置文件以Volume的形式挂载到容器内）</span></span><br><span class="line"><span class="attr">ConfigMap：将保存在ConfigMap资源对象中的配置文件信息挂载到容器内的某个目录下</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Secret：将保存在Secret资源对象中的密码密钥等信息挂载到容器内的某个文件中。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">downwardAPI：将downwardAPI的数据以环境变量或文件的形式注入容器中。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">gitErpo：将某Git代码库挂载到容器内的某个目录下</span></span><br><span class="line"></span><br><span class="line"><span class="attr">3.本地存储类</span></span><br><span class="line"><span class="attr">hostpath：将宿主机的目录或文件挂载到容器内进行使用。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">local：Kubernetes从v1.9版本引入，将本地存储以PV的形式提供给容器使用，并能够实现存储空间的管理。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">4.共享存储</span></span><br><span class="line"><span class="attr">PV（Persistent</span> <span class="string">Volume）：将共享存储定义为一种“持久存储卷”，可以被多个容器应用共享使用。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">PVC（Persistent</span> <span class="string">Volume Claim）：用户对存储资源的一次“申请”，PVC申请的对象是PV，一旦申请成功，应用就能够像使用本地目录一样使用共享存储了。</span></span><br></pre></td></tr></table></figure>

<p>共享存储主要用于多个应用都能够使用存储资源，例如NFS存储、光纤存储Glusterfs共享文件系统等，在k8s系统中通过PV&#x2F;StorageClass和PVC来完成定义，并通过volumeMount挂载到容器的目录或文件进行使用。</p>
<p>ConfigMap、Secret、emptyDir、hostPath等属于临时性存储，当pod被调度到某个节点上时，它们随pod的创建而创建，临时占用节点存储资源，当pod离开节点时，存储资源被交还给节点，pod一旦离开这个节点，存储就失效，不具备持久化存储数据的能力。与此相反，持久化存储拥有独立的生命周期，具备持久化存储能力，其后端一般是独立的存储系统如NFS、iSCSI、cephfs、glusterfs等。</p>
<p>pv与pvc</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Kubernetes中的node代表计算资源，而PersistentVolume(PV)则代表存储资源，它是对各种诸如NFS、iSCSI、云存储等各种存储后端所提供存储块的统一抽象从而提供网络存储，通过它屏蔽低层实现细节。与普通volume不同，PV拥有完全独立的生命周期。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">因为PV表示的是集群能力，它是一种集群资源，所以用户（通常是开发人员）不能直接使用PV，就像不能直接使用内存一样，需要先向系统申请，而</span> <span class="string">PVC 就是请求存储资源的。</span></span><br><span class="line"><span class="attr">Kubernetes通过PersistentVolumeClaim(PVC)代理用户行为，用户通过对PVC的操作实现对PV申请、使用、释放等操作，PVC是用户层面的资源。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">PV</span> <span class="string">和 PVC 可以将 pod 和数据卷解耦，pod 不需要知道确切的文件系统或者支持它的持久化引擎。</span></span><br></pre></td></tr></table></figure>

<p>Kubernetes的共享存储供应模式包括静态和动态两种模式</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">静态模式</span></span><br><span class="line"><span class="attr">静态PV由系统管理员负责创建、提供、维护，系统管理员为用户屏蔽真正提供存储的后端及其实现细节，普通用户作为消费者，只需通过PVC申请、使用此类资源。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">动态模式：</span></span><br><span class="line"><span class="attr">集群管理员无须手工创建PV，而是通过对Storage</span> <span class="string">Class的设置对后端存储进行描述，“storage class”可以理解成某种具体的后端存储，标记为某种“类型（Class）”，此时要求PVC对存储的类型进行声明，系统将自动完成PV的创建与PVC的绑定。如果用户的PVC中“storage class”的值为&quot;&quot;，则表示不能为此PVC动态创建PV。</span></span><br></pre></td></tr></table></figure>

<p>PV与PVC的绑定</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">用户创建包含容量、访问模式等信息的PVC，向系统请求存储资源。系统查找已存在PV或者监控新创建PV，如果与PVC匹配则将两者绑定。如果PVC创建动态PV，则系统将一直将两者绑定。PV与PVC的绑定是一一对应关系，不能重复绑定。如果系统一直没有为PVC找到匹配PV，则PVC无限期维持在&quot;unbound&quot;状态，直到系统找到匹配PV。实际绑定的PV容量可能大于PVC中申请的容量。</span></span><br></pre></td></tr></table></figure>

<h4 id="24-2-持久卷pv的类型"><a href="#24-2-持久卷pv的类型" class="headerlink" title="24.2 持久卷pv的类型"></a>24.2 持久卷pv的类型</h4><p>PV 持久卷是用插件的形式来实现的。Kubernetes 目前支持以下插件</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">-</span> <span class="string">GCEPersistentDisk</span></span><br><span class="line"><span class="attr">-</span> <span class="string">AWSElasticBlockStore</span></span><br><span class="line"><span class="attr">-</span> <span class="string">AzureFile</span></span><br><span class="line"><span class="attr">-</span> <span class="string">AzureDisk</span></span><br><span class="line"><span class="attr">-</span> <span class="string">FC (Fibre Channel)</span></span><br><span class="line"><span class="attr">-</span> <span class="string">Flexvolume</span></span><br><span class="line"><span class="attr">-</span> <span class="string">Flocker</span></span><br><span class="line"><span class="attr">-</span> <span class="string">NFS</span></span><br><span class="line"><span class="attr">-</span> <span class="string">iSCSI</span></span><br><span class="line"><span class="attr">-</span> <span class="string">RBD (Ceph Block Device)</span></span><br><span class="line"><span class="attr">-</span> <span class="string">CephFS</span></span><br><span class="line"><span class="attr">-</span> <span class="string">Cinder (OpenStack block storage)</span></span><br><span class="line"><span class="attr">-</span> <span class="string">Glusterfs</span></span><br><span class="line"><span class="attr">-</span> <span class="string">VsphereVolume</span></span><br><span class="line"><span class="attr">-</span> <span class="string">Quobyte Volumes</span></span><br><span class="line"><span class="attr">-</span> <span class="string">HostPath (Single node testing only – local storage is not supported in any way and WILL NOT WORK in a multi-node cluster)</span></span><br><span class="line"><span class="attr">-</span> <span class="string">Portworx Volumes</span></span><br><span class="line"><span class="attr">-</span> <span class="string">ScaleIO Volumes</span></span><br><span class="line"><span class="attr">-</span> <span class="string">StorageOS</span></span><br></pre></td></tr></table></figure>

<h4 id="24-5-实验mysql基于NFS共享存储实现持久化存储"><a href="#24-5-实验mysql基于NFS共享存储实现持久化存储" class="headerlink" title="24.5 实验mysql基于NFS共享存储实现持久化存储"></a>24.5 实验mysql基于NFS共享存储实现持久化存储</h4><h5 id="24-5-1-安装NFS"><a href="#24-5-1-安装NFS" class="headerlink" title="24.5.1 安装NFS"></a>24.5.1 安装NFS</h5><p>机器准备</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">k8s-master</span>  <span class="string">制作nfs服务端作为共享文件系统</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">~]# yum install -y nfs-utils rpcbind</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">~]# mkdir /mnt/data  #制作共享目录</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">~]# vim /etc/exports</span></span><br><span class="line"><span class="attr">/mnt/data</span> <span class="string">192.168.122.0/24(rw,no_root_squash)</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">~]# systemctl start rpcbind nfs-server #启动服务</span></span><br><span class="line"><span class="comment"># 使配置生效</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">~]# exportfs -r</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 检查配置是否生效</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">~]# exportfs</span></span><br><span class="line"></span><br><span class="line"><span class="attr">集群中的工作节点都需要安装客户端工具，主要作用是节点能够驱动</span> <span class="string">nfs 文件系统</span></span><br><span class="line"><span class="attr">只安装，不启动服务</span></span><br><span class="line"><span class="comment"># yum install -y nfs-utils</span></span><br><span class="line"><span class="comment"># showmount -e master_ip</span></span><br><span class="line"><span class="comment"># mount -t nfs master_ip:/mnt/data /mnt/data</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">master节点</span></span><br><span class="line"><span class="attr">制作pv.yaml（一般这个动作由</span> <span class="string">kubernetes 管理员完成，也就是我们运维人员）</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">~]# mkdir /k8s/mysql -p </span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">~]# cd /k8s/mysql/</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">mysql]# vim pv.yaml</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">v1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">PersistentVolume   #类型定义为pv</span></span><br><span class="line"><span class="attr">metadata</span>: <span class="string"></span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">my-pv  #pv的名字</span></span><br><span class="line">  <span class="attr">labels</span>:  <span class="string">#定义标签</span></span><br><span class="line">    <span class="attr">type</span>: <span class="string">nfs  #类型为nfs</span></span><br><span class="line"><span class="attr">spec</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">nfs</span>:  <span class="string"># 存储类型，需要与底层实际的存储一致，这里采用 nfs</span></span><br><span class="line">    <span class="attr">server</span>: <span class="string">192.168.122.24 # NFS 服务器的 IP</span></span><br><span class="line">    <span class="attr">path</span>: <span class="string">&quot;/mnt/data&quot; # NFS 上共享的目录</span></span><br><span class="line">  <span class="attr">capacity</span>:   <span class="string">#定义存储能力</span></span><br><span class="line">    <span class="attr">storage</span>: <span class="string">3Gi  #指定存储空间</span></span><br><span class="line">  <span class="attr">accessModes</span>:  <span class="string">#定义访问模式</span></span><br><span class="line">    <span class="attr">-</span> <span class="string">ReadWriteMany   #读写权限，允许被多个Node挂载</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy</span>: <span class="string">Retain  #定义数据回收策略,这里是保留</span></span><br></pre></td></tr></table></figure>

<h5 id="24-5-2-PV参数详解"><a href="#24-5-2-PV参数详解" class="headerlink" title="24.5.2 PV参数详解"></a>24.5.2 PV参数详解</h5><p>1.存储能力（Capacity）</p>
<p>描述存储设备的能力，目前仅支持对存储空间的设置（storage&#x3D;xx）。</p>
<p>2.访问模式（Access Modes）</p>
<p>对PV进行访问模式的设置，用于描述用户应用对存储资源的访问权限。访问模式如下：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ReadWriteOnce：读写权限，并且只能被单个pod挂载。</span></span><br><span class="line"><span class="attr">ReadOnlyMany：只读权限，允许被多个pod挂载。</span></span><br><span class="line"><span class="attr">ReadWriteMany：读写权限，允许被多个pod挂载。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">某些PV可能支持多种访问模式，但PV在挂载时只能使用一种访问模式，多种访问模式不能同时生效。</span></span><br></pre></td></tr></table></figure>

<p>3.persistentVolumeReclaimPolicy定义数据回收策略</p>
<p>目前支持如下三种回收策略：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">保留（Retain）：保留数据，需要手工处理。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">回收空间（Recycle）：警告：</span> <span class="string">回收策略 Recycle 已被废弃。取而代之的建议方案是使用动态供应。如果下层的卷插件支持，回收策略 Recycle 会在卷上执行一些基本的 擦除（rm -rf /thevolume/*）操作，之后允许该卷用于新的 PVC 申领</span></span><br><span class="line"></span><br><span class="line"><span class="attr">删除（Delete）：会将</span> <span class="string">PersistentVolume 对象从 Kubernetes 中移除，同时也会从外部基础设施（如 AWS EBS、GCE PD、Azure Disk 或 Cinder 卷）中移除所关联的存储资产。 就是把云存储一起删了。</span></span><br></pre></td></tr></table></figure>

<p>目前，只有 NFS 和 HostPath 两种类型的存储设备支持 “Recycle” 策略； AWS EBS、 GCE PD、Azure Disk 和 Cinder volumes 支持 “Delete” 策略。</p>
<p>4.storageClassName存储类别（Class）</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">PV可以设定其存储的类型（Class），通过</span> <span class="string">storageClassName参数指定一个 StorageClass 资源对象的名称。</span></span><br><span class="line"><span class="attr">具有特定“类别”的</span> <span class="string">PV 只能与请求了该“类别”的 PVC 进行绑定。未设定 “类别” 的 PV 则只能与不请求任何 “类别” 的 PVC 进行绑定。</span></span><br><span class="line"><span class="attr">相当于一个标签。</span></span><br></pre></td></tr></table></figure>

<h5 id="24-5-3-创建pv"><a href="#24-5-3-创建pv" class="headerlink" title="24.5.3 创建pv"></a>24.5.3 创建pv</h5><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">mysql]# kubectl apply -f pv.yaml </span></span><br><span class="line"><span class="attr">persistentvolume/my-pv</span> <span class="string">created</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">mysql]# kubectl get pv</span></span><br></pre></td></tr></table></figure>

<p><img src="https://img.beyourself.org.cn/abc/image-20211130215841040.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_32,text_6KW_5a6J5Y2D6ZSL5LqR6K6h566X,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10#id=WtVfN&originHeight=43&originWidth=1111&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p>PV 生命周期的各个阶段（Phase）</p>
<p>某个 PV 在生命周期中，可以处于以下4个阶段之一：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">-</span> <span class="string">Available：可用状态，还未与某个 PVC 绑定。</span></span><br><span class="line"><span class="attr">-</span> <span class="string">Bound：已与某个 PVC 绑定。</span></span><br><span class="line"><span class="attr">-</span> <span class="string">Released：释放，绑定的 PVC 已经删除，但没有被集群回收存储空间 。</span></span><br><span class="line"><span class="attr">-</span> <span class="string">Failed：自动资源回收失败。</span></span><br></pre></td></tr></table></figure>

<p>pv创建成功目前属于可用状态，还没有与pvc绑定，那么现在创建pvc</p>
<p>创建pvc</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">mysql]# vim mysql-pvc.yaml</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">v1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">PersistentVolumeClaim   #定义类型为PVC</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">mypvc   #声明pvc的名称，当做pod的卷使用时会用到</span></span><br><span class="line"><span class="attr">spec</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">accessModes</span>:  <span class="string">#定义访问pvc的模式，与pv拥有一样的模式</span></span><br><span class="line">    <span class="attr">-</span> <span class="string">ReadWriteMany   #读写权限，允许被多个pod挂载</span></span><br><span class="line">  <span class="attr">resources</span>:  <span class="string">#声明可以请求特定数量的资源，目前仅支持 request.storage 的设置，即存储空间大小。</span></span><br><span class="line">   <span class="attr">requests</span>:<span class="string"></span></span><br><span class="line">     <span class="attr">storage</span>: <span class="string">3Gi  #定义空间大小</span></span><br><span class="line">  <span class="attr">selector</span>:  <span class="string">#PV选择条件,标签选择器，通过标签选择</span></span><br><span class="line">     <span class="attr">matchLabels</span>:<span class="string"></span></span><br><span class="line">       <span class="attr">type</span>: <span class="string">&quot;nfs&quot; #选择pv类型的nfs</span></span><br><span class="line">       </span><br><span class="line"></span><br><span class="line"><span class="attr">注意：当我们申请pvc的容量大于pv的容量是无法进行绑定的。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">创建pvc</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">mysql]# kubectl apply -f mysql-pvc.yaml </span></span><br><span class="line"><span class="attr">persistentvolumeclaim/mypvc</span> <span class="string">created</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">mysql]# kubectl get pvc</span></span><br><span class="line"><span class="attr">NAME</span>    <span class="string">STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span></span><br><span class="line"><span class="attr">mypvc</span>   <span class="string">Bound    my-pv    3Gi        RWX            pv-nfs         37s</span></span><br></pre></td></tr></table></figure>

<p>status状态</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">-</span> <span class="string">Available (可用): 表示可用状态，还未被任何PVC绑定</span></span><br><span class="line"><span class="attr">-</span> <span class="string">Bound (已绑定)：已经绑定到某个PVC</span></span><br><span class="line"><span class="attr">-</span> <span class="string">Released (已释放)：对应的PVC已经删除,但资源还没有被集群收回</span></span><br><span class="line"><span class="attr">-</span> <span class="string">Failed：PV自动回收失败</span></span><br></pre></td></tr></table></figure>

<p>Kubernetes中会自动帮我们查看pv状态为Available并且根据声明pvc容量storage的大小进行筛选匹配，同时还会根据AccessMode进行匹配。如果pvc匹配不到pv会一直处于pending状态。</p>
<h5 id="24-5-4-mysql使用pvc持久卷"><a href="#24-5-4-mysql使用pvc持久卷" class="headerlink" title="24.5.4 mysql使用pvc持久卷"></a>24.5.4 mysql使用pvc持久卷</h5><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">创建secret</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">mysql]# echo -n &#x27;QianFeng@123!&#x27; | base64</span></span><br><span class="line"><span class="attr">UWlhbkZlbmdAMTIzIQ</span>=<span class="string">=</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">mysql]# vim mysql-secret.yaml</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">v1</span></span><br><span class="line"><span class="attr">data</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">password</span>: <span class="string">UWlhbkZlbmdAMTIzIQ==</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">annotations</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">my-pass</span></span><br><span class="line"><span class="attr">type</span>: <span class="string">Opaque</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">mysql]# kubectl apply -f mysql-secret.yaml </span></span><br><span class="line"><span class="attr">secret/my-pass</span> <span class="string">created</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">mysql]# kubectl get secret</span></span><br><span class="line"><span class="attr">NAME</span>                  <span class="string">TYPE                                  DATA   AGE</span></span><br><span class="line"><span class="attr">default-token-24c52</span>   <span class="string">kubernetes.io/service-account-token   3      6d22h</span></span><br><span class="line"><span class="attr">my-pass</span>               <span class="string">Opaque                                1      69s</span></span><br><span class="line"></span><br><span class="line"><span class="attr">创建myslq-pod文件</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">mysql]# cat mysql-deployment.yaml </span></span><br><span class="line"><span class="attr">apiVersion</span>:  <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">my-mysql</span></span><br><span class="line"><span class="attr">spec</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">replicas</span>: <span class="string">1</span></span><br><span class="line">  <span class="attr">selector</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">matchLabels</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">app</span>: <span class="string">mysql</span></span><br><span class="line">  <span class="attr">template</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">labels</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">app</span>: <span class="string">mysql</span></span><br><span class="line">    <span class="attr">spec</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">containers</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">-</span> <span class="string">name: my-mysql</span></span><br><span class="line">        <span class="attr">image</span>: <span class="string">daocloud.io/library/mysql:5.7</span></span><br><span class="line">        <span class="attr">ports</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">-</span> <span class="string">containerPort: 3306</span></span><br><span class="line">        <span class="attr">env</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">-</span> <span class="string">name: MYSQL_ROOT_PASSWORD</span></span><br><span class="line">          <span class="attr">valueFrom</span>:<span class="string"></span></span><br><span class="line">            <span class="attr">secretKeyRef</span>:<span class="string"></span></span><br><span class="line">              <span class="attr">name</span>: <span class="string">my-pass</span></span><br><span class="line">              <span class="attr">key</span>: <span class="string">password</span></span><br><span class="line">        <span class="attr">volumeMounts</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">-</span> <span class="string">name: mysql-data</span></span><br><span class="line">          <span class="attr">mountPath</span>: <span class="string">/var/lib/mysql</span></span><br><span class="line">      <span class="attr">volumes</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">-</span> <span class="string">name: mysql-data</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim</span>:  <span class="string">#绑定pvc</span></span><br><span class="line">          <span class="attr">claimName</span>: <span class="string">mypvc #指定对应的pvc名字</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">mysql]# kubectl apply -f mysql-deployment.yaml          </span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">mysql]# kubectl get pod</span></span><br><span class="line"><span class="attr">NAME</span>                         <span class="string">READY   STATUS    RESTARTS   AGE</span></span><br><span class="line"><span class="attr">my-mysql-5474b6885f-c5dmp</span>    <span class="string">1/1     Running   0          8s</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">mysql]# kubectl get pod -o wide</span></span><br><span class="line"><span class="attr">NAME</span>                         <span class="string">READY   STATUS    RESTARTS   AGE   IP            NODE        NOMINATED NODE   READINESS GATES</span></span><br><span class="line"><span class="attr">my-mysql-5474b6885f-c5dmp</span>    <span class="string">1/1     Running   0          40s   10.244.2.5    k8s-node2   &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">测试</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">~]# cd /mnt/data/</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">data]# ll</span></span><br><span class="line"><span class="attr">总用量</span> <span class="string">188484</span></span><br><span class="line"><span class="attr">-rw-r-----</span> <span class="string">1 polkitd ssh_keys       56 11月  8 21:49 auto.cnf</span></span><br><span class="line"><span class="attr">-rw-------</span> <span class="string">1 polkitd ssh_keys     1680 11月  8 21:49 ca-key.pem</span></span><br><span class="line"><span class="attr">-rw-r--r--</span> <span class="string">1 polkitd ssh_keys     1112 11月  8 21:49 ca.pem</span></span><br><span class="line"><span class="attr">-rw-r--r--</span> <span class="string">1 polkitd ssh_keys     1112 11月  8 21:49 client-cert.pem</span></span><br><span class="line"><span class="attr">-rw-------</span> <span class="string">1 polkitd ssh_keys     1680 11月  8 21:49 client-key.pem</span></span><br><span class="line"><span class="attr">-rw-r-----</span> <span class="string">1 polkitd ssh_keys      688 11月  8 21:57 ib_buffer_pool</span></span><br><span class="line"><span class="attr">-rw-r-----</span> <span class="string">1 polkitd ssh_keys 79691776 11月  8 21:59 ibdata1</span></span><br><span class="line"><span class="attr">-rw-r-----</span> <span class="string">1 polkitd ssh_keys 50331648 11月  8 21:59 ib_logfile0</span></span><br><span class="line"><span class="attr">-rw-r-----</span> <span class="string">1 polkitd ssh_keys 50331648 11月  8 21:49 ib_logfile1</span></span><br><span class="line"><span class="attr">-rw-r-----</span> <span class="string">1 polkitd ssh_keys 12582912 11月  8 22:00 ibtmp1</span></span><br><span class="line"><span class="attr">drwxr-x---</span> <span class="string">2 polkitd ssh_keys     4096 11月  8 21:49 mysql</span></span><br><span class="line"><span class="attr">drwxr-x---</span> <span class="string">2 polkitd ssh_keys     8192 11月  8 21:49 performance_schema</span></span><br><span class="line"><span class="attr">-rw-------</span> <span class="string">1 polkitd ssh_keys     1680 11月  8 21:49 private_key.pem</span></span><br><span class="line"><span class="attr">-rw-r--r--</span> <span class="string">1 polkitd ssh_keys      452 11月  8 21:49 public_key.pem</span></span><br><span class="line"><span class="attr">-rw-r--r--</span> <span class="string">1 polkitd ssh_keys     1112 11月  8 21:49 server-cert.pem</span></span><br><span class="line"><span class="attr">-rw-------</span> <span class="string">1 polkitd ssh_keys     1676 11月  8 21:49 server-key.pem</span></span><br><span class="line"><span class="attr">drwxr-x---</span> <span class="string">2 polkitd ssh_keys     8192 11月  8 21:49 sys</span></span><br></pre></td></tr></table></figure>

<h4 id="24-6-动态绑定pv"><a href="#24-6-动态绑定pv" class="headerlink" title="24.6 动态绑定pv"></a>24.6 动态绑定pv</h4><p>StorageClass 相当于一个创建 PV 的模板，用户通过 PVC 申请存储卷，StorageClass 通过模板自动创建 PV，然后和 PVC 进行绑定。</p>
<p>StorageClass创建动态存储卷流程</p>
<blockquote>
<ol>
<li>集群管理员预先创建存储类（StorageClass）；</li>
<li>用户创建使用存储类的持久化存储声明(PVC：PersistentVolumeClaim)；</li>
<li>存储持久化声明通知系统，它需要一个持久化存储(PV: PersistentVolume)；</li>
<li>系统读取存储类的信息；</li>
<li>系统基于存储类的信息，在后台自动创建PVC需要的PV；</li>
<li>用户创建一个使用PVC的Pod；</li>
<li>Pod中的应用通过PVC进行数据的持久化；</li>
<li>而PVC使用PV进行数据的最终持久化处理。</li>
</ol>
</blockquote>
<p><img src="https://img.beyourself.org.cn/abc/image-20210603221719476.png#id=BxDWU&originHeight=680&originWidth=1142&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p>StorageClass支持的动态存储插件：</p>
<p><img src="https://img.beyourself.org.cn/abc/image-20210603221733827.png#id=faMFa&originHeight=1642&originWidth=770&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner">NFS Provisioner</a> 是一个自动配置卷程序，它使用现有的和已配置的 NFS 服务器来支持通过持久卷声明动态配置 Kubernetes 持久卷。</p>
</blockquote>
<p><strong>注意</strong>：k8s 1.21版本中创建pvc时nfs-provisioner会报错</p>
<blockquote>
<p>E0903 08:00:24.858523 1 controller.go:1004] provision “default&#x2F;test-claim” class “managed-nfs-storage”: unexpected error getting claim reference: selfLink was empty, can’t make reference</p>
</blockquote>
<blockquote>
<p>解决方法：<br>修改 &#x2F;etc&#x2F;kubernetes&#x2F;manifests&#x2F;kube-apiserver.yaml文件<br>增加 - –feature-gates&#x3D;RemoveSelfLink&#x3D;false</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kube-apiserver</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--feature-gates=RemoveSelfLink=false</span>   <span class="comment"># 增加这行</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--advertise-address=172.24.0.5</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--allow-privileged=true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--authorization-mode=Node,RBAC</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--client-ca-file=/etc/kubernetes/pki/ca.crt</span></span><br></pre></td></tr></table></figure>

<h5 id="24-6-1-配置nfs-provisioner授权"><a href="#24-6-1-配置nfs-provisioner授权" class="headerlink" title="24.6.1 配置nfs-provisioner授权"></a>24.6.1 配置nfs-provisioner授权</h5><blockquote>
<p>创建ServiceAccount、ClusterRole、ClusterRoleBinding等，为nfs-client-provisioner授权</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rbac.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner-runner</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumes&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;delete&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumeclaims&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;storage.k8s.io&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;storageclasses&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;events&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">run-nfs-client-provisioner</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner-runner</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line">    <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;endpoints&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>

<h5 id="24-6-2-部署nfs-client-provisioner"><a href="#24-6-2-部署nfs-client-provisioner" class="headerlink" title="24.6.2 部署nfs-client-provisioner"></a>24.6.2 部署nfs-client-provisioner</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nfs-provisioner.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span>  <span class="comment">#与RBAC文件中的namespace保持一致</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/newrain_wang/nfs-client-provisioner:latest</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/persistentvolumes</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROVISIONER_NAME</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">gxf-nfs-storage</span>  <span class="comment">#provisioner名称,请确保该名称与 nfs-StorageClass.yaml文件中的provisioner名称保持一致</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_SERVER</span></span><br><span class="line">              <span class="attr">value:</span> <span class="number">10.24</span><span class="string">.X.X</span>    <span class="comment">#NFS Server IP地址</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_PATH</span>  </span><br><span class="line">              <span class="attr">value:</span> <span class="string">/home/nfs/1</span>    <span class="comment">#NFS挂载卷</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">          <span class="attr">nfs:</span></span><br><span class="line">            <span class="attr">server:</span> <span class="number">10.24</span><span class="string">.X.X</span>  <span class="comment">#NFS Server IP地址</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/home/nfs/1</span>     <span class="comment">#NFS 挂载卷</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">部署</span></span><br><span class="line">[root@kube-master ~]# kubectl apply -f rbac.yaml </span><br><span class="line">[root@kube-master ~]# kubectl apply -f nfs-provisioner.yaml </span><br><span class="line">[root@kube-master ~]# kubectl get pod </span><br><span class="line">NAME                                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">nfs-client-provisioner-75bfdbdcd8-5mqbv   1/1     Running   0          4m24s</span><br></pre></td></tr></table></figure>

<p><img src="https://img.beyourself.org.cn/abc/image-20231101144733290.png#id=BR8R4&originHeight=394&originWidth=2482&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<h5 id="24-6-3-创建StorageClass"><a href="#24-6-3-创建StorageClass" class="headerlink" title="24.6.3 创建StorageClass"></a>24.6.3 创建StorageClass</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nfs-StorageClass.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">managed-nfs-storage</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">storageclass.kubernetes.io/is-default-class:</span> <span class="string">&quot;true&quot;</span>  <span class="comment"># 设置该StorageClass为默认</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">gxf-nfs-storage</span> <span class="comment"># 这里的名称要和provisioner配置文件中的环境变量PROVISIONER_NAME保持一致</span></span><br><span class="line"><span class="attr">reclaimPolicy:</span> <span class="string">Retain</span> <span class="comment"># 默认为Delete</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line">  <span class="attr">archiveOnDelete:</span> <span class="string">&quot;true&quot;</span> <span class="comment"># false表示pv被删除时，在nfs下面对应的文件夹也会被删除,true正相反</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>注意：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">如果其他storage-class已经设置为默认，需要取消默认</span></span><br><span class="line"><span class="comment"># old-default-storage 为旧的名字</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">patch</span> <span class="string">storageclass</span> <span class="string">old-default-storage</span> <span class="string">-p</span> <span class="string">&#x27;&#123;&quot;metadata&quot;: &#123;&quot;annotations&quot;: &#123;&quot;storageclass.kubernetes.io/is-default-class&quot;: &quot;false&quot;&#125;&#125;&#125;&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="24-6-4-deployment-动态挂载"><a href="#24-6-4-deployment-动态挂载" class="headerlink" title="24.6.4 deployment 动态挂载"></a>24.6.4 deployment 动态挂载</h5><blockquote>
<p>部署一个有2个副本的deployment，挂载共享目录</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">创建pvc，“storageClassName&quot;为上面创建的&quot;managed-nfs-storage”，即指定动态创建PV的模板文件的名字。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># test-pvclaim.yaml</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-claim</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">100Mi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">managed-nfs-storage</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@kube-master ~]# kubectl apply -f test-pvclaim.yaml</span><br></pre></td></tr></table></figure>

<blockquote>
<p>deployment部署</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># test-deploy.yaml </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-deploy</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">test-deploy</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span>  <span class="comment">#与RBAC文件中的namespace保持一致</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">test-deploy</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">test-deploy</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">test-deploy</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-pod</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">busybox:1.24</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;/bin/sh&quot;</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;-c&quot;</span></span><br><span class="line">          <span class="comment"># - &quot;touch /mnt/SUCCESS3 &amp;&amp; exit 0 || exit 1&quot;   #创建一个SUCCESS文件后退出</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">touch</span> <span class="string">/mnt/SUCCESS5;</span> <span class="string">sleep</span> <span class="number">50000</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-pvc</span></span><br><span class="line">            <span class="attr">mountPath:</span> <span class="string">&quot;/mnt&quot;</span></span><br><span class="line">            <span class="comment"># subPath: test-pod-3 # 子路径 （这路基代表存储卷下面的test-pod子目录）  </span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-pvc</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">test-claim</span>  <span class="comment">#与PVC名称保持一致</span></span><br></pre></td></tr></table></figure>

<h5 id="24-6-5-statefulset-动态挂载"><a href="#24-6-5-statefulset-动态挂载" class="headerlink" title="24.6.5 statefulset 动态挂载"></a>24.6.5 statefulset 动态挂载</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># test-sts-1.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-sts</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">test-sts</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">test-sts-svc</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">test-sts</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">test-sts</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">busybox:1.24</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">test-pod</span></span><br><span class="line">          <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;/bin/sh&quot;</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;-c&quot;</span></span><br><span class="line">            <span class="comment"># - &quot;touch /mnt/SUCCESS3 &amp;&amp; exit 0 || exit 1&quot;   #创建一个SUCCESS文件后退出</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">touch</span> <span class="string">/mnt/SUCCESS5;</span> <span class="string">sleep</span> <span class="number">50000</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-pvc</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">&quot;/mnt&quot;</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nfs-pvc</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteMany&quot;</span>]</span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">managed-nfs-storage</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">20Mi</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@kube-master ~]# kubectl apply -f test-sts-1.yaml</span><br><span class="line">[root@kube-master ~]# kubectl get sts</span><br><span class="line">NAME       READY   AGE</span><br><span class="line">test-sts   3/3     4m46s</span><br></pre></td></tr></table></figure>

<p><img src="https://img.beyourself.org.cn/abc/image-20231101145546348.png#id=ngztY&originHeight=304&originWidth=2188&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<h3 id="二十五-StatefulSet有状态的应用"><a href="#二十五-StatefulSet有状态的应用" class="headerlink" title="二十五.StatefulSet有状态的应用"></a>二十五.StatefulSet有状态的应用</h3><blockquote>
<p>在Kubernetes系统中，Pod的管理对象RC、Deployment、DaemonSet都是面向无状态的服务，它们所管理的Pod的IP、名字，启停顺序等都是随机的。但现实中有很多服务是有状态的，特别是一些复杂的中间件集群。例如Mysql集群、MongoDB集群、Kafka集群、Zookeeper集群等，这些都有一个共同的特点：</p>
</blockquote>
<p>1.每个节点都有固定的ID，通过这个ID，集群中的成员可以相互发现并且通信。<br>2.集群的规模是比较固定的，集群规模不能随意改动。<br>3.集群里的每个节点都是有状态的，通常会持久化数据到永久存储中。<br>4.如果磁盘损坏，集群里的某个节点就无法正常运行，集群功能受损。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">StatefulSet本质上是Deployment的一种变体，在v1.9版本中已成为GA版本，它为了解决有状态服务的问题，它所管理的Pod拥有固定的Pod名称，启停顺序的，如果使用RC/Deployment控制副本的方式实现有状态的集群那么pod的名字是没有办法控制的因为是随机产生，同时也无法为每一个pod确定唯一不变的ID号，为了解决这个问题，在k8s中引用了新的资源对象即StatefulSet。在StatefulSet中，Pod名字称为网络标识(hostname)，还必须要用到共享存储。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">1.StatefulSet里的每个Pod都有稳定、唯一的网络标识，可以用来发现集群中的其他成员，比如说StatefulSet的名字是N，那么第一个pod的名字就是N-0，第二个就是N-1，以此类推</span></span><br><span class="line"><span class="attr">2.StatefulSet控制的pod副本的启停顺序是受控制的，操作第n个pod，前面的n-1的pod已经是运行且准备好的状态。</span></span><br><span class="line"><span class="attr">3.StatefulSet里的pod采用稳定的持久化存储卷，通过PV/PVC来实现，删除Pod时默认不会删除与StatefulSet相关的存储卷（目的是为了保证数据的安全性）</span></span><br><span class="line"></span><br><span class="line"><span class="attr">所以,StatefulSet的核心功能,就是通过某种方式,记录这些状态,然后在Pod被重新创建时,能够为新Pod恢复这些状态.</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>在Deployment中，与之对应的服务是service，而在StatefulSet中与之对应的headless service，headless service，即无头服务，与service的区别就是它没有Cluster IP，解析它的名称时将返回该Headless Service对应的全部Pod的Endpoint列表。</p>
<p>除此之外，StatefulSet在Headless Service的基础上又为StatefulSet控制的每个Pod副本创建了一个DNS域名，这个域名的格式为：</p>
</blockquote>
<p>$(podname).(headless server name)</p>
<h4 id="25-1-StatefulSet实现Pod的存储状态"><a href="#25-1-StatefulSet实现Pod的存储状态" class="headerlink" title="25.1 StatefulSet实现Pod的存储状态"></a>25.1 StatefulSet实现Pod的存储状态</h4><p>通过PVC机制来实现存储状态管理</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">在StatefulSet对象中除了定义PodTemplate还会定义一个volumeClaimTemplates凡是被这个StatefulSet管理的Pod都会声明一个对应的PVC,这个PVC的定义就来自于</span> <span class="string">volumeClaimTemplates这个模板字段，这个PVC的名字,会被分配一个与这个Pod完全一致的编号。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">把一个Pod比如N-0删除之后,这个Pod对应的PVC和PV并不会被删除,而这个Volume</span> <span class="string">里已经写入的数据,也依然会保存在远程存储服务里</span></span><br><span class="line"></span><br><span class="line"><span class="attr">StatefulSet在重新创建N-0这个pod的时候.它声明使用的PVC的名字还是叫作</span>:<span class="string">N-0 这个PVC的定义,还是来自于PVC模板（volumeClaimTemplates）这是StatefulSet创建 Pod的标准流程</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Kubernetes为它查找名叫N-0的PVC时,就会直接找到旧Pod遗留下来的同名的</span> <span class="string">PVC进而找到跟这个PVC绑定在一起的PV.这样新的Pod就可以挂载到旧Pod对应的那个Volume并且获取到保存在Volume里的数据.通过这种方式Kubernetes的StatefulSet就实现了对应用存储状态的管理</span></span><br></pre></td></tr></table></figure>

<h4 id="25-2-StatefulSet-的应用特点"><a href="#25-2-StatefulSet-的应用特点" class="headerlink" title="25.2 StatefulSet 的应用特点"></a>25.2 StatefulSet 的应用特点</h4><ul>
<li>StatefulSet的核心功能就是，通过某种方式记录应用状态，在Pod被重建的时候，通过这种方式还可以恢复原来的状态。 </li>
<li>StatefulSet由以下几个部分组成： <ul>
<li>Headless Service 用于定义网络标识（DNS）</li>
<li>volumeClaimTemplates  用于创建PV</li>
<li>StatefulSet  用于定义具体应用</li>
</ul>
</li>
<li>稳定且有唯一的网络标识符 当节点挂掉，既pod重新调度后其PodName和HostName不变，基于Headless Service来实现 </li>
<li>稳定且持久的存储  当节点挂掉，既pod重新调度能访问到相同的持久化存储，基于PVC实现 </li>
<li>有序、平滑的扩展、部署 即Pod是有顺序的，在部署或者扩展的时候要依据定义的顺序依次进行（即从0到N-1，在下一个Pod运行之前所有之前的Pod必须都是Running和Ready状态），基于init containers来实现。 </li>
<li>有序、平滑的收缩、删除 既Pod是有顺序的，在收缩或者删除的时候要依据定义的顺序依次进行（既从N-1到0，既倒序）。 </li>
<li><strong>拓扑状态。</strong>是应用多个实例之间的不完全对等的关系，这些应用实例是必须按照定义的顺序启动的。例如主应用A先于从应用B启动，如果把A和B删掉，应用还要按照先启动主应用A再启动从应用B，且创建的应用必须和原来的应用的网络标识一样（既PodName和HostName）。这样他们就可以按照原来的顺序创建了。 </li>
<li>存储状态。应用实例分别绑定了不同的数据存储，Pod A第一次读到的数据要和10分钟后读到的数据，是同一份。哪怕这期间Pod A被重建。这种典型的例子就是数据库应用的多个存储实例。</li>
</ul>
<h4 id="25-3-实战1-通过StatefulSet创建nginx"><a href="#25-3-实战1-通过StatefulSet创建nginx" class="headerlink" title="25.3 实战1-通过StatefulSet创建nginx"></a>25.3 实战1-通过StatefulSet创建nginx</h4><p>由于statefulSet在创建的时候使用的是动态绑定pvc，而动态绑定pvc是需要插件支持的，一下实验通过手动创建pv在通过StatefulSet自动实现pvc申请持久卷。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">1.创建基于NFS的pv持久卷</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">~]# mkdir /mnt/data-1  #创建共享目录</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">~]# mkdir /mnt/data-2</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">~]# vim /etc/exports</span></span><br><span class="line"><span class="attr">/mnt/data-1</span> <span class="string">172.16.229.*/24 (rw,sync,insecure,no_subtree_check,no_root_squash)</span></span><br><span class="line"><span class="attr">/mnt/data-2</span> <span class="string">172.16.229.*/24 (rw,sync,insecure,no_subtree_check,no_root_squash)</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">~]# systemctl restart nfs</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">~]# mkdir /k8s/nginx  #创建工作目录</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">~]# cd /k8s/nginx/</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">nginx]# vim nginx-pv.yaml</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">v1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata</span>: <span class="string"></span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">pv-0</span></span><br><span class="line">  <span class="attr">labels</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">type</span>: <span class="string">pv-0</span></span><br><span class="line"><span class="attr">spec</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">capacity</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">storage</span>: <span class="string">5Gi</span></span><br><span class="line">  <span class="attr">accessModes</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy</span>: <span class="string">Recycle</span></span><br><span class="line">  <span class="attr">nfs</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">server</span>: <span class="string">172.16.229.143</span></span><br><span class="line">    <span class="attr">path</span>: <span class="string">&quot;/mnt/data-1&quot;</span></span><br><span class="line"><span class="attr">---</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">v1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">pv-1</span></span><br><span class="line">  <span class="attr">labels</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">type</span>: <span class="string">pv-1</span></span><br><span class="line"><span class="attr">spec</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">capacity</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">storage</span>: <span class="string">5Gi</span></span><br><span class="line">  <span class="attr">accessModes</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy</span>: <span class="string">Recycle</span></span><br><span class="line">  <span class="attr">nfs</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">server</span>: <span class="string">172.16.229.143</span></span><br><span class="line">    <span class="attr">path</span>: <span class="string">&quot;/mnt/data-2&quot;</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">2.创建pv</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">nginx]# kubectl apply -f nginx-pv.yaml </span></span><br><span class="line"><span class="attr">persistentvolume/nginx-pv</span> <span class="string">created</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">nginx]# kubectl get pv</span></span><br><span class="line"><span class="attr">NAME</span>    <span class="string">CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM           STORAGECLASS   REASON   AGE</span></span><br><span class="line"><span class="attr">my-pv</span>   <span class="string">3Gi        RWX            Recycle          Bound       default/mypvc   pv-nfs                  6d16h</span></span><br><span class="line"><span class="attr">pv-0</span>    <span class="string">5Gi        RWX            Recycle          Available                                           43s</span></span><br><span class="line"><span class="attr">pv-1</span>    <span class="string">5Gi        RWX            Recycle          Available                                           43s</span></span><br><span class="line"></span><br><span class="line"><span class="attr">3.创建</span> <span class="string">service的Headless Service无头服务</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">nginx]# vim nginx-service.yaml</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">v1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">nginx  #service的名字</span></span><br><span class="line">  <span class="attr">labels</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">app</span>: <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">ports</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">-</span> <span class="string">port: 80</span></span><br><span class="line">    <span class="attr">name</span>: <span class="string">web</span></span><br><span class="line">  <span class="attr">clusterIP</span>: <span class="string">None   #采用什么类型的service，这里采用的是Headless Service</span></span><br><span class="line">  <span class="attr">selector</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">app</span>: <span class="string">nginx</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">nginx]# kubectl apply -f nginx-service.yaml </span></span><br><span class="line"><span class="attr">service/nginx</span> <span class="string">created</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">nginx]# kubectl get svc </span></span><br><span class="line"><span class="attr">NAME</span>              <span class="string">TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE</span></span><br><span class="line"><span class="attr">kubernetes</span>        <span class="string">ClusterIP   10.96.0.1      &lt;none&gt;        443/TCP        12d</span></span><br><span class="line"><span class="attr">nginx</span>             <span class="string">ClusterIP   None           &lt;none&gt;        80/TCP         5s</span></span><br><span class="line"></span><br><span class="line"><span class="attr">4.创建StatefulSet,通过StatefulSet创建pvc实现自动绑定已经创建好的pv</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">nginx]# cat nginx-web.yaml </span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">apps/v1  #选择apiserver的版本</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">StatefulSet  #定义pod类型</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">nginx-web</span></span><br><span class="line"><span class="attr">spec</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">serviceName</span>: <span class="string">&quot;nginx&quot; #定义属于哪个Headless Service</span></span><br><span class="line">  <span class="attr">replicas</span>: <span class="string">2  #定义pod的副本</span></span><br><span class="line">  <span class="attr">selector</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">matchLabels</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">app</span>: <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">labels</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">app</span>: <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">containers</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">-</span> <span class="string">name: nginx</span></span><br><span class="line">        <span class="attr">image</span>: <span class="string">daocloud.io/library/nginx</span></span><br><span class="line">        <span class="attr">ports</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">-</span> <span class="string">containerPort: 80</span></span><br><span class="line">          <span class="attr">name</span>: <span class="string">web</span></span><br><span class="line">        <span class="attr">volumeMounts</span>:       <span class="string">#定义卷的挂载到pod的路径</span></span><br><span class="line">        <span class="attr">-</span> <span class="string">name: nginx-data</span></span><br><span class="line">          <span class="attr">mountPath</span>: <span class="string">/usr/share/nginx/html</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates</span>:  <span class="string">#pvc的申请模版，会自动创建pvc并与pv绑定。从而实现各pod有专用存储（我们使用的是静态创建pv）</span></span><br><span class="line">  <span class="attr">-</span> <span class="string">metadata:</span></span><br><span class="line">      <span class="attr">name</span>: <span class="string">nginx-data   #pvc的名字</span></span><br><span class="line">    <span class="attr">spec</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">accessModes</span>: <span class="string">[&quot;ReadWriteMany&quot;]</span></span><br><span class="line">      <span class="attr">resources</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">requests</span>:<span class="string"></span></span><br><span class="line">          <span class="attr">storage</span>: <span class="string">5Gi  #指定每一个持久卷的大小</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">nginx]# kubectl apply -f nginx-web.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">查看statefulset</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">nginx]# kubectl get statefulset nginx-web</span></span><br><span class="line"><span class="attr">NAME</span>        <span class="string">READY   AGE</span></span><br><span class="line"><span class="attr">nginx-web</span>   <span class="string">2/2     19m</span></span><br><span class="line"></span><br><span class="line"><span class="attr">查看service</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">nginx]# kubectl get svc </span></span><br><span class="line"><span class="attr">NAME</span>              <span class="string">TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE</span></span><br><span class="line"><span class="attr">nginx</span>             <span class="string">ClusterIP   None           &lt;none&gt;        80/TCP         18m</span></span><br></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">为什么需要volumeClaimTemplate？</span></span><br><span class="line"><span class="attr">对于有状态的副本集都会用到持久存储，对于分布式系统来讲，它的最大特点是数据是不一样的，所以各个节点不能使用同一存储卷，每个节点有自已的专用存储，但是如果在Deployment中的Pod</span> <span class="string">template里定义的存储卷，是所有副本集共用一个存储卷，数据是相同的，因为是基于模板来的 ，而statefulset中每个Pod都要自已的专有存储卷，所以statefulset的存储卷就不能再用Pod模板来创建了，于是statefulSet使用volumeClaimTemplate，称为卷申请模板，它会为每个Pod生成不同的pvc，并绑定pv， 从而实现各pod有专用存储。这就是为什么要用volumeClaimTemplate的原因。</span></span><br></pre></td></tr></table></figure>

<h5 id="25-3-1-顺序创建-Pod"><a href="#25-3-1-顺序创建-Pod" class="headerlink" title="25.3.1 顺序创建 Pod"></a>25.3.1 顺序创建 Pod</h5><p>对于一个拥有 N 个副本的 StatefulSet，Pod 被部署时是按照 {0 …… N-1} 的序号顺序创建的。在终端中使用 <code>kubectl get</code> 检查输出。这个输出最终将看起来像下面的样子</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">nginx]# kubectl get -l app=&#x27;nginx&#x27; pods</span></span><br><span class="line"><span class="attr">NAME</span>          <span class="string">READY   STATUS    RESTARTS   AGE</span></span><br><span class="line"><span class="attr">nginx-web-0</span>   <span class="string">1/1     Running   0          18m</span></span><br><span class="line"><span class="attr">nginx-web-1</span>   <span class="string">1/1     Running   0          6m34s</span></span><br></pre></td></tr></table></figure>

<p>请注意在 <code>nginx-web-0</code> Pod 处于 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/user-guide/pod-states">Running和Ready</a> 状态后 <code>nginx-web-1</code> Pod 才会被启动</p>
<p>如同 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/abstractions/controllers/statefulsets/">StatefulSets</a> 概念中所提到的，StatefulSet 中的 Pod 拥有一个具有黏性的、独一无二的身份标志。这个标志基于 StatefulSet 控制器分配给每个 Pod 的唯一顺序索引。Pod 的名称的形式为<code>&lt;statefulset name&gt;-&lt;ordinal index&gt;</code>。<code>web</code>StatefulSet 拥有两个副本，所以它创建了两个 Pod：<code>nginx-web-0</code>和<code>nginx-web-1</code>。</p>
<h5 id="25-3-2-使用稳定的网络身份标识"><a href="#25-3-2-使用稳定的网络身份标识" class="headerlink" title="25.3.2 使用稳定的网络身份标识 "></a>25.3.2 使用稳定的网络身份标识<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tutorials/stateful-application/basic-stateful-set/#%E4%BD%BF%E7%94%A8%E7%A8%B3%E5%AE%9A%E7%9A%84%E7%BD%91%E7%BB%9C%E8%BA%AB%E4%BB%BD%E6%A0%87%E8%AF%86"> </a></h5><p>每个 Pod 都拥有一个基于其顺序索引的稳定的主机名。使用<code>[kubectl exec](https://kubernetes.io/zh/docs/reference/generated/kubectl/kubectl-commands/#exec)</code>在每个 Pod 中执行<code>hostname</code></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">nginx]# for i in 0 1; do kubectl exec nginx-web-$i -- /bin/bash -c &#x27;hostname&#x27;; done</span></span><br><span class="line"><span class="attr">nginx-web-0</span></span><br><span class="line"><span class="attr">nginx-web-1</span></span><br></pre></td></tr></table></figure>

<h5 id="25-3-3-查看statefulset创建的pod的存储"><a href="#25-3-3-查看statefulset创建的pod的存储" class="headerlink" title="25.3.3 查看statefulset创建的pod的存储"></a>25.3.3 查看statefulset创建的pod的存储</h5><p>获取 <code>nginx-web-0</code> 和 <code>nginx-web-1</code> 的 PersistentVolumeClaims。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">nginx]# kubectl get pvc -l app=&#x27;nginx&#x27;</span></span><br><span class="line"><span class="attr">NAME</span>                     <span class="string">STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span></span><br><span class="line"><span class="attr">nginx-data-nginx-web-0</span>   <span class="string">Bound    pv-0     5Gi        RWX                           53m</span></span><br><span class="line"><span class="attr">nginx-data-nginx-web-1</span>   <span class="string">Bound    pv-1     5Gi        RWX                           53m</span></span><br></pre></td></tr></table></figure>

<p>StatefulSet 控制器创建了两个 PersistentVolumeClaims，绑定到两个 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/">PersistentVolumes</a>。由于这里我们使用的是手动创建pv，所有的 PersistentVolume 都是手动创建自动的绑定。</p>
<p>NGINX web 服务器默认会加载位于 <code>/usr/share/nginx/html/index.html</code> 的 index 文件。StatefulSets <code>spec</code> 中的 <code>volumeMounts</code> 字段保证了 <code>/usr/share/nginx/html</code> 文件夹由一个 PersistentVolume 支持。</p>
<p>将 Pod 的主机名写入它们的<code>index.html</code>文件并验证 NGINX web 服务器使用该主机名提供服务。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">nginx]# kubectl exec -it nginx-web-0 /bin/bash</span></span><br><span class="line"><span class="attr">root@nginx-web-0</span>:<span class="string">/# echo nginx-web-0 &gt;&gt; /usr/share/nginx/html/index.html </span></span><br><span class="line"><span class="attr">root@nginx-web-0</span>:<span class="string">/# exit  </span></span><br><span class="line"><span class="attr">exit</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">nginx]# kubectl exec -it nginx-web-1 /bin/bash</span></span><br><span class="line"><span class="attr">root@nginx-web-1</span>:<span class="string">/# echo nginx-web-1 &gt;&gt; /usr/share/nginx/html/index.html</span></span><br><span class="line"><span class="attr">root@nginx-web-1</span>:<span class="string">/# exit</span></span><br><span class="line"><span class="attr">exit</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">nginx]# kubectl get pods -l app=&#x27;nginx&#x27; -o wide</span></span><br><span class="line"><span class="attr">NAME</span>          <span class="string">READY   STATUS    RESTARTS   AGE   IP            NODE        NOMINATED NODE   READINESS GATES</span></span><br><span class="line"><span class="attr">nginx-web-0</span>   <span class="string">1/1     Running   0          84m   10.244.2.24   k8s-node2   &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line"><span class="attr">nginx-web-1</span>   <span class="string">1/1     Running   0          84m   10.244.1.26   k8s-node1   &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">nginx]# curl -s http://10.244.2.24</span></span><br><span class="line"><span class="attr">nginx-web-0</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">nginx]# curl -s http://10.244.1.26</span></span><br><span class="line"><span class="attr">nginx-web-1</span></span><br></pre></td></tr></table></figure>

<h5 id="25-3-4-说明"><a href="#25-3-4-说明" class="headerlink" title="25.3.4 说明"></a>25.3.4 说明</h5><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">请注意，如果你看见上面的</span> <span class="string">curl 命令返回了 403 Forbidden 的响应，你需要像这样修复使用 `volumeMounts`挂载的目录的权限：</span></span><br><span class="line"><span class="comment"># for i in 0 1; do kubectl exec web-$i -- chmod 755 /usr/share/nginx/html; done</span></span><br></pre></td></tr></table></figure>

<p>将StatefulSet创建的 所有 Pod删除</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">nginx]# kubectl delete -f nginx-web.yaml </span></span><br><span class="line"><span class="attr">statefulset.apps</span> <span class="string">&quot;nginx-web&quot; deleted</span></span><br></pre></td></tr></table></figure>

<p>在使用StatefulSet重新创建的所有Pod</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">nginx]# kubectl apply -f nginx-web.yaml </span></span><br><span class="line"><span class="attr">statefulset.apps/nginx-web</span> <span class="string">created</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">nginx]# kubectl get pods -l app=&#x27;nginx&#x27; -o wide</span></span><br><span class="line"><span class="attr">NAME</span>          <span class="string">READY   STATUS    RESTARTS   AGE   IP            NODE        NOMINATED NODE   READINESS GATES</span></span><br><span class="line"><span class="attr">nginx-web-0</span>   <span class="string">1/1     Running   0          14s   10.244.2.25   k8s-node2   &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line"><span class="attr">nginx-web-1</span>   <span class="string">1/1     Running   0          12s   10.244.1.27   k8s-node1   &lt;none&gt;           &lt;none&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们发现pod的IP地址发生了变化，接下来再次访问</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">nginx]# curl -s http://10.244.2.25</span></span><br><span class="line"><span class="attr">nginx-web-0</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">nginx]# curl -s http://10.244.1.27</span></span><br><span class="line"><span class="attr">nginx-web-1</span></span><br></pre></td></tr></table></figure>

<p>虽然 <code>nginx-web-0</code> 和 <code>nginx-web-1</code> 被重新调度了，但它们仍然继续监听各自的主机名，因为和它们的 PersistentVolumeClaim 相关联的 PersistentVolume 被重新挂载到了各自的 <code>volumeMount</code> 上。不管 <code>nginx-web-0</code> 和 <code>nginx-web-1</code> 被调度到了哪个节点上，它们的 PersistentVolumes 将会被挂载到合适的挂载点上。</p>
<h5 id="25-3-5-扩容-缩容-StatefulSet"><a href="#25-3-5-扩容-缩容-StatefulSet" class="headerlink" title="25.3.5 扩容&#x2F;缩容 StatefulSet"></a>25.3.5 扩容&#x2F;缩容 StatefulSet</h5><p>扩容&#x2F;缩容 StatefulSet 指增加或减少它的副本数。这通过更新 <code>replicas</code> 字段完成.如果是手动创建的pv，那么需要提前将pv创建好了。</p>
<h4 id="25-4-实战2-通过StatefulSet来管理有状态的服务msyql"><a href="#25-4-实战2-通过StatefulSet来管理有状态的服务msyql" class="headerlink" title="25.4 实战2-通过StatefulSet来管理有状态的服务msyql"></a>25.4 实战2-通过StatefulSet来管理有状态的服务msyql</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">~]# mkdir /mnt/data-3</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">~]# vim /etc/exports</span></span><br><span class="line"><span class="attr">/mnt/data-3</span> <span class="string">172.16.229.*/24 (rw,sync,insecure,no_subtree_check,no_root_squash)</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">~]# systemctl restart nfs</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">~]# mkdir /k8s/application/mysql</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">mysql]# cat mysql.pv.yaml</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">v1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata</span>: <span class="string"></span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">mysql-pv</span></span><br><span class="line">  <span class="attr">labels</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">type</span>: <span class="string">mysql-pv</span></span><br><span class="line"><span class="attr">spec</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">capacity</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">storage</span>: <span class="string">5Gi</span></span><br><span class="line">  <span class="attr">accessModes</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy</span>: <span class="string">Recycle</span></span><br><span class="line">  <span class="attr">nfs</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">server</span>: <span class="string">172.16.229.143</span></span><br><span class="line">    <span class="attr">path</span>: <span class="string">&quot;/mnt/data-3&quot;</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">mysql]# cat mysql-svc.yaml</span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">v1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">mysql</span></span><br><span class="line">  <span class="attr">labels</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">app</span>: <span class="string">mysql</span></span><br><span class="line"><span class="attr">spec</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">ports</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">-</span> <span class="string">port: 3306</span></span><br><span class="line">    <span class="attr">name</span>: <span class="string">mysql</span></span><br><span class="line">  <span class="attr">clusterIP</span>: <span class="string">None</span></span><br><span class="line">  <span class="attr">selector</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">app</span>: <span class="string">mysql</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">mysql]# cat mysql-server.yaml </span></span><br><span class="line"><span class="attr">apiVersion</span>: <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind</span>: <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">name</span>: <span class="string">mysql</span></span><br><span class="line"><span class="attr">spec</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">serviceName</span>: <span class="string">&quot;mysql&quot;</span></span><br><span class="line">  <span class="attr">replicas</span>: <span class="string">1</span></span><br><span class="line">  <span class="attr">selector</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">matchLabels</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">app</span>: <span class="string">mysql</span></span><br><span class="line">  <span class="attr">template</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">metadata</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">labels</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">app</span>: <span class="string">mysql</span></span><br><span class="line">    <span class="attr">spec</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">containers</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">-</span> <span class="string">name: mysql</span></span><br><span class="line">        <span class="attr">image</span>: <span class="string">daocloud.io/library/mysql:5.7</span></span><br><span class="line">        <span class="attr">ports</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">-</span> <span class="string">containerPort: 3306</span></span><br><span class="line">        <span class="attr">env</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">-</span> <span class="string">name: MYSQL_ROOT_PASSWORD</span></span><br><span class="line">          <span class="attr">value</span>: <span class="string">&quot;Qfedu@123&quot;</span></span><br><span class="line">        <span class="attr">volumeMounts</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">-</span> <span class="string">name: mysql-data</span></span><br><span class="line">          <span class="attr">mountPath</span>: <span class="string">/var/lib/mysql</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">-</span> <span class="string">metadata:</span></span><br><span class="line">      <span class="attr">name</span>: <span class="string">mysql-data</span></span><br><span class="line">    <span class="attr">spec</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">accessModes</span>: <span class="string">[&quot;ReadWriteMany&quot;]</span></span><br><span class="line">      <span class="attr">resources</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">requests</span>:<span class="string"></span></span><br><span class="line">          <span class="attr">storage</span>: <span class="string">5Gi</span></span><br><span class="line">          </span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">mysql]# kubectl apply -f mysql.pv.yaml </span></span><br><span class="line"><span class="attr">persistentvolume/mysql-pv</span> <span class="string">created</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">mysql]# kubectl apply -f mysql-svc.yaml </span></span><br><span class="line"><span class="attr">service/mysql</span> <span class="string">created </span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">mysql]# kubectl apply -f mysql-server.yaml </span></span><br><span class="line"><span class="attr">statefulset.apps/mysql</span> <span class="string">created</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">mysql]# kubectl get pv | grep mysql</span></span><br><span class="line"><span class="attr">mysql-pv</span>   <span class="string">5Gi        RWX            Recycle          Bound    default/mysql-data-mysql-0                               7m28s</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">mysql]# kubectl get pvc</span></span><br><span class="line"><span class="attr">NAME</span>                     <span class="string">STATUS   VOLUME     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span></span><br><span class="line"><span class="attr">mysql-data-mysql-0</span>       <span class="string">Bound    mysql-pv   5Gi        RWX                           7m16s</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">mysql]# kubectl get pods -l app=&#x27;mysql&#x27; -o wide</span></span><br><span class="line"><span class="attr">NAME</span>                        <span class="string">READY   STATUS             RESTARTS   AGE     IP            NODE        NOMINATED NODE   READINESS GATES</span></span><br><span class="line"><span class="attr">mysql-0</span>                     <span class="string">1/1     Running            0          6m22s   10.244.1.28   k8s-node1   &lt;none&gt;           &lt;none&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">mysql]# kubectl exec -it mysql-0 /bin/bash</span></span><br><span class="line"><span class="attr">root@mysql-0</span>:<span class="string">/# mysql -uroot -p&#x27;Qfedu@123&#x27;</span></span><br><span class="line"><span class="attr">mysql</span>: <span class="string">[Warning] Using a password on the command line interface can be insecure.</span></span><br><span class="line"><span class="attr">Welcome</span> <span class="string">to the MySQL monitor.  Commands end with ; or \g.</span></span><br><span class="line"><span class="attr">...</span></span><br><span class="line"><span class="attr">mysql&gt;</span> <span class="string">show databases;</span></span><br><span class="line"><span class="attr">+--------------------+</span></span><br><span class="line"><span class="attr">|</span> <span class="string">Database           |</span></span><br><span class="line"><span class="attr">+--------------------+</span></span><br><span class="line"><span class="attr">|</span> <span class="string">information_schema |</span></span><br><span class="line"><span class="attr">|</span> <span class="string">mysql              |</span></span><br><span class="line"><span class="attr">|</span> <span class="string">performance_schema |</span></span><br><span class="line"><span class="attr">|</span> <span class="string">sys                |</span></span><br><span class="line"><span class="attr">+--------------------+</span></span><br><span class="line"><span class="attr">4</span> <span class="string">rows in set (0.01 sec)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mysql&gt;</span> <span class="string">create database test1;</span></span><br><span class="line"><span class="attr">Query</span> <span class="string">OK, 1 row affected (0.00 sec)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mysql&gt;</span> <span class="string">exit</span></span><br><span class="line"><span class="attr">Bye</span></span><br><span class="line"><span class="attr">root@mysql-0</span>:<span class="string">/# exit</span></span><br><span class="line"><span class="attr">exit</span> <span class="string"></span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">mysql]# cd /mnt/data-3/</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">data-3]# ll</span></span><br><span class="line"><span class="attr">总用量</span> <span class="string">188484</span></span><br><span class="line"><span class="attr">-rw-r-----</span> <span class="string">1 polkitd ssh_keys       56 11月 15 16:24 auto.cnf</span></span><br><span class="line"><span class="attr">-rw-------</span> <span class="string">1 polkitd ssh_keys     1676 11月 15 16:24 ca-key.pem</span></span><br><span class="line"><span class="attr">-rw-r--r--</span> <span class="string">1 polkitd ssh_keys     1112 11月 15 16:24 ca.pem</span></span><br><span class="line"><span class="attr">-rw-r--r--</span> <span class="string">1 polkitd ssh_keys     1112 11月 15 16:24 client-cert.pem</span></span><br><span class="line"><span class="attr">-rw-------</span> <span class="string">1 polkitd ssh_keys     1680 11月 15 16:24 client-key.pem</span></span><br><span class="line"><span class="attr">-rw-r-----</span> <span class="string">1 polkitd ssh_keys     1353 11月 15 16:25 ib_buffer_pool</span></span><br><span class="line"><span class="attr">-rw-r-----</span> <span class="string">1 polkitd ssh_keys 79691776 11月 15 16:25 ibdata1</span></span><br><span class="line"><span class="attr">-rw-r-----</span> <span class="string">1 polkitd ssh_keys 50331648 11月 15 16:25 ib_logfile0</span></span><br><span class="line"><span class="attr">-rw-r-----</span> <span class="string">1 polkitd ssh_keys 50331648 11月 15 16:24 ib_logfile1</span></span><br><span class="line"><span class="attr">-rw-r-----</span> <span class="string">1 polkitd ssh_keys 12582912 11月 15 16:25 ibtmp1</span></span><br><span class="line"><span class="attr">drwxr-x---</span> <span class="string">2 polkitd ssh_keys     4096 11月 15 16:25 mysql</span></span><br><span class="line"><span class="attr">drwxr-x---</span> <span class="string">2 polkitd ssh_keys     8192 11月 15 16:25 performance_schema</span></span><br><span class="line"><span class="attr">-rw-------</span> <span class="string">1 polkitd ssh_keys     1680 11月 15 16:24 private_key.pem</span></span><br><span class="line"><span class="attr">-rw-r--r--</span> <span class="string">1 polkitd ssh_keys      452 11月 15 16:24 public_key.pem</span></span><br><span class="line"><span class="attr">-rw-r--r--</span> <span class="string">1 polkitd ssh_keys     1112 11月 15 16:24 server-cert.pem</span></span><br><span class="line"><span class="attr">-rw-------</span> <span class="string">1 polkitd ssh_keys     1680 11月 15 16:24 server-key.pem</span></span><br><span class="line"><span class="attr">drwxr-x---</span> <span class="string">2 polkitd ssh_keys     8192 11月 15 16:25 sys</span></span><br><span class="line"><span class="attr">drwxr-x---</span> <span class="string">2 polkitd ssh_keys       20 11月 15 16:29 test1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">mysql]# kubectl delete -f mysql-server.yaml </span></span><br><span class="line"><span class="attr">statefulset.apps</span> <span class="string">&quot;mysql&quot; deleted</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">mysql]# cd /mnt/data-3/</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">data-3]# ll</span></span><br><span class="line"><span class="attr">总用量</span> <span class="string">176196</span></span><br><span class="line"><span class="attr">-rw-r-----</span> <span class="string">1 polkitd ssh_keys       56 11月 15 16:24 auto.cnf</span></span><br><span class="line"><span class="attr">-rw-------</span> <span class="string">1 polkitd ssh_keys     1676 11月 15 16:24 ca-key.pem</span></span><br><span class="line"><span class="attr">-rw-r--r--</span> <span class="string">1 polkitd ssh_keys     1112 11月 15 16:24 ca.pem</span></span><br><span class="line"><span class="attr">-rw-r--r--</span> <span class="string">1 polkitd ssh_keys     1112 11月 15 16:24 client-cert.pem</span></span><br><span class="line"><span class="attr">-rw-------</span> <span class="string">1 polkitd ssh_keys     1680 11月 15 16:24 client-key.pem</span></span><br><span class="line"><span class="attr">-rw-r-----</span> <span class="string">1 polkitd ssh_keys      688 11月 15 16:32 ib_buffer_pool</span></span><br><span class="line"><span class="attr">-rw-r-----</span> <span class="string">1 polkitd ssh_keys 79691776 11月 15 16:32 ibdata1</span></span><br><span class="line"><span class="attr">-rw-r-----</span> <span class="string">1 polkitd ssh_keys 50331648 11月 15 16:32 ib_logfile0</span></span><br><span class="line"><span class="attr">-rw-r-----</span> <span class="string">1 polkitd ssh_keys 50331648 11月 15 16:24 ib_logfile1</span></span><br><span class="line"><span class="attr">drwxr-x---</span> <span class="string">2 polkitd ssh_keys     4096 11月 15 16:25 mysql</span></span><br><span class="line"><span class="attr">drwxr-x---</span> <span class="string">2 polkitd ssh_keys     8192 11月 15 16:25 performance_schema</span></span><br><span class="line"><span class="attr">-rw-------</span> <span class="string">1 polkitd ssh_keys     1680 11月 15 16:24 private_key.pem</span></span><br><span class="line"><span class="attr">-rw-r--r--</span> <span class="string">1 polkitd ssh_keys      452 11月 15 16:24 public_key.pem</span></span><br><span class="line"><span class="attr">-rw-r--r--</span> <span class="string">1 polkitd ssh_keys     1112 11月 15 16:24 server-cert.pem</span></span><br><span class="line"><span class="attr">-rw-------</span> <span class="string">1 polkitd ssh_keys     1680 11月 15 16:24 server-key.pem</span></span><br><span class="line"><span class="attr">drwxr-x---</span> <span class="string">2 polkitd ssh_keys     8192 11月 15 16:25 sys</span></span><br><span class="line"><span class="attr">drwxr-x---</span> <span class="string">2 polkitd ssh_keys       20 11月 15 16:29 test1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">data-3]# cd -</span></span><br><span class="line"><span class="attr">/k8s/application/mysql</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">mysql]# kubectl apply  -f mysql-server.yaml </span></span><br><span class="line"><span class="attr">statefulset.apps/mysql</span> <span class="string">created</span></span><br><span class="line"><span class="attr">[root@k8s-master</span> <span class="string">mysql]# kubectl exec -it mysql-0 /bin/bash</span></span><br><span class="line"><span class="attr">root@mysql-0</span>:<span class="string">/# mysql -uroot -p&#x27;Qfedu@123&#x27;</span></span><br><span class="line"><span class="attr">...</span></span><br><span class="line"><span class="attr">mysql&gt;</span> <span class="string">show databases;</span></span><br><span class="line"><span class="attr">+--------------------+</span></span><br><span class="line"><span class="attr">|</span> <span class="string">Database           |</span></span><br><span class="line"><span class="attr">+--------------------+</span></span><br><span class="line"><span class="attr">|</span> <span class="string">information_schema |</span></span><br><span class="line"><span class="attr">|</span> <span class="string">mysql              |</span></span><br><span class="line"><span class="attr">|</span> <span class="string">performance_schema |</span></span><br><span class="line"><span class="attr">|</span> <span class="string">sys                |</span></span><br><span class="line"><span class="attr">|</span> <span class="string">test1              |</span></span><br><span class="line"><span class="attr">+--------------------+</span></span><br><span class="line"><span class="attr">5</span> <span class="string">rows in set (0.01 sec)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mysql&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="25-5-k8s中无状态服务和有状态服务部署的区别？"><a href="#25-5-k8s中无状态服务和有状态服务部署的区别？" class="headerlink" title="25.5 k8s中无状态服务和有状态服务部署的区别？"></a>25.5 k8s中无状态服务和有状态服务部署的区别？</h4><p><strong>无状态</strong>：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">1.</span> <span class="string">pod命名：pod名由资源名+随机的字符串组成；</span></span><br><span class="line"><span class="attr">2.</span> <span class="string">数据存储：多个实例pod可以共享相同的持久化数据，存储不是必要条件；</span></span><br><span class="line"><span class="attr">3.</span> <span class="string">扩缩容：可以随意扩缩容某个pod，不会指定某个pod进行扩缩容；</span></span><br><span class="line"><span class="attr">4.</span> <span class="string">启停顺序：因为pod名的序号是随机串，无启停顺序之分；</span></span><br><span class="line"><span class="attr">5.</span> <span class="string">无状态k8s资源：ReplicaSet、ReplicationController、Deployment、DaemonSet、Job等资源；</span></span><br><span class="line"><span class="attr">6.</span> <span class="string">无状态服务：tomcat、nginx等；</span></span><br></pre></td></tr></table></figure>

<p><strong>有状态</strong><br>这里假设有N个pod；</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">1.</span> <span class="string">pod命名：pod名由statefulset资源名+有序的数字组成（0,1,2...N-1），且pod有特定的网络标识；</span></span><br><span class="line"><span class="attr">2.</span> <span class="string">数据存储：有状态的服务对应实例需要有自己的独立持久卷存储；</span></span><br><span class="line"><span class="attr">3.</span> <span class="string">扩缩容：扩缩容不可随意，缩容是从数字最大的开始递减，扩容是在原有pod序号基础上递增1。</span></span><br><span class="line"><span class="attr">4.</span> <span class="string">启停顺序：pod启停是有顺序的，启动时，先启动pod序号为0的，然后依次递增至N-1；停止时，先停止pod序号为最大的N-1，然后依次递减至0；</span></span><br><span class="line"><span class="attr">5.</span> <span class="string">有状态k8s资源：StatefulSet资源；</span></span><br><span class="line"><span class="attr">6.</span> <span class="string">有状态服务：Kafka、ZooKeeper、MySql、MongoDB以及一些需要保存日志的应用等服务；</span></span><br></pre></td></tr></table></figure>


    </article>
    
    <div class="read-nums">
      <!-- id 将作为查询条件 -->
      <span id="2024/06/02/Kubernetes组件/" class="leancloud_visitors" data-flag-title="Your Article Title">
        <em class="post-meta-item-text">浏览量</em>
        <i class="leancloud-visitors-count"></i>
      </span>
    </div>
    <div class="comments-intro">
      <h2>评论区</h2>
      <p>欢迎你留下宝贵的意见，昵称输入QQ号会显示QQ头像哦~</p>
    </div>
    <div id="vcomments" class="vcomments"></div>
    
  </div>
  <div class="article-catelogue">
    <div class="article-catelogue--wrapper">
      <div class="catelogue catelogue-1">
        <h3>目录</h3>
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Kubernetes-%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92"><span class="toc-number">1.</span> <span class="toc-text">Kubernetes 容器编排</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.1.</span> <span class="toc-text">前言</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E6%89%A9%E5%B1%95"><span class="toc-number">1.1.1.</span> <span class="toc-text">知识扩展</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E7%BC%96%E6%8E%92"><span class="toc-number">1.1.2.</span> <span class="toc-text">什么是编排</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%E4%B9%8B%E6%88%98"><span class="toc-number">1.2.</span> <span class="toc-text">容器编排之战</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80-kubernetes%E7%AE%80%E8%A6%81%E6%A6%82%E8%BF%B0"><span class="toc-number">1.2.1.</span> <span class="toc-text">一. kubernetes简要概述</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-kubernetes-%E5%8A%9F%E8%83%BD%E7%AE%80%E4%BB%8B"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">1.1 kubernetes 功能简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-Kubernetes%E6%9E%B6%E6%9E%84%E5%8F%8A%E7%BB%84%E4%BB%B6"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">1.2 Kubernetes架构及组件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-Kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-number">1.2.1.3.</span> <span class="toc-text">1.3 Kubernetes核心概念</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C-%E5%B8%B8%E7%94%A8%E9%95%9C%E5%83%8F%E5%BA%93"><span class="toc-number">1.2.2.</span> <span class="toc-text">二. 常用镜像库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89-%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2%E6%96%B9%E5%BC%8F"><span class="toc-number">1.2.3.</span> <span class="toc-text">三.集群部署方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B-Kubeadm-%E6%96%B9%E5%BC%8F%E9%83%A8%E7%BD%B2%E9%9B%86%E7%BE%A4"><span class="toc-number">1.2.4.</span> <span class="toc-text">四.Kubeadm 方式部署集群</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-%E5%AE%89%E8%A3%85docker-%E9%9B%86%E7%BE%A4"><span class="toc-number">1.2.4.1.</span> <span class="toc-text">4.1 安装docker[集群]</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-%E8%8E%B7%E5%8F%96%E9%95%9C%E5%83%8F-%E9%9B%86%E7%BE%A4"><span class="toc-number">1.2.4.2.</span> <span class="toc-text">4.2 获取镜像[集群]</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-%E9%98%BF%E9%87%8C%E4%BB%93%E5%BA%93%E4%B8%8B%E8%BD%BD-%E9%9B%86%E7%BE%A4"><span class="toc-number">1.2.4.3.</span> <span class="toc-text">4.3 阿里仓库下载[集群]</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2-%E9%9B%86%E7%BE%A4"><span class="toc-number">1.2.4.4.</span> <span class="toc-text">4.4 集群部署[集群]</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-5-%E9%9B%86%E7%BE%A4%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE-%E9%9B%86%E7%BE%A4"><span class="toc-number">1.2.4.5.</span> <span class="toc-text">4.5 集群环境配置[集群]</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-6-%E5%85%B3%E9%97%AD%E7%B3%BB%E7%BB%9FSwap-%E9%9B%86%E7%BE%A4"><span class="toc-number">1.2.4.6.</span> <span class="toc-text">4.6 关闭系统Swap[集群]</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-7-%E5%AE%89%E8%A3%85Kubeadm%E5%8C%85-%E9%9B%86%E7%BE%A4"><span class="toc-number">1.2.4.7.</span> <span class="toc-text">4.7 安装Kubeadm包[集群]</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-8-%E9%85%8D%E7%BD%AE%E5%90%AF%E5%8A%A8kubelet-%E9%9B%86%E7%BE%A4"><span class="toc-number">1.2.4.8.</span> <span class="toc-text">4.8 配置启动kubelet[集群]</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-9-%E9%85%8D%E7%BD%AEmaster%E8%8A%82%E7%82%B9-master"><span class="toc-number">1.2.4.9.</span> <span class="toc-text">4.9 配置master节点[master]</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-9-1-%E5%AE%89%E8%A3%85haproxy"><span class="toc-number">1.2.4.9.1.</span> <span class="toc-text">4.9.1 安装haproxy</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-9-2-%E5%88%9D%E5%A7%8B%E5%8C%96%E9%9B%86%E7%BE%A4"><span class="toc-number">1.2.4.9.2.</span> <span class="toc-text">4.9.2 初始化集群</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-10-%E9%85%8D%E7%BD%AE%E4%BD%BF%E7%94%A8%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6-master"><span class="toc-number">1.2.4.10.</span> <span class="toc-text">4.10 配置使用网络插件[master]</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-11-%E5%8A%A0%E5%85%A5%E9%9B%86%E7%BE%A4-node"><span class="toc-number">1.2.4.11.</span> <span class="toc-text">4.11 加入集群[node]</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-12-%E5%90%8E%E7%BB%AD%E6%A3%80%E6%9F%A5-master"><span class="toc-number">1.2.4.12.</span> <span class="toc-text">4.12 后续检查[master]</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-13-%E9%9B%86%E7%BE%A4%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C"><span class="toc-number">1.2.4.13.</span> <span class="toc-text">4.13 集群数据库相关操作</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94-%E5%8F%AF%E8%A7%86%E5%8C%96%E9%83%A8%E7%BD%B2"><span class="toc-number">1.2.5.</span> <span class="toc-text">五.可视化部署</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-%E5%AE%98%E6%96%B9Dashboard"><span class="toc-number">1.2.5.1.</span> <span class="toc-text">5.1 官方Dashboard</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1-1-%E9%83%A8%E7%BD%B2Dashboard"><span class="toc-number">1.2.5.1.1.</span> <span class="toc-text">5.1.1 部署Dashboard</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1-2-%E5%88%9B%E5%BB%BA%E8%AE%BF%E9%97%AE%E8%B4%A6%E5%8F%B7"><span class="toc-number">1.2.5.1.2.</span> <span class="toc-text">5.1.2 创建访问账号</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1-3-%E8%8E%B7%E5%8F%96%E8%AE%BF%E9%97%AE%E4%BB%A4%E7%89%8C"><span class="toc-number">1.2.5.1.3.</span> <span class="toc-text">5.1.3 获取访问令牌</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1-4-%E6%B5%8F%E8%A7%88%E5%99%A8%E8%AE%BF%E9%97%AE"><span class="toc-number">1.2.5.1.4.</span> <span class="toc-text">5.1.4 浏览器访问</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-kuboard-%E9%83%A8%E7%BD%B2"><span class="toc-number">1.2.5.2.</span> <span class="toc-text">5.2 kuboard 部署</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-kubesphere-%E9%83%A8%E7%BD%B2"><span class="toc-number">1.2.5.3.</span> <span class="toc-text">5.3 kubesphere 部署</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-rainbond-%E9%83%A8%E7%BD%B2"><span class="toc-number">1.2.5.4.</span> <span class="toc-text">5.4  rainbond 部署</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AD-%E9%9B%86%E7%BE%A4%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4"><span class="toc-number">1.2.6.</span> <span class="toc-text">六.集群常用指令</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-1-%E5%9F%BA%E7%A1%80%E6%8E%A7%E5%88%B6%E6%8C%87%E4%BB%A4"><span class="toc-number">1.2.6.1.</span> <span class="toc-text">6.1 基础控制指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-%E5%91%BD%E4%BB%A4%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.2.6.2.</span> <span class="toc-text">6.2 命令实践</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-3-%E5%A4%87%E6%B3%A8"><span class="toc-number">1.2.6.3.</span> <span class="toc-text">6.3 备注</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%83-Yaml%E8%AF%AD%E6%B3%95%E8%A7%A3%E6%9E%90"><span class="toc-number">1.2.7.</span> <span class="toc-text">七.Yaml语法解析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AB-k8s%E4%B8%AD%E7%9A%84Pod"><span class="toc-number">1.2.8.</span> <span class="toc-text">八.k8s中的Pod</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pod-API-%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.2.9.</span> <span class="toc-text">Pod API 对象</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E5%8F%AF%E9%80%89%E7%9A%84%E8%AE%BE%E7%BD%AE%E5%B1%9E%E6%80%A7%E5%8C%85%E6%8B%AC%EF%BC%9A"><span class="toc-number">1.2.9.1.</span> <span class="toc-text">容器可选的设置属性包括：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-1-%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AApod"><span class="toc-number">1.2.9.2.</span> <span class="toc-text">8.1 创建一个pod</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-2-pod%E6%98%AF%E5%A6%82%E4%BD%95%E8%A2%AB%E5%88%9B%E5%BB%BA%E7%9A%84"><span class="toc-number">1.2.9.3.</span> <span class="toc-text">8.2 pod是如何被创建的</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-3-%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%8D%95%E5%AE%B9%E5%99%A8pod"><span class="toc-number">1.2.9.4.</span> <span class="toc-text">8.3 创建一个单容器pod</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-4-%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%A4%9A%E5%AE%B9%E5%99%A8pod"><span class="toc-number">1.2.9.5.</span> <span class="toc-text">8.4 创建一个多容器pod</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#8-4-1-%E9%85%8D%E7%BD%AE%E8%8A%82%E7%82%B9%E6%A0%87%E7%AD%BE"><span class="toc-number">1.2.9.5.1.</span> <span class="toc-text">8.4.1 配置节点标签</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-5-Pod%E5%AE%B9%E5%99%A8%E7%9A%84%E4%BA%A4%E4%BA%92"><span class="toc-number">1.2.9.6.</span> <span class="toc-text">8.5 Pod容器的交互</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#8-5-1-%E5%88%9B%E5%BB%BApod%EF%BC%8C%E5%B9%B6%E5%81%9A%E6%9C%AC%E5%9C%B0%E8%A7%A3%E6%9E%90"><span class="toc-number">1.2.9.6.1.</span> <span class="toc-text">8.5.1 创建pod，并做本地解析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#8-5-2-pod%E5%85%B1%E4%BA%AB%E8%BF%9B%E7%A8%8B"><span class="toc-number">1.2.9.6.2.</span> <span class="toc-text">8.5.2 pod共享进程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#8-5-2-pod%E5%85%B1%E7%94%A8%E5%AE%BF%E4%B8%BB%E6%9C%BAnamespace"><span class="toc-number">1.2.9.6.3.</span> <span class="toc-text">8.5.2 pod共用宿主机namespace</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-6-%E9%92%A9%E5%AD%90%E5%87%BD%E6%95%B0lifecycle"><span class="toc-number">1.2.9.7.</span> <span class="toc-text">8.6 钩子函数lifecycle</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#kubernetes-%E5%9C%A8%E4%B8%BB%E5%AE%B9%E5%99%A8%E5%90%AF%E5%8A%A8%E4%B9%8B%E5%90%8E%E5%92%8C%E5%88%A0%E9%99%A4%E4%B9%8B%E5%89%8D%E6%8F%90%E4%BE%9B%E4%BA%86%E4%B8%A4%E4%B8%AA%E9%92%A9%E5%AD%90%E5%87%BD%E6%95%B0%EF%BC%9A-post-start%EF%BC%9A%E5%AE%B9%E5%99%A8%E5%88%9B%E5%BB%BA%E4%B9%8B%E5%90%8E%E6%89%A7%E8%A1%8C%EF%BC%8C%E5%A6%82%E6%9E%9C%E5%A4%B1%E8%B4%A5%E4%BC%9A%E9%87%8D%E5%90%AF%E5%AE%B9%E5%99%A8-pre-stop%EF%BC%9A%E5%AE%B9%E5%99%A8%E5%88%A0%E9%99%A4%E4%B9%8B%E5%89%8D%E6%89%A7%E8%A1%8C%EF%BC%8C%E6%89%A7%E8%A1%8C%E5%AE%8C%E6%88%90%E4%B9%8B%E5%90%8E%E5%AE%B9%E5%99%A8%E5%B0%86%E6%88%90%E5%8A%9F%E5%88%A0%E9%99%A4%EF%BC%8C%E5%9C%A8%E5%85%B6%E5%AE%8C%E6%88%90%E4%B9%8B%E5%89%8D%E4%BC%9A%E9%98%BB%E5%A1%9E%E5%88%A0%E9%99%A4%E5%AE%B9%E5%99%A8%E7%9A%84%E6%93%8D%E4%BD%9C-%E9%92%A9%E5%AD%90%E5%87%BD%E6%95%B0%E6%9C%89%E4%B8%89%E7%A7%8D%E5%AE%9A%E4%B9%89%E6%96%B9%E5%BC%8F-%E7%AC%AC%E4%B8%80%E7%A7%8D-exec-%E6%89%A7%E8%A1%8C%E6%8C%87%E4%BB%A4"><span class="toc-number">1.3.</span> <span class="toc-text">kubernetes 在主容器启动之后和删除之前提供了两个钩子函数：-  post start：容器创建之后执行，如果失败会重启容器-  pre stop：容器删除之前执行，执行完成之后容器将成功删除，在其完成之前会阻塞删除容器的操作-  钩子函数有三种定义方式-  第一种 exec 执行指令 </span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%80%E4%B8%AA%E9%92%A9%E5%AD%90%E5%87%BD%E6%95%B0%E7%9A%84%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.3.0.0.1.</span> <span class="toc-text">一个钩子函数的示例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B9%9D-%E5%AE%B9%E5%99%A8%E7%9B%91%E6%8E%A7%E6%A3%80%E6%9F%A5%E5%8F%8A%E6%81%A2%E5%A4%8D%E6%9C%BA%E5%88%B6"><span class="toc-number">1.3.1.</span> <span class="toc-text">九.容器监控检查及恢复机制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#9-1-%E5%91%BD%E4%BB%A4%E6%A8%A1%E5%BC%8F%E6%8E%A2%E9%92%88"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">9.1 命令模式探针</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9-2-http-get%E6%96%B9%E5%BC%8F%E6%8E%A2%E9%92%88"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">9.2 http get方式探针</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9-3-POD-%E7%9A%84%E6%81%A2%E5%A4%8D%E7%AD%96%E7%95%A5"><span class="toc-number">1.3.1.3.</span> <span class="toc-text">9.3 POD 的恢复策略</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%81-%E6%8A%95%E5%B0%84%E6%95%B0%E6%8D%AE%E5%8D%B7-Projected-Volume"><span class="toc-number">1.3.2.</span> <span class="toc-text">十.投射数据卷 Projected Volume</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#10-1-%E4%BB%80%E4%B9%88%E6%98%AFProjected-Volume"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">10.1 什么是Projected Volume</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-2-k8s-%E6%94%AF%E6%8C%81%E7%9A%84-Projected-Volume-%E6%96%B9%E5%BC%8F"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">10.2 k8s 支持的 Projected Volume 方式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%81%E4%B8%80-Secret-%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.3.3.</span> <span class="toc-text">十一.Secret 实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#11-1-secret-%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">11.1 secret  详解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-2-secret-%E4%BD%BF%E7%94%A8"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">11.2 secret 使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-3-%E4%BD%BF%E7%94%A8Secret"><span class="toc-number">1.3.3.3.</span> <span class="toc-text">11.3 使用Secret</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-4-%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B"><span class="toc-number">1.3.3.4.</span> <span class="toc-text">11.4 实战案例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%81%E4%BA%8C-ConfigMap%E7%A5%A5%E8%A7%A3"><span class="toc-number">1.3.4.</span> <span class="toc-text">十二.ConfigMap祥解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#12-1-%E5%88%9B%E5%BB%BAConfigMap%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="toc-number">1.3.4.1.</span> <span class="toc-text">12.1 创建ConfigMap的方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#12-2-%E9%80%9A%E8%BF%87%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%82%E6%95%B0%E5%88%9B%E5%BB%BA"><span class="toc-number">1.3.4.2.</span> <span class="toc-text">12.2 通过命令行参数创建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#12-3-%E9%80%9A%E8%BF%87%E6%8C%87%E5%AE%9A%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA"><span class="toc-number">1.3.4.3.</span> <span class="toc-text">12.3 通过指定文件创建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#12-4-%E6%8C%87%E5%AE%9A%E7%9B%AE%E5%BD%95%E5%88%9B%E5%BB%BA"><span class="toc-number">1.3.4.4.</span> <span class="toc-text">12.4 指定目录创建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#12-5-%E9%80%9A%E8%BF%87yaml%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA"><span class="toc-number">1.3.4.5.</span> <span class="toc-text">12.5 通过yaml文件创建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#12-6-%E4%BD%BF%E7%94%A8ConfigMap"><span class="toc-number">1.3.4.6.</span> <span class="toc-text">12.6 使用ConfigMap</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#12-6-1-%E9%80%9A%E8%BF%87%E5%8F%98%E9%87%8F%E4%BD%BF%E7%94%A8"><span class="toc-number">1.3.4.6.1.</span> <span class="toc-text">12.6.1 通过变量使用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#12-6-2-%E4%BD%9C%E4%B8%BAvolume%E6%8C%82%E8%BD%BD%E4%BD%BF%E7%94%A8"><span class="toc-number">1.3.4.6.2.</span> <span class="toc-text">12.6.2 作为volume挂载使用</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#12-7-%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B"><span class="toc-number">1.3.4.7.</span> <span class="toc-text">12.7 实战案例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%81%E4%B8%89-Downward-API"><span class="toc-number">1.3.5.</span> <span class="toc-text">十三.Downward API</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#13-1-%E7%9B%AE%E5%89%8D-Downward-API-%E6%94%AF%E6%8C%81%E7%9A%84%E5%AD%97%E6%AE%B5"><span class="toc-number">1.3.5.1.</span> <span class="toc-text">13.1 目前 Downward API 支持的字段</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-2-%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B"><span class="toc-number">1.3.5.2.</span> <span class="toc-text">13.2 实战案例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%81%E5%9B%9B-ServiceAccount%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.3.6.</span> <span class="toc-text">十四.ServiceAccount详解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#14-1-Service-Account%E5%BA%94%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.3.6.1.</span> <span class="toc-text">14.1 Service Account应用示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%81%E4%BA%94-RBAC-%E8%AF%A6%E8%A7%A3-%E5%9F%BA%E4%BA%8E%E8%A7%92%E8%89%B2%E7%9A%84%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6"><span class="toc-number">1.3.7.</span> <span class="toc-text">十五.RBAC 详解(基于角色的访问控制)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#15-1-%E5%88%9B%E5%BB%BAk8s%E8%B4%A6%E5%8F%B7%E4%B8%8ERBAC%E6%8E%88%E6%9D%83%E4%BD%BF%E7%94%A8"><span class="toc-number">1.3.7.1.</span> <span class="toc-text">15.1 创建k8s账号与RBAC授权使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#15-2-%E8%AE%BE%E7%BD%AE%E4%B8%8A%E4%B8%8B%E6%96%87%E5%92%8C%E8%B4%A6%E6%88%B7%E5%88%87%E6%8D%A2"><span class="toc-number">1.3.7.2.</span> <span class="toc-text">15.2 设置上下文和账户切换</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%81%E5%85%AD-Deployment-%E8%B5%84%E6%BA%90%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.3.8.</span> <span class="toc-text">十六.Deployment 资源详解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#16-1-deployment-%E5%AE%9E%E4%BE%8B"><span class="toc-number">1.3.8.1.</span> <span class="toc-text">16.1 deployment 实例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#16-2-%E6%96%87%E4%BB%B6%E8%AF%B4%E6%98%8E"><span class="toc-number">1.3.8.2.</span> <span class="toc-text">16.2 文件说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#16-3-deployment%E5%8F%AF%E7%94%A8%E5%AD%97%E6%AE%B5"><span class="toc-number">1.3.8.3.</span> <span class="toc-text">16.3 deployment可用字段</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%81%E4%B8%83-Service-%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.3.9.</span> <span class="toc-text">十七.Service 服务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#17-1-%E5%88%9B%E5%BB%BAservice"><span class="toc-number">1.3.9.1.</span> <span class="toc-text">17.1 创建service</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#17-2-%E9%A1%B5%E9%9D%A2%E8%AF%B7%E6%B1%82%E6%B5%8B%E8%AF%95"><span class="toc-number">1.3.9.2.</span> <span class="toc-text">17.2 页面请求测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#17-3-pod%E5%86%85%E9%83%A8%E8%AF%B7%E6%B1%82%E6%B5%8B%E8%AF%95"><span class="toc-number">1.3.9.3.</span> <span class="toc-text">17.3 pod内部请求测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#17-4-%E7%AB%AF%E5%8F%A3%E8%A7%A3%E6%9E%90"><span class="toc-number">1.3.9.4.</span> <span class="toc-text">17.4 端口解析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#17-5-kube-proxy-%E4%BD%BF%E7%94%A8ipvs"><span class="toc-number">1.3.9.5.</span> <span class="toc-text">17.5 kube-proxy 使用ipvs</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%81%E5%85%AB-k8s%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2"><span class="toc-number">1.3.10.</span> <span class="toc-text">十八.k8s服务暴露</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#18-1-ClusterIP"><span class="toc-number">1.3.10.1.</span> <span class="toc-text">18.1 ClusterIP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#18-2-NodePort"><span class="toc-number">1.3.10.2.</span> <span class="toc-text">18.2 NodePort</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#18-3-loadbalance"><span class="toc-number">1.3.10.3.</span> <span class="toc-text">18.3 loadbalance</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#18-4-Ingress"><span class="toc-number">1.3.10.4.</span> <span class="toc-text">18.4 Ingress</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%81%E4%B9%9D-Ingress-%E6%9A%B4%E9%9C%B2%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.3.11.</span> <span class="toc-text">十九.Ingress 暴露服务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#19-1-ingress%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.3.11.1.</span> <span class="toc-text">19.1 ingress详解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#19-2-%E5%A6%82%E4%BD%95%E5%88%9B%E5%BB%BA-Ingress-%E8%B5%84%E6%BA%90"><span class="toc-number">1.3.11.2.</span> <span class="toc-text">19.2 如何创建 Ingress 资源</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#19-3-%E9%83%A8%E7%BD%B2-Ingress-%E6%8E%A7%E5%88%B6%E5%99%A8%EF%BC%88Nginx%EF%BC%89"><span class="toc-number">1.3.11.3.</span> <span class="toc-text">19.3 部署 Ingress 控制器（Nginx）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#19-3-1-%E4%B8%8B%E8%BD%BDingress-controller"><span class="toc-number">1.3.11.3.1.</span> <span class="toc-text">19.3.1 下载ingress controller</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#19-3-2-%E5%88%9B%E5%BB%BAingress-controller"><span class="toc-number">1.3.11.3.2.</span> <span class="toc-text">19.3.2 创建ingress-controller</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#19-3-3-%E4%BF%AE%E6%94%B9ingress%E8%BD%AC%E5%8F%91%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.3.11.3.3.</span> <span class="toc-text">19.3.3 修改ingress转发类型</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E5%8D%81-%E4%BC%81%E4%B8%9A%E7%BA%A7%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93Harbor"><span class="toc-number">1.3.12.</span> <span class="toc-text">二十.企业级镜像仓库Harbor</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#20-1-%E4%B8%8A%E4%BC%A0harbor%E5%AE%89%E8%A3%85%E5%8C%85%E5%B9%B6%E5%AE%89%E8%A3%85"><span class="toc-number">1.3.12.1.</span> <span class="toc-text">20.1 上传harbor安装包并安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#20-2-%E6%B5%8F%E8%A7%88%E5%99%A8%E8%AE%BF%E9%97%AE"><span class="toc-number">1.3.12.2.</span> <span class="toc-text">20.2 浏览器访问</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#20-3-k8s%E4%BD%BF%E7%94%A8harbor%E4%BB%93%E5%BA%93"><span class="toc-number">1.3.12.3.</span> <span class="toc-text">20.3 k8s使用harbor仓库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#20-4-%E4%B8%8A%E4%BC%A0%E9%95%9C%E5%83%8F%E5%88%B0%E4%BB%93%E5%BA%93"><span class="toc-number">1.3.12.4.</span> <span class="toc-text">20.4 上传镜像到仓库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#20-5-%E5%88%9B%E5%BB%BAsecret-yaml%E6%96%87%E4%BB%B6"><span class="toc-number">1.3.12.5.</span> <span class="toc-text">20.5 创建secret.yaml文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#20-6-k8s-pod-%E4%BD%BF%E7%94%A8%E9%95%9C%E5%83%8F"><span class="toc-number">1.3.12.6.</span> <span class="toc-text">20.6 k8s-pod 使用镜像</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E5%8D%81%E4%B8%80-%E6%B0%B4%E5%B9%B3%E6%89%A9%E5%B1%95-%E6%94%B6%E7%BC%A9%E4%B8%8E%E6%BB%9A%E5%8A%A8%E6%9B%B4%E6%96%B0"><span class="toc-number">1.3.13.</span> <span class="toc-text">二十一.水平扩展&#x2F;收缩与滚动更新</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#21-1-%E6%B0%B4%E5%B9%B3%E6%89%A9%E5%B1%95-%E6%94%B6%E7%BC%A9"><span class="toc-number">1.3.13.1.</span> <span class="toc-text">21.1 水平扩展&#x2F;收缩</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#21-1-1-%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AAdeployment"><span class="toc-number">1.3.13.1.1.</span> <span class="toc-text">21.1.1 创建一个deployment</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#21-1-2-%E9%80%9A%E8%BF%87%E5%A3%B0%E6%98%8E%E6%96%B9%E5%BC%8F%E6%89%A9%E5%B1%95"><span class="toc-number">1.3.13.1.2.</span> <span class="toc-text">21.1.2 通过声明方式扩展</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#21-1-3-%E9%80%9A%E8%BF%87edit%E6%96%B9%E5%BC%8F%E6%94%B6%E7%BC%A9"><span class="toc-number">1.3.13.1.3.</span> <span class="toc-text">21.1.3 通过edit方式收缩</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#21-2-%E6%BB%9A%E5%8A%A8%E6%9B%B4%E6%96%B0"><span class="toc-number">1.3.13.2.</span> <span class="toc-text">21.2 滚动更新</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#21-2-1-%E8%BF%9B%E8%A1%8C%E7%89%88%E6%9C%AC%E7%9A%84%E5%8D%87%E7%BA%A7"><span class="toc-number">1.3.13.2.1.</span> <span class="toc-text">21.2.1 进行版本的升级</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#21-2-2-%E9%AA%8C%E8%AF%81"><span class="toc-number">1.3.13.2.2.</span> <span class="toc-text">21.2.2 验证</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#21-2-3-%E6%BB%9A%E5%8A%A8%E6%9B%B4%E6%96%B0%E7%9A%84%E5%A5%BD%E5%A4%84"><span class="toc-number">1.3.13.2.3.</span> <span class="toc-text">21.2.3 滚动更新的好处</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#21-3-%E7%89%88%E6%9C%AC%E5%9B%9E%E6%BB%9A"><span class="toc-number">1.3.13.3.</span> <span class="toc-text">21.3 版本回滚</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#21-3-1-%E6%9F%A5%E7%9C%8B%E7%89%88%E6%9C%AC%E5%8E%86%E5%8F%B2"><span class="toc-number">1.3.13.3.1.</span> <span class="toc-text">21.3.1 查看版本历史</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#21-3-2-%E5%9B%9E%E6%BB%9A%E5%88%B0%E4%BB%A5%E5%89%8D%E7%9A%84%E6%97%A7%E7%89%88%E6%9C%AC%EF%BC%9A"><span class="toc-number">1.3.13.3.2.</span> <span class="toc-text">21.3.2 回滚到以前的旧版本：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#21-3-3-%E5%9B%9E%E6%BB%9A%E5%88%B0%E6%9B%B4%E6%97%A9%E4%B9%8B%E5%89%8D%E7%9A%84%E7%89%88%E6%9C%AC"><span class="toc-number">1.3.13.3.3.</span> <span class="toc-text">21.3.3 回滚到更早之前的版本</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E5%8D%81%E4%BA%8C-DeamonSet%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.3.14.</span> <span class="toc-text">二十二.DeamonSet详解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#22-1-%E4%BD%95%E4%B8%BADaemonSet"><span class="toc-number">1.3.14.1.</span> <span class="toc-text">22.1 何为DaemonSet</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#22-2-DaemonSet-%E7%9A%84-API-%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%AE%9A%E4%B9%89"><span class="toc-number">1.3.14.2.</span> <span class="toc-text">22.2 DaemonSet 的 API 对象的定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#22-3-DaemonSet%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.3.14.3.</span> <span class="toc-text">22.3 DaemonSet实践</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#22-3-1-%E5%88%9B%E5%BB%BA-DaemonSet-%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.3.14.3.1.</span> <span class="toc-text">22.3.1 创建 DaemonSet 对象</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#22-3-2-%E6%9F%A5%E7%9C%8B-DaemonSet-%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.3.14.3.2.</span> <span class="toc-text">22.3.2 查看 DaemonSet 对象</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#22-3-3-DaemonSet-%E7%89%88%E6%9C%AC%E7%AE%A1%E7%90%86"><span class="toc-number">1.3.14.3.3.</span> <span class="toc-text">22.3.3 DaemonSet 版本管理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#22-3-4-DaemonSet-%E7%9A%84%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F%E7%89%88%E6%9C%AC%E5%88%B0-v2-2-0"><span class="toc-number">1.3.14.3.4.</span> <span class="toc-text">22.3.4 DaemonSet 的容器镜像版本到 v2.2.0</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E5%8D%81%E4%B8%89-%E7%A6%BB%E7%BA%BF%E4%B8%9A%E5%8A%A1%E7%BC%96%E6%8E%92%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.3.15.</span> <span class="toc-text">二十三.离线业务编排详解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#23-1-%E5%9C%A8%E7%BA%BF%E4%B8%9A%E5%8A%A1%E5%92%8C%E7%A6%BB%E7%BA%BF%E4%B8%9A%E5%8A%A1"><span class="toc-number">1.3.15.1.</span> <span class="toc-text">23.1 在线业务和离线业务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#23-2-Job%E8%A7%A3%E6%9E%90"><span class="toc-number">1.3.15.2.</span> <span class="toc-text">23.2 Job解析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#23-3-%E8%BF%90%E8%A1%8C%E7%A8%8B%E5%BA%8F"><span class="toc-number">1.3.15.3.</span> <span class="toc-text">23.3 运行程序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#23-4-%E5%88%9B%E5%BB%BAJob"><span class="toc-number">1.3.15.4.</span> <span class="toc-text">23.4 创建Job</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#23-5-%E5%B9%B6%E8%A1%8C%E4%BD%9C%E4%B8%9A"><span class="toc-number">1.3.15.5.</span> <span class="toc-text">23.5 并行作业</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#23-6-Job%E6%8E%A7%E5%88%B6%E5%99%A8CronJob"><span class="toc-number">1.3.15.6.</span> <span class="toc-text">23.6 Job控制器CronJob</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E5%8D%81%E5%9B%9B-k8s%E4%B9%8B%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8pv-pvc"><span class="toc-number">1.3.16.</span> <span class="toc-text">二十四.k8s之共享存储pv&amp;pvc</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#24-1-%E5%AD%98%E5%82%A8%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86"><span class="toc-number">1.3.16.1.</span> <span class="toc-text">24.1 存储资源管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#24-2-%E6%8C%81%E4%B9%85%E5%8D%B7pv%E7%9A%84%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.3.16.2.</span> <span class="toc-text">24.2 持久卷pv的类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#24-5-%E5%AE%9E%E9%AA%8Cmysql%E5%9F%BA%E4%BA%8ENFS%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E5%AE%9E%E7%8E%B0%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8"><span class="toc-number">1.3.16.3.</span> <span class="toc-text">24.5 实验mysql基于NFS共享存储实现持久化存储</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#24-5-1-%E5%AE%89%E8%A3%85NFS"><span class="toc-number">1.3.16.3.1.</span> <span class="toc-text">24.5.1 安装NFS</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#24-5-2-PV%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.3.16.3.2.</span> <span class="toc-text">24.5.2 PV参数详解</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#24-5-3-%E5%88%9B%E5%BB%BApv"><span class="toc-number">1.3.16.3.3.</span> <span class="toc-text">24.5.3 创建pv</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#24-5-4-mysql%E4%BD%BF%E7%94%A8pvc%E6%8C%81%E4%B9%85%E5%8D%B7"><span class="toc-number">1.3.16.3.4.</span> <span class="toc-text">24.5.4 mysql使用pvc持久卷</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#24-6-%E5%8A%A8%E6%80%81%E7%BB%91%E5%AE%9Apv"><span class="toc-number">1.3.16.4.</span> <span class="toc-text">24.6 动态绑定pv</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#24-6-1-%E9%85%8D%E7%BD%AEnfs-provisioner%E6%8E%88%E6%9D%83"><span class="toc-number">1.3.16.4.1.</span> <span class="toc-text">24.6.1 配置nfs-provisioner授权</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#24-6-2-%E9%83%A8%E7%BD%B2nfs-client-provisioner"><span class="toc-number">1.3.16.4.2.</span> <span class="toc-text">24.6.2 部署nfs-client-provisioner</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#24-6-3-%E5%88%9B%E5%BB%BAStorageClass"><span class="toc-number">1.3.16.4.3.</span> <span class="toc-text">24.6.3 创建StorageClass</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#24-6-4-deployment-%E5%8A%A8%E6%80%81%E6%8C%82%E8%BD%BD"><span class="toc-number">1.3.16.4.4.</span> <span class="toc-text">24.6.4 deployment 动态挂载</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#24-6-5-statefulset-%E5%8A%A8%E6%80%81%E6%8C%82%E8%BD%BD"><span class="toc-number">1.3.16.4.5.</span> <span class="toc-text">24.6.5 statefulset 动态挂载</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E5%8D%81%E4%BA%94-StatefulSet%E6%9C%89%E7%8A%B6%E6%80%81%E7%9A%84%E5%BA%94%E7%94%A8"><span class="toc-number">1.3.17.</span> <span class="toc-text">二十五.StatefulSet有状态的应用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#25-1-StatefulSet%E5%AE%9E%E7%8E%B0Pod%E7%9A%84%E5%AD%98%E5%82%A8%E7%8A%B6%E6%80%81"><span class="toc-number">1.3.17.1.</span> <span class="toc-text">25.1 StatefulSet实现Pod的存储状态</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#25-2-StatefulSet-%E7%9A%84%E5%BA%94%E7%94%A8%E7%89%B9%E7%82%B9"><span class="toc-number">1.3.17.2.</span> <span class="toc-text">25.2 StatefulSet 的应用特点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#25-3-%E5%AE%9E%E6%88%981-%E9%80%9A%E8%BF%87StatefulSet%E5%88%9B%E5%BB%BAnginx"><span class="toc-number">1.3.17.3.</span> <span class="toc-text">25.3 实战1-通过StatefulSet创建nginx</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#25-3-1-%E9%A1%BA%E5%BA%8F%E5%88%9B%E5%BB%BA-Pod"><span class="toc-number">1.3.17.3.1.</span> <span class="toc-text">25.3.1 顺序创建 Pod</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#25-3-2-%E4%BD%BF%E7%94%A8%E7%A8%B3%E5%AE%9A%E7%9A%84%E7%BD%91%E7%BB%9C%E8%BA%AB%E4%BB%BD%E6%A0%87%E8%AF%86"><span class="toc-number">1.3.17.3.2.</span> <span class="toc-text">25.3.2 使用稳定的网络身份标识</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#25-3-3-%E6%9F%A5%E7%9C%8Bstatefulset%E5%88%9B%E5%BB%BA%E7%9A%84pod%E7%9A%84%E5%AD%98%E5%82%A8"><span class="toc-number">1.3.17.3.3.</span> <span class="toc-text">25.3.3 查看statefulset创建的pod的存储</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#25-3-4-%E8%AF%B4%E6%98%8E"><span class="toc-number">1.3.17.3.4.</span> <span class="toc-text">25.3.4 说明</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#25-3-5-%E6%89%A9%E5%AE%B9-%E7%BC%A9%E5%AE%B9-StatefulSet"><span class="toc-number">1.3.17.3.5.</span> <span class="toc-text">25.3.5 扩容&#x2F;缩容 StatefulSet</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#25-4-%E5%AE%9E%E6%88%982-%E9%80%9A%E8%BF%87StatefulSet%E6%9D%A5%E7%AE%A1%E7%90%86%E6%9C%89%E7%8A%B6%E6%80%81%E7%9A%84%E6%9C%8D%E5%8A%A1msyql"><span class="toc-number">1.3.17.4.</span> <span class="toc-text">25.4 实战2-通过StatefulSet来管理有状态的服务msyql</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#25-5-k8s%E4%B8%AD%E6%97%A0%E7%8A%B6%E6%80%81%E6%9C%8D%E5%8A%A1%E5%92%8C%E6%9C%89%E7%8A%B6%E6%80%81%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2%E7%9A%84%E5%8C%BA%E5%88%AB%EF%BC%9F"><span class="toc-number">1.3.17.5.</span> <span class="toc-text">25.5 k8s中无状态服务和有状态服务部署的区别？</span></a></li></ol></li></ol></li></ol></li></ol>
      </div>
      
        <div class="catelogue catelogue-2">
          
            <p>
              <span>上一篇：</span>
              <a href="/2024/06/10/二进制方式部署k8s集群/">Kubernetes集群部署</a>
            </p>
           
          
            <p>
              <span>下一篇</span>
              <a href="/2024/06/01/Kubernetes容器编排技术[扩展]/">Kubernetes扩展</a>
            </p>
          
        </div>
      
    </div>
  </div>
</div>


<script>
  // var定义，避免pjax重新进来造成的重复声明错误
  var config = JSON.parse('{"enable":true,"appId":"Pf8zCXGEH1qsprnWfikVVujL-gzGzoHsz","appKey":"qOqoiUHhH1TGtLRUYURkLRQX","placeholder":"请留下你宝贵的意见吧~","meta":["nick"],"recordIP":true,"visitor":true,"enableQQ":true}')
  new Valine({
    el: '#vcomments',
    appId: config.appId,
    appKey: config.appKey,
    placeholder: config.placeholder,
    meta: config.meta,
    recordIP: config.recordIP,
    visitor: config.visitor,
    enableQQ: config.enableQQ,
    path: '2024/06/02/Kubernetes组件/'
  })
</script>


<script>
  $(document).on('pjax:complete', function() {
    const tocs = document.querySelector('.toc')
    const links = tocs ? tocs.querySelectorAll('a') : []
    links.forEach(link => {
      link.addEventListener('click', e => {
        const href = decodeURIComponent(e.href)
        href.search(/#(.*)/)
        const id = RegExp.$1
        const target = document.querySelector('#' + id)
        const top = target.offsetTop
        document.documentElement.scrollTo({
          top: top - 100,
          behavior: 'smooth'
        })
        e.preventDefault()
      })
    })
  })
</script> 

</div>
      <div class="main-right-wrapper"><div class="main-right">
  <div class="main-right--board">
    <div class="main-right--title">
      <h5>公告栏</h5>
      <i class="iconfont icon-gonggao"></i>
    </div>
    <div class="main-right--content">
      Hello~大噶好。唔系小曹宅，欢迎你们来到我的博客小站，希望能在这里收获到有用的东西哦！ 
    </div>
  </div>

  <div id="aplayer" class="main-right--music"></div>

  <div class="operate-items">
    <div class="operate-item backtop">
      <i class="iconfont icon-huidaodingbu"></i>
      <span>回到顶部</span>
    </div>
    
    <div class="operate-item turn-comment hidden">
      <i class="iconfont icon-pinglun"></i>
      <span>查看评论</span>
    </div>
    
  </div>

  <div class="main-right--site">
    <div class="main-right--power">
      <p>Power By <a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/docs/">Hexo</a>.</p>
      <p>Theme：<a target="_blank" rel="noopener" href="https://github.com/Aizener/hexo-theme-cola">Cola.</a></p>
    </div>
    <p class="main-right--refer"><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/#/Integrated/index">2262690094</a> </p>
  </div>
</div>

<script>
  function setOperateItem () {
    const reg = /\d{4}\/\d{2}\/\d{2}\/.+/
    const path = location.pathname
    const operateDom = document.querySelector('.main-right .operate-items')
    const commentDom = document.querySelector('.turn-comment')
    const cateloguDom = document.querySelector('.article-catelogue > .article-catelogue--wrapper');

    if (commentDom) {
      if (reg.test(path) || path.match(/\/log\/.+/)) {
        commentDom.classList.remove('hidden')
        const newDom = operateDom.cloneNode(true);
        const _backtopDom = newDom.querySelector('.backtop');
        const _commentDom = newDom.querySelector('.turn-comment');
        _backtopDom.addEventListener('click', () => backTopEvent());
        _commentDom.addEventListener('click', () => commentDomEvent());
        cateloguDom.appendChild(newDom);
      } else {
        commentDom.classList.add('hidden')
      }
    }
  }

  setOperateItem()
  const musics = JSON.parse(`[{"name":"不找了","artist":"隔壁老樊","url":"music/隔壁老樊 - 不找了.mp3","cover":"https://img2.baidu.com/it/u=1260056724,1076343118&fm=253&fmt=auto&app=138&f=JPEG?w=500&h=500"},{"name":"于是天气刚好","artist":"泪桥","url":"music/于是天气刚好 - 泪桥.mp3","cover":"https://img2.baidu.com/it/u=705831265,2862720033&fm=253&fmt=auto&app=138&f=JPEG?w=500&h=500"},{"name":"安和桥","artist":"林芬宇","url":"music/林芬宇 - 安和桥.mp3","cover":"https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQo0SWQx6YrNA8lElaG4OOKLkNkNzLO1PflKg&usqp=CAU"}]`)
  const ap = new APlayer({
    container: document.querySelector('#aplayer'),
    audio: musics,
  })

  $(document).on('pjax:complete', function() {
    setOperateItem()
  })

  document.querySelector('.backtop').addEventListener('click', () => {
    backTopEvent();
  })
  const dom = document.querySelector('.turn-comment')
  dom && dom.addEventListener('click', () => {
    commentDomEvent();
  })

  function backTopEvent() {
    document.documentElement.scrollTo({
      top: 0,
      behavior: 'smooth'
    })
  }

  function commentDomEvent() {
    const commentDom = document.querySelector('.comments-intro')
    if (!commentDom) return
    const top = commentDom.offsetTop, height = commentDom.offsetHeight
    document.documentElement.scrollTo({
      top: top - 2 * height,
      behavior: 'smooth'
    })
  }
</script></div>
    </section>
  </div>
  <div id="progress" class="progress"></div>
  <div id="gray" class="gray"></div>

  <script>
    function initScroll () {
      document.addEventListener('scroll', () => {
        const doc = document.documentElement
        const scrollTop = doc.scrollTop
        const pageHeight = doc.offsetHeight
        const clientHeight = doc.clientHeight
        const ratio = scrollTop / (pageHeight - clientHeight)
        const progress = document.querySelector('#progress')
        const avatarImg = document.querySelector('.main-left--avatar')
        progress.style.width = (100 * ratio) + '%'
        avatarImg.style.transform = `rotate(${360 * ratio}deg)`
      })
    }

    const rootPath = "/"

    const checkAndSetArticlePageLayout = () => {
      const path = location.pathname.replace(rootPath, '');
      if (
        /^\/?\d{4}\/\d{2}\/\d{2}\/.*/.test(path) ||
        /^log\/.+/.test(path)
      ) {
        $('.main-container, .main-right, .main-right-wrapper').addClass('is-article')
      } else {
        $('.main-container, .main-right, .main-right-wrapper').removeClass('is-article')
      }
    }

    const gray = "none"
    const setGrayStyle = () => {
      if (gray === 'none') {
        return
      } else if (gray === 'index') {
        location.pathname === '/' ? $('#gray').show() : $('#gray').hide()
      } else if (gray === 'all') {
        $('#gray').show()
      }
    }
    setGrayStyle()


    window.onload = function () {
      checkAndSetArticlePageLayout()
      setTimeout(() => {
        $('#load').slideUp()
        $('#container').slideToggle()
        setTimeout(() => {
          initScroll();
        }, 500)
      }, 500)
    }
    
    let status = 0
    // 对所有链接跳转事件绑定pjax容器container
    $(document).pjax('a[target!=_blank]', '#main-container', {
      container: '#main-container',
      fragment: '#main-container',
      timeout: 8000
    })

    $(document).on('pjax:start', function() {
    })
    $(document).on('pjax:complete', function() {
      status = 0
      $('.main-container').addClass('to-up').on('animationend', function() {
        $(this).removeClass('to-up')
      })
      setGrayStyle()
      checkAndSetArticlePageLayout()
    })
    $(document).on('pjax:popstate', function() {
      status = -1
      checkAndSetArticlePageLayout()
    });
  </script>
</body>
</html>