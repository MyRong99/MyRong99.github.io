<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>我的技术与生活——小站首页 | Mr.Long</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="shortcut icon" href="/imgs/shortcut-icon.ico" type="image/x-icon">
  <link rel="stylesheet" href="/css/public.css" />
  <link rel="stylesheet" href="/css/layout.css" />
  <link rel="stylesheet" href="/css/iconfont.css" />
  <link rel="stylesheet" href="/css/APlayer.min.css" />
  <script src="/js/APlayer.min.js"></script>
  <script src="/js/jquery.min.js"></script>
  <script src="/js/jquery.pjax.min.js"></script>

  <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
  <script>
    document.title = `我的技术与生活——小站首页`
  </script>
<meta name="generator" content="Hexo 7.3.0"></head>

<style>
  .load {
    width: 100%;
    height: 100vh;
    background-color: rgb(37, 35, 40);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    position: relative;
    z-index: 9999;
  }
  .load-circle {
    width: 80px;
    height: 80px;
    border: 8px solid orange;
    border-bottom-color: transparent;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    animation: rotate 1s linear infinite;
    filter: drop-shadow(0 0 3px orange);
  }
  .load-circle-inner {
    width: 40px;
    height: 40px;
    border: 8px solid orange;
    border-top-color: transparent;
    border-radius: 50%;
    animation: rotate-reverse .5s linear infinite;
  }
  .load-text {
    margin-top: 20px;
    font-size: 24px;
    color: orange;
    display: flex;
  }
  .load-text span {
    margin: 0 5px;
    text-shadow: 5px 5px 5px orange;
    animation: move 1s linear infinite;
  }
  .load-text span:nth-child(1) {
    animation-delay: -0.6s;
  }
  .load-text span:nth-child(2) {
    animation-delay: -0.5s;
  }
  .load-text span:nth-child(3) {
    animation-delay: -0.4s;
  }
  .load-text span:nth-child(4) {
    animation-delay: -0.3s;
  }
  .load-text span:nth-child(5) {
    animation-delay: -0.2s;
  }
  .load-text span:nth-child(6) {
    animation-delay: -0.1s;
  }
  @keyframes rotate {
    0% { transform: rotate(0); }
    100% { transform: rotate(360deg); }
  }
  @keyframes rotate-reverse {
    0% { transform: rotate(0); }
    100% { transform: rotate(-360deg); }
  }
  @keyframes move {
    0% { transform: translateY(0%) rotate(0) scale(1); }
    20% { transform: translateY(20%) rotate(10deg) scale(1.2); }
    80% { transform: translateY(-10%) rotate(-20deg) scale(.8);}
    100% { transform: translateY(0) rotate(0) scale(1); }
  }

  .progress {
    position: fixed;
    left: 0; top: 0;
    width: 0;
    height: 3px;
    background-color: green;
    transition: all cubic-bezier(0.215, 0.610, 0.355, 1) .1s;
    z-index: 9999;
  }

  .to-up {
    animation: toUp .5s 1;
  }
  .gray {
    position: fixed;
    left: 0;
    top: 0;
    width: 100%;
    height: 100vh;
    z-index: 9999;
    display: none;
    pointer-events: none;
    background-color: #000;
    mix-blend-mode: color;
  }
  @keyframes toUp {
    from { transform: translateY(15px); opacity: 0; }
    to { transform: translateY(0) ; opacity: 1; }
  }
</style>
<body>
  <div id="load" class="load">
    <div class="load-circle">
      <div class="load-circle-inner"></div>
    </div>
    <p class="load-text">
      <span>L</span>
      <span>O</span>
      <span>A</span>
      <span>D</span>
      <span>I</span>
      <span>N</span>
      <span>G</span>
    </p>
  </div>
  <div id="container" class="container w-100 vh-100" style="display: none;">
    <header class="header">
  <div class="header-wrapper">
    <div class="header-left">
      <div class="header-search">
        <input id="search-input" type="text" class="header-search--input" placeholder="请输入要检索的文章标题" />
        <span id="search-btn" class="header-search--icon"><i class="iconfont icon-sousuo"></i></span>
      </div>
      <div id="search-layer" class="header-search--layer hidden">
        <p class="title">
          <span>以下是搜索内容：</span>
          <span id="close-layer-btn">关闭</span>
        </p>
        <ul>
        </ul>
      </div>
    </div>
    <div class="header-right">
      <ul class="header-menu">
        <li>
          <a href="http://example.com/">
            <i class="header-menu--icon iconfont icon-shouye"></i>
            <span class="header-menu--span">首页</span>
          </a>
        </li>
        <li>
          <a href="http://example.com/log">
            <i class="header-menu--icon iconfont icon-rizhi"></i>
            <span class="header-menu--span">日志</span>
          </a>
        </li>
        <li>
          <a href="http://example.com/link">
            <i class="header-menu--icon iconfont icon-youqinglianjie"></i>
            <span class="header-menu--span">友情链接</span>
          </a>
        </li>
        <li>
          <a href="http://example.com/about">
            <i class="header-menu--icon iconfont icon-guanyuwomen"></i>
            <span class="header-menu--span">关于我</span>
          </a>
        </li>
      </ul>
    </div>
  </div>
</header>

<script>
  const ipt = document.querySelector('#search-input')
  const btn = document.querySelector('#search-btn')
  const layer = document.querySelector('#search-layer')
  const posts = JSON.parse(`[{"title":"LVM逻辑卷管理","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/d733537fd3e06784932826b5e82a855d","path":"2023/06/28/LVM逻辑卷管理 /"},{"title":"docker命令","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/71e27d1e01da8c13f3f165a1c3bcc8b571e27d1e01da8c13f3f165a1c3bcc8b5","path":"2024/03/21/Docker命令大全/"},{"title":"LV移除、缩容","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/d733537fd3e06784932826b5e82a855d","path":"2023/06/14/LV逻辑卷扩展/"},{"title":"PXE+Kickstart无人值守安装操作系统","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/82cb48f718f8acc8cb2568140eeaaec382cb48f718f8acc8cb2568140eeaaec3","path":"2023/06/26/PXE+Kickstart无人值守安装操作系统/"},{"title":"python三","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/15096963228077376","path":"2024/02/25/Python 3/"},{"title":"python四","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/15096963228077376","path":"2024/03/01/Python 4/"},{"title":"python二","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/15096963228077376","path":"2024/02/21/Python 2/"},{"title":"ansible模块","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/1e624a7ba7e09f195b3f2f384b2b9bb1","path":"2023/08/17/ansible 模块扩展/"},{"title":"TCP协议","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/15047394039467328","path":"2023/06/23/TCP协议/"},{"title":"docker容器","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/71e27d1e01da8c13f3f165a1c3bcc8b571e27d1e01da8c13f3f165a1c3bcc8b5","path":"2024/03/11/docker容器/"},{"title":"FTP文件服务器","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/a9045286aa9b50dcc09302eff83b328a","path":"2023/06/23/ftp/"},{"title":"用户文件权限","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/3719037aa1a43c4806d84ac9bd3dbc34","path":"2023/06/01/文件权限/"},{"title":"单用户模式破解密码","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/3f6ae566e1f093d2d9dbcc3df361fc4b3f6ae566e1f093d2d9dbcc3df361fc4b","path":"2023/07/01/破解密码/"},{"title":"linux文件管理","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/de0f7b079a80d192f90989d9c2c9622d","path":"2023/06/21/文件管理/"},{"title":"磁盘阵列","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/69d9906ff9bf88dbc02184ecb8504fc5","path":"2023/07/09/磁盘阵列RAID/"},{"title":"存储管理--1","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/d733537fd3e06784932826b5e82a855d","path":"2023/06/25/磁盘存储管理1/"},{"title":"shell编程","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/9217d5c6d87ce0e8ec7422ca7469db95","path":"2023/07/21/shell_newrain/"},{"title":"自建YUM源","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/56260873f5720f373c20f43587eab0b8","path":"2023/06/21/自建yum源笔记/"},{"title":"Linux网卡","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/346f59e468f2155074d1fb3164594702","path":"2023/06/11/网络管理基础/"},{"title":"走进网络世界","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/583716b0cb306203c308cc0def55dd9e583716b0cb306203c308cc0def55dd9e","path":"2023/06/16/走进网络世界/"},{"title":"python一","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/15096963228077376","path":"2024/02/20/Python 1 /"},{"title":"","path":"2024/09/01/PromQL 讲解/"},{"title":"","path":"2024/09/01/galera/"},{"title":"","path":"2024/09/01/nginx2/"},{"title":"","path":"2024/09/01/nginx1/"},{"title":"","path":"2024/09/01/nnginx5/"},{"title":"","path":"2024/09/01/redis集群/"},{"title":"","path":"2024/09/01/prometheus 监控/"},{"title":"","path":"2024/09/01/shell脚本/"},{"title":"","path":"2024/09/01/node_exporter/"},{"title":"","path":"2024/09/01/容器技术-Docker1/"},{"title":"","path":"2024/09/01/容器技术-docker2/"},{"title":"","path":"2024/09/01/容器技术docker4/"},{"title":"","path":"2024/09/01/容器技术-docker5/"},{"title":"","path":"2024/09/01/微服务概念/"},{"title":"","path":"2024/09/01/自定义监控/"}]`)
  ipt.addEventListener('keyup', e => {
    if (e.key === 'Enter') {
      handleSearch()
    }
  })
  btn.addEventListener('click', () => {
    handleSearch()
  })

  document.querySelector('#close-layer-btn').addEventListener('click', () => {
    layer.classList.toggle('hidden')
  })

  function handleSearch() {
    if (ipt.value.trim() === '') {
      return
    }
    let html = ''
    const targetPosts = posts.filter(post => post.title.includes(ipt.value))
    targetPosts.forEach(post => {
      html += `
        <li>
          <div>
            <a href="/${post.path}">${post.title.replace(new RegExp(ipt.value), `<span>${ipt.value}</span>`)}</a>
          </div>
          <img src="${post.cover || '/imgs/default-cover.webp' }" />
        </li>
      `
    })
    if (html.trim () === '') {
      html += '<p class="empty">没有搜索到内容</p>'
    }
    layer.querySelector('ul').innerHTML = html
    layer.classList.remove('hidden')
  }
</script> 
    <section id="main" class="main">
      <div class="main-left-wrapper">
<div class="main-left">
  <div class="main-left--block">
    <div class="main-left--info">
      <img src="/imgs/avatar.jpg"" class="main-left--avatar" />
      <div class="main-left--intro">
        <p class="main-left--name">Mr.Long</p>
        <div class="main-left--tags">
          <span class="main-left--tag">唱跳rap篮球</span>
          <span class="main-left--tag">宅但不肥</span>
        </div>
      </div>
    </div>
  
    <div>
      <div class="main-left--motto">
        <p>“花有重开日，人无再少年”</p>
        <p>“一个简单普通的男孩”</p>
      </div>
      <div class="main-left--github">
        <span class="line"></span>
        <a target="_blank" rel="noopener" href="https://github.com/MyRong99/MyRong99.github.io"><i class="logo iconfont icon-github-fill"></i></a>
        <span class="line"></span>
      </div>
      <div class="main-left--statics">
        <a href="/categories">
          <div>
            <span>3</span>
            <span>分类</span>
          </div>
        </a>
        <a href="/tags">
          <div>
            <span>4</span>
            <span>标签</span>
          </div>
        </a>
        <a href="/archives">
          <div>
            <span>6 </span>
            <span>归档</span>
          </div>
        </a>
      </div>
    </div>
  </div>

  <div class="main-left--block">
    <ul class="main-left--menu">
      
        <li>
          <a href="/">
            <span class="header-menu--span">小站首页</span>
            <i class="header-menu--icon iconfont icon-shouye"></i>
          </a>
        </li>
      
        <li>
          <a href="/log">
            <span class="header-menu--span">个人日志</span>
            <i class="header-menu--icon iconfont icon-rizhi"></i>
          </a>
        </li>
      
        <li>
          <a href="/link">
            <span class="header-menu--span">友情链接</span>
            <i class="header-menu--icon iconfont icon-youqinglianjie"></i>
          </a>
        </li>
      
        <li>
          <a href="/about">
            <span class="header-menu--span">关于自己</span>
            <i class="header-menu--icon iconfont icon-guanyuwomen"></i>
          </a>
        </li>
      
        <li>
          <a href="/tools">
            <span class="header-menu--span">我的工具</span>
            <i class="header-menu--icon iconfont icon-gongju"></i>
          </a>
        </li>
      
    </ul>
  </div>

  <div class="main-left--block">
    <div class="main-left--site">
      <h5 class="main-left--title">
        <span>站点信息</span>
        <i class="iconfont icon-zhandian"></i>
      </h5>
      <p class="main-left--subtitle">
        <span>文章数目：</span>
        <span>36 篇</span>
      </p>
      <p class="main-left--subtitle">
        <span>最近动态：</span>
        <span>今天</span>
      </p>
      <p class="main-left--subtitle">
        <span>上线时间：</span>
        <span>439天</span>
      </p>
      <p class="main-left--subtitle">
        <span>当前版本：</span>
        <span>v1.0.2</span>
      </p>
    </div>
  </div>
</div></div>
      <div id="main-container" class="main-container">


  <link rel="stylesheet" href="/css/partial/article.css" />

<div class="article-container">
  <div class="article">
    <h1 class="article-title"></h1>
    <div class="article-info">
      <div class="article-info--item">
        <div class="article-info--info">
          
          <div class="article-info--categories">
            <span>分类：</span>
            
          </div>
          
          
          <div class="article-info--tags">
            <span>标签：</span>
            
          </div>
          
          <p class="article-info--date">日期：2024-09-01 17:38:35</p>
        </div>
        <img src="/imgs/default-cover.webp" alt="" class="article-cover">
      </div>
    </div>
    <article class="article-content markdown-body">
      <p>title: nginx2<br>cover: ‘<a target="_blank" rel="noopener" href="https://haowallpaper.com/link/common/file/getCroppingImg/8c29198625ff99eee0073bbbb137bbc78c29198625ff99eee0073bbbb137bbc7">https://haowallpaper.com/link/common/file/getCroppingImg/8c29198625ff99eee0073bbbb137bbc78c29198625ff99eee0073bbbb137bbc7</a>‘<br>author: CAO<br>date: 2023-12-19 22:20:29</p>
<h3 id="9、Nginx-Proxy-代理"><a href="#9、Nginx-Proxy-代理" class="headerlink" title="9、Nginx Proxy 代理"></a>9、Nginx Proxy 代理</h3><h4 id="1、代理原理"><a href="#1、代理原理" class="headerlink" title="1、代理原理"></a>1、代理原理</h4><ul>
<li>反向代理产生的背景：<br>在计算机世界里，由于单个服务器的处理客户端（用户）请求能力有一个极限，当用户的接入请求蜂拥而入时，会造成服务器忙不过来的局面，可以使用多个服务器来共同分担成千上万的用户请求，这些服务器提供相同的服务，对于用户来说，根本感觉不到任何差别。 </li>
<li>反向代理服务的实现：<br>需要有一个负载均衡设备（即反向代理服务器）来分发用户请求，将用户请求分发到空闲的服务器上。<br>服务器返回自己的服务到负载均衡设备。<br>负载均衡设备将服务器的服务返回用户。</li>
</ul>
<p><img src="https://img.beyourself.org.cn/201e2e3c5b472d1d3be85985a00a90018f663ab3.jpg#id=zT2yd&originHeight=456&originWidth=839&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p><img src="https://img.beyourself.org.cn/a75121596263e4334e1849773587797e91f78ef9.jpg#id=C6hQT&originHeight=462&originWidth=818&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<h4 id="2、正-反向代理的区别"><a href="#2、正-反向代理的区别" class="headerlink" title="2、正&#x2F;反向代理的区别"></a>2、正&#x2F;反向代理的区别</h4><p>那么问题来了，很多人这时会问什么是反向代理？为什么叫反向代理？什么是正向代理？我们来举例说明</p>
<ul>
<li>正向代理：<br>举例：贷款<br>正向代理的过程隐藏了真实的请求客户端，服务器不知道真实的客户端是谁，客户端请求的服务都被代理服务器代替请求。我们常说的代理也就是正向代理，正向代理代理的是请求方，也就是客户端；比如我们要访问youtube，可是不能访问，只能先安装个FQ软件代你去访问，通过FQ软件才能访问，FQ软件就叫作正向代理。</li>
</ul>
<p><img src="https://img.beyourself.org.cn/42e98ab38bc9d9c60d9457f3b19082f90605e269.jpg#id=CQcEf&originHeight=428&originWidth=754&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p>FQ软件就是正向代理</p>
<p><img src="https://img.beyourself.org.cn/1b9522aad580e67c4cc21646d6bfef4c95e89752.jpg#id=wgWu4&originHeight=472&originWidth=827&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p>正向代理中，proxy和client同属一个LAN</p>
<p>反向代理：</p>
<p>反向代理的过程隐藏了真实的服务器，客户不知道真正提供服务的人是谁，客户端请求的服务都被代理服务器处理。反向代理代理的是响应方，也就是服务端；我们请求<a target="_blank" rel="noopener" href="http://www.baidu.com时这www.baidu.com就是反向代理服务器,真实提供服务的服务器有很多台,反向代理服务器会把我们的请求分转发到真实提供服务的各台服务器.nginx就是性能非常好的反向代理服务器,用来做负载均衡./">www.baidu.com时这www.baidu.com就是反向代理服务器，真实提供服务的服务器有很多台，反向代理服务器会把我们的请求分转发到真实提供服务的各台服务器。Nginx就是性能非常好的反向代理服务器，用来做负载均衡。</a></p>
<p>访问<a target="_blank" rel="noopener" href="http://www.baidu.com是正向代理的过程/">www.baidu.com是正向代理的过程</a></p>
<p><img src="https://img.beyourself.org.cn/23f7a50104951d8def844dcc04576483f488d127.jpg#id=Z6t2A&originHeight=404&originWidth=615&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p>反向代理中，proxy和server同属一个LAN</p>
<p><img src="https://img.beyourself.org.cn/52e3b4429d6454b427fce0744ef84f447c3d1901.jpg#id=ttNfy&originHeight=335&originWidth=818&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p>正向代理和反向代理对比示意图</p>
<p>两者的区别在于代理的对象不一样：</p>
<p>正向代理中代理的对象是客户端，proxy和client同属一个LAN，对server透明；</p>
<p>反向代理中代理的对象是服务端，proxy和server同属一个LAN，对client透明。</p>
<p><img src="https://img.beyourself.org.cn/512360fdd7b753d0ac8948621a45052d58225526.jpg#id=VEM4Q&originHeight=795&originWidth=630&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<h4 id="3、知识扩展1"><a href="#3、知识扩展1" class="headerlink" title="3、知识扩展1"></a>3、知识扩展1</h4><ol>
<li>没有使用LVS时，客户端请求直接到反向代理Nginx，Nginx分发到各个服务器，服务端响应再由Ngnix返回给客户端，这样请求和响应都经过Ngnix的模式使其性能降低，这时用LVS+Nginx解决。 </li>
<li>LVS+Nginx，客户端请求先由LVS接收，分发给Nginx，再由Nginx转发给服务器，LVS有三种方式：NAT模式（Network Address Translation）网络地址转换，DR模式（直接路由模式），IP隧道模式，路由方式使服务器响应不经过LVS,由Nginx直接返回给客户端。<br><img src="https://img.beyourself.org.cn/0cc862d09926afc2a7482d38138dfe62457c5db4.jpg#id=spSrY&originHeight=542&originWidth=805&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="><br><img src="https://img.beyourself.org.cn/32297ef30f0bf355b402e554f66a70597118c11d.jpg#id=KLcyq&originHeight=575&originWidth=851&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></li>
</ol>
<h4 id="4、知识扩展2"><a href="#4、知识扩展2" class="headerlink" title="4、知识扩展2"></a>4、知识扩展2</h4><ol>
<li>HTTP Server和Application Server的区别和联系<br>Apache&#x2F;nignx是静态服务器（HTTP Server）：<br>Nginx优点：负载均衡、反向代理、处理静态文件优势。nginx处理静态请求的速度高于apache；<br>Apache优点：相对于Tomcat服务器来说处理静态文件是它的优势，速度快。Apache是静态解析，适合静态HTML、图片等。<br>HTTP Server 关心的是 HTTP 协议层面的传输和访问控制，所以在 Apache&#x2F;Nginx 上你可以看到代理、负载均衡等功能<br>HTTP Server（Nginx&#x2F;Apache）常用做静态内容服务和代理服务器，将外来请求转发给后面的应用服务（tomcat，jboss，jetty等）。<br>应用服务器(tomcat&#x2F;jboss&#x2F;jetty)是动态服务器（Application Server）：<br>应用服务器Application Server，则是一个应用执行的容器。它首先需要支持开发语言的 Runtime（对于 Tomcat 来说，就是 Java，若是Ruby&#x2F;Python 等其他语言开发的应用也无法直接运行在 Tomcat 上）。 </li>
<li>但是事无绝对，为了方便，应用服务器(如tomcat)往往也会集成 HTTP Server 的功能，nginx也可以通过模块开发来提供应用功能，只是不如专业的 HTTP Server 那么强大，所以应用服务器往往是运行在 HTTP Server 的背后，执行应用，将动态的内容转化为静态的内容之后，通过 HTTP Server 分发到客户端。 </li>
<li>常用开源集群软件有：lvs，keepalived，haproxy，nginx，git，jenkins，ansible，tomcat，zabbix，rabbitmq，redis，apache，heartbeat<br>常用商业集群硬件有：F5, Netscaler，Radware，A10等</li>
</ol>
<h4 id="5、nginx-Proxy-配置"><a href="#5、nginx-Proxy-配置" class="headerlink" title="5、nginx Proxy 配置"></a>5、nginx Proxy 配置</h4><h5 id="1、代理模块"><a href="#1、代理模块" class="headerlink" title="1、代理模块"></a>1、代理模块</h5><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ngx_http_proxy_module</span></span><br></pre></td></tr></table></figure>

<h5 id="2、代理配置"><a href="#2、代理配置" class="headerlink" title="2、代理配置"></a>2、代理配置</h5><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">代理</span></span><br><span class="line"><span class="attr">Syntax</span>: 	<span class="string">proxy_pass URL;				   #代理的后端服务器URL</span></span><br><span class="line"><span class="attr">Default</span>: 	<span class="string">—</span></span><br><span class="line"><span class="attr">Context</span>: 	<span class="string">location, if in location, limit_except</span></span><br><span class="line"></span><br><span class="line"><span class="attr">缓冲区</span></span><br><span class="line"><span class="attr">Syntax</span>:     <span class="string">proxy_buffering on | off;</span></span><br><span class="line"><span class="attr">Default</span>:    <span class="string">proxy_buffering on;			   #缓冲开关</span></span><br><span class="line"><span class="attr">Context</span>: 	<span class="string">http, server, location</span></span><br><span class="line"><span class="attr">proxy_buffering开启的情况下，nignx会把后端返回的内容先放到缓冲区当中，然后再返回给客户端</span></span><br><span class="line"><span class="attr">（边收边传，不是全部接收完再传给客户端)。</span></span><br><span class="line"><span class="attr">Nginx</span> <span class="string">全局配置中的 tcp_nopush 的作用就是 数据包会累计到一定大小之后才会发送 。而 tcp_nodelay 是尽快发送数据，所以若你启用了 buffer，建议关闭 tcp_nodelay。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Syntax</span>:   <span class="string">proxy_buffer_size size;</span></span><br><span class="line"><span class="attr">Default</span>: 	<span class="string">proxy_buffer_size 4k|8k;	   #缓冲区大小</span></span><br><span class="line"><span class="attr">Context</span>: 	<span class="string">http, server, location</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Syntax</span>: 	<span class="string">proxy_buffers number size;</span></span><br><span class="line"><span class="attr">Default</span>: 	<span class="string">proxy_buffers 4k|8k;		   #缓冲区数量</span></span><br><span class="line"><span class="attr">Context</span>: 	<span class="string">http, server, location</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Syntax</span>:   <span class="string">proxy_busy_buffers_size size;</span></span><br><span class="line"><span class="attr">Default</span>: 	<span class="string">proxy_busy_buffers_size 8k|16k;#忙碌的缓冲区大小控制同时传递给客户端的buffer数量</span></span><br><span class="line"><span class="attr">Context</span>: 	<span class="string">http, server, location</span></span><br><span class="line"></span><br><span class="line"><span class="attr">头信息</span></span><br><span class="line"><span class="attr">Syntax</span>: 	<span class="string">proxy_set_header field value;</span></span><br><span class="line"><span class="attr">Default</span>: 	<span class="string">proxy_set_header Host $proxy_host;		#设置真实客户端地址</span></span><br><span class="line">                <span class="attr">proxy_set_header</span> <span class="string">Connection close;</span></span><br><span class="line"><span class="attr">Context</span>: 	<span class="string">http, server, location</span></span><br><span class="line"></span><br><span class="line"><span class="attr">超时</span></span><br><span class="line"><span class="attr">Syntax</span>: 	<span class="string">proxy_connect_timeout time;</span></span><br><span class="line"><span class="attr">Default</span>: 	<span class="string">proxy_connect_timeout 60s;				#链接超时</span></span><br><span class="line"><span class="attr">Context</span>: 	<span class="string">http, server, location</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Syntax</span>: 	<span class="string">proxy_read_timeout time;</span></span><br><span class="line"><span class="attr">Default</span>: 	<span class="string">proxy_read_timeout 60s;</span></span><br><span class="line"><span class="attr">Context</span>: 	<span class="string">http, server, location</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Syntax</span>: 	<span class="string">proxy_send_timeout time; #nginx进程向fastcgi进程发送request的整个过程的超时时间</span></span><br><span class="line"><span class="attr">Default</span>: 	<span class="string">proxy_send_timeout 60s;</span></span><br><span class="line"><span class="attr">Context</span>: 	<span class="string">http, server, location</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#buffer 工作原理</span></span><br><span class="line"><span class="attr">1.</span> <span class="string">所有的proxy buffer参数是作用到每一个请求的。每一个请求会按照参数的配置获得自己的buffer。proxy buffer不是global而是 request的。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">2.</span> <span class="string">proxy_buffering 是为了开启response buffering of the proxied server，开启后proxy_buffers和proxy_busy_buffers_size参数才会起作用。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">3.</span> <span class="string">无论proxy_buffering是否开启，proxy_buffer_size（main buffer）都是工作的，proxy_buffer_size所设置的buffer_size的作用是用来存储upstream端response的header。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">4.</span> <span class="string">在proxy_buffering 开启的情况下，Nginx将会尽可能的读取所有的upstream端传输的数据到buffer，直到proxy_buffers设置的所有buffer们 被写满或者数据被读取完(EOF)。此时nginx开始向客户端传输数据，会同时传输这一整串buffer们。同时如果response的内容很大的话，Nginx会接收并把他们写入到temp_file里去。大小由proxy_max_temp_file_size控制。如果busy的buffer 传输完了会从temp_file里面接着读数据，直到传输完毕。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">5.</span> <span class="string">一旦proxy_buffers设置的buffer被写入，直到buffer里面的数据被完整的传输完（传输到客户端），这个buffer将会一直处在busy状态，我们不能对这个buffer进行任何别的操作。所有处在busy状态的buffer size加起来不能超过proxy_busy_buffers_size，所以proxy_busy_buffers_size是用来控制同时传输到客户端的buffer数量的。</span></span><br></pre></td></tr></table></figure>

<h5 id="3、启用-nginx-proxy-代理"><a href="#3、启用-nginx-proxy-代理" class="headerlink" title="3、启用 nginx proxy 代理"></a>3、启用 nginx proxy 代理</h5><p>环境两台nginx真实服务器</p>
<p>a、nginx-1 启动网站(内容)（作为网站服务器）</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">nginx-1的ip</span>:<span class="string">10.0.105.199</span></span><br><span class="line"><span class="attr">已经编译安装好，检查nginx是否启动是否可以访问</span></span><br></pre></td></tr></table></figure>

<p>b、nginx-2 启动代理程序</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">nginx-2的ip</span>:<span class="string">10.0.105.202</span></span><br><span class="line"><span class="attr">配置nginx的yum源直接yum安装</span></span><br><span class="line"><span class="attr">启动</span></span><br><span class="line"><span class="attr">编辑nginx的配置文件</span>:<span class="string"></span></span><br><span class="line"><span class="attr">[root@nginx-server</span> <span class="string">~]# vim /etc/nginx/conf.d/default.conf</span></span><br><span class="line"><span class="attr">server</span> <span class="string">&#123;</span></span><br><span class="line">    <span class="attr">server</span> <span class="string">&#123;</span></span><br><span class="line">    <span class="attr">listen</span>       <span class="string">80;</span></span><br><span class="line">    <span class="attr">server_name</span>  <span class="string">localhost;</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">location</span> <span class="string">/ &#123;</span></span><br><span class="line">    <span class="attr">proxy_pass</span> <span class="string">http://10.0.105.199:80;</span></span><br><span class="line">    <span class="attr">proxy_redirect</span> <span class="string">default;</span></span><br><span class="line">    <span class="attr">proxy_set_header</span> <span class="string">Host $http_host;</span></span><br><span class="line">    <span class="attr">proxy_set_header</span> <span class="string">X-Real-IP $remote_addr;</span></span><br><span class="line"><span class="comment">    #proxy_set_header REMOTE-HOST $remote_addr;</span></span><br><span class="line">    <span class="attr">proxy_set_header</span> <span class="string">X-Forwarded-For $proxy_add_x_forwarded_for;</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">proxy_connect_timeout</span> <span class="string">30;</span></span><br><span class="line">    <span class="attr">proxy_send_timeout</span> <span class="string">60;</span></span><br><span class="line">    <span class="attr">proxy_read_timeout</span> <span class="string">60;</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">proxy_buffering</span> <span class="string">on;</span></span><br><span class="line">    <span class="attr">proxy_buffer_size</span> <span class="string">32k;</span></span><br><span class="line">    <span class="attr">proxy_buffers</span> <span class="string">4 128k;</span></span><br><span class="line">    <span class="attr">proxy_busy_buffers_size</span> <span class="string">256k;</span></span><br><span class="line">    <span class="attr">proxy_max_temp_file_size</span> <span class="string">256k;</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"><span class="attr">重新加载nginx配置文件</span></span><br><span class="line"><span class="attr">[root@nginx-server</span> <span class="string">~]# nginx -s reload</span></span><br></pre></td></tr></table></figure>

<p>c、nginx proxy 具体配置详解</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">proxy_pass</span> <span class="string">：真实服务器的地址，可以是ip也可以是域名和url地址</span></span><br><span class="line"><span class="attr">proxy_redirect</span> <span class="string">：如果真实服务器使用的是的真实IP:非默认端口。则改成IP：默认端口。</span></span><br><span class="line"><span class="attr">proxy_set_header：重新定义或者添加发往后端服务器的请求头</span></span><br><span class="line"><span class="attr">proxy_set_header</span> <span class="string">X-Real-IP ：启用客户端真实地址（否则日志中显示的是代理在访问网站）</span></span><br><span class="line"><span class="attr">proxy_set_header</span> <span class="string">X-Forwarded-For：记录代理地址</span></span><br><span class="line"></span><br><span class="line"><span class="attr">proxy_connect_timeout：</span>:<span class="string">后端服务器连接的超时时间发起三次握手等候响应超时时间</span></span><br><span class="line"><span class="attr">proxy_send_timeout：后端服务器数据回传时间就是在规定时间之内后端服务器必须传完所有的数据</span></span><br><span class="line"><span class="attr">proxy_read_timeout</span> <span class="string">：nginx接收upstream（上游/真实） server数据超时, 默认60s, 如果连续的60s内没有收到1个字节, 连接关闭。像长连接</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">proxy_buffering</span> <span class="string">on;开启缓存</span></span><br><span class="line"><span class="attr">proxy_buffer_size：proxy_buffer_size只是响应头的缓冲区</span></span><br><span class="line"><span class="attr">proxy_buffers</span> <span class="string">4 128k; 内容缓冲区域大小</span></span><br><span class="line"><span class="attr">proxy_busy_buffers_size</span> <span class="string">256k; 从proxy_buffers划出一部分缓冲区来专门向客户端传送数据的地方</span></span><br><span class="line"><span class="attr">proxy_max_temp_file_size</span> <span class="string">256k;超大的响应头存储成文件。</span></span><br></pre></td></tr></table></figure>

<p><img src="https://img.beyourself.org.cn/431db74e1db21a6c46eff40df95b4a9030f7e512.jpg#id=JJPPv&originHeight=524&originWidth=662&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">proxy_set_header</span> <span class="string">X-Real-IP </span></span><br><span class="line"><span class="attr">未配置</span></span><br><span class="line"><span class="attr">Nginxbackend</span> <span class="string">的日志：记录只有192.168.107.112</span></span><br><span class="line"><span class="attr">配置</span></span><br><span class="line"><span class="attr">Nginxbackend</span> <span class="string">的日志,记录的有192.168.107.16 192.168.107.107 192.168.107.112</span></span><br><span class="line"></span><br><span class="line"><span class="attr">proxy_buffers</span> <span class="string">的缓冲区大小一般会设置的比较大，以应付大网页。 proxy_buffers当中单个缓冲区的大小是由系统的内存页面大小决定的，Linux系统中一般为4k。 proxy_buffers由缓冲区数量和缓冲区大小组成的。总的大小为number*size。</span></span><br><span class="line"><span class="attr">若某些请求的响应过大,则超过_buffers的部分将被缓冲到硬盘(缓冲目录由_temp_path指令指定),</span> <span class="string">当然这将会使读取响应的速度减慢, 影响用户体验. 可以使用proxy_max_temp_file_size指令关闭磁盘缓冲.</span></span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：proxy_pass http:&#x2F;&#x2F; 填写nginx-1服务器的地址。</p>
<p>d、 使用PC客户端访问nginx-2服务器地址 浏览器中输入<a target="_blank" rel="noopener" href="http://10.0.105.202/">http://10.0.105.202</a> (也可以是nginx-2服务器的域名)</p>
<p>成功访问nginx-1服务器页面 e、 观察nginx-1服务器的日志 (记得打开下面的日志路径,默认为&#x2F;var&#x2F;log)</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">10.0.105.202</span> <span class="string">- - [27/Jun/2019:15:54:17 +0800] &quot;GET / HTTP/1.0&quot; 304 0 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3770.100 Safari/537.36&quot; &quot;10.0.105.207&quot;</span></span><br></pre></td></tr></table></figure>

<p>10.0.105.202 代理服务器地址</p>
<p>10.0.105.207 客户机地址。</p>
<p>访问成功。 记录了客户机的IP和代理服务器的IP</p>
<h4 id="6、Nginx负载均衡"><a href="#6、Nginx负载均衡" class="headerlink" title="6、Nginx负载均衡"></a>6、Nginx负载均衡</h4><h5 id="1、负载均衡的作用"><a href="#1、负载均衡的作用" class="headerlink" title="1、负载均衡的作用"></a>1、负载均衡的作用</h5><p>如果你的nginx服务器给2台web服务器做代理，负载均衡算法采用轮询，那么当你的一台机器web程序关闭造成web不能访问，那么nginx服务器分发请求还是会给这台不能访问的web服务器，如果这里的响应连接时间过长，就会导致客户端的页面一直在等待响应，对用户来说体验就打打折扣，这里我们怎么避免这样的情况发生呢。这里我配张图来说明下问题。</p>
<p><img src="https://img.beyourself.org.cn/bf3dfe00fea359ac6fa6f2a7e4b9e2e8a0e90eac.jpg#id=BK4of&originHeight=439&originWidth=777&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p>如果负载均衡中其中web2发生这样的情况，nginx首先会去web1请求，但是nginx在配置不当的情况下会继续分发请求道web2，然后等待web2响应，直到我们的响应时间超时，才会把请求重新分发给web1，这里的响应时间如果过长，用户等待的时间就会越长。</p>
<p>下面的配置是解决方案之一。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">proxy_connect_timeout</span> <span class="string">1;   #nginx服务器与被代理的服务器建立连接的超时时间，默认60秒</span></span><br><span class="line"><span class="attr">proxy_read_timeout</span> <span class="string">1; #nginx服务器向被代理服务器组发出read请求后，等待响应的超时间，默认为60秒。</span></span><br><span class="line"><span class="attr">proxy_send_timeout</span> <span class="string">1; #nginx服务器向被代理服务器组发出write请求后，等待响应的超时间，默认为60秒。</span></span><br><span class="line"><span class="attr">proxy_ignore_client_abort</span> <span class="string">on;  #客户端断网时，nginx服务器是否中断对被代理服务器的请求。默认为off。</span></span><br></pre></td></tr></table></figure>

<p>使用upstream指令配置一组服务器作为被代理服务器，服务器中的访问算法遵循配置的负载均衡规则，同时可以使用该指令配置在发生哪些异常情况时，将请求顺次交由下一组服务器处理.</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">proxy_next_upstream</span> <span class="string">timeout;  #反向代理upstream中设置的服务器组，出现故障时，被代理服务器返回的状态值。error|timeout|invalid_header|http_500|http_502|http_503|http_504|http_404|off</span></span><br></pre></td></tr></table></figure>

<p>error：建立连接或向被代理的服务器发送请求或读取响应信息时服务器发生错误。</p>
<p>timeout：建立连接，想被代理服务器发送请求或读取响应信息时服务器发生超时。</p>
<p>invalid_header:被代理服务器返回的响应头异常。</p>
<p>off:无法将请求分发给被代理的服务器。</p>
<p>http_400，….:被代理服务器返回的状态码为400，500，502，等</p>
<h5 id="2、upstream配置"><a href="#2、upstream配置" class="headerlink" title="2、upstream配置"></a>2、upstream配置</h5><p>首先给大家说下 upstream 这个配置的，这个配置是写一组被代理的服务器地址，然后配置负载均衡的算法。这里的被代理服务器地址有两种写法。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">upstream</span> <span class="string">testapp &#123; </span></span><br><span class="line">      <span class="attr">server</span> <span class="string">10.0.105.199:8081;</span></span><br><span class="line">      <span class="attr">server</span> <span class="string">10.0.105.202:8081;</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line"> <span class="attr">server</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="attr">listen</span> <span class="string">80;</span></span><br><span class="line">        <span class="attr">server_name</span> <span class="string">localhost;</span></span><br><span class="line">        <span class="attr">location</span> <span class="string">/ &#123;         </span></span><br><span class="line">           <span class="attr">proxy_pass</span>  <span class="string">http://testapp;  #请求转向 testapp 定义的服务器列表         </span></span><br><span class="line">        <span class="attr">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">upstream</span> <span class="string">mysvr &#123; </span></span><br><span class="line">      <span class="attr">server</span>  <span class="string">http://10.0.105.199:8081;</span></span><br><span class="line">      <span class="attr">server</span>  <span class="string">http://10.0.105.202:8081;</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line"> <span class="attr">server</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="attr">listen</span> <span class="string">80;</span></span><br><span class="line">        <span class="attr">server_name</span> <span class="string">localhost;</span></span><br><span class="line">        <span class="attr">location</span>  <span class="string">/ &#123;         </span></span><br><span class="line">           <span class="attr">proxy_pass</span>  <span class="string">http://mysvr;  #请求转向mysvr 定义的服务器列表         </span></span><br><span class="line">        <span class="attr">&#125;</span></span><br></pre></td></tr></table></figure>

<h5 id="3、负载均衡算法"><a href="#3、负载均衡算法" class="headerlink" title="3、负载均衡算法"></a>3、负载均衡算法</h5><p>upstream 支持4种负载均衡调度算法:</p>
<p>A、<code>轮询(默认)</code>:每个请求按时间顺序逐一分配到不同的后端服务器;</p>
<p>B、<code>ip_hash</code>:每个请求按访问IP的hash结果分配，同一个IP客户端固定访问一个后端服务器。可以保证来自同一ip的请求被打到固定的机器上，可以解决session问题。</p>
<p>C、<code>url_hash</code>:按访问url的hash结果来分配请求，使每个url定向到同一个后端服务器。后台服务器为缓存的时候提高效率。</p>
<p>D、<code>fair</code>:这是比上面两个更加智能的负载均衡算法。此种算法可以依据页面大小和加载时间长短智能地进行负载均衡，也就是根据后端服务器的响应时间来分配请求，响应时间短的优先分配。<code>Nginx</code>本身是不支持 <code>fair</code>的，如果需要使用这种调度算法，必须下载Nginx的 <code>upstream_fair</code>模块。 # 课后扩展</p>
<p><strong>2、配置实例</strong></p>
<p>1、热备：如果你有2台服务器，当一台服务器发生事故时，才启用第二台服务器给提供服务。服务器处理请求的顺序：AAAAAA突然A挂啦，BBBBBBBBBBBBBB…..</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">upstream</span> <span class="string">myweb &#123; </span></span><br><span class="line">      <span class="attr">server</span> <span class="string">172.17.14.2:8080; </span></span><br><span class="line">      <span class="attr">server</span> <span class="string">172.17.14.3:8080 backup;  #热备     </span></span><br><span class="line">    <span class="attr">&#125;</span></span><br></pre></td></tr></table></figure>

<p>2、轮询：nginx默认就是轮询其权重都默认为1，服务器处理请求的顺序：ABABABABAB….</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">upstream</span> <span class="string">myweb &#123; </span></span><br><span class="line">      <span class="attr">server</span> <span class="string">172.17.14.2:8080;</span></span><br><span class="line">      <span class="attr">server</span> <span class="string">172.17.14.3:8080;</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br></pre></td></tr></table></figure>

<p>3、加权轮询：跟据配置的权重的大小而分发给不同服务器不同数量的请求。如果不设置，则默认为1。下面服务器的请求顺序为：ABBABBABBABBABB….</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">upstream</span> <span class="string">myweb &#123; </span></span><br><span class="line">      <span class="attr">server</span> <span class="string">172.17.14.2:8080 weight=1;</span></span><br><span class="line">      <span class="attr">server</span> <span class="string">172.17.14.3:8080 weight=2;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure>

<p>4、ip_hash:nginx会让相同的客户端ip请求相同的服务器。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">upstream</span> <span class="string">myweb &#123; </span></span><br><span class="line">      <span class="attr">server</span> <span class="string">172.17.14.2:8080; </span></span><br><span class="line">      <span class="attr">server</span> <span class="string">172.17.14.3:8080;</span></span><br><span class="line">      <span class="attr">ip_hash;</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br></pre></td></tr></table></figure>

<p>5、nginx负载均衡配置状态参数</p>
<ul>
<li>down，表示当前的server暂时不参与负载均衡。</li>
<li>backup，预留的备份机器。当其他所有的非backup机器出现故障或者忙的时候，才会请求backup机器，因此这台机器的压力最轻。</li>
<li>max_fails，允许请求失败的次数，默认为1。当超过最大次数时，返回proxy_next_upstream 模块定义的错误。</li>
<li>fail_timeout，在经历了max_fails次失败后，暂停服务的时间单位秒。max_fails可以和fail_timeout一起使用。</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">upstream</span> <span class="string">myweb &#123; </span></span><br><span class="line">     <span class="attr">server</span> <span class="string">172.17.14.2:8080 weight=2 max_fails=2 fail_timeout=2;</span></span><br><span class="line">     <span class="attr">server</span> <span class="string">172.17.14.3:8080 weight=1 max_fails=2 fail_timeout=1;    </span></span><br><span class="line">   <span class="attr">&#125;</span></span><br></pre></td></tr></table></figure>

<p>如果你像跟多更深入的了解 nginx 的负载均衡算法，nginx官方提供一些插件大家可以了解下。</p>
<h5 id="4、nginx配置7层协议及4层协议方法（扩展）"><a href="#4、nginx配置7层协议及4层协议方法（扩展）" class="headerlink" title="4、nginx配置7层协议及4层协议方法（扩展）"></a>4、nginx配置7层协议及4层协议方法（扩展）</h5><p>举例讲解下什么是7层协议，什么是4层协议。</p>
<p>（1）7层协议</p>
<p>OSI（Open System Interconnection）是一个开放性的通行系统互连参考模型，他是一个定义的非常好的协议规范，共包含七层协议。直接上图，这样更直观些：</p>
<p><img src="https://img.beyourself.org.cn/65a933b08af3992c9103a4663a6271a90fd38d47.jpg#id=F80pl&originHeight=396&originWidth=698&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p>好，详情不进行仔细讲解，可以自行<a target="_blank" rel="noopener" href="https://www.baidu.com/s?wd=%E7%99%BE%E5%BA%A6&tn=24004469_oem_dg&rsv_dl=gh_pl_sl_csd">百度</a>！</p>
<p>（2）4层协议</p>
<p>TCP&#x2F;IP协议 之所以说TCP&#x2F;IP是一个协议族，是因为TCP&#x2F;IP协议包括TCP、IP、UDP、ICMP、RIP、TELNETFTP、SMTP、ARP、TFTP等许多协议，这些协议一起称为TCP&#x2F;IP协议。</p>
<p>从协议分层模型方面来讲，TCP&#x2F;IP由四个层次组成：网络接口层、网络层、传输层、应用层。</p>
<p><img src="https://img.beyourself.org.cn/7998521f2a593f9b22d0666b262e6427699edc02.jpg#id=pMNsf&originHeight=233&originWidth=711&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p>（3）协议配置</p>
<p>这里我们举例，在nginx做负载均衡，负载多个服务，部分服务是需要7层的，部分服务是需要4层的，也就是说7层和4层配置在同一个配置文件中。</p>
<p>准备三台机器:</p>
<p>代理服务IP:10.0.105. –配置本地host解析域名；</p>
<p>后端服务器IP:nginx-a ：10.0.105.199&#x2F;nginx-b：10.0.105.202(yum安装)后端服务器将nginx服务启动</p>
<p>配置代理服务器的nginx配置文件</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">worker_processes</span>  <span class="string">4;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">worker_rlimit_nofile</span> <span class="string">102400;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">events</span> <span class="string">&#123;</span></span><br><span class="line">    <span class="attr">worker_connections</span>  <span class="string">1024;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">http</span> <span class="string">&#123;</span></span><br><span class="line">    <span class="attr">include</span>       <span class="string">mime.types;</span></span><br><span class="line">    <span class="attr">default_type</span>  <span class="string">application/octet-stream;</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">log_format</span>  <span class="string">main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class="line">                      <span class="attr">&#x27;$status</span> <span class="string">$body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line">                      <span class="attr">&#x27;&quot;$http_user_agent&quot;</span> <span class="string">&quot;$http_x_forwarded_for&quot;&#x27;;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    #access_log  logs/access.log  main;</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">sendfile</span>        <span class="string">on;</span></span><br><span class="line">    <span class="attr">keepalive_timeout</span>  <span class="string">65;</span></span><br><span class="line">    <span class="attr">gzip</span>  <span class="string">on;</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">upstream</span> <span class="string">testweb &#123;</span></span><br><span class="line">	<span class="attr">ip_hash;</span></span><br><span class="line">	<span class="attr">server</span> <span class="string">10.0.105.199:80 weight=2 max_fails=2 fail_timeout=2s;</span></span><br><span class="line">	<span class="attr">server</span> <span class="string">10.0.105.202:80 weight=2 max_fails=2 fail_timeout=2s;</span></span><br><span class="line">     <span class="attr">&#125;</span></span><br><span class="line">    <span class="attr">server</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="attr">listen</span>       <span class="string">80;</span></span><br><span class="line">        <span class="attr">server_name</span>  <span class="string">www.test.com;</span></span><br><span class="line">        <span class="attr">charset</span> <span class="string">utf-8;</span></span><br><span class="line"><span class="comment">        #access_log  logs/host.access.log  main;</span></span><br><span class="line">        <span class="attr">location</span> <span class="string">/ &#123;</span></span><br><span class="line">	          <span class="attr">proxy_pass</span> <span class="string">http://testweb;</span></span><br><span class="line">            <span class="attr">proxy_set_header</span> <span class="string">Host $host:$server_port;</span></span><br><span class="line">            <span class="attr">proxy_set_header</span> <span class="string">X-Real-IP $remote_addr;</span></span><br><span class="line">            <span class="attr">proxy_set_header</span> <span class="string">X-Forwarded-For $proxy_add_x_forwarded_for;</span></span><br><span class="line">        	<span class="attr">&#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">error_page</span>   <span class="string">500 502 503 504  /50x.html;</span></span><br><span class="line">        <span class="attr">location</span> = <span class="string">/50x.html &#123;</span></span><br><span class="line">            <span class="attr">root</span>   <span class="string">html;</span></span><br><span class="line">        	<span class="attr">&#125;</span></span><br><span class="line">	<span class="attr">&#125;</span></span><br><span class="line"></span><br><span class="line">     <span class="attr">upstream</span> <span class="string">testapp &#123;</span></span><br><span class="line">	       <span class="attr">server</span> <span class="string">10.0.105.202:8081 weight=2 max_fails=2 fail_timeout=2s;</span></span><br><span class="line">         <span class="attr">server</span> <span class="string">10.0.105.199:8081 weight=2 max_fails=2 fail_timeout=2s;               </span></span><br><span class="line">	<span class="attr">&#125;</span></span><br><span class="line"></span><br><span class="line">     <span class="attr">server</span> <span class="string">&#123;</span></span><br><span class="line">	       <span class="attr">listen</span>	    <span class="string">81;</span></span><br><span class="line">	<span class="attr">server_name</span>	<span class="string">www.app.com;</span></span><br><span class="line">	<span class="attr">charset</span> <span class="string">utf-8;</span></span><br><span class="line"><span class="comment">	#access_log  logs/host.access.log  main;</span></span><br><span class="line">	<span class="attr">location</span> <span class="string">/ &#123;</span></span><br><span class="line">	    <span class="attr">proxy_pass</span> <span class="string">http://testapp;</span></span><br><span class="line">            <span class="attr">proxy_set_header</span> <span class="string">Host $host:$server_port;</span></span><br><span class="line">            <span class="attr">proxy_set_header</span> <span class="string">X-Real-IP $remote_addr;</span></span><br><span class="line">            <span class="attr">proxy_set_header</span> <span class="string">X-Forwarded-For $proxy_add_x_forwarded_for;</span></span><br><span class="line"></span><br><span class="line">		<span class="attr">&#125;</span></span><br><span class="line"></span><br><span class="line">	<span class="attr">&#125;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure>

<p>浏览器测试访问:</p>
<p><a target="_blank" rel="noopener" href="http://www.test.com/">http://www.test.com/</a></p>
<p><a target="_blank" rel="noopener" href="http://www.app.com:81/">http://www.app.com:81/</a></p>
<p>202服务器yum安装的创建新的配置文件:</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@nginx-server</span> <span class="string">~]# cd /etc/nginx/conf.d/</span></span><br><span class="line"><span class="attr">[root@nginx-server</span> <span class="string">conf.d]# cp default.conf test.conf</span></span><br><span class="line"><span class="attr">[root@nginx-server</span> <span class="string">conf.d]# cat test.conf </span></span><br><span class="line"><span class="attr">server</span> <span class="string">&#123;</span></span><br><span class="line">    <span class="attr">listen</span>       <span class="string">80;</span></span><br><span class="line">    <span class="attr">server_name</span>  <span class="string">localhost;</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">location</span> <span class="string">/ &#123;</span></span><br><span class="line">         <span class="attr">root</span>   <span class="string">/usr/share/nginx/html;</span></span><br><span class="line">         <span class="attr">index</span>  <span class="string">index.html index.htm;</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server</span> <span class="string">&#123;</span></span><br><span class="line">    <span class="attr">listen</span>       <span class="string">8081;</span></span><br><span class="line">    <span class="attr">server_name</span>  <span class="string">localhost;</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">location</span> <span class="string">/ &#123;</span></span><br><span class="line">         <span class="attr">root</span>   <span class="string">/var/www/nginx/html;</span></span><br><span class="line">         <span class="attr">index</span>  <span class="string">index.html index.htm;</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"><span class="attr">[root@nginx-server</span> <span class="string">~]# nginx -s reload</span></span><br></pre></td></tr></table></figure>

<p>nginx在1.9.0的时候，增加了一个 stream 模块，用来实现四层协议（网络层和传输层）的转发、代理、负载均衡等。stream模块的用法跟http的用法类似，允许我们配置一组TCP或者UDP等协议的监听，然后通过proxy_pass来转发我们的请求，通过upstream添加多个后端服务，实现负载均衡。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#4层tcp负载 </span></span><br><span class="line"><span class="attr">stream</span> <span class="string">&#123;</span></span><br><span class="line">			<span class="attr">upstream</span> <span class="string">myweb &#123;</span></span><br><span class="line">                <span class="attr">hash</span> <span class="string">$remote_addr consistent;</span></span><br><span class="line">                <span class="attr">server</span> <span class="string">172.17.14.2:8080;</span></span><br><span class="line">                <span class="attr">server</span> <span class="string">172.17.14.3:8080;</span></span><br><span class="line">        <span class="attr">&#125;</span></span><br><span class="line">        <span class="attr">server</span> <span class="string">&#123;</span></span><br><span class="line">            <span class="attr">listen</span> <span class="string">82;</span></span><br><span class="line">            <span class="attr">proxy_connect_timeout</span> <span class="string">10s;</span></span><br><span class="line">            <span class="attr">proxy_timeout</span> <span class="string">30s;</span></span><br><span class="line">            <span class="attr">proxy_pass</span> <span class="string">myweb;</span></span><br><span class="line">           </span><br><span class="line">        <span class="attr">&#125;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="7、nginx-会话保持"><a href="#7、nginx-会话保持" class="headerlink" title="7、nginx 会话保持"></a>7、nginx 会话保持</h4><p>nginx会话保持主要有以下几种实现方式。</p>
<h5 id="1、ip-hash"><a href="#1、ip-hash" class="headerlink" title="1、ip_hash"></a><strong>1、ip_hash</strong></h5><p>ip_hash使用源地址哈希算法，将同一客户端的请求总是发往同一个后端服务器，除非该服务器不可用。</p>
<p>ip_hash语法：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">upstream</span> <span class="string">backend &#123;</span></span><br><span class="line">    <span class="attr">ip_hash;</span></span><br><span class="line">    <span class="attr">server</span> <span class="string">backend1.example.com;</span></span><br><span class="line">    <span class="attr">server</span> <span class="string">backend2.example.com;</span></span><br><span class="line">    <span class="attr">server</span> <span class="string">backend3.example.com down;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure>

<p>ip_hash简单易用，但有如下问题： 当后端服务器宕机后，session会丢失； 来自同一局域网的客户端会被转发到同一个后端服务器，可能导致负载失衡； 不适用于CDN网络，不适用于前段还有代理的情况。</p>
<h5 id="2、sticky-cookie-insert"><a href="#2、sticky-cookie-insert" class="headerlink" title="2、sticky_cookie_insert"></a>2、sticky_cookie_insert</h5><p>使用sticky_cookie_insert启用会话亲缘关系，这会导致来自同一客户端的请求被传递到一组服务器的同一台服务器。与ip_hash不同之处在于，它不是基于IP来判断客户端的，而是基于cookie来判断。因此可以避免上述ip_hash中来自同一局域网的客户端和前段代理导致负载失衡的情况。(需要引入第三方模块才能实现) # 课后扩展 语法：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">upstream</span> <span class="string">backend &#123;</span></span><br><span class="line">    <span class="attr">server</span> <span class="string">backend1.example.com;</span></span><br><span class="line">    <span class="attr">server</span> <span class="string">backend2.example.com;</span></span><br><span class="line">    <span class="attr">sticky</span> <span class="string">expires=1h domain=3evip.cn path=/;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure>

<p>说明： expires：设置浏览器中保持cookie的时间 domain：定义cookie的域 path：为cookie定义路径</p>
<h5 id="3、jvm-route方式"><a href="#3、jvm-route方式" class="headerlink" title="3、jvm_route方式"></a><strong>3、jvm_route方式</strong></h5><p>jvm_route是通过session_cookie这种方式来实现session粘性。将特定会话附属到特定tomcat上，从而解决session不同步问题，但是无法解决宕机后会话转移问题。如果在cookie和url中并没有session，则这只是个简单的round-robin负载均衡。</p>
<p>jvm_route的原理</p>
<ul>
<li>一开始请求过来，没有带session的信息，jvm_route就根据round robin的方法，发到一台Tomcat上面</li>
<li>Tomcat添加上session信息，并返回给客户</li>
<li>用户再次请求，jvm_route看到session中有后端服务器的名称，他就把请求转到对应的服务器上</li>
</ul>
<p>暂时jvm_route模块还不支持fair的模式。jvm_route的工作模式和fair是冲突的。对于某个特定用户，当一直为他服务的Tomcat宕机后，默认情况下它会重试max_fails的次数，如果还是失败，就重新启用round robin的方式，而这种情况下就会导致用户的session丢失。</p>
<h5 id="4、使用后端服务器自身通过相关机制保持session同步，如：使用数据库、redis、memcached-等做session复制"><a href="#4、使用后端服务器自身通过相关机制保持session同步，如：使用数据库、redis、memcached-等做session复制" class="headerlink" title="4、使用后端服务器自身通过相关机制保持session同步，如：使用数据库、redis、memcached 等做session复制"></a><strong>4、使用后端服务器自身通过相关机制保持session同步，如：使用数据库、redis、memcached 等做session复制</strong></h5><h3 id="10、nginx-实现动静分离"><a href="#10、nginx-实现动静分离" class="headerlink" title="10、nginx 实现动静分离"></a>10、nginx 实现动静分离</h3><p>为了加快网站的解析速度，可以把动态页面和静态页面由不同的服务器来解析，加快解析速度。降低原来单个服务器的压力。 在动静分离的tomcat的时候比较明显，因为tomcat解析静态很慢，其实这些原理的话都很好理解，简单来说，就是使用正则表达式匹配过滤，然后交个不同的服务器。</p>
<p><strong>1、准备环境</strong></p>
<p>准备一个nginx代理 两个http 分别处理动态和静态。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">1.配置nginx反向代理upstream；</span></span><br><span class="line"><span class="attr">upstream</span> <span class="string">static &#123;</span></span><br><span class="line">        <span class="attr">server</span> <span class="string">10.0.105.196:80 weight=1 max_fails=1 fail_timeout=60s;</span></span><br><span class="line">        <span class="attr">&#125;</span></span><br><span class="line"><span class="attr">upstream</span> <span class="string">php &#123;</span></span><br><span class="line">        <span class="attr">server</span> <span class="string">10.0.105.200:80 weight=1 max_fails=1 fail_timeout=60s;</span></span><br><span class="line">        <span class="attr">&#125;</span></span><br><span class="line">     <span class="attr">server</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="attr">listen</span>      <span class="string">80;</span></span><br><span class="line">        <span class="attr">server_name</span>     <span class="string">localhost;</span></span><br><span class="line"><span class="comment">        #动态资源加载</span></span><br><span class="line">        <span class="attr">location</span> <span class="string">~ \.(php|jsp)$ &#123;</span></span><br><span class="line">            <span class="attr">proxy_pass</span> <span class="string">http://php;</span></span><br><span class="line">            <span class="attr">proxy_set_header</span> <span class="string">Host $host:$server_port;</span></span><br><span class="line">            <span class="attr">proxy_set_header</span> <span class="string">X-Real-IP $remote_addr;</span></span><br><span class="line">            <span class="attr">proxy_set_header</span> <span class="string">X-Forwarded-For $proxy_add_x_forwarded_for;</span></span><br><span class="line">                <span class="attr">&#125;</span></span><br><span class="line"><span class="comment">        #静态资源加载</span></span><br><span class="line">        <span class="attr">location</span> <span class="string">~ .*\.(html|gif|jpg|png|bmp|swf|css|js)$ &#123;</span></span><br><span class="line">            <span class="attr">proxy_pass</span> <span class="string">http://static;</span></span><br><span class="line">            <span class="attr">proxy_set_header</span> <span class="string">Host $host:$server_port;</span></span><br><span class="line">            <span class="attr">proxy_set_header</span> <span class="string">X-Real-IP $remote_addr;</span></span><br><span class="line">            <span class="attr">proxy_set_header</span> <span class="string">X-Forwarded-For $proxy_add_x_forwarded_for;</span></span><br><span class="line">                <span class="attr">&#125;</span></span><br><span class="line">        <span class="attr">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">静态资源配置</span></span><br><span class="line"><span class="attr">server</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="attr">listen</span> <span class="string">80;</span></span><br><span class="line">        <span class="attr">server_name</span>     <span class="string">localhost;</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">location</span> <span class="string">~ \.(html|jpg|png|js|css|gif|bmp|jpeg) &#123;</span></span><br><span class="line">        <span class="attr">root</span> <span class="string">/home/www/nginx;</span></span><br><span class="line">        <span class="attr">&#125;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">动态资源配置</span>:<span class="string"></span></span><br><span class="line"><span class="attr">yum</span> <span class="string">安装php7.1</span></span><br><span class="line"><span class="attr">[root@nginx-server</span> <span class="string">~]#rpm -Uvh https://mirror.webtatic.com/yum/el7/epel-release.rpm</span></span><br><span class="line"><span class="attr">[root@nginx-server</span> <span class="string">~]#rpm -Uvh https://mirror.webtatic.com/yum/el7/webtatic-release.rpm</span></span><br><span class="line"><span class="attr">[root@nginx-server</span> <span class="string">~]#yum install php74-php-xsl php74-php php74-php-ldap php74-php-cli php74-php-common php74-php-devel php74-php-gd php74-php-pdo php74-php-mysql php74-php-mbstring php74-php-bcmath php74-php-mcrypt -y</span></span><br><span class="line"><span class="attr">[root@nginx-server</span> <span class="string">~]#yum install -y php74-php-fpm</span></span><br><span class="line"><span class="attr">[root@nginx-server</span> <span class="string">~]#systemctl start php-fpm</span></span><br><span class="line"><span class="attr">[root@nginx-server</span> <span class="string">~]#systemctl enable php-fpm</span></span><br><span class="line"><span class="attr">编辑nginx的配置文件</span>:<span class="string"></span></span><br><span class="line"><span class="attr">server</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="attr">listen</span>      <span class="string">80;</span></span><br><span class="line">        <span class="attr">server_name</span>     <span class="string">localhost;</span></span><br><span class="line">        <span class="attr">location</span> <span class="string">~ \.php$ &#123;</span></span><br><span class="line">            <span class="attr">root</span>           <span class="string">/home/nginx/html;  #指定网站目录</span></span><br><span class="line">            <span class="attr">fastcgi_pass</span>   <span class="string">127.0.0.1:9000;    #指定访问地址</span></span><br><span class="line">            <span class="attr">fastcgi_index</span>  <span class="string">index.php;		#指定默认文件</span></span><br><span class="line">            <span class="attr">fastcgi_param</span>  <span class="string">SCRIPT_FILENAME  $document_root$fastcgi_script_name; #站点根目录，取决于root配置项           （编译安装的nginx需要注意配置路径是否和这里一致）</span></span><br><span class="line">            <span class="attr">include</span>        <span class="string">fastcgi_params;  #包含nginx常量定义</span></span><br><span class="line">        		<span class="attr">&#125;</span></span><br><span class="line">        <span class="attr">&#125;</span></span><br></pre></td></tr></table></figure>

<p>当访问静态页面的时候location 匹配到 (html|jpg|png|js|css|gif|bmp|jpeg) 通过转发到静态服务器，静态服务通过location的正则匹配来处理请求。当访问动态页面时location匹配到 .php 结尾的文件转发到后端php服务处理请求。</p>
<h3 id="11、nginx-防盗链问题"><a href="#11、nginx-防盗链问题" class="headerlink" title="11、nginx 防盗链问题"></a>11、nginx 防盗链问题</h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">两个网站</span> <span class="string">A 和 B， A网站引用了B网站上的图片，这种行为就叫做盗链。 防盗链，就是要防止A引用B的图片。</span></span><br></pre></td></tr></table></figure>

<h4 id="1、nginx-防止网站资源被盗用模块"><a href="#1、nginx-防止网站资源被盗用模块" class="headerlink" title="1、nginx 防止网站资源被盗用模块"></a>1、nginx 防止网站资源被盗用模块</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ngx_http_referer_module</span></span><br></pre></td></tr></table></figure>

<p><strong>如何区分哪些是不正常的用户？</strong></p>
<p>HTTP Referer是Header的一部分，当浏览器向Web服务器发送请求的时候，一般会带上Referer，告诉服务器我是从哪个页面链接过来的，服务器借此可以获得一些信息用于处理，例如防止未经允许的网站盗链图片、文件等。因此HTTP Referer头信息是可以通过程序来伪装生成的，所以通过Referer信息防盗链并非100%可靠，但是，它能够限制大部分的盗链情况.</p>
<p>比如在<a target="_blank" rel="noopener" href="http://www.google.com/">www.google.com</a> 里有一个<code>www.baidu.com</code> 链接，那么点击这个<code>www.baidu.com</code> ，它的<code>header</code> 信息里就有：Referer&#x3D;<a target="_blank" rel="noopener" href="http://www.google.com/">http://www.google.com</a></p>
<h4 id="2、防盗链配置"><a href="#2、防盗链配置" class="headerlink" title="2、防盗链配置"></a>2、防盗链配置</h4><p><strong>配置要点：</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@nginx-server</span> <span class="string">~]# vim /etc/nginx/nginx.conf</span></span><br><span class="line"><span class="comment"># 日志格式添加&quot;$http_referer&quot;</span></span><br><span class="line"><span class="attr">log_format</span>  <span class="string">main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class="line">                         <span class="attr">&#x27;$status</span> <span class="string">$body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line">                         <span class="attr">&#x27;&quot;$http_user_agent&quot;</span> <span class="string">&quot;$http_x_forwarded_for&quot;&#x27;;</span></span><br><span class="line"><span class="comment"># valid_referers 使用方式                         </span></span><br><span class="line"><span class="attr">Syntax</span>: 	<span class="string">valid_referers none | blocked | server_names | string ...;</span></span><br><span class="line"><span class="attr">Default</span>: 	<span class="string">—</span></span><br><span class="line"><span class="attr">Context</span>: <span class="string">server, location</span></span><br></pre></td></tr></table></figure>

<ul>
<li>none : 允许没有http_refer的请求访问资源； </li>
<li>blocked : 允许不是http:&#x2F;&#x2F;开头的，不带协议的请求访问资源； </li>
<li>server_names : 只允许指定ip&#x2F;域名来的请求访问资源（白名单）；<br>准备两台机器,两张图片(缓存问题) <figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">配置nginx配置文件，并上传图片</span></span><br><span class="line"><span class="attr">[root@nginx-server</span> <span class="string">html]# vim /etc/nginx/conf.d/nginx.conf</span></span><br><span class="line"><span class="attr">server</span> <span class="string">&#123;</span></span><br><span class="line">    <span class="attr">listen</span>       <span class="string">80;</span></span><br><span class="line">    <span class="attr">server_name</span>  <span class="string">localhost;</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">location</span> <span class="string">/ &#123;</span></span><br><span class="line">         <span class="attr">root</span>   <span class="string">/usr/share/nginx/html;</span></span><br><span class="line">         <span class="attr">index</span>  <span class="string">index.html index.htm;</span></span><br><span class="line"></span><br><span class="line">         <span class="attr">valid_referers</span> <span class="string">none blocked *.qf.com 10.0.105.202;</span></span><br><span class="line">                <span class="attr">if</span> <span class="string">($invalid_referer) &#123;</span></span><br><span class="line">                   <span class="attr">return</span> <span class="string">502;</span></span><br><span class="line">                <span class="attr">&#125;</span></span><br><span class="line">        <span class="attr">&#125;</span></span><br><span class="line">    <span class="attr">location</span> <span class="string">~  .*\.(gif|jpg|png|jpeg)$ &#123;</span></span><br><span class="line">         <span class="attr">root</span>  <span class="string">/usr/share/nginx/html;</span></span><br><span class="line"></span><br><span class="line">         <span class="attr">valid_referers</span>  <span class="string">qf.com 10.0.105.202;</span></span><br><span class="line">                <span class="attr">if</span> <span class="string">($invalid_referer) &#123;</span></span><br><span class="line">                   <span class="attr">return</span> <span class="string">403;</span></span><br><span class="line">                <span class="attr">&#125;</span></span><br><span class="line">        <span class="attr">&#125;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">重载nginx服务</span></span><br><span class="line"><span class="attr">[root@nginx-server</span> <span class="string">~]# nginx -s reload -c /etc/nginx/nginx.conf</span></span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">第二台机器客户端</span></span><br><span class="line"><span class="attr">配置nginx访问页面</span></span><br><span class="line"><span class="attr">创建页面</span></span><br><span class="line"><span class="attr">[root@nginx-server</span> <span class="string">nginx]# vim index.html</span></span><br><span class="line"><span class="attr">&lt;html&gt;</span></span><br><span class="line"><span class="attr">&lt;head&gt;</span></span><br><span class="line">    <span class="attr">&lt;meta</span> <span class="string">charset=&quot;utf-8&quot;&gt;</span></span><br><span class="line">    <span class="attr">&lt;title&gt;qf.com&lt;/title&gt;</span></span><br><span class="line"><span class="attr">&lt;/head&gt;</span></span><br><span class="line"><span class="attr">&lt;body</span> <span class="string">style=&quot;background-color:red;&quot;&gt;</span></span><br><span class="line">    <span class="attr">&lt;img</span> <span class="string">src=&quot;http://10.0.105.202/test.jpg&quot;/&gt;</span></span><br><span class="line"><span class="attr">&lt;/body&gt;</span></span><br><span class="line"><span class="attr">&lt;/html&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">测试不带http_refer：</span></span><br><span class="line"><span class="attr">[root@nginx-server</span> <span class="string">nginx]# curl -I &quot;http://10.0.105.202/test1.png&quot;</span></span><br><span class="line"><span class="attr">HTTP/1.1</span> <span class="string">200 OK</span></span><br><span class="line"><span class="attr">Server</span>: <span class="string">nginx/1.16.0</span></span><br><span class="line"><span class="attr">Date</span>: <span class="string">Thu, 27 Jun 2019 16:21:13 GMT</span></span><br><span class="line"><span class="attr">Content-Type</span>: <span class="string">image/png</span></span><br><span class="line"><span class="attr">Content-Length</span>: <span class="string">235283</span></span><br><span class="line"><span class="attr">Last-Modified</span>: <span class="string">Thu, 27 Jun 2019 11:27:11 GMT</span></span><br><span class="line"><span class="attr">Connection</span>: <span class="string">keep-alive</span></span><br><span class="line"><span class="attr">ETag</span>: <span class="string">&quot;5d14a80f-39713&quot;</span></span><br><span class="line"><span class="attr">Accept-Ranges</span>: <span class="string">bytes</span></span><br><span class="line"></span><br><span class="line"><span class="attr">测试带非法http_refer</span>:<span class="string"></span></span><br><span class="line"><span class="attr">[root@nginx-server</span> <span class="string">nginx]# curl -e http://www.baidu.com -I &quot;http://10.0.105.202/test.jpg&quot;</span></span><br><span class="line"><span class="attr">HTTP/1.1</span> <span class="string">403 Forbidden</span></span><br><span class="line"><span class="attr">Server</span>: <span class="string">nginx/1.16.0</span></span><br><span class="line"><span class="attr">Date</span>: <span class="string">Thu, 27 Jun 2019 16:22:32 GMT</span></span><br><span class="line"><span class="attr">Content-Type</span>: <span class="string">text/html</span></span><br><span class="line"><span class="attr">Content-Length</span>: <span class="string">153</span></span><br><span class="line"><span class="attr">Connection</span>: <span class="string">keep-alive</span></span><br><span class="line"></span><br><span class="line"><span class="attr">测试带合法的http_refer</span>:<span class="string"></span></span><br><span class="line"><span class="attr">[root@nginx-server</span> <span class="string">nginx]# curl -e http://10.0.105.202 -I &quot;http://10.0.105.202/test.jpg&quot;</span></span><br><span class="line"><span class="attr">HTTP/1.1</span> <span class="string">200 OK</span></span><br><span class="line"><span class="attr">Server</span>: <span class="string">nginx/1.16.0</span></span><br><span class="line"><span class="attr">Date</span>: <span class="string">Thu, 27 Jun 2019 16:23:21 GMT</span></span><br><span class="line"><span class="attr">Content-Type</span>: <span class="string">image/jpeg</span></span><br><span class="line"><span class="attr">Content-Length</span>: <span class="string">27961</span></span><br><span class="line"><span class="attr">Last-Modified</span>: <span class="string">Thu, 27 Jun 2019 12:28:51 GMT</span></span><br><span class="line"><span class="attr">Connection</span>: <span class="string">keep-alive</span></span><br><span class="line"><span class="attr">ETag</span>: <span class="string">&quot;5d14b683-6d39&quot;</span></span><br><span class="line"><span class="attr">Accept-Ranges</span>: <span class="string">bytes</span></span><br></pre></td></tr></table></figure>


<h4 id="3、其他配置"><a href="#3、其他配置" class="headerlink" title="3、其他配置"></a>3、其他配置</h4><h5 id="3-1、匹配域名"><a href="#3-1、匹配域名" class="headerlink" title="3.1、匹配域名"></a>3.1、匹配域名</h5><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#    location ~  .*\.(gif|jpg|png|jpeg)$ &#123;</span></span><br><span class="line"><span class="comment">#        root  /usr/share/nginx/html;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#         valid_referers none blocked qf.com 10.0.105.202;</span></span><br><span class="line"><span class="comment">#               if ($invalid_referer) &#123;</span></span><br><span class="line"><span class="comment">#                  return 403;</span></span><br><span class="line"><span class="comment">#               &#125;</span></span><br><span class="line"><span class="comment">#       &#125;</span></span><br><span class="line">    <span class="attr">location</span> <span class="string">~ .*\.(gif|jpg|png|jpeg)$ &#123;</span></span><br><span class="line">        <span class="attr">root</span>  <span class="string">/usr/share/nginx/html;</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">valid_referers</span> <span class="string">10.0.105.202 *.baidu.com *.google.com;</span></span><br><span class="line">                <span class="attr">if</span> <span class="string">($invalid_referer) &#123;</span></span><br><span class="line">                <span class="attr">rewrite</span> <span class="string">^/ http://10.0.105.202/test.jpg;</span></span><br><span class="line"><span class="comment">                #return 403;</span></span><br><span class="line">                <span class="attr">&#125;</span></span><br><span class="line">        <span class="attr">&#125;</span></span><br></pre></td></tr></table></figure>

<p>以上所有来自 qf.com 和域名中google和baidu的站点都可以访问到当前站点的图片，如果来源域名不在这个列表中，那么$invalid_referer等于1，在if语句中返回一个403给用户，这样用户便会看到一个403的页面，如果使用下面的rewrite，那么盗链的图片都会显示403.jpg。如果用户直接在浏览器输入你的图片地址，那么图片显示正常，因为它符合none这个规则。</p>

    </article>
    
    <div class="read-nums">
      <!-- id 将作为查询条件 -->
      <span id="2024/09/01/nginx2/" class="leancloud_visitors" data-flag-title="Your Article Title">
        <em class="post-meta-item-text">浏览量</em>
        <i class="leancloud-visitors-count"></i>
      </span>
    </div>
    <div class="comments-intro">
      <h2>评论区</h2>
      <p>欢迎你留下宝贵的意见，昵称输入QQ号会显示QQ头像哦~</p>
    </div>
    <div id="vcomments" class="vcomments"></div>
    
  </div>
  <div class="article-catelogue">
    <div class="article-catelogue--wrapper">
      <div class="catelogue catelogue-1">
        <h3>目录</h3>
        <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#9%E3%80%81Nginx-Proxy-%E4%BB%A3%E7%90%86"><span class="toc-number">1.</span> <span class="toc-text">9、Nginx Proxy 代理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E4%BB%A3%E7%90%86%E5%8E%9F%E7%90%86"><span class="toc-number">1.1.</span> <span class="toc-text">1、代理原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E6%AD%A3-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">1.2.</span> <span class="toc-text">2、正&#x2F;反向代理的区别</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81%E7%9F%A5%E8%AF%86%E6%89%A9%E5%B1%951"><span class="toc-number">1.3.</span> <span class="toc-text">3、知识扩展1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%E3%80%81%E7%9F%A5%E8%AF%86%E6%89%A9%E5%B1%952"><span class="toc-number">1.4.</span> <span class="toc-text">4、知识扩展2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5%E3%80%81nginx-Proxy-%E9%85%8D%E7%BD%AE"><span class="toc-number">1.5.</span> <span class="toc-text">5、nginx Proxy 配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1%E3%80%81%E4%BB%A3%E7%90%86%E6%A8%A1%E5%9D%97"><span class="toc-number">1.5.1.</span> <span class="toc-text">1、代理模块</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2%E3%80%81%E4%BB%A3%E7%90%86%E9%85%8D%E7%BD%AE"><span class="toc-number">1.5.2.</span> <span class="toc-text">2、代理配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3%E3%80%81%E5%90%AF%E7%94%A8-nginx-proxy-%E4%BB%A3%E7%90%86"><span class="toc-number">1.5.3.</span> <span class="toc-text">3、启用 nginx proxy 代理</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6%E3%80%81Nginx%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">1.6.</span> <span class="toc-text">6、Nginx负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1%E3%80%81%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">1.6.1.</span> <span class="toc-text">1、负载均衡的作用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2%E3%80%81upstream%E9%85%8D%E7%BD%AE"><span class="toc-number">1.6.2.</span> <span class="toc-text">2、upstream配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3%E3%80%81%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95"><span class="toc-number">1.6.3.</span> <span class="toc-text">3、负载均衡算法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4%E3%80%81nginx%E9%85%8D%E7%BD%AE7%E5%B1%82%E5%8D%8F%E8%AE%AE%E5%8F%8A4%E5%B1%82%E5%8D%8F%E8%AE%AE%E6%96%B9%E6%B3%95%EF%BC%88%E6%89%A9%E5%B1%95%EF%BC%89"><span class="toc-number">1.6.4.</span> <span class="toc-text">4、nginx配置7层协议及4层协议方法（扩展）</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7%E3%80%81nginx-%E4%BC%9A%E8%AF%9D%E4%BF%9D%E6%8C%81"><span class="toc-number">1.7.</span> <span class="toc-text">7、nginx 会话保持</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1%E3%80%81ip-hash"><span class="toc-number">1.7.1.</span> <span class="toc-text">1、ip_hash</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2%E3%80%81sticky-cookie-insert"><span class="toc-number">1.7.2.</span> <span class="toc-text">2、sticky_cookie_insert</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3%E3%80%81jvm-route%E6%96%B9%E5%BC%8F"><span class="toc-number">1.7.3.</span> <span class="toc-text">3、jvm_route方式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4%E3%80%81%E4%BD%BF%E7%94%A8%E5%90%8E%E7%AB%AF%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%87%AA%E8%BA%AB%E9%80%9A%E8%BF%87%E7%9B%B8%E5%85%B3%E6%9C%BA%E5%88%B6%E4%BF%9D%E6%8C%81session%E5%90%8C%E6%AD%A5%EF%BC%8C%E5%A6%82%EF%BC%9A%E4%BD%BF%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E3%80%81redis%E3%80%81memcached-%E7%AD%89%E5%81%9Asession%E5%A4%8D%E5%88%B6"><span class="toc-number">1.7.4.</span> <span class="toc-text">4、使用后端服务器自身通过相关机制保持session同步，如：使用数据库、redis、memcached 等做session复制</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10%E3%80%81nginx-%E5%AE%9E%E7%8E%B0%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB"><span class="toc-number">2.</span> <span class="toc-text">10、nginx 实现动静分离</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11%E3%80%81nginx-%E9%98%B2%E7%9B%97%E9%93%BE%E9%97%AE%E9%A2%98"><span class="toc-number">3.</span> <span class="toc-text">11、nginx 防盗链问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81nginx-%E9%98%B2%E6%AD%A2%E7%BD%91%E7%AB%99%E8%B5%84%E6%BA%90%E8%A2%AB%E7%9B%97%E7%94%A8%E6%A8%A1%E5%9D%97"><span class="toc-number">3.1.</span> <span class="toc-text">1、nginx 防止网站资源被盗用模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E9%98%B2%E7%9B%97%E9%93%BE%E9%85%8D%E7%BD%AE"><span class="toc-number">3.2.</span> <span class="toc-text">2、防盗链配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81%E5%85%B6%E4%BB%96%E9%85%8D%E7%BD%AE"><span class="toc-number">3.3.</span> <span class="toc-text">3、其他配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1%E3%80%81%E5%8C%B9%E9%85%8D%E5%9F%9F%E5%90%8D"><span class="toc-number">3.3.1.</span> <span class="toc-text">3.1、匹配域名</span></a></li></ol></li></ol></li></ol>
      </div>
      
        <div class="catelogue catelogue-2">
          
            <p>
              <span>上一篇：</span>
              <a href="/2024/09/01/nnginx5/"></a>
            </p>
           
          
            <p>
              <span>下一篇</span>
              <a href="/2024/09/01/nginx1/"></a>
            </p>
          
        </div>
      
    </div>
  </div>
</div>


<script>
  // var定义，避免pjax重新进来造成的重复声明错误
  var config = JSON.parse('{"enable":true,"appId":"Pf8zCXGEH1qsprnWfikVVujL-gzGzoHsz","appKey":"qOqoiUHhH1TGtLRUYURkLRQX","placeholder":"请留下你宝贵的意见吧~","meta":["nick"],"recordIP":true,"visitor":true,"enableQQ":true}')
  new Valine({
    el: '#vcomments',
    appId: config.appId,
    appKey: config.appKey,
    placeholder: config.placeholder,
    meta: config.meta,
    recordIP: config.recordIP,
    visitor: config.visitor,
    enableQQ: config.enableQQ,
    path: '2024/09/01/nginx2/'
  })
</script>


<script>
  $(document).on('pjax:complete', function() {
    const tocs = document.querySelector('.toc')
    const links = tocs ? tocs.querySelectorAll('a') : []
    links.forEach(link => {
      link.addEventListener('click', e => {
        const href = decodeURIComponent(e.href)
        href.search(/#(.*)/)
        const id = RegExp.$1
        const target = document.querySelector('#' + id)
        const top = target.offsetTop
        document.documentElement.scrollTo({
          top: top - 100,
          behavior: 'smooth'
        })
        e.preventDefault()
      })
    })
  })
</script> 

</div>
      <div class="main-right-wrapper"><div class="main-right">
  <div class="main-right--board">
    <div class="main-right--title">
      <h5>公告栏</h5>
      <i class="iconfont icon-gonggao"></i>
    </div>
    <div class="main-right--content">
      Hello~大噶好。唔系小曹宅，欢迎你们来到我的博客小站，希望能在这里收获到有用的东西哦！ 
    </div>
  </div>

  <div id="aplayer" class="main-right--music"></div>

  <div class="operate-items">
    <div class="operate-item backtop">
      <i class="iconfont icon-huidaodingbu"></i>
      <span>回到顶部</span>
    </div>
    
    <div class="operate-item turn-comment hidden">
      <i class="iconfont icon-pinglun"></i>
      <span>查看评论</span>
    </div>
    
  </div>

  <div class="main-right--site">
    <div class="main-right--power">
      <p>Power By <a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/docs/">Hexo</a>.</p>
      <p>Theme：<a target="_blank" rel="noopener" href="https://github.com/Aizener/hexo-theme-cola">Cola.</a></p>
    </div>
    <p class="main-right--refer"><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/#/Integrated/index">2262690094</a> </p>
  </div>
</div>

<script>
  function setOperateItem () {
    const reg = /\d{4}\/\d{2}\/\d{2}\/.+/
    const path = location.pathname
    const operateDom = document.querySelector('.main-right .operate-items')
    const commentDom = document.querySelector('.turn-comment')
    const cateloguDom = document.querySelector('.article-catelogue > .article-catelogue--wrapper');

    if (commentDom) {
      if (reg.test(path) || path.match(/\/log\/.+/)) {
        commentDom.classList.remove('hidden')
        const newDom = operateDom.cloneNode(true);
        const _backtopDom = newDom.querySelector('.backtop');
        const _commentDom = newDom.querySelector('.turn-comment');
        _backtopDom.addEventListener('click', () => backTopEvent());
        _commentDom.addEventListener('click', () => commentDomEvent());
        cateloguDom.appendChild(newDom);
      } else {
        commentDom.classList.add('hidden')
      }
    }
  }

  setOperateItem()
  const musics = JSON.parse(`[{"name":"不找了","artist":"隔壁老樊","url":"music/隔壁老樊 - 不找了.mp3","cover":"https://img2.baidu.com/it/u=1260056724,1076343118&fm=253&fmt=auto&app=138&f=JPEG?w=500&h=500"},{"name":"于是天气刚好","artist":"泪桥","url":"music/于是天气刚好 - 泪桥.mp3","cover":"https://img2.baidu.com/it/u=705831265,2862720033&fm=253&fmt=auto&app=138&f=JPEG?w=500&h=500"},{"name":"安和桥","artist":"林芬宇","url":"music/林芬宇 - 安和桥.mp3","cover":"https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQo0SWQx6YrNA8lElaG4OOKLkNkNzLO1PflKg&usqp=CAU"}]`)
  const ap = new APlayer({
    container: document.querySelector('#aplayer'),
    audio: musics,
  })

  $(document).on('pjax:complete', function() {
    setOperateItem()
  })

  document.querySelector('.backtop').addEventListener('click', () => {
    backTopEvent();
  })
  const dom = document.querySelector('.turn-comment')
  dom && dom.addEventListener('click', () => {
    commentDomEvent();
  })

  function backTopEvent() {
    document.documentElement.scrollTo({
      top: 0,
      behavior: 'smooth'
    })
  }

  function commentDomEvent() {
    const commentDom = document.querySelector('.comments-intro')
    if (!commentDom) return
    const top = commentDom.offsetTop, height = commentDom.offsetHeight
    document.documentElement.scrollTo({
      top: top - 2 * height,
      behavior: 'smooth'
    })
  }
</script></div>
    </section>
  </div>
  <div id="progress" class="progress"></div>
  <div id="gray" class="gray"></div>

  <script>
    function initScroll () {
      document.addEventListener('scroll', () => {
        const doc = document.documentElement
        const scrollTop = doc.scrollTop
        const pageHeight = doc.offsetHeight
        const clientHeight = doc.clientHeight
        const ratio = scrollTop / (pageHeight - clientHeight)
        const progress = document.querySelector('#progress')
        const avatarImg = document.querySelector('.main-left--avatar')
        progress.style.width = (100 * ratio) + '%'
        avatarImg.style.transform = `rotate(${360 * ratio}deg)`
      })
    }

    const rootPath = "/"

    const checkAndSetArticlePageLayout = () => {
      const path = location.pathname.replace(rootPath, '');
      if (
        /^\/?\d{4}\/\d{2}\/\d{2}\/.*/.test(path) ||
        /^log\/.+/.test(path)
      ) {
        $('.main-container, .main-right, .main-right-wrapper').addClass('is-article')
      } else {
        $('.main-container, .main-right, .main-right-wrapper').removeClass('is-article')
      }
    }

    const gray = "none"
    const setGrayStyle = () => {
      if (gray === 'none') {
        return
      } else if (gray === 'index') {
        location.pathname === '/' ? $('#gray').show() : $('#gray').hide()
      } else if (gray === 'all') {
        $('#gray').show()
      }
    }
    setGrayStyle()


    window.onload = function () {
      checkAndSetArticlePageLayout()
      setTimeout(() => {
        $('#load').slideUp()
        $('#container').slideToggle()
        setTimeout(() => {
          initScroll();
        }, 500)
      }, 500)
    }
    
    let status = 0
    // 对所有链接跳转事件绑定pjax容器container
    $(document).pjax('a[target!=_blank]', '#main-container', {
      container: '#main-container',
      fragment: '#main-container',
      timeout: 8000
    })

    $(document).on('pjax:start', function() {
    })
    $(document).on('pjax:complete', function() {
      status = 0
      $('.main-container').addClass('to-up').on('animationend', function() {
        $(this).removeClass('to-up')
      })
      setGrayStyle()
      checkAndSetArticlePageLayout()
    })
    $(document).on('pjax:popstate', function() {
      status = -1
      checkAndSetArticlePageLayout()
    });
  </script>
</body>
</html>