<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>我的技术与生活——nginx5 | Mr.Long</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="shortcut icon" href="/imgs/shortcut-icon.ico" type="image/x-icon">
  <link rel="stylesheet" href="/css/public.css" />
  <link rel="stylesheet" href="/css/layout.css" />
  <link rel="stylesheet" href="/css/iconfont.css" />
  <link rel="stylesheet" href="/css/APlayer.min.css" />
  <script src="/js/APlayer.min.js"></script>
  <script src="/js/jquery.min.js"></script>
  <script src="/js/jquery.pjax.min.js"></script>

  <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
  <script>
    document.title = `我的技术与生活——nginx5`
  </script>
<meta name="generator" content="Hexo 7.3.0"></head>

<style>
  .load {
    width: 100%;
    height: 100vh;
    background-color: rgb(37, 35, 40);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    position: relative;
    z-index: 9999;
  }
  .load-circle {
    width: 80px;
    height: 80px;
    border: 8px solid orange;
    border-bottom-color: transparent;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    animation: rotate 1s linear infinite;
    filter: drop-shadow(0 0 3px orange);
  }
  .load-circle-inner {
    width: 40px;
    height: 40px;
    border: 8px solid orange;
    border-top-color: transparent;
    border-radius: 50%;
    animation: rotate-reverse .5s linear infinite;
  }
  .load-text {
    margin-top: 20px;
    font-size: 24px;
    color: orange;
    display: flex;
  }
  .load-text span {
    margin: 0 5px;
    text-shadow: 5px 5px 5px orange;
    animation: move 1s linear infinite;
  }
  .load-text span:nth-child(1) {
    animation-delay: -0.6s;
  }
  .load-text span:nth-child(2) {
    animation-delay: -0.5s;
  }
  .load-text span:nth-child(3) {
    animation-delay: -0.4s;
  }
  .load-text span:nth-child(4) {
    animation-delay: -0.3s;
  }
  .load-text span:nth-child(5) {
    animation-delay: -0.2s;
  }
  .load-text span:nth-child(6) {
    animation-delay: -0.1s;
  }
  @keyframes rotate {
    0% { transform: rotate(0); }
    100% { transform: rotate(360deg); }
  }
  @keyframes rotate-reverse {
    0% { transform: rotate(0); }
    100% { transform: rotate(-360deg); }
  }
  @keyframes move {
    0% { transform: translateY(0%) rotate(0) scale(1); }
    20% { transform: translateY(20%) rotate(10deg) scale(1.2); }
    80% { transform: translateY(-10%) rotate(-20deg) scale(.8);}
    100% { transform: translateY(0) rotate(0) scale(1); }
  }

  .progress {
    position: fixed;
    left: 0; top: 0;
    width: 0;
    height: 3px;
    background-color: green;
    transition: all cubic-bezier(0.215, 0.610, 0.355, 1) .1s;
    z-index: 9999;
  }

  .to-up {
    animation: toUp .5s 1;
  }
  .gray {
    position: fixed;
    left: 0;
    top: 0;
    width: 100%;
    height: 100vh;
    z-index: 9999;
    display: none;
    pointer-events: none;
    background-color: #000;
    mix-blend-mode: color;
  }
  @keyframes toUp {
    from { transform: translateY(15px); opacity: 0; }
    to { transform: translateY(0) ; opacity: 1; }
  }
</style>
<body>
  <div id="load" class="load">
    <div class="load-circle">
      <div class="load-circle-inner"></div>
    </div>
    <p class="load-text">
      <span>L</span>
      <span>O</span>
      <span>A</span>
      <span>D</span>
      <span>I</span>
      <span>N</span>
      <span>G</span>
    </p>
  </div>
  <div id="container" class="container w-100 vh-100" style="display: none;">
    <header class="header">
  <div class="header-wrapper">
    <div class="header-left">
      <div class="header-search">
        <input id="search-input" type="text" class="header-search--input" placeholder="请输入要检索的文章标题" />
        <span id="search-btn" class="header-search--icon"><i class="iconfont icon-sousuo"></i></span>
      </div>
      <div id="search-layer" class="header-search--layer hidden">
        <p class="title">
          <span>以下是搜索内容：</span>
          <span id="close-layer-btn">关闭</span>
        </p>
        <ul>
        </ul>
      </div>
    </div>
    <div class="header-right">
      <ul class="header-menu">
        <li>
          <a href="http://example.com/">
            <i class="header-menu--icon iconfont icon-shouye"></i>
            <span class="header-menu--span">首页</span>
          </a>
        </li>
        <li>
          <a href="http://example.com/log">
            <i class="header-menu--icon iconfont icon-rizhi"></i>
            <span class="header-menu--span">日志</span>
          </a>
        </li>
        <li>
          <a href="http://example.com/link">
            <i class="header-menu--icon iconfont icon-youqinglianjie"></i>
            <span class="header-menu--span">友情链接</span>
          </a>
        </li>
        <li>
          <a href="http://example.com/about">
            <i class="header-menu--icon iconfont icon-guanyuwomen"></i>
            <span class="header-menu--span">关于我</span>
          </a>
        </li>
      </ul>
    </div>
  </div>
</header>

<script>
  const ipt = document.querySelector('#search-input')
  const btn = document.querySelector('#search-btn')
  const layer = document.querySelector('#search-layer')
  const posts = JSON.parse(`[{"title":"docker命令","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/71e27d1e01da8c13f3f165a1c3bcc8b571e27d1e01da8c13f3f165a1c3bcc8b5","path":"2024/03/21/Docker命令大全/"},{"title":"LV移除、缩容","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/d733537fd3e06784932826b5e82a855d","path":"2023/06/14/LV逻辑卷扩展/"},{"title":"PXE+Kickstart无人值守安装操作系统","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/82cb48f718f8acc8cb2568140eeaaec382cb48f718f8acc8cb2568140eeaaec3","path":"2023/06/26/PXE+Kickstart无人值守安装操作系统/"},{"title":"PQL","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/240007b00ab1bcd1e3af7bb55f18a966","path":"2024/06/30/PromQL 讲解/"},{"title":"TCP协议","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/15047394039467328","path":"2023/06/23/TCP协议/"},{"title":"ansible模块","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/1e624a7ba7e09f195b3f2f384b2b9bb1","path":"2023/08/17/ansible 模块扩展/"},{"title":"docker容器","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/71e27d1e01da8c13f3f165a1c3bcc8b571e27d1e01da8c13f3f165a1c3bcc8b5","path":"2024/03/11/docker容器/"},{"title":"FTP文件服务器","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/a9045286aa9b50dcc09302eff83b328a","path":"2023/06/23/ftp/"},{"title":"Galera集群","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/3719037aa1a43c4806d84ac9bd3dbc34","path":"2024/07/26/galera/"},{"title":"nginx1","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/8c29198625ff99eee0073bbbb137bbc78c29198625ff99eee0073bbbb137bbc7","path":"2023/12/17/nginx1/"},{"title":"nginx2","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/8c29198625ff99eee0073bbbb137bbc78c29198625ff99eee0073bbbb137bbc7","path":"2023/12/19/nginx2/"},{"title":"nginx5","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/8c29198625ff99eee0073bbbb137bbc78c29198625ff99eee0073bbbb137bbc7","path":"2023/12/31/nnginx5/"},{"title":"prometheus","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/240007b00ab1bcd1e3af7bb55f18a966","path":"2024/06/16/prometheus 监控/"},{"title":"redis集群安装","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/a13d778b5db38e4b127b71bdf122f695","path":"2023/09/21/redis集群/"},{"title":"shell脚本","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/9217d5c6d87ce0e8ec7422ca7469db95","path":"2024/08/10/shell脚本/"},{"title":"docker安装","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/71e27d1e01da8c13f3f165a1c3bcc8b571e27d1e01da8c13f3f165a1c3bcc8b5","path":"2024/03/06/容器技术-Docker1/"},{"title":"docker镜像容器","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/71e27d1e01da8c13f3f165a1c3bcc8b571e27d1e01da8c13f3f165a1c3bcc8b5","path":"2024/03/14/容器技术-docker2/"},{"title":"docker-Compose","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/71e27d1e01da8c13f3f165a1c3bcc8b571e27d1e01da8c13f3f165a1c3bcc8b5","path":"2024/03/21/容器技术-docker5/"},{"title":"prometheus-exporter","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/240007b00ab1bcd1e3af7bb55f18a966","path":"2024/06/16/node_exporter/"},{"title":"shell编程","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/9217d5c6d87ce0e8ec7422ca7469db95","path":"2023/07/21/shell_newrain/"},{"title":"docker资源限制","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/71e27d1e01da8c13f3f165a1c3bcc8b571e27d1e01da8c13f3f165a1c3bcc8b5","path":"2024/03/15/容器技术docker4/"},{"title":"用户文件权限","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/3719037aa1a43c4806d84ac9bd3dbc34","path":"2023/06/01/文件权限/"},{"title":"单用户模式破解密码","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/3f6ae566e1f093d2d9dbcc3df361fc4b3f6ae566e1f093d2d9dbcc3df361fc4b","path":"2023/07/01/破解密码/"},{"title":"磁盘阵列","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/69d9906ff9bf88dbc02184ecb8504fc5","path":"2023/07/09/磁盘阵列RAID/"},{"title":"linux文件管理","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/de0f7b079a80d192f90989d9c2c9622d","path":"2023/06/21/文件管理/"},{"title":"存储管理--1","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/d733537fd3e06784932826b5e82a855d","path":"2023/06/25/磁盘存储管理1/"},{"title":"自建YUM源","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/56260873f5720f373c20f43587eab0b8","path":"2023/06/21/自建yum源笔记/"},{"title":"prometheus自定义监控","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/240007b00ab1bcd1e3af7bb55f18a966","path":"2024/06/26/自定义监控/"},{"title":"Linux网卡","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/346f59e468f2155074d1fb3164594702","path":"2023/06/11/网络管理基础/"},{"title":"微服务","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/3719037aa1a43c4806d84ac9bd3dbc34","path":"2024/07/26/微服务概念/"},{"title":"走进网络世界","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/583716b0cb306203c308cc0def55dd9e583716b0cb306203c308cc0def55dd9e","path":"2023/06/16/走进网络世界/"},{"title":"docker容器","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/71e27d1e01da8c13f3f165a1c3bcc8b571e27d1e01da8c13f3f165a1c3bcc8b5","path":"2024/03/13/容器技术-docker3/"},{"title":"nginx4","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/8c29198625ff99eee0073bbbb137bbc78c29198625ff99eee0073bbbb137bbc7","path":"2023/12/30/nginx4/"},{"title":"nginx3","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/8c29198625ff99eee0073bbbb137bbc78c29198625ff99eee0073bbbb137bbc7","path":"2023/12/22/nginx3/"},{"title":"微服务项目","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/3719037aa1a43c4806d84ac9bd3dbc34","path":"2024/07/26/微服务项目-mall-swarm/"},{"title":"redis操作","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/a13d778b5db38e4b127b71bdf122f695","path":"2023/09/26/Redis操作/"},{"title":"LVM逻辑卷管理","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/d733537fd3e06784932826b5e82a855d","path":"2023/06/28/LVM逻辑卷管理/"},{"title":"python一","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/15096963228077376","path":"2024/02/20/Python1/"},{"title":"python四","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/15096963228077376","path":"2024/03/01/Python4/"},{"title":"python二","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/15096963228077376","path":"2024/02/21/Python2/"},{"title":"python三","cover":"https://haowallpaper.com/link/common/file/getCroppingImg/15096963228077376","path":"2024/02/25/Python3/"}]`)
  ipt.addEventListener('keyup', e => {
    if (e.key === 'Enter') {
      handleSearch()
    }
  })
  btn.addEventListener('click', () => {
    handleSearch()
  })

  document.querySelector('#close-layer-btn').addEventListener('click', () => {
    layer.classList.toggle('hidden')
  })

  function handleSearch() {
    if (ipt.value.trim() === '') {
      return
    }
    let html = ''
    const targetPosts = posts.filter(post => post.title.includes(ipt.value))
    targetPosts.forEach(post => {
      html += `
        <li>
          <div>
            <a href="/${post.path}">${post.title.replace(new RegExp(ipt.value), `<span>${ipt.value}</span>`)}</a>
          </div>
          <img src="${post.cover || '/imgs/default-cover.webp' }" />
        </li>
      `
    })
    if (html.trim () === '') {
      html += '<p class="empty">没有搜索到内容</p>'
    }
    layer.querySelector('ul').innerHTML = html
    layer.classList.remove('hidden')
  }
</script> 
    <section id="main" class="main">
      <div class="main-left-wrapper">
<div class="main-left">
  <div class="main-left--block">
    <div class="main-left--info">
      <img src="/imgs/avatar.jpg"" class="main-left--avatar" />
      <div class="main-left--intro">
        <p class="main-left--name">Mr.Long</p>
        <div class="main-left--tags">
          <span class="main-left--tag">唱跳rap篮球</span>
          <span class="main-left--tag">宅但不肥</span>
        </div>
      </div>
    </div>
  
    <div>
      <div class="main-left--motto">
        <p>“花有重开日，人无再少年”</p>
        <p>“一个简单普通的男孩”</p>
      </div>
      <div class="main-left--github">
        <span class="line"></span>
        <a target="_blank" rel="noopener" href="https://github.com/MyRong99/MyRong99.github.io"><i class="logo iconfont icon-github-fill"></i></a>
        <span class="line"></span>
      </div>
      <div class="main-left--statics">
        <a href="/categories">
          <div>
            <span>0</span>
            <span>分类</span>
          </div>
        </a>
        <a href="/tags">
          <div>
            <span>8</span>
            <span>标签</span>
          </div>
        </a>
        <a href="/archives">
          <div>
            <span>10 </span>
            <span>归档</span>
          </div>
        </a>
      </div>
    </div>
  </div>

  <div class="main-left--block">
    <ul class="main-left--menu">
      
        <li>
          <a href="/">
            <span class="header-menu--span">小站首页</span>
            <i class="header-menu--icon iconfont icon-shouye"></i>
          </a>
        </li>
      
        <li>
          <a href="/log">
            <span class="header-menu--span">个人日志</span>
            <i class="header-menu--icon iconfont icon-rizhi"></i>
          </a>
        </li>
      
        <li>
          <a href="/link">
            <span class="header-menu--span">友情链接</span>
            <i class="header-menu--icon iconfont icon-youqinglianjie"></i>
          </a>
        </li>
      
        <li>
          <a href="/about">
            <span class="header-menu--span">关于自己</span>
            <i class="header-menu--icon iconfont icon-guanyuwomen"></i>
          </a>
        </li>
      
        <li>
          <a href="/tools">
            <span class="header-menu--span">我的工具</span>
            <i class="header-menu--icon iconfont icon-gongju"></i>
          </a>
        </li>
      
    </ul>
  </div>

  <div class="main-left--block">
    <div class="main-left--site">
      <h5 class="main-left--title">
        <span>站点信息</span>
        <i class="iconfont icon-zhandian"></i>
      </h5>
      <p class="main-left--subtitle">
        <span>文章数目：</span>
        <span>41 篇</span>
      </p>
      <p class="main-left--subtitle">
        <span>最近动态：</span>
        <span>今天</span>
      </p>
      <p class="main-left--subtitle">
        <span>上线时间：</span>
        <span>439天</span>
      </p>
      <p class="main-left--subtitle">
        <span>当前版本：</span>
        <span>v1.0.2</span>
      </p>
    </div>
  </div>
</div></div>
      <div id="main-container" class="main-container">


  <link rel="stylesheet" href="/css/partial/article.css" />

<div class="article-container">
  <div class="article">
    <h1 class="article-title">nginx5</h1>
    <div class="article-info">
      <div class="article-info--item">
        <div class="article-info--info">
          
          <div class="article-info--categories">
            <span>分类：</span>
            
          </div>
          
          
          <div class="article-info--tags">
            <span>标签：</span>
            <a class="tag-link" href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" rel="tag">-中间件</a>
          </div>
          
          <p class="article-info--date">日期：2023-12-31 10:18:38</p>
        </div>
        <img src="https://haowallpaper.com/link/common/file/getCroppingImg/8c29198625ff99eee0073bbbb137bbc78c29198625ff99eee0073bbbb137bbc7" alt="" class="article-cover">
      </div>
    </div>
    <article class="article-content markdown-body">
      <h2 id="三、HTTPS-基本原理"><a href="#三、HTTPS-基本原理" class="headerlink" title="三、HTTPS 基本原理"></a>三、HTTPS 基本原理</h2><h3 id="1、https-介绍"><a href="#1、https-介绍" class="headerlink" title="1、https 介绍"></a>1、https 介绍</h3><p>HTTPS（全称：HyperText Transfer Protocol over Secure Socket Layer），其实 HTTPS 并不是一个新鲜协议，Google 很早就开始启用了，初衷是为了保证数据安全。 近些年，Google、Baidu、Facebook 等这样的互联网巨头，不谋而合地开始大力推行 HTTPS， 国内外的大型互联网公司很多也都已经启用了全站 HTTPS，这也是未来互联网发展的趋势。</p>
<p>为鼓励全球网站的 HTTPS 实现，一些互联网公司都提出了自己的要求：</p>
<ol>
<li>Google 已调整搜索引擎算法，让采用 HTTPS 的网站在搜索中排名更靠前；</li>
<li>从 2017 年开始，Chrome 浏览器已把采用 HTTP 协议的网站标记为不安全网站；</li>
<li>苹果要求 2017 年App Store 中的所有应用都必须使用 HTTPS 加密连接；</li>
<li>当前国内炒的很火热的微信小程序也要求必须使用 HTTPS 协议；</li>
<li>新一代的 HTTP&#x2F;2 协议的支持需以 HTTPS 为基础。</li>
</ol>
<p>等等，因此想必在不久的将来，全网 HTTPS 势在必行。</p>
<ul>
<li>HTTP 协议（HyperText Transfer Protocol，超文本传输协议）：是客户端浏览器或其他程序与Web服务器之间的应用层通信协议 。</li>
<li>HTTPS 协议（HyperText Transfer Protocol over Secure Socket Layer）：可以理解为HTTP+SSL&#x2F;TLS， 即 HTTP 下加入 SSL 层，HTTPS 的安全基础是 SSL，因此加密的详细内容就需要 SSL，用于安全的 HTTP 数据传输。</li>
</ul>
<p><img src="https://img.beyourself.org.cn/4529046966f5508b02a6ace2bcdae1434f38311e.jpg#id=CTWCB&originHeight=224&originWidth=461&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<ul>
<li>如上图所示 HTTPS 相比 HTTP 多了一层 SSL&#x2F;TLS <ul>
<li>SSL（Secure Socket Layer，安全套接字层）：1994年为 Netscape(网景公司) 所研发，SSL 协议位于 TCP&#x2F;IP 协议与各种应用层协议之间，为数据通讯提供安全支持。</li>
<li>TLS（Transport Layer Security，传输层安全）：其前身是 SSL，它最初的几个版本（SSL 1.0、SSL 2.0、SSL 3.0）由网景公司开发，1999年从 3.1 开始被 IETF 标准化并改名，发展至今已经有 TLS 1.0、TLS 1.1、TLS 1.2 三个版本。SSL3.0和TLS1.0由于存在安全漏洞，已经很少被使用到。TLS 1.3 改动会比较大，目前还在草案阶段，目前使用最广泛的是TLS 1.1、TLS 1.2。</li>
</ul>
</li>
</ul>
<h3 id="2、加密算法"><a href="#2、加密算法" class="headerlink" title="2、加密算法"></a>2、加密算法</h3><p>据记载，公元前400年，古希腊人就发明了置换密码；在第二次世界大战期间，德国军方启用了“恩尼格玛”密码机，所以密码学在社会发展中有着广泛的用途。</p>
<ol>
<li>对称加密<br>有流式、分组两种，加密和解密都是使用的同一个密钥。<br>例如：DES、AES-GCM、ChaCha20-Poly1305等 </li>
<li>非对称加密<br>加密使用的密钥和解密使用的密钥是不相同的，分别称为：公钥、私钥，公钥和算法都是公开的，私钥是保密的。非对称加密算法性能较低，但是安全性超强，由于其加密特性，非对称加密算法能加密的数据长度也是有限的。<br>例如：RSA、DSA、ECDSA、 DH、ECDHE </li>
<li>哈希算法<br>将任意长度的信息转换为较短的固定长度的值，通常其长度要比信息小得多，且算法不可逆。<br>例如：MD5、SHA-1、SHA-2、SHA-256 等 </li>
<li>数字签名<br>签名就是在信息的后面再加上一段内容（信息经过hash后的值），可以证明信息没有被修改过。hash值一般都会加密后（也就是签名）再和信息一起发送，以保证这个hash值不被修改。</li>
</ol>
<h3 id="3、HTTPS-原理"><a href="#3、HTTPS-原理" class="headerlink" title="3、HTTPS 原理"></a>3、HTTPS 原理</h3><h4 id="1、HTTP-访问过程"><a href="#1、HTTP-访问过程" class="headerlink" title="1、HTTP 访问过程"></a>1、HTTP 访问过程</h4><p><img src="https://img.beyourself.org.cn/f59968fc2d4f2e335edd4a7c4159fa8c1f8dd97d.jpg#id=bUdcy&originHeight=238&originWidth=463&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p><img src="https://img.beyourself.org.cn/b309f24128978a4852bddfb7ad22f6931fce4efc.jpg#id=Jvmsb&originHeight=213&originWidth=849&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p>如上图所示，HTTP请求过程中，客户端与服务器之间没有任何身份确认的过程，数据全部明文传输，“裸奔”在互联网上，所以很容易遭到黑客的攻击，如下：</p>
<p><img src="https://img.beyourself.org.cn/6e41d9b507f95a4277dbcd50cc84e65ed8ef2640.jpg#id=FApzE&originHeight=252&originWidth=626&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p>可以看到，客户端发出的请求很容易被黑客截获，如果此时黑客冒充服务器，则其可返回任意信息给客户端，而不被客户端察觉，所以我们经常会听到一词“劫持”，现象如下：</p>
<p>下面两图中，浏览器中填入的是相同的URL，左边是正确响应，而右边则是被劫持后的响应（从貌美如花变成如花。。。）</p>
<p><img src="https://img.beyourself.org.cn/39c5b7e39de87adcd240e8dde3934b4ca177c079.jpg#id=BL2G7&originHeight=321&originWidth=778&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p>所以 HTTP 传输面临的风险有：</p>
<ul>
<li>窃听风险：黑客可以获知通信内容。</li>
<li>篡改风险：黑客可以修改通信内容。</li>
<li>冒充风险：黑客可以冒充他人身份参与通信。</li>
</ul>
<h4 id="2、HTTP-向-HTTPS-演化的过程"><a href="#2、HTTP-向-HTTPS-演化的过程" class="headerlink" title="2、HTTP 向 HTTPS 演化的过程"></a>2、HTTP 向 HTTPS 演化的过程</h4><p>第一步：为了防止上述现象的发生，人们想到一个办法：对传输的信息加密（即使黑客截获，也无法破解）</p>
<p><img src="https://img.beyourself.org.cn/0d71bd2c3d97eeaa7aa6774ab13560ddeaff7a48.jpg#id=obhzl&originHeight=279&originWidth=589&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p>如上图所示，此种方式属于对称加密，双方拥有相同的密钥，信息得到安全传输，但此种方式的缺点是：</p>
<p>（1）不同的客户端、服务器数量庞大，所以双方都需要维护大量的密钥，维护成本很高</p>
<p>（2）因每个客户端、服务器的安全级别不同，密钥极易泄露</p>
<p>第二步：既然使用对称加密时，密钥维护这么繁琐，那我们就用非对称加密试试</p>
<p><img src="https://img.beyourself.org.cn/445c0a1d0a89b26517692f06afb751294454bd88.jpg#id=eS8m8&originHeight=316&originWidth=609&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p>如上图所示，客户端用公钥对请求内容加密，服务器使用私钥对内容解密，反之亦然，但上述过程也存在缺点：</p>
<p>（1）公钥是公开的（也就是黑客也会有公钥），所以第 ④ 步私钥加密的信息，如果被黑客截获，其可以使用公钥进行解密，获取其中的内容</p>
<p>第三步：非对称加密既然也有缺陷，那我们就将对称加密，非对称加密两者结合起来，取其精华、去其糟粕，发挥两者的各自的优势</p>
<p><img src="https://img.beyourself.org.cn/844897db358c64fffea5e9d4c6c6e0568999deb9.jpg#id=iVK3m&originHeight=457&originWidth=721&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p>如上图所示</p>
<p>（1）第 ③ 步时，客户端说：（咱们后续回话采用对称加密吧，这是对称加密的算法和对称密钥）这段话用公钥进行加密，然后传给服务器</p>
<p>（2）服务器收到信息后，用私钥解密，提取出对称加密算法和对称密钥后，服务器说：（好的）对称密钥加密</p>
<p>（3）后续两者之间信息的传输就可以使用对称加密的方式了</p>
<p>遇到的问题：</p>
<p>（1）客户端如何获得公钥</p>
<p>（2）如何确认服务器是真实的而不是黑客</p>
<p>第四步：获取公钥与确认服务器身份</p>
<p><img src="https://img.beyourself.org.cn/75d9a5e3c4d2793f44f2d19dfcb8d60b6fd67304.jpg#id=qnn5u&originHeight=296&originWidth=813&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p>1、获取公钥</p>
<p>（1）提供一个下载公钥的地址，回话前让客户端去下载。（缺点：下载地址有可能是假的；客户端每次在回话前都先去下载公钥也很麻烦）</p>
<p>（2）回话开始时，服务器把公钥发给客户端（缺点：黑客冒充服务器，发送给客户端假的公钥）</p>
<p>2、那有木有一种方式既可以安全的获取公钥，又能防止黑客冒充呢？ 那就需要用到终极武器了：SSL 证书（申购）</p>
<p><img src="https://img.beyourself.org.cn/60adda60f52b9357385879909dd8642db3351ea5.jpg#id=OyBjA&originHeight=473&originWidth=725&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p>如上图所示，在第 ② 步时服务器发送了一个SSL证书给客户端，SSL 证书中包含的具体内容有：</p>
<p>（1）证书的发布机构CA</p>
<p>（2）证书的有效期</p>
<p>（3）公钥</p>
<p>（4）证书所有者</p>
<p>（5）签名</p>
<p>………</p>
<p>3、客户端在接受到服务端发来的SSL证书时，会对证书的真伪进行校验，以浏览器为例说明如下：</p>
<p>（1）首先浏览器读取证书中的证书所有者、有效期等信息进行一一校验</p>
<p>（2）浏览器开始查找操作系统中已内置的受信任的证书发布机构CA，与服务器发来的证书中的颁发者CA比对，用于校验证书是否为合法机构颁发</p>
<p>（3）如果找不到，浏览器就会报错，说明服务器发来的证书是不可信任的。</p>
<p>（4）如果找到，那么浏览器就会从操作系统中取出 颁发者CA 的公钥，然后对服务器发来的证书里面的签名进行解密</p>
<p>（5）浏览器使用相同的hash算法计算出服务器发来的证书的hash值，将这个计算的hash值与证书中签名做对比</p>
<p>（6）对比结果一致，则证明服务器发来的证书合法，没有被冒充</p>
<p>（7）此时浏览器就可以读取证书中的公钥，用于后续加密了</p>
<p>4、所以通过发送SSL证书的形式，既解决了公钥获取问题，又解决了黑客冒充问题，一箭双雕，HTTPS加密过程也就此形成</p>
<p>所以相比HTTP，HTTPS 传输更加安全</p>
<p>（1） 所有信息都是加密传播，黑客无法窃听。</p>
<p>（2） 具有校验机制，一旦被篡改，通信双方会立刻发现。</p>
<p>（3） 配备身份证书，防止身份被冒充。</p>
<h4 id="3、HTTPS-总结"><a href="#3、HTTPS-总结" class="headerlink" title="3、HTTPS 总结"></a>3、HTTPS 总结</h4><p>综上所述，相比 HTTP 协议，HTTPS 协议增加了很多握手、加密解密等流程，虽然过程很复杂，但其可以保证数据传输的安全。所以在这个互联网膨胀的时代，其中隐藏着各种看不见的危机，为了保证数据的安全，维护网络稳定，建议大家多多推广HTTPS。</p>
<p>HTTPS 缺点：</p>
<ol>
<li>SSL 证书费用很高，以及其在服务器上的部署、更新维护非常繁琐</li>
<li>HTTPS 降低用户访问速度（多次握手）</li>
<li>网站改用HTTPS 以后，由HTTP 跳转到 HTTPS 的方式增加了用户访问耗时（多数网站采用302跳转）</li>
<li>HTTPS 涉及到的安全算法会消耗 CPU 资源，需要增加大量机器（https访问过程需要加解密）</li>
</ol>
<h3 id="4、nginx-HTTPS-部署实战"><a href="#4、nginx-HTTPS-部署实战" class="headerlink" title="4、nginx HTTPS 部署实战"></a>4、nginx HTTPS 部署实战</h3><ol>
<li>申请证书与认证</li>
<li>证书下载与配置</li>
<li>问题分析与总结</li>
</ol>
<h4 id="1、申请证书与认证"><a href="#1、申请证书与认证" class="headerlink" title="1、申请证书与认证"></a>1、申请证书与认证</h4><p>要搭建https服务首先需有SSL证书，证书通常是在第三方申请，在阿里云的安全服务中有SSL证书这一项，可以在里面申请免费的证书；</p>
<blockquote>
<p>也可以在自己电脑中生成，虽然也能完成加密，但是浏览器是不认可的，因此最好还是去第三方申请</p>
</blockquote>
<h5 id="1、证书申请"><a href="#1、证书申请" class="headerlink" title="1、证书申请"></a>1、证书申请</h5><p>阿里云提供免费的证书，不需要人工审核，用来做测试是非常不错的选择，申请地址如下URL。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://common-buy.aliyun.com/?spm=5176.2020520163.cas.1.1aa12b7aWWn20O&amp;commodityCode=cas#/buy</span><br></pre></td></tr></table></figure>

<p>免费型的证书隐藏的比较深，想要申请免费证书需要先选择 1个域名-&gt;Symantec-&gt;免费型  ,所以读者这里需要注意一下，如下图参考。</p>
<p><img src="https://img.beyourself.org.cn/b3e138ca15775ef65f0c46ac981a92182b06abb3.jpg#id=mrjAt&originHeight=485&originWidth=847&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p>选择之后，一直点击下一步，便可购买完成，免费购买证书之后笔者需要回到证书控制台，在控制台有一个补全信息的链接地址，需要通过此地址补充申请人的联系信息，参考下图填写</p>
<p><img src="https://img.beyourself.org.cn/99bb938987ea0b9def53442da83e10f091e569d4.jpg#id=wEWVs&originHeight=598&originWidth=865&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<h5 id="2、域名验证"><a href="#2、域名验证" class="headerlink" title="2、域名验证"></a>2、域名验证</h5><p>补全个人信息之后，还需要给阿里云验证当前域名是属于本人的，验证方式有两种，第一种是通过dns解析认证，第二种是通过上传验证文件认证，这里采用的是验证文件认证，首先需要下载文件，如下图</p>
<p><img src="https://img.beyourself.org.cn/f5cb0eafe2a55d5639262d91bbfeabab2016101b.jpg#id=ZZHxn&originHeight=523&originWidth=855&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p>在下载验证文件完成之后，需要把文件放到服务器中去，这里提供一条复制命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@web ~]#scp ~/Downloads/fileauth.txt  root@192.168.43.34:~/</span><br></pre></td></tr></table></figure>

<p>将验证文件复制到服务器之后，还需要将验证文件放到站点对应目录，参考命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx ~]# cd /usr/share/nginx/html/</span><br><span class="line">[root@nginx html]#mkdir -p /website/.well-known/pki-validation  &amp;&amp;  cp  fileauth.txt  /website/.well-known/pki-validation/</span><br><span class="line">[root@nginx html]# cd &amp;&amp; vim /etc/nginx/nginx.conf</span><br><span class="line">server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line">        location / &#123;</span><br><span class="line">             root /usr/share/nginx/html/website;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h6 id="1、手动验证"><a href="#1、手动验证" class="headerlink" title="1、手动验证"></a>1、手动验证</h6><p>手动验证的目的是首先确保文件位置放置是否正确，可以通过访问站点的url是否成功进行判断，比如笔者可以访问如下URL，如果返回如果页面能够正常打开，并且可以看到某些值，则代表配置成功。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.qf.com/.well-known/pki-validation/fileauth.txt</span><br></pre></td></tr></table></figure>

<h6 id="2、通过阿里云来验证"><a href="#2、通过阿里云来验证" class="headerlink" title="2、通过阿里云来验证"></a>2、通过阿里云来验证</h6><p>在确保文件放置正确之后，关键的是能让阿里云能访问到，阿里云这里提供了一个检查配置的功能，在下载验证文件页面，有一个检测配置的链接，单击之后便可进行检查，如下图。</p>
<p><img src="https://img.beyourself.org.cn/9c8cbcdae2b55c8361610c0d497270c605e56fc5.jpg#id=rRdne&originHeight=386&originWidth=860&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p>当点击 检查配置 之后，如果阿里云能够正常访问，则会在左侧给出提示，现在可以返回证书列表，在列表中可以看到当前状态为审核中，如下图</p>
<p><img src="https://img.beyourself.org.cn/502c6a61d8a5d18fb6820a6e48ef40099bbdd077.jpg#id=mxMnS&originHeight=147&originWidth=857&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p>审核因为不需要人为干预，所以很快就能下发证书，下发证书的时间大约是2分钟左右。</p>
<h4 id="2、证书下载与配置"><a href="#2、证书下载与配置" class="headerlink" title="2、证书下载与配置"></a>2、证书下载与配置</h4><h5 id="1、证书下载"><a href="#1、证书下载" class="headerlink" title="1、证书下载"></a>1、证书下载</h5><p>证书签发之后，可以在列表中可以看到状态栏中为 已签发 ，同时操作栏可以下载以及查看详情等，如下图所示</p>
<p><img src="https://img.beyourself.org.cn/c8eedaf07674eb9c591d85114b365f851394bffb.jpg#id=TDwO9&originHeight=195&originWidth=1489&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p>点击下载后，会跳转到下载详情页面，在下载详情页可以选择自己相对应的web服务，比如使用nginx，当选择nginx之后，下方还会很贴心的提示如何配置，下载nginx配置文件。</p>
<p>下载配置文件之后，需要将其解压，解压之后可以看见里面包含了两个证书文件</p>
<p>xxx.key</p>
<p>xxx.pem</p>
<p>接着需要把这两个证书文件给复制到服务器当中去，首先需要在服务器创建对应的文件夹，参考命令如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx ~]# cd /etc/nginx/ &amp;&amp; mkdir cert</span><br></pre></td></tr></table></figure>

<p>在服务器创建完成对应文件夹之后，将证书文件复制到服务器中</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx ~]# ls</span><br><span class="line">2447549_www.testpm.cn_nginx.zip</span><br><span class="line">[root@nginx ~]# unzip 2447549_www.testpm.cn_nginx.zip</span><br><span class="line">Archive:  2447549_www.testpm.cn_nginx.zip</span><br><span class="line">Aliyun Certificate Download</span><br><span class="line">  inflating: 2447549_www.testpm.cn.pem  </span><br><span class="line">  inflating: 2447549_www.testpm.cn.key   </span><br><span class="line">[root@nginx ~]# ls</span><br><span class="line">2447549_www.testpm.cn.key  2447549_www.testpm.cn_nginx.zip  2447549_www.testpm.cn.pem</span><br><span class="line">[root@nginx ~]# cp 2447549_www.testpm.cn* /etc/nginx/cert/</span><br><span class="line">[root@nginx ~]# cd /etc/nginx/cert/</span><br><span class="line">[root@nginx cert]# mv 2447549_www.testpm.cn.key www.testpm.cn.key </span><br><span class="line">[root@nginx cert]# mv 2447549_www.testpm.cn.pem www.testpm.cn.pem</span><br></pre></td></tr></table></figure>

<h5 id="2、证书配置"><a href="#2、证书配置" class="headerlink" title="2、证书配置"></a>2、证书配置</h5><p>证书复制完成之后，可以对nginx配置文件进行更改，使用vim命令编辑nginx配置文件，参考命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx ~]# cd /etc/nginx/conf.d/</span><br><span class="line">[root@nginx conf.d]# cp default.conf default.conf.bak</span><br><span class="line">[root@nginx conf.d]# mv default.conf nginx_ssl.conf</span><br><span class="line">[root@nginx conf.d]# vim nginx_ssl.conf</span><br><span class="line">[root@nginx conf.d]# cat /etc/nginx/conf.d/nginx_ssl.conf </span><br><span class="line">server &#123;</span><br><span class="line">    listen 443 ssl;</span><br><span class="line">    server_name www.testpm.cn;</span><br><span class="line">    access_log  /var/log/nginx/https_access.log  main;</span><br><span class="line"></span><br><span class="line">    #ssl on;</span><br><span class="line">    ssl_certificate   /etc/nginx/cert/2447549_www.testpm.cn.pem;</span><br><span class="line">    ssl_certificate_key  /etc/nginx/cert/2447549_www.testpm.cn.key;</span><br><span class="line">    ssl_session_timeout 5m;</span><br><span class="line">    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span><br><span class="line">    ssl_ciphers  ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP;</span><br><span class="line">    ssl_prefer_server_ciphers on;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root  /usr/share/nginx/html;</span><br><span class="line">        index index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3、重启Nginx"><a href="#3、重启Nginx" class="headerlink" title="3、重启Nginx"></a>3、重启Nginx</h5><p>修改配置文件之后，需要测试nginx配置文件是否正确</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx cert]# nginx -t </span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@nginx cert]# nginx -s reload</span><br></pre></td></tr></table></figure>

<p><img src="https://img.beyourself.org.cn/46ce49ff62fde8cf93d5f8f359ca9e5f9f8cc7c6.jpg#id=AQ6ha&originHeight=329&originWidth=1267&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p>如果看到浏览器，展示安全，并且显示绿色就说明大功告成了!</p>
<h3 id="5、nginx-性能优化"><a href="#5、nginx-性能优化" class="headerlink" title="5、nginx 性能优化"></a>5、nginx 性能优化</h3><p>当我需要进行性能优化时，说明我们服务器无法满足日益增长的业务。性能优化是一个比较大的课题，需要从以下几个方面进行探讨</p>
<ul>
<li>当前系统结构瓶颈</li>
<li>了解业务模式</li>
<li>性能与安全</li>
</ul>
<h4 id="1、当前系统结构瓶颈"><a href="#1、当前系统结构瓶颈" class="headerlink" title="1、当前系统结构瓶颈"></a>1、当前系统结构瓶颈</h4><p>首先需要了解的是当前系统瓶颈，用的是什么，跑的是什么业务。里面的服务是什么样子，每个服务最大支持多少并发。比如针对nginx而言，我们处理静态资源效率最高的瓶颈是多大？能支持多少qps访问请求？怎么得出系统当前的结构瓶颈？</p>
<p>可以通过查看当前cpu负荷，内存使用率，进程使用率来做简单判断。还可以通过操作系统的一些工具来判断当前系统性能瓶颈，如分析对应的日志，查看请求数量。也可以通过nginx http_stub_status_module模块来查看对应的连接数，总握手次数，总请求数。也可以对线上进行压力测试，来了解当前的系统能性能，并发数，做好性能评估。</p>
<h4 id="2、了解业务模式"><a href="#2、了解业务模式" class="headerlink" title="2、了解业务模式"></a>2、了解业务模式</h4><p>虽然我们是在做性能优化，但还是要熟悉业务，最终目的都是为业务服务的。我们要了解每一个接口业务类型是什么样的业务，比如电子商务抢购模式，这种情况平时流量会很小，但是到了抢购时间，流量一下子就会猛涨。也要了解系统层级结构，每一层在中间层做的是代理还是动静分离，还是后台进行直接服务。需要我们对业务接入层和系统层次要有一个梳理</p>
<h4 id="3、性能与安全"><a href="#3、性能与安全" class="headerlink" title="3、性能与安全"></a>3、性能与安全</h4><p>性能与安全也是一个需要考虑的因素，往往大家注重性能忽略安全或注重安全又忽略性能。比如说我们在设计防火墙时，如果规则过于全面肯定会对性能方面有影响。如果对性能过于注重在安全方面肯定会留下很大隐患。所以大家要评估好两者的关系，把握好两者的孰重孰轻，以及整体的相关性。权衡好对应的点。</p>
<h4 id="4、系统与nginx性能优化"><a href="#4、系统与nginx性能优化" class="headerlink" title="4、系统与nginx性能优化"></a>4、系统与nginx性能优化</h4><p>大家对相关的系统瓶颈及现状有了一定的了解之后，就可以根据影响性能方面做一个全体的评估和优化。</p>
<ul>
<li>网络（网络流量、是否有丢包，网络的稳定性都会影响用户请求）</li>
<li>系统（系统负载、饱和、内存使用率、系统的稳定性、硬件磁盘是否有损坏）</li>
<li>服务（连接优化、内核性能优化、http服务请求优化都可以在nginx中根据业务来进行设置）</li>
<li>程序（接口性能、处理请求速度、每个程序的执行效率）</li>
<li>数据库、底层服务</li>
</ul>
<p>上面列举出来每一级都会有关联，也会影响整体性能，这里主要关注的是nginx服务这一层。</p>
<h5 id="1、文件句柄"><a href="#1、文件句柄" class="headerlink" title="1、文件句柄"></a>1、文件句柄</h5><p>在linux&#x2F;unix操作系统中一切皆文件，我们的设备是文件，文件是文件，文件夹也是文件。当我们用户每发起一次请求，就会产生一个文件句柄。文件句柄可以简单的理解为<code>文件句柄就是一个索引</code>。文件句柄就会随着请求量的增多,进程调用频繁增加，那么产生的文件句柄也就会越多。</p>
<p>系统默认对文件句柄是有限制的，不可能会让一个进程无限制的调用句柄。因为系统资源是有限的，所以我们需要限制每一个服务能够使用多大的文件句柄。操作系统默认使用的文件句柄是1024个句柄。</p>
<h5 id="2、设置方式"><a href="#2、设置方式" class="headerlink" title="2、设置方式"></a>2、设置方式</h5><ul>
<li>系统全局性修改</li>
<li>用户局部性修改</li>
<li>进程局部性修改</li>
</ul>
<h5 id="3、系统全局性修该和用户局部性修改"><a href="#3、系统全局性修该和用户局部性修改" class="headerlink" title="3、系统全局性修该和用户局部性修改"></a>3、系统全局性修该和用户局部性修改</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx-server ~]# vim /etc/security/limits.conf</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">*               soft    core            0</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">*               hard    rss             10000</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">@student        hard    <span class="built_in">nproc</span>           20</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">@faculty        soft    <span class="built_in">nproc</span>           20</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">@faculty        hard    <span class="built_in">nproc</span>           50</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ftp             hard    <span class="built_in">nproc</span>           0</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">@student        -       maxlogins       4</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">root只是针对root这个用户来限制，soft只是发提醒，操作系统不会强制限制,一般的站点设置为一万左右就ok了</span></span><br><span class="line">root soft nofile 65535</span><br><span class="line">root hard nofile 65535</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">*代表通配符 所有的用户</span></span><br><span class="line">*    soft nofile 25535</span><br><span class="line">*    hard nofile 25535</span><br></pre></td></tr></table></figure>

<p>可以看到<code>root</code>和<code>*</code>，root代表是root用户，*代表的是所有用户，后面的数字就是文件句柄大小。大家可以根据个人业务来进行设置。</p>
<h5 id="4、进程局部性修改"><a href="#4、进程局部性修改" class="headerlink" title="4、进程局部性修改"></a>4、进程局部性修改</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx-server ~]# vim /etc/nginx/nginx.conf</span><br><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;  </span><br><span class="line"></span><br><span class="line">error_log  /var/log/nginx/error.log warn;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">worker_rlimit_nofile 65535; #进程限制</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  &#x27;$http_user_agent&#x27; &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">                      &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">                      &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot; &#x27;</span><br><span class="line">                      &#x27;&quot;$args&quot; &quot;$request_uri&quot;&#x27;;</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on; </span><br><span class="line">    #tcp_nopush     on; </span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65; </span><br><span class="line"></span><br><span class="line">    #gzip  on; </span><br><span class="line"></span><br><span class="line">    include /etc/nginx/conf.d/*.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>worker_rlimit_nofile</code> 是在进程上面进行限制。</p>
<h5 id="5、cpu的亲和配置"><a href="#5、cpu的亲和配置" class="headerlink" title="5、cpu的亲和配置"></a>5、cpu的亲和配置</h5><p>cpu的亲和能够使nginx对于不同的work工作进程绑定到不同的cpu上面去。就能够减少在work间不断切换cpu，把进程通常不会在处理器之间频繁迁移，进程迁移的频率小，来减少性能损耗。<a target="_blank" rel="noopener" href="https://nginx.org/en/docs/ngx_core_module.html#worker_cpu_affinity">nginx 亲和配置</a></p>
<p>查看物理cpu</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx-server ~]# cat /proc/cpuinfo | grep &quot;physical id&quot; | sort|uniq | wc -l</span><br></pre></td></tr></table></figure>

<p>查看cpu核心数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx-server ~]# cat /proc/cpuinfo|grep &quot;cpu cores&quot;|uniq</span><br></pre></td></tr></table></figure>

<p>查看cpu使用率</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx-server ~]#top  回车后按 1</span><br></pre></td></tr></table></figure>

<h5 id="6、配置worker-processes"><a href="#6、配置worker-processes" class="headerlink" title="6、配置worker_processes"></a>6、配置worker_processes</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx-server ~]# vim /etc/nginx/nginx.conf</span><br><span class="line">将刚才查看到自己cpu * cpu核心就是worker_processes</span><br><span class="line">worker_processes 2; #根据自己cpu核心数配置/这里也可以设置为auto</span><br></pre></td></tr></table></figure>

<h5 id="7、cpu亲和配置"><a href="#7、cpu亲和配置" class="headerlink" title="7、cpu亲和配置"></a>7、cpu亲和配置</h5><p>假如配置是2cpu，每个cpu是8核。配置如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">worker_processes 16;</span><br><span class="line">  1010101010101010 0101010101010101;</span><br></pre></td></tr></table></figure>

<p>配置完成后可以通过下面命令查看nginx进程配置在哪个核上</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx-server ~]# ps -eo pid,args,psr |grep [n]ginx</span><br></pre></td></tr></table></figure>

<p>在nginx 1.9版本之后，就帮我们自动绑定了cpu;</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">worker_cpu_affinity auto;</span><br></pre></td></tr></table></figure>

<h4 id="5、nginx通用配置优化"><a href="#5、nginx通用配置优化" class="headerlink" title="5、nginx通用配置优化"></a>5、nginx通用配置优化</h4><h6 id="cpu绑定"><a href="#cpu绑定" class="headerlink" title="cpu绑定"></a>cpu绑定</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">将nginx进程设置为普通用户，为了安全考虑</span></span><br><span class="line">user nginx; </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">当前启动的worker进程，官方建议是与系统核心数一致</span></span><br><span class="line">worker_processes 2;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方式一， 第一个work进程绑定第一个cpu核心，第二个work进程绑定到第二个cpu核心，依次内推 直到第16个</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">worker_cpu_affinity 0000000000000000 0000000000000001 0000000000000010 0000000000000100 ... 1000000000000000</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方式二，当 worker_processes 2 时，表明 第一work进程可以绑定第 2 4 6 8 10 12 14 16 核心，那么第二work进程就绑定 奇数核心</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">worker_cpu_affinity 1010101010101010 0101010101010101;</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方式三，就是自动分配绑定</span></span><br><span class="line">worker_cpu_affinity auto;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">日志配置成warn</span></span><br><span class="line">error_log /var/log/nginx/error.log warn; </span><br><span class="line">pid /var/run/nginx.pid;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">针对 nginx 句柄的文件限制</span></span><br><span class="line">worker_rlimit_nofile 35535;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">事件模型</span></span><br><span class="line">events &#123;</span><br><span class="line">    #使用epoll内核模型</span><br><span class="line">    use epoll;</span><br><span class="line">    #每一个进程可以处理多少个连接，如果是多核可以将连接数调高 worker_processes * 1024</span><br><span class="line">    worker_connections 10240;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    charset utf-8;  #设置字符集</span><br><span class="line"></span><br><span class="line">    #设置日志输出格式，根据自己的情况设置</span><br><span class="line">    log_format  main  &#x27;$http_user_agent&#x27; &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">                      &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">                      &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot; &#x27;</span><br><span class="line">                      &#x27;&quot;$args&quot; &quot;$request_uri&quot;&#x27;;</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;   #对静态资源的处理比较有效</span><br><span class="line">    #tcp_nopush     on;   #如果做静态资源服务器可以打开</span><br><span class="line">    #tcp_nodelay     on;   #当nginx做动态的服务时可以选择打开</span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65; </span><br><span class="line"></span><br><span class="line">    ########</span><br><span class="line">    #Gzip module</span><br><span class="line">    gzip  on;    #文件压缩默认可以打开</span><br><span class="line">    gzip_disable &quot;MSIE [1-6]\.&quot;; #对于有些浏览器不能识别压缩，需要过滤如ie6</span><br><span class="line">    gzip_http_version 1.1;</span><br><span class="line"></span><br><span class="line">    include /etc/nginx/conf.d/*.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="nginx-隐藏版本"><a href="#nginx-隐藏版本" class="headerlink" title="nginx 隐藏版本"></a>nginx 隐藏版本</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">	server_tokens off;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="nginx-修改上传文件大小"><a href="#nginx-修改上传文件大小" class="headerlink" title="nginx 修改上传文件大小"></a>nginx 修改上传文件大小</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">  client_max_body_size 10m;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="nginx-启用压缩传输"><a href="#nginx-启用压缩传输" class="headerlink" title="nginx 启用压缩传输"></a>nginx 启用压缩传输</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    #开启gzip</span><br><span class="line">    gzip  on;  </span><br><span class="line">    #低于1kb的资源不压缩 </span><br><span class="line">    gzip_min_length 1k;</span><br><span class="line">    #压缩级别1-9，越大压缩率越高，同时消耗cpu资源也越多，建议设置在5左右。 </span><br><span class="line">    gzip_comp_level 5; </span><br><span class="line">    #需要压缩哪些响应类型的资源，多个空格隔开。不建议压缩图片.</span><br><span class="line">    gzip_types text/plain application/javascript application/x-javascript text/javascript text/xml text/css;  </span><br><span class="line">    #配置禁用gzip条件，支持正则。此处表示ie6及以下不启用gzip（因为ie低版本不支持）</span><br><span class="line">    gzip_disable &quot;MSIE [1-6]\.&quot;;  </span><br><span class="line">    #是否添加“Vary: Accept-Encoding”响应头</span><br><span class="line">    gzip_vary on;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="6、ab接口压力测试工具"><a href="#6、ab接口压力测试工具" class="headerlink" title="6、ab接口压力测试工具"></a>6、ab接口压力测试工具</h4><p>ab是Apache超文本传输协议(HTTP)的性能测试工具。其设计意图是描绘当前所安装的Apache的执行性能，主要是显示你安装的Apache每秒可以处理多少个请求。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx-server ~]# yum install httpd-tools</span><br><span class="line">[root@nginx-server ~]# ab -n 2000 -c 2 http://127.0.0.1/</span><br><span class="line">-n 总的请求数</span><br><span class="line">-c 并发数</span><br><span class="line">-k 是否开启长连接</span><br></pre></td></tr></table></figure>

<p><strong>1、参数选项</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">-n：即requests，用于指定压力测试总共的执行次数</span><br><span class="line">-c：即concurrency，用于指定的并发数</span><br><span class="line">-t：即timelimit，等待响应的最大时间(单位：秒)</span><br><span class="line">-b：即windowsize，TCP发送/接收的缓冲大小(单位：字节)</span><br><span class="line">-p：即postfile，发送POST请求时需要上传的文件，此外还必须设置-T参数</span><br><span class="line">-u：即putfile，发送PUT请求时需要上传的文件，此外还必须设置-T参数</span><br><span class="line">-T：即content-type，用于设置Content-Type请求头信息，例如：application/x-www-form-urlencoded，默认值为text/plain</span><br><span class="line">-v：即verbosity，指定打印帮助信息的冗余级别</span><br><span class="line">-w：以HTML表格形式打印结果</span><br><span class="line">-i：使用HEAD请求代替GET请求</span><br><span class="line">-x：插入字符串作为table标签的属性</span><br><span class="line">-y：插入字符串作为tr标签的属性</span><br><span class="line">-z：插入字符串作为td标签的属性</span><br><span class="line">-C：添加cookie信息，例如：&quot;Apache=1234&quot;(可以重复该参数选项以添加多个)</span><br><span class="line">-H：添加任意的请求头，例如：&quot;Accept-Encoding: gzip&quot;，请求头将会添加在现有的多个请求头之后(可以重复该参数选项以添加多个)</span><br><span class="line">-A：添加一个基本的网络认证信息，用户名和密码之间用英文冒号隔开</span><br><span class="line">-P：添加一个基本的代理认证信息，用户名和密码之间用英文冒号隔开</span><br><span class="line">-X：指定使用的和端口号，例如:&quot;126.10.10.3:88&quot;</span><br><span class="line">-V：打印版本号并退出</span><br><span class="line">-k：使用HTTP的KeepAlive特性</span><br><span class="line">-d：不显示百分比</span><br><span class="line">-S：不显示预估和警告信息</span><br><span class="line">-g：输出结果信息到gnuplot格式的文件中</span><br><span class="line">-e：输出结果信息到CSV格式的文件中</span><br><span class="line">-r：指定接收到错误信息时不退出程序</span><br><span class="line">-H：显示用法信息，其实就是ab -help</span><br></pre></td></tr></table></figure>

<p><strong>2、内容解释</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Server Software:        nginx/1.10.2 (服务器软件名称及版本信息)</span><br><span class="line">Server Hostname:        192.168.1.106(服务器主机名)</span><br><span class="line">Server Port:            80 (服务器端口)</span><br><span class="line"></span><br><span class="line">Document Path:          /index1.html. (供测试的URL路径)</span><br><span class="line">Document Length:        3721 bytes (供测试的URL返回的文档大小)</span><br><span class="line"></span><br><span class="line">Concurrency Level:      1000 (并发数)</span><br><span class="line">Time taken for tests:   2.327 seconds (压力测试消耗的总时间)</span><br><span class="line">Complete requests:      5000 (的总次数)</span><br><span class="line">Failed requests:        688 (失败的请求数)</span><br><span class="line">Write errors:           0 (网络连接写入错误数)</span><br><span class="line">Total transferred:      17402975 bytes (传输的总数据量)</span><br><span class="line">HTML transferred:       16275725 bytes (HTML文档的总数据量)</span><br><span class="line">Requests per second:    2148.98 [#/sec] (mean) (平均每秒的请求数) 这个是非常重要的参数数值，服务器的吞吐量 </span><br><span class="line">Time per request:       465.338 [ms] (mean) (所有并发用户(这里是1000)都请求一次的平均时间)</span><br><span class="line">Time  request:       	0.247 [ms] (mean, across all concurrent requests) (单个用户请求一次的平均时间)</span><br><span class="line">Transfer rate:          7304.41 [Kbytes/sec] received 每秒获取的数据长度 (传输速率，单位：KB/s)</span><br><span class="line">...</span><br><span class="line">Percentage of the requests served within a certain time (ms)</span><br><span class="line"><span class="meta prompt_">  50% </span><span class="language-bash">   347  <span class="comment">## 50%的请求在347ms内返回</span></span> </span><br><span class="line"><span class="meta prompt_">  66% </span><span class="language-bash">   401  <span class="comment">## 60%的请求在401ms内返回</span></span> </span><br><span class="line"><span class="meta prompt_">  75% </span><span class="language-bash">   431</span></span><br><span class="line"><span class="meta prompt_">  80% </span><span class="language-bash">   516</span></span><br><span class="line"><span class="meta prompt_">  90% </span><span class="language-bash">   600</span></span><br><span class="line"><span class="meta prompt_">  95% </span><span class="language-bash">   846</span></span><br><span class="line"><span class="meta prompt_">  98% </span><span class="language-bash">  1571</span></span><br><span class="line"><span class="meta prompt_">  99% </span><span class="language-bash">  1593</span></span><br><span class="line"><span class="meta prompt_">  100% </span><span class="language-bash">  1619 (longest request)</span></span><br></pre></td></tr></table></figure>

<p><strong>3、示例演示</strong></p>
<h5 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h5><p>● 测试机与被测试机要分开</p>
<p>● 不要对线上的服务器做压力测试</p>
<p>● 观察测试工具ab所在机器，以及被测试的前端机的CPU、内存、网络等都不超过最高限度的75%</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx-server ~]# ab -n 50 -c 2 http://www.testpm.cn/</span><br><span class="line">This is ApacheBench, Version 2.3 &lt;$Revision: 1430300 $&gt;</span><br><span class="line">Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/</span><br><span class="line">Licensed to The Apache Software Foundation, http://www.apache.org/</span><br><span class="line"></span><br><span class="line">Benchmarking www.testpm.cn (be patient).....done</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Server Software:        nginx/1.16.0</span><br><span class="line">Server Hostname:        www.testpm.cn</span><br><span class="line">Server Port:            80</span><br><span class="line"></span><br><span class="line">Document Path:          /</span><br><span class="line">Document Length:        612 bytes</span><br><span class="line"></span><br><span class="line">Concurrency Level:      2</span><br><span class="line">Time taken for tests:   2.724 seconds</span><br><span class="line">Complete requests:      50</span><br><span class="line">Failed requests:        0</span><br><span class="line">Write errors:           0</span><br><span class="line">Total transferred:      42250 bytes</span><br><span class="line">HTML transferred:       30600 bytes</span><br><span class="line">Requests per second:    18.35 [#/sec] (mean)</span><br><span class="line">Time per request:       108.968 [ms] (mean)</span><br><span class="line">Time per request:       54.484 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          15.15 [Kbytes/sec] received</span><br><span class="line"></span><br><span class="line">Connection Times (ms)</span><br><span class="line">              min  mean[+/-sd] median   max</span><br><span class="line">Connect:       42   52  17.3     46     137</span><br><span class="line">Processing:    43   54  20.8     47     170</span><br><span class="line">Waiting:       42   53  20.7     47     170</span><br><span class="line">Total:         84  106  28.9     93     219</span><br><span class="line"></span><br><span class="line">Percentage of the requests served within a certain time (ms)</span><br><span class="line"><span class="meta prompt_">  50% </span><span class="language-bash">    93</span></span><br><span class="line"><span class="meta prompt_">  66% </span><span class="language-bash">    96</span></span><br><span class="line"><span class="meta prompt_">  75% </span><span class="language-bash">   101</span></span><br><span class="line"><span class="meta prompt_">  80% </span><span class="language-bash">   130</span></span><br><span class="line"><span class="meta prompt_">  90% </span><span class="language-bash">   153</span></span><br><span class="line"><span class="meta prompt_">  95% </span><span class="language-bash">   161</span></span><br><span class="line"><span class="meta prompt_">  98% </span><span class="language-bash">   219</span></span><br><span class="line"><span class="meta prompt_">  99% </span><span class="language-bash">   219</span></span><br><span class="line"><span class="meta prompt_"> 100% </span><span class="language-bash">   219 (longest request)</span></span><br></pre></td></tr></table></figure>

<p><strong>4、ab性能指标</strong></p>
<h6 id="1、吞吐率（Requests-per-second）"><a href="#1、吞吐率（Requests-per-second）" class="headerlink" title="1、吞吐率（Requests per second）"></a>1、吞吐率（Requests per second）</h6><p>服务器并发处理能力的量化描述，单位是reqs&#x2F;s，指的是在某个并发用户数下单位时间内处理的请求数。某个并发用户数下单位时间内能处理的最大请求数，称之为最大吞吐率。记住：吞吐率是基于并发用户数的。这句话代表了两个含义：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">● 吞吐率和并发用户数相关</span><br><span class="line"></span><br><span class="line">● 不同的并发用户数下，吞吐率一般是不同的</span><br></pre></td></tr></table></figure>

<p>计算公式：总请求数&#x2F;处理完成这些请求数所花费的时间，即</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Request per second=Complete requests/Time taken for tests</span><br></pre></td></tr></table></figure>

<p>必须要说明的是，这个数值表示当前机器的整体性能，值越大越好</p>
<h6 id="2、并发连接数（The-number-of-concurrent-connections）"><a href="#2、并发连接数（The-number-of-concurrent-connections）" class="headerlink" title="2、并发连接数（The number of concurrent connections）"></a>2、并发连接数（The number of concurrent connections）</h6><p>并发连接数指的是某个时刻服务器所接受的请求数目，简单的讲，就是一个会话。</p>
<h6 id="3、并发用户数（Concurrency-Level）"><a href="#3、并发用户数（Concurrency-Level）" class="headerlink" title="3、并发用户数（Concurrency Level）"></a>3、并发用户数（Concurrency Level）</h6><p>要注意区分这个概念和并发连接数之间的区别，一个用户可能同时会产生多个会话，也即连接数。在HTTP&#x2F;1.1下，IE7支持两个并发连接，IE8支持6个并发连接，FireFox3支持4个并发连接，所以相应的，我们的并发用户数就得除以这个基数。</p>
<h6 id="4-用户平均请求等待时间（Time-per-request）"><a href="#4-用户平均请求等待时间（Time-per-request）" class="headerlink" title="4.用户平均请求等待时间（Time per request）"></a>4.用户平均请求等待时间（Time per request）</h6><p>计算公式：处理完成所有请求数所花费的时间&#x2F;（总请求数&#x2F;并发用户数），即：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Time per request=Time taken for tests/（Complete requests/Concurrency Level）</span><br></pre></td></tr></table></figure>

<h6 id="5-服务器平均请求等待时间（Time-per-request-across-all-concurrent-requests）"><a href="#5-服务器平均请求等待时间（Time-per-request-across-all-concurrent-requests）" class="headerlink" title="5.服务器平均请求等待时间（Time per request:across all concurrent requests）"></a>5.服务器平均请求等待时间（Time per request:across all concurrent requests）</h6><p>计算公式：处理完成所有请求数所花费的时间&#x2F;总请求数，即：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Time taken for/testsComplete requests</span><br></pre></td></tr></table></figure>

<p>可以看到，它是吞吐率的倒数。同时，它也等于用户平均请求等待时间&#x2F;并发用户数，即</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Time per request/Concurrency Level</span><br></pre></td></tr></table></figure>

    </article>
    
    <div class="read-nums">
      <!-- id 将作为查询条件 -->
      <span id="2023/12/31/nnginx5/" class="leancloud_visitors" data-flag-title="Your Article Title">
        <em class="post-meta-item-text">浏览量</em>
        <i class="leancloud-visitors-count"></i>
      </span>
    </div>
    <div class="comments-intro">
      <h2>评论区</h2>
      <p>欢迎你留下宝贵的意见，昵称输入QQ号会显示QQ头像哦~</p>
    </div>
    <div id="vcomments" class="vcomments"></div>
    
  </div>
  <div class="article-catelogue">
    <div class="article-catelogue--wrapper">
      <div class="catelogue catelogue-1">
        <h3>目录</h3>
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81HTTPS-%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86"><span class="toc-number">1.</span> <span class="toc-text">三、HTTPS 基本原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81https-%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.1.</span> <span class="toc-text">1、https 介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95"><span class="toc-number">1.2.</span> <span class="toc-text">2、加密算法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81HTTPS-%E5%8E%9F%E7%90%86"><span class="toc-number">1.3.</span> <span class="toc-text">3、HTTPS 原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81HTTP-%E8%AE%BF%E9%97%AE%E8%BF%87%E7%A8%8B"><span class="toc-number">1.3.1.</span> <span class="toc-text">1、HTTP 访问过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81HTTP-%E5%90%91-HTTPS-%E6%BC%94%E5%8C%96%E7%9A%84%E8%BF%87%E7%A8%8B"><span class="toc-number">1.3.2.</span> <span class="toc-text">2、HTTP 向 HTTPS 演化的过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81HTTPS-%E6%80%BB%E7%BB%93"><span class="toc-number">1.3.3.</span> <span class="toc-text">3、HTTPS 总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81nginx-HTTPS-%E9%83%A8%E7%BD%B2%E5%AE%9E%E6%88%98"><span class="toc-number">1.4.</span> <span class="toc-text">4、nginx HTTPS 部署实战</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E7%94%B3%E8%AF%B7%E8%AF%81%E4%B9%A6%E4%B8%8E%E8%AE%A4%E8%AF%81"><span class="toc-number">1.4.1.</span> <span class="toc-text">1、申请证书与认证</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1%E3%80%81%E8%AF%81%E4%B9%A6%E7%94%B3%E8%AF%B7"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">1、证书申请</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2%E3%80%81%E5%9F%9F%E5%90%8D%E9%AA%8C%E8%AF%81"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">2、域名验证</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1%E3%80%81%E6%89%8B%E5%8A%A8%E9%AA%8C%E8%AF%81"><span class="toc-number">1.4.1.2.1.</span> <span class="toc-text">1、手动验证</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2%E3%80%81%E9%80%9A%E8%BF%87%E9%98%BF%E9%87%8C%E4%BA%91%E6%9D%A5%E9%AA%8C%E8%AF%81"><span class="toc-number">1.4.1.2.2.</span> <span class="toc-text">2、通过阿里云来验证</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E8%AF%81%E4%B9%A6%E4%B8%8B%E8%BD%BD%E4%B8%8E%E9%85%8D%E7%BD%AE"><span class="toc-number">1.4.2.</span> <span class="toc-text">2、证书下载与配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1%E3%80%81%E8%AF%81%E4%B9%A6%E4%B8%8B%E8%BD%BD"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">1、证书下载</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2%E3%80%81%E8%AF%81%E4%B9%A6%E9%85%8D%E7%BD%AE"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">2、证书配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3%E3%80%81%E9%87%8D%E5%90%AFNginx"><span class="toc-number">1.4.2.3.</span> <span class="toc-text">3、重启Nginx</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81nginx-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="toc-number">1.5.</span> <span class="toc-text">5、nginx 性能优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E5%BD%93%E5%89%8D%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84%E7%93%B6%E9%A2%88"><span class="toc-number">1.5.1.</span> <span class="toc-text">1、当前系统结构瓶颈</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E4%BA%86%E8%A7%A3%E4%B8%9A%E5%8A%A1%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.5.2.</span> <span class="toc-text">2、了解业务模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81%E6%80%A7%E8%83%BD%E4%B8%8E%E5%AE%89%E5%85%A8"><span class="toc-number">1.5.3.</span> <span class="toc-text">3、性能与安全</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%E3%80%81%E7%B3%BB%E7%BB%9F%E4%B8%8Enginx%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="toc-number">1.5.4.</span> <span class="toc-text">4、系统与nginx性能优化</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1%E3%80%81%E6%96%87%E4%BB%B6%E5%8F%A5%E6%9F%84"><span class="toc-number">1.5.4.1.</span> <span class="toc-text">1、文件句柄</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2%E3%80%81%E8%AE%BE%E7%BD%AE%E6%96%B9%E5%BC%8F"><span class="toc-number">1.5.4.2.</span> <span class="toc-text">2、设置方式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3%E3%80%81%E7%B3%BB%E7%BB%9F%E5%85%A8%E5%B1%80%E6%80%A7%E4%BF%AE%E8%AF%A5%E5%92%8C%E7%94%A8%E6%88%B7%E5%B1%80%E9%83%A8%E6%80%A7%E4%BF%AE%E6%94%B9"><span class="toc-number">1.5.4.3.</span> <span class="toc-text">3、系统全局性修该和用户局部性修改</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4%E3%80%81%E8%BF%9B%E7%A8%8B%E5%B1%80%E9%83%A8%E6%80%A7%E4%BF%AE%E6%94%B9"><span class="toc-number">1.5.4.4.</span> <span class="toc-text">4、进程局部性修改</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5%E3%80%81cpu%E7%9A%84%E4%BA%B2%E5%92%8C%E9%85%8D%E7%BD%AE"><span class="toc-number">1.5.4.5.</span> <span class="toc-text">5、cpu的亲和配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6%E3%80%81%E9%85%8D%E7%BD%AEworker-processes"><span class="toc-number">1.5.4.6.</span> <span class="toc-text">6、配置worker_processes</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7%E3%80%81cpu%E4%BA%B2%E5%92%8C%E9%85%8D%E7%BD%AE"><span class="toc-number">1.5.4.7.</span> <span class="toc-text">7、cpu亲和配置</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5%E3%80%81nginx%E9%80%9A%E7%94%A8%E9%85%8D%E7%BD%AE%E4%BC%98%E5%8C%96"><span class="toc-number">1.5.5.</span> <span class="toc-text">5、nginx通用配置优化</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#cpu%E7%BB%91%E5%AE%9A"><span class="toc-number">1.5.5.0.1.</span> <span class="toc-text">cpu绑定</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#nginx-%E9%9A%90%E8%97%8F%E7%89%88%E6%9C%AC"><span class="toc-number">1.5.5.0.2.</span> <span class="toc-text">nginx 隐藏版本</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#nginx-%E4%BF%AE%E6%94%B9%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6%E5%A4%A7%E5%B0%8F"><span class="toc-number">1.5.5.0.3.</span> <span class="toc-text">nginx 修改上传文件大小</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#nginx-%E5%90%AF%E7%94%A8%E5%8E%8B%E7%BC%A9%E4%BC%A0%E8%BE%93"><span class="toc-number">1.5.5.0.4.</span> <span class="toc-text">nginx 启用压缩传输</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6%E3%80%81ab%E6%8E%A5%E5%8F%A3%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7"><span class="toc-number">1.5.6.</span> <span class="toc-text">6、ab接口压力测试工具</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">1.5.6.1.</span> <span class="toc-text">注意事项</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1%E3%80%81%E5%90%9E%E5%90%90%E7%8E%87%EF%BC%88Requests-per-second%EF%BC%89"><span class="toc-number">1.5.6.1.1.</span> <span class="toc-text">1、吞吐率（Requests per second）</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2%E3%80%81%E5%B9%B6%E5%8F%91%E8%BF%9E%E6%8E%A5%E6%95%B0%EF%BC%88The-number-of-concurrent-connections%EF%BC%89"><span class="toc-number">1.5.6.1.2.</span> <span class="toc-text">2、并发连接数（The number of concurrent connections）</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3%E3%80%81%E5%B9%B6%E5%8F%91%E7%94%A8%E6%88%B7%E6%95%B0%EF%BC%88Concurrency-Level%EF%BC%89"><span class="toc-number">1.5.6.1.3.</span> <span class="toc-text">3、并发用户数（Concurrency Level）</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#4-%E7%94%A8%E6%88%B7%E5%B9%B3%E5%9D%87%E8%AF%B7%E6%B1%82%E7%AD%89%E5%BE%85%E6%97%B6%E9%97%B4%EF%BC%88Time-per-request%EF%BC%89"><span class="toc-number">1.5.6.1.4.</span> <span class="toc-text">4.用户平均请求等待时间（Time per request）</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#5-%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%B9%B3%E5%9D%87%E8%AF%B7%E6%B1%82%E7%AD%89%E5%BE%85%E6%97%B6%E9%97%B4%EF%BC%88Time-per-request-across-all-concurrent-requests%EF%BC%89"><span class="toc-number">1.5.6.1.5.</span> <span class="toc-text">5.服务器平均请求等待时间（Time per request:across all concurrent requests）</span></a></li></ol></li></ol></li></ol></li></ol></li></ol>
      </div>
      
        <div class="catelogue catelogue-2">
          
            <p>
              <span>上一篇：</span>
              <a href="/2024/02/20/Python1/">python一</a>
            </p>
           
          
            <p>
              <span>下一篇</span>
              <a href="/2023/12/30/nginx4/">nginx4</a>
            </p>
          
        </div>
      
    </div>
  </div>
</div>


<script>
  // var定义，避免pjax重新进来造成的重复声明错误
  var config = JSON.parse('{"enable":true,"appId":"Pf8zCXGEH1qsprnWfikVVujL-gzGzoHsz","appKey":"qOqoiUHhH1TGtLRUYURkLRQX","placeholder":"请留下你宝贵的意见吧~","meta":["nick"],"recordIP":true,"visitor":true,"enableQQ":true}')
  new Valine({
    el: '#vcomments',
    appId: config.appId,
    appKey: config.appKey,
    placeholder: config.placeholder,
    meta: config.meta,
    recordIP: config.recordIP,
    visitor: config.visitor,
    enableQQ: config.enableQQ,
    path: '2023/12/31/nnginx5/'
  })
</script>


<script>
  $(document).on('pjax:complete', function() {
    const tocs = document.querySelector('.toc')
    const links = tocs ? tocs.querySelectorAll('a') : []
    links.forEach(link => {
      link.addEventListener('click', e => {
        const href = decodeURIComponent(e.href)
        href.search(/#(.*)/)
        const id = RegExp.$1
        const target = document.querySelector('#' + id)
        const top = target.offsetTop
        document.documentElement.scrollTo({
          top: top - 100,
          behavior: 'smooth'
        })
        e.preventDefault()
      })
    })
  })
</script> 

</div>
      <div class="main-right-wrapper"><div class="main-right">
  <div class="main-right--board">
    <div class="main-right--title">
      <h5>公告栏</h5>
      <i class="iconfont icon-gonggao"></i>
    </div>
    <div class="main-right--content">
      Hello~大噶好。唔系小曹宅，欢迎你们来到我的博客小站，希望能在这里收获到有用的东西哦！ 
    </div>
  </div>

  <div id="aplayer" class="main-right--music"></div>

  <div class="operate-items">
    <div class="operate-item backtop">
      <i class="iconfont icon-huidaodingbu"></i>
      <span>回到顶部</span>
    </div>
    
    <div class="operate-item turn-comment hidden">
      <i class="iconfont icon-pinglun"></i>
      <span>查看评论</span>
    </div>
    
  </div>

  <div class="main-right--site">
    <div class="main-right--power">
      <p>Power By <a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/docs/">Hexo</a>.</p>
      <p>Theme：<a target="_blank" rel="noopener" href="https://github.com/Aizener/hexo-theme-cola">Cola.</a></p>
    </div>
    <p class="main-right--refer"><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/#/Integrated/index">2262690094</a> </p>
  </div>
</div>

<script>
  function setOperateItem () {
    const reg = /\d{4}\/\d{2}\/\d{2}\/.+/
    const path = location.pathname
    const operateDom = document.querySelector('.main-right .operate-items')
    const commentDom = document.querySelector('.turn-comment')
    const cateloguDom = document.querySelector('.article-catelogue > .article-catelogue--wrapper');

    if (commentDom) {
      if (reg.test(path) || path.match(/\/log\/.+/)) {
        commentDom.classList.remove('hidden')
        const newDom = operateDom.cloneNode(true);
        const _backtopDom = newDom.querySelector('.backtop');
        const _commentDom = newDom.querySelector('.turn-comment');
        _backtopDom.addEventListener('click', () => backTopEvent());
        _commentDom.addEventListener('click', () => commentDomEvent());
        cateloguDom.appendChild(newDom);
      } else {
        commentDom.classList.add('hidden')
      }
    }
  }

  setOperateItem()
  const musics = JSON.parse(`[{"name":"不找了","artist":"隔壁老樊","url":"music/隔壁老樊 - 不找了.mp3","cover":"https://img2.baidu.com/it/u=1260056724,1076343118&fm=253&fmt=auto&app=138&f=JPEG?w=500&h=500"},{"name":"于是天气刚好","artist":"泪桥","url":"music/于是天气刚好 - 泪桥.mp3","cover":"https://img2.baidu.com/it/u=705831265,2862720033&fm=253&fmt=auto&app=138&f=JPEG?w=500&h=500"},{"name":"安和桥","artist":"林芬宇","url":"music/林芬宇 - 安和桥.mp3","cover":"https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQo0SWQx6YrNA8lElaG4OOKLkNkNzLO1PflKg&usqp=CAU"}]`)
  const ap = new APlayer({
    container: document.querySelector('#aplayer'),
    audio: musics,
  })

  $(document).on('pjax:complete', function() {
    setOperateItem()
  })

  document.querySelector('.backtop').addEventListener('click', () => {
    backTopEvent();
  })
  const dom = document.querySelector('.turn-comment')
  dom && dom.addEventListener('click', () => {
    commentDomEvent();
  })

  function backTopEvent() {
    document.documentElement.scrollTo({
      top: 0,
      behavior: 'smooth'
    })
  }

  function commentDomEvent() {
    const commentDom = document.querySelector('.comments-intro')
    if (!commentDom) return
    const top = commentDom.offsetTop, height = commentDom.offsetHeight
    document.documentElement.scrollTo({
      top: top - 2 * height,
      behavior: 'smooth'
    })
  }
</script></div>
    </section>
  </div>
  <div id="progress" class="progress"></div>
  <div id="gray" class="gray"></div>

  <script>
    function initScroll () {
      document.addEventListener('scroll', () => {
        const doc = document.documentElement
        const scrollTop = doc.scrollTop
        const pageHeight = doc.offsetHeight
        const clientHeight = doc.clientHeight
        const ratio = scrollTop / (pageHeight - clientHeight)
        const progress = document.querySelector('#progress')
        const avatarImg = document.querySelector('.main-left--avatar')
        progress.style.width = (100 * ratio) + '%'
        avatarImg.style.transform = `rotate(${360 * ratio}deg)`
      })
    }

    const rootPath = "/"

    const checkAndSetArticlePageLayout = () => {
      const path = location.pathname.replace(rootPath, '');
      if (
        /^\/?\d{4}\/\d{2}\/\d{2}\/.*/.test(path) ||
        /^log\/.+/.test(path)
      ) {
        $('.main-container, .main-right, .main-right-wrapper').addClass('is-article')
      } else {
        $('.main-container, .main-right, .main-right-wrapper').removeClass('is-article')
      }
    }

    const gray = "none"
    const setGrayStyle = () => {
      if (gray === 'none') {
        return
      } else if (gray === 'index') {
        location.pathname === '/' ? $('#gray').show() : $('#gray').hide()
      } else if (gray === 'all') {
        $('#gray').show()
      }
    }
    setGrayStyle()


    window.onload = function () {
      checkAndSetArticlePageLayout()
      setTimeout(() => {
        $('#load').slideUp()
        $('#container').slideToggle()
        setTimeout(() => {
          initScroll();
        }, 500)
      }, 500)
    }
    
    let status = 0
    // 对所有链接跳转事件绑定pjax容器container
    $(document).pjax('a[target!=_blank]', '#main-container', {
      container: '#main-container',
      fragment: '#main-container',
      timeout: 8000
    })

    $(document).on('pjax:start', function() {
    })
    $(document).on('pjax:complete', function() {
      status = 0
      $('.main-container').addClass('to-up').on('animationend', function() {
        $(this).removeClass('to-up')
      })
      setGrayStyle()
      checkAndSetArticlePageLayout()
    })
    $(document).on('pjax:popstate', function() {
      status = -1
      checkAndSetArticlePageLayout()
    });
  </script>
</body>
</html>